function Component(){this.id=CURRENT_ID_COMPONENT++,this.draw=function(a){console.log("Not implemented")}}function PionJoueur(a,b,c){Component.apply(this),this.axe,this.pos,this.x,this.y,this.color=a,this.isSelected=!1,this.largeur=b,this.currentInterval=null,this.img=null,c&&(this.img=new Image,this.img.src=c,this.largeur+=6),this.init=function(a,b){var c=a+"-"+b;this.axe=a,this.pos=b,this.x=GestionFiche.getById(c).drawing.getCenter().x,this.y=GestionFiche.getById(c).drawing.getCenter().y},this.draw=function(a){this.isSelected&&DrawerHelper.drawCircle(a,"#FFFFFF",(this.largeur+6)/2,{x:this.x,y:this.y},"#FF0000"),null!=this.img?DrawerHelper.drawImage(a,this.img,this.x-this.largeur/2,this.y-this.largeur/2,this.largeur,this.largeur,0):DrawerHelper.drawCircle(a,this.color,this.largeur/2,{x:this.x,y:this.y},"#FF0000")},this.setSelected=function(a){this.isSelected=a},this["goto"]=function(a,b,c,d){if(null!=this.currentInterval)throw"Impossible de realiser ce deplacement primaire";if(d){var e=GestionFiche.getById(this.axe+"-"+this.pos).drawing.getCenter();this.x=e.x,this.y=e.y}if(this.axe==a&&this.pos==b){var f=GestionFiche.getById(this.axe+"-"+this.pos).drawing._decalagePion();return this.x=f.x,this.y=f.y,void(c&&c())}var g=this._toNextCase(),h=5,i="x";this.x==g.x&&(i="y");var j=this,k=Math.abs(g[i]-this[i]),l=g[i]>this[i]?1:-1;this.currentInterval=setInterval(function(){k>0?(j[i]+=h*l,k-=h):(j.y=g.y,j.x=g.x,clearInterval(j.currentInterval),j.currentInterval=null,j["goto"](a,b,c))},30)},this.gotoDirect=function(a,b,c){if(null!=a&&null!=b){if(null!=this.currentInterval)throw"Impossible de realiser ce deplacement direct";var d=GestionFiche.getById(this.axe+"-"+this.pos).drawing.getCenter(),e=GestionFiche.getById(a+"-"+b).drawing.getCenter();if(d.x==e.x){var f=(d.y,d.y>e.y?-1:1),g=this;this.currentInterval=setInterval(function(){return 0>f&&g.y<=e.y||f>0&&g.y>=e.y?(g.axe=a,g.pos=b,clearInterval(g.currentInterval),g.currentInterval=null,void(c&&c())):void(g.y+=30*(0>f?-1:1))},30)}else{var h=(d.y-e.y)/(d.x-e.x),i=e.y-h*e.x,j=d.x,f=d.x>e.x?-1:1,g=this;this.currentInterval=setInterval(function(){return 0>f&&j<=e.x||f>0&&j>=e.x?(g.x=e.x,g.y=e.y,g.axe=a,g.pos=b,clearInterval(g.currentInterval),g.currentInterval=null,void(c&&c())):(g.x=j,g.y=h*j+i,void(j+=30*(0>f?-1:1)))},30)}}},this._toNextCase=function(){return this.pos++,this.pos>=10&&(this.axe=(this.axe+1)%4,this.pos=0),GestionFiche.getById(this.axe+"-"+this.pos).drawing.getCenter()},this.init(2,0)}function Case(a,b,c,d,e,f){Component.apply(this),this.data={},this.pos=a,this.axe=b,this.nbMaison=0,this.imgMaison=new Image,this.imgHotel=new Image,this.colorPossede=null,this.rayon=10,this.setNbMaison=function(a){this.nbMaison=a},this.init=function(){this.imgMaison.src="img/maison.png",this.imgHotel.src="img/hotel.png";var c=DrawerFactory.dimensions.plateauSize/2,d=DrawerFactory.dimensions.largeur,e=DrawerFactory.dimensions.hauteur,g=9*d/2;if(b%2==1?(this.data.height=d,this.data.width=e,1==b?(this.data.x=c+g,this.data.y=c+(a-5.5)*d):(this.data.x=c-g-e,this.data.y=c+(4.5-a)*d)):(this.data.height=e,this.data.width=d,2==b?(this.data.y=c+g,this.data.x=c+(4.5-a)*d):(this.data.y=c-g-e,this.data.x=c+(a-5.5)*d)),null!=f){var h=new Image;h.src=f.src,h.height=f.height,h.width=f.width,h.margin=f.margin,this.data.image=h}},this.getCenter=function(){return{x:this.data.x+this.data.width/2,y:this.data.y+this.data.height/2}},this.draw=function(a){var f=DrawerFactory.dimensions.bordure/2,g=DrawerFactory.dimensions.largeur,h=DrawerFactory.dimensions.hauteur;if(a.strokeStyle="#000000",a.strokeRect(this.data.x,this.data.y,this.data.width,this.data.height),null!=c)switch(a.fillStyle=c,b){case 0:a.fillRect(this.data.x,this.data.y+h-f,this.data.width,f);break;case 1:a.fillRect(this.data.x,this.data.y,f,g);break;case 2:a.fillRect(this.data.x,this.data.y,this.data.width,f);break;case 3:a.fillRect(this.data.x+h-f,this.data.y,f,g)}if(null!=d){var i=10+(null!=c?f:0);switch(b){case 0:DrawerHelper.writeText(d,this.data.x+g,this.data.y+h-i,Math.PI,a);break;case 1:DrawerHelper.writeText(d,this.data.x+i,this.data.y+g,-Math.PI/2,a);break;case 2:DrawerHelper.writeText(d,this.data.x,this.data.y+i,0,a);break;case 3:DrawerHelper.writeText(d,this.data.x+h-i,this.data.y,Math.PI/2,a)}}if(null!=e){var i=5;switch(b){case 0:DrawerHelper.writeText(e,this.data.x+g,this.data.y+i,Math.PI,a);break;case 1:DrawerHelper.writeText(e,this.data.x+h-i,this.data.y+g,-Math.PI/2,a);break;case 2:DrawerHelper.writeText(e,this.data.x,this.data.y+h-i,0,a);break;case 3:DrawerHelper.writeText(e,this.data.x+i,this.data.y,Math.PI/2,a)}}if(null!=this.data.image){var j=Math.PI/2*((this.axe+2)%4),k=(g-this.data.image.width)/2,i=10+(null!=c?f:10)+(null!=d?10:0)+(this.data.image.margin||0);switch(b){case 0:DrawerHelper.drawImage(a,this.data.image,this.data.x+g-k,this.data.y+h-i,this.data.image.width,this.data.image.height,j);break;case 1:DrawerHelper.drawImage(a,this.data.image,this.data.x+i,this.data.y+g-k,this.data.image.width,this.data.image.height,j);break;case 2:DrawerHelper.drawImage(a,this.data.image,this.data.x+k,this.data.y+i,this.data.image.width,this.data.image.height,j);break;case 3:DrawerHelper.drawImage(a,this.data.image,this.data.x+h-i,this.data.y+k,this.data.image.width,this.data.image.height,j)}}if(this.nbMaison<=4){a.fillStyle="#00FF00";for(var l=0;l<this.nbMaison;l++)switch(b){case 0:DrawerHelper.drawImage(a,this.imgMaison,this.data.x+g-15*l-3,this.data.y+h-2,15,15,-Math.PI);break;case 1:DrawerHelper.drawImage(a,this.imgMaison,this.data.x+3,this.data.y+g-2-15*l,15,15,-Math.PI/2);break;case 2:DrawerHelper.drawImage(a,this.imgMaison,this.data.x+3+15*l,this.data.y+2,15,15,0);break;case 3:DrawerHelper.drawImage(a,this.imgMaison,this.data.x+h-3,this.data.y+2+15*l,15,15,Math.PI/2)}}else{var m=(g-18)/2;switch(b){case 0:DrawerHelper.drawImage(a,this.imgHotel,this.data.x+g-m,this.data.y+h,18,18,-Math.PI);break;case 1:DrawerHelper.drawImage(a,this.imgHotel,this.data.x,this.data.y+g-m,18,18,-Math.PI/2);break;case 2:DrawerHelper.drawImage(a,this.imgHotel,this.data.x+m,this.data.y,18,18,0);break;case 3:DrawerHelper.drawImage(a,this.imgHotel,this.data.x+h,this.data.y+m,18,18,Math.PI/2)}}if(null!=this.colorPossede)switch(b){case 0:DrawerHelper.drawArcCircle(a,this.colorPossede,this.rayon,{x:this.data.x+g,y:this.data.y},Math.PI/2,Math.PI);break;case 1:DrawerHelper.drawArcCircle(a,this.colorPossede,this.rayon,{x:this.data.x+h,y:this.data.y+g},Math.PI,3*Math.PI/2);break;case 2:DrawerHelper.drawArcCircle(a,this.colorPossede,this.rayon,{x:this.data.x,y:this.data.y+h},3*Math.PI/2,2*Math.PI);break;case 3:DrawerHelper.drawArcCircle(a,this.colorPossede,this.rayon,{x:this.data.x,y:this.data.y},2*Math.PI,Math.PI/2)}},this.setJoueur=function(a){this.colorPossede=null,null!=a&&(this.colorPossede=a.color)},this.getNbJoueurs=function(){var a=0;return GestionJoueur.forEach(function(b){a+=b.pion.axe==this.axe&&b.pion.position==this.pos?1:0},this),a},this._decalagePion=function(){var a=DrawerFactory.dimensions.bordure/2,b=20+(null!=c?a:0)+DrawerFactory.dimensions.largeurPion/2,d=this.getCenter();d.x+=5;var e={x:DrawerFactory.dimensions.largeurPion,y:(this.data.height-b)/3},f=this.getNbJoueurs()-1;return this.axe%2==0?{x:d.x+(f%3-1)*e.y,y:3>f?d.y-e.x:d.y+e.x}:{x:3>f?d.x-e.x:d.x+e.x,y:d.y+(f%3-1)*e.y}},this.init()}function CaseSpeciale(a,b){Case.call(this,0,a,null,b),this.titre=b,this.data={},this.init=function(){var b=DrawerFactory.dimensions.largeur,c=DrawerFactory.dimensions.hauteur,d=DrawerFactory.dimensions.plateauSize/2,e=9*b/2;a%2==1?1==a?(this.data.x=d+e,this.data.y=d+-4.5*b-c):(this.data.x=d-e-c,this.data.y=d+4.5*b):2==a?(this.data.y=d+e,this.data.x=d+4.5*b):(this.data.y=d-e-c,this.data.x=d-4.5*b-c),this.data.height=this.data.width=c},this.getCenter=function(){return{x:this.data.x+this.data.height/2,y:this.data.y+this.data.height/2}},this.draw=function(a){a.strokeStyle="#000000",a.strokeRect(this.data.x,this.data.y,this.data.width,this.data.height),DrawerHelper.writeText(this.titre,this.data.x,this.data.y+DrawerFactory.dimensions.hauteur/2,0,a,9,this.data.width)},this.init()}function DesRapide(a,b,c){Des.call(this,a,b,c),this.imgBus=new Image,this.imgBus.src="img/bus.png",this.imgMr=new Image,this.imgMr.src="img/mr_monopoly.png",this.margin=.1*c,this.draw=function(d){this._drawCadre(d),null!=this.value&&((1==this.value||3==this.value)&&this.drawPoint(d,a+c/2,b+c/2,c/5,this.color),(2==this.value||3==this.value)&&(this.drawPoint(d,a+.25*c,b+.75*c,c/5,this.color),this.drawPoint(d,a+.75*c,b+.25*c,c/5,this.color)),(4==this.value||6==this.value)&&DrawerHelper.drawImage(d,this.imgBus,a+this.margin,b+this.margin,c-this.margin,c-this.margin,0),5==this.value&&DrawerHelper.drawImage(d,this.imgMr,a+this.margin,b+this.margin,c-this.margin,c-this.margin,0))}}function Des(a,b,c){this.value,this.coin=15,this.width=c-2*this.coin,this.setValue=function(a,b){this.value=a,this.color=b||"#000000"},this.draw=function(d){this._drawCadre(d),null!=this.value&&(this.value%2==1&&this.drawPoint(d,a+c/2,b+c/2,c/5,this.color),1!=this.value&&(this.drawPoint(d,a+.25*c,b+.75*c,c/5,this.color),this.drawPoint(d,a+.75*c,b+.25*c,c/5,this.color)),this.value>=4&&(this.drawPoint(d,a+.75*c,b+.75*c,c/5,this.color),this.drawPoint(d,a+.25*c,b+.25*c,c/5,this.color)),6==this.value&&(this.drawPoint(d,a+.75*c,b+.5*c,c/5,this.color),this.drawPoint(d,a+.25*c,b+.5*c,c/5,this.color)))},this._drawCadre=function(c){c.strokeStyle="#000000",c.fillStyle="#000000",c.beginPath(),c.moveTo(a+this.coin,b),c.lineTo(a+this.coin+this.width,b),c.bezierCurveTo(a+2*this.coin+this.width,b,a+2*this.coin+this.width,b+this.coin,a+2*this.coin+this.width,b+this.coin),c.lineTo(a+2*this.coin+this.width,b+this.coin+this.width),c.bezierCurveTo(a+2*this.coin+this.width,b+2*this.coin+this.width,a+this.width+this.coin,b+2*this.coin+this.width,a+this.width+this.coin,b+2*this.coin+this.width),c.lineTo(a+this.coin,b+2*this.coin+this.width),c.bezierCurveTo(a,b+2*this.coin+this.width,a,b+this.coin+this.width,a,b+this.coin+this.width),c.lineTo(a,b+this.coin),c.bezierCurveTo(a,b,a+this.coin,b,a+this.coin,b),c.stroke(),c.closePath()},this.drawPoint=function(a,b,c,d,e){a.strokeStyle=e||"#000000",a.fillStyle=e||"#000000",a.beginPath(),a.arc(b,c,d/2,0,2*Math.PI),a.fill(),a.closePath()}}function Plateau(a,b,c,d,e){Component.apply(),this.canvas=null,this.data={x:a,y:b,width:c,height:d},this.draw=function(a){this.canvas=a,a.fillStyle=e,a.fillRect(this.data.x,this.data.y,this.data.width,this.data.height)},this.enableCaseDetect=function(a){var b=this;$("canvas").unbind("mousedown").bind("mousedown",function(c){var d=$(this).offset(),e=b._findFiche(c.clientX-d.left,c.clientY-d.top);null!=e&&(b.disableCaseDetect(),a(e))})},this.disableCaseDetect=function(){$("canvas").unbind("mousedown")},this._findFiche=function(a,b){var c=null;return GestionFiche.fiches.forEach(function(d){var e=d.drawing.data;a>=e.x&&a<=e.x+e.width&&b>=e.y&&b<=e.y+e.height&&(c=d)}),c}}function initSquareInstance(){var a={type:"square",standardCase:Case,specialCase:CaseSpeciale,pionJoueur:PionJoueur,des:Des,desRapide:DesRapide,plateau:Plateau,endPlateau:null};DrawerFactory.addInstance(a),DrawerFactory.type=a.type}function getCoords(a,b){return{y:Math.sin(a)*b,x:Math.cos(a)*b}}function convertAxePos(a,b){return(a+2)%4*10+b}function CirclePionJoueur(a,b,c){Component.apply(this),this.pos,this.color=a,this.isSelected=!1,this.largeur=b/2,this.img=null,null!=c&&(this.img=new Image,this.img.src=c,this.largeur+=10),this.init=function(a,b){var c=DrawerFactory.dimensions.plateauSize/2;this.pos=convertAxePos(a,b),this._rayon=c-(70+nbJoueurs%3*25),this._angle=.5+.25*(nbJoueurs%2?1:-1),nbJoueurs++},this.draw=function(a){var b=DrawerFactory.dimensions.plateauSize/2,c=getCoords((this.pos+this._angle)*pasAngle,this._rayon);this.isSelected&&DrawerHelper.drawCircle(a,"#FFFFFF",(this.largeur+2)/2,{x:c.x+b,y:c.y+b},"#FF0000"),null!=this.img?DrawerHelper.drawImage(a,this.img,c.x+b-this.largeur/2,c.y+b-this.largeur/2,this.largeur,this.largeur,0):DrawerHelper.drawCircle(a,this.color,this.largeur,{x:c.x+b,y:c.y+b},"#FF0000")},this.setSelected=function(a){this.isSelected=a},this._moveTo=function(a,b,c){var d=this;this.pos!=a?setTimeout(function(){d.pos=parseFloat((d.pos+c).toFixed(1)),d.pos>=40&&(d.pos=0),d._moveTo(a,b,c)},30):b&&b()},this["goto"]=function(a,b,c){var d=convertAxePos(a,b);this._moveTo(d,c,.1)},this.gotoDirect=function(a,b,c){if(null!=a&&null!=b){var d=convertAxePos(a,b);this._moveTo(d,c,1)}},this.init(2,0)}function CircleCase(a,b,c,d,e,f){Component.apply(this),this.pos=convertAxePos(b,a),this.color=c,this.title=d,this.prix=e,this.img=f,this.nbMaison=0,this.data={},this.imageMaison=new Image,this.imageHotel=new Image,this.joueurPossede=null,this.setJoueur=function(a){this.joueurPossede=a},this.setNbMaison=function(a){this.nbMaison=a},this.init=function(){if(this.imageMaison.src="img/maison.png",this.imageHotel.src="img/hotel.png",null!=this.img){this.img=$.extend(!0,{},DrawerFactory.infos.defaultImage||{},this.img);var a=new Image;a.src=this.img.src,a.height=Math.min(this.img.height,30),a.width=Math.min(this.img.width,40),a.margin=this.img.marginTop||0,a.marginLeft=this.img.marginLeft||0,a.rotate=this.img.rotate||0,this.pos>10&&this.pos<30&&(a.rotate=(a.rotate+180)%360,a.marginLeft=a.marginLeft+.5,a.margin=Math.max(0,a.margin-20)),this.data.image=a}},this.draw=function(a){var b=DrawerFactory.dimensions.plateauSize/2,c=DrawerFactory.dimensions.bordure/2,d=getCoords(this.pos*pasAngle,b),e=getCoords(this.pos*pasAngle,b-DrawerFactory.dimensions.innerPlateauSize),f=DrawerFactory.getInfo("backgroundColor");a.fillStyle="#FFFFFF",a.lineWidth=.5,a.moveTo(b-d.x,b-d.y),a.lineTo(b-e.x,b-e.y),a.stroke();var g=120;if(null!=this.color&&(a.beginPath(),a.fillStyle=this.color,a.moveTo(b,b),a.arc(b,b,b,this.pos*pasAngle,(this.pos+1)*pasAngle),a.fill(),a.closePath(),a.beginPath(),a.fillStyle=f,a.moveTo(b,b),a.arc(b,b,b-c,this.pos*pasAngle,(this.pos+1)*pasAngle),a.fill(),a.closePath()),null!=this.title)if(this.pos>10&&this.pos<30){var h=getCoords((this.pos+.7)*pasAngle,b-c-5);DrawerHelper.writeText(this.title,h.x+b,h.y+b,((this.pos+20)%40+.8)*pasAngle,a,9,g,"left")}else{var h=(a.measureText(this.title).width+30,getCoords((this.pos+.3)*pasAngle,b-g-c-5));DrawerHelper.writeText(this.title,h.x+b,h.y+b,(this.pos+.2)*pasAngle,a,9,g,"right")}if(null!=this.prix)if(this.pos>10&&this.pos<30){var h=getCoords((this.pos+.15)*pasAngle,b-c-5);DrawerHelper.writeText(this.prix,h.x+b,h.y+b,((this.pos+20)%40+.5)*pasAngle,a,9,g,"left")}else{var h=(a.measureText(this.prix).width+30,getCoords((this.pos+.9)*pasAngle,b-g-c-5));DrawerHelper.writeText(this.prix,h.x+b,h.y+b,(this.pos+.7)*pasAngle,a,9,g,"right")}if(null!=this.data.image){var i=getCoords((this.pos+this.data.image.marginLeft)*pasAngle,b-c-5-this.data.image.margin),j=DrawerHelper.fromDegresToRad(this.data.image.rotate)+this.pos*pasAngle+Math.PI/2;DrawerHelper.drawImage(a,this.data.image,b+i.x,b+i.y,this.data.image.width,this.data.image.height,j)}if(this.nbMaison<=4)for(var k=0;k<this.nbMaison;k++){var i=getCoords((this.pos+.25*k)*pasAngle,b-4);DrawerHelper.drawImage(a,this.imageMaison,b+i.x,b+i.y,16,16,this.pos*pasAngle+Math.PI/2)}else{var i=getCoords((this.pos+.4)*pasAngle,b-4);DrawerHelper.drawImage(a,this.imageHotel,b+i.x,b+i.y,16,16,this.pos*pasAngle+Math.PI/2)}null!=this.joueurPossede&&(a.beginPath(),a.strokeStyle=this.joueurPossede.color,a.lineWidth=10,a.arc(b,b,b-DrawerFactory.dimensions.innerPlateauSize+15,this.pos*pasAngle,(this.pos+1)*pasAngle),a.stroke(),a.closePath())},this.init()}function CircleCaseSpeciale(a,b){Component.apply(this),this.pos=convertAxePos(a,0),this.title=b,this.draw=function(a){var b=DrawerFactory.dimensions.plateauSize/2,c=getCoords(this.pos*pasAngle,b),d=getCoords(this.pos*pasAngle,b-DrawerFactory.dimensions.innerPlateauSize),e=DrawerFactory.getInfo("backgroundColor");a.fillStyle=e,a.lineWidth=.5,a.moveTo(b-c.x,b-c.y),a.lineTo(b-d.x,b-d.y),a.stroke(),DrawerHelper.drawArcCircle(a,e,b,{x:b,y:b},this.pos*pasAngle,(this.pos+1)*pasAngle);var f=120;if(null!=this.title)if(this.pos>10&&this.pos<30){var g=getCoords((this.pos+.5)*pasAngle,b-15);DrawerHelper.writeText(this.title,g.x+b,g.y+b,((this.pos+20)%40+.6)*pasAngle,a,9,f,"left")}else{var g=getCoords((this.pos+.6)*pasAngle,b-f-15);DrawerHelper.writeText(this.title,g.x+b,g.y+b,(this.pos+.2)*pasAngle,a,9,f,"right")}}}function CircleDes(a,b,c){Des.call(this,a+195,b+100,c)}function CircleDesRapide(a,b,c){DesRapide.call(this,a+190,b+100,c)}function CirclePlateau(a,b,c,d,e){Component.apply(this),this.data={x:a,y:b,width:c,height:d},this.draw=function(a){DrawerHelper.drawCircle(a,e,this.data.width/2,{x:this.data.width/2,y:this.data.width/2})}}function EndCirclePlateau(){Component.apply(this),this.draw=function(a){var b=DrawerFactory.dimensions.plateauSize/2,c=DrawerFactory.dimensions.innerPlateauSize;DrawerHelper.drawCircle(a,"#000000",b-c,{x:b,y:b}),DrawerHelper.drawCircle(a,"#FFFFFF",b-c-2,{x:b,y:b}),DrawerHelper.drawArcCircle(a,"#FF0000",b-c-2,{x:b,y:b},-Math.PI,0),DrawerHelper.drawCircle(a,"#FFFFFF",b-c-50,{x:b,y:b})}}function initCircleInstance(){var a={type:"circle",standardCase:CircleCase,specialCase:CircleCaseSpeciale,pionJoueur:CirclePionJoueur,des:CircleDes,desRapide:CircleDesRapide,plateau:CirclePlateau,endPlateau:EndCirclePlateau};DrawerFactory.addInstance(a)}function CarteAction(a,b){this.type=a,this.action=function(a){alert("Not implemented")}}function ReparationsCarte(a,b){this.action=function(c){stats=c.getStats();var d=stats.hotel*a+stats.maison*b;c.payer(d,function(){GestionJoueur.change()})}}function BirthdayCarte(a){CarteAction.call(this,"birthday"),this.action=function(b){var c=0;GestionJoueur.joueurs.forEach(function(d){b.equals(d)||d.payerTo(a,b,function(){++c>=GestionJoueur.joueurs.length-1&&GestionJoueur.change()})})}}function GotoCarte(a,b,c){CarteAction.call(this,"goto"),this.action=function(d){c?d.pion.goDirectToCell(a,b,doActions):d.pion["goto"](a,b,doActions)}}function PrisonCarte(){CarteAction.call(this,"prison"),this.joueurPossede=null,this.action=function(a){a.cartesSortiePrison.push(this),this.joueurPossede=a,GestionJoueur.change()},this.isLibre=function(){return null==this.joueurPossede}}function MoveNbCarte(a){CarteAction.call(this,"move"),this.action=function(b){var c=b.pion.deplaceValeursDes(a);b.pion.goDirectToCell(c.axe,c.pos,doActions)}}function PayerCarte(a,b){CarteAction.call(this,"taxe"),this.parc=b,this.montant=a,this.action=function(a){a.payerParcGratuit(this.parc,this.montant,function(){GestionJoueur.change()})}}function GagnerCarte(a){CarteAction.call(this,"prime"),this.montant=a,this.action=function(a){a.gagner(this.montant),GestionJoueur.change()}}function Comportement(a,b,c){this.risque=a,this.probaDes=[0,2.77,5.55,8.33,11.1,13.8,16.7,13.8,11.1,8.33,5.55,2.77],this.name=b,this.id=c,this.getRisqueTotal=function(a,b){var c=this.calculMargeMontant(a,b),d=this.calculRisque(a,a.montant);return c*(d/100+1)},this.getMaxBudgetForStrategie=function(a,b){var c=this.calculRisque(a,a.montant),d=b/(c/100+1),e=this.findCoutFromFixMarge(a,d);return e+=Math.round(.1*e*((1e3*Math.random()%10-5)/10)),Math.min(e,a.montant-5e3)},this.getFactorForProposition=function(){return 1+this.risque},this.getBudget=function(a,b){var c=a.montant;(1==b||this.risque>.6)&&(c=a.getStats().argentDispoHypo);var d=this.plusFortLoyer(a),e=this.calculRisque(a,c);return Math.round((a.montant-d*(1-this.risque*this.risque))*(1-e/100))},this.getNextProprietesVisitees=function(a){var b=[];return GestionJoueur.forEach(function(c){if(!c.equals(a))for(var d=(c.getPosition(),1);12>d;d++){var e=GestionFiche.get(c.pion.deplaceValeursDes(d));e.isTerrain()&&null!=e.joueurPossede&&e.joueurPossede.equals(a)&&(null!=b[e.id]?b[e.id].proba+=this.probaDes[d]/100:b[e.id]={proba:this.probaDes[d]/100,maison:e})}},this),b},this.calculMargeMontant=function(a,b){var c=b/a.montant;return c/this.risque},this.findCoutFromFixMarge=function(a,b){var c=b*this.risque*a.montant;return c},this.calculRisque=function(a,b){for(var c=a.pion.position,d=a.pion.axe,e=0,f=1;12>=f;f++){var g=GestionFiche.nextPos(d,c);d=g.axe,c=g.position;var h=GestionFiche.getById(d+"-"+c);null!=h&&null!=h.getLoyer&&null!=h.joueurPossede&&!h.joueurPossede.equals(a)&&h.getLoyer()>b*this.risque&&(e+=this.probaDes[f-1])}return e},this.plusFortLoyer=function(a){for(var b=2e4,c=GestionFiche.iteratorTerrains();c.hasNext();){var d=c.next();null!=d.getLoyer&&null!=d.joueurPossede&&!a.equals(d.joueurPossede)&&d.getLoyer()>b&&(b=d.getLoyer())}return b},this.getLoyerMoyen=function(a){for(var b=2e4,c=1,d=GestionFiche.iteratorTerrains();d.hasNext();){var e=d.next();null==e.getLoyer||null==e.joueurPossede||a.equals(e.joueurPossede)||(b+=e.getLoyer(),c++)}return{montant:b/c,nb:c}}}function CheapComportement(){Comportement.call(this,.25,"Prudent",0)}function MediumComportement(){Comportement.call(this,.5,"Normal",1)}function HardComportement(){Comportement.call(this,.8,"Fou",2)}function JoueurOrdinateur(a,b,c,d){Joueur.call(this,a,b,c,d),this.canPlay=!1,this.initialName=b,this.strategie=null,this.comportement=null,this.nom=b,this.rejectedPropositions=[],this.init=function(a,b){this.strategie=null==a?GestionStrategie.createRandom():GestionStrategie.create(a),this.comportement=null==b?GestionComportement.createRandom():GestionComportement.create(b)},this.saveMore=function(a){a.comportement=this.comportement.id,a.strategie=this.strategie.id,a.rejectedPropositions=[];for(var b in this.rejectedPropositions){var c=this.rejectedPropositions[b][this.rejectedPropositions[b].length-1].proposition,d=[];for(var e in c.terrains)d.push(c.terrains[e].id);a.rejectedPropositions.push({id:b,proposition:{compensation:c.compensation,terrains:d}})}},this.loadMore=function(a){if(this.init(a.strategie,a.comportement),this.rejectedPropositions=[],null!=a.rejectedPropositions)for(var b in a.rejectedPropositions){var c=a.rejectedPropositions[b].proposition,d=[];if(null!=c.terrains)for(var e in c.terrains)d.push(GestionFiche.getById(c.terrains[e]));this.rejectedPropositions[a.rejectedPropositions[b].id]=[{proposition:{compensation:c.compensation,terrains:d}}]}},this.joue=function(){this.changeStrategie();var a=this;this.echangeProprietes(function(){a.buildConstructions(),a.rebuyHypotheque(),$.trigger("monopoly.debug",{message:"joueur "+a.nom+" joue"}),GestionDes.lancer()})},this.choisiCase=function(a){var b,c,d=GestionFiche.getFreeFiches();d.forEach(function(a){var d=this.strategie.interetGlobal(a,this,!1).interet;0!=d&&(null==b||d>b)&&(b=d,c=a)},this),a(null!=c?c:this.getOutPrison()?GestionFiche.getDepart():GestionFiche.getPrison())},this.choisiDes=function(a,b,c){var d={fiche:this.pion.deplaceValeursDes(a),total:a},e={fiche:this.pion.deplaceValeursDes(b),total:b},f={fiche:this.pion.deplaceValeursDes(a+b),total:a+b},g=-1e3,h=0;[d,e,f].forEach(function(a){var b=this._analyseCase(GestionFiche.get(a.fiche));b>g&&(h=a.total,g=b)},this),c(h)},this._analyseCase=function(a){var b=0;switch(1==a.isTerrain()&&(b=a.statut==ETAT_LIBRE?this.strategie.interetGlobal(a,this,!1).interet:a.getLoyerFor(this)/-1e3),a.type){case"prison":b=this.getOutPrison()?-2:1;break;case"taxe":b=-1*a.montant/1e3;break;case"depart":b=.5}return b},this.actionApresDes=function(a,b){if(null!=a){var c=this;setTimeout(function(){if(null!=a.Acheter&&null!=b){var d=c.strategie.interetGlobal(b).interet,e=c.comportement.getRisqueTotal(c,b.achat);if($.trigger("monopoly.debug",{message:"Strategie : "+d+" "+e}),d>e)return $.trigger("monopoly.debug",{message:"IA Achete"}),void a.Acheter()}for(var f in a)if("Acheter"!=f)return void a[f]()},IA_TIMEOUT)}},this.notifyAcceptProposition=function(a){a&&a()},this.notifyRejectProposition=function(a,b,c){null==this.rejectedPropositions[b.id]&&(this.rejectedPropositions[b.id]=[]),this.rejectedPropositions[b.id].push({nbTours:globalStats.nbTours,proposition:c}),a&&a()},this.echangeProprietes=function(a){if(VARIANTES.echangeApresVente&&GestionFiche.isFreeFiches())return void(a&&a());var b=this.findOthersInterestProprietes();if(0==b.length)return void a();var c=this.findGroupes().length,d=Math.pow(1/(1+c),2),e=[];for(var f in b){var g=b[f],h=g.maison;if(this._canAskTerrain(h)){var i=this._getLastProposition(h),j=h.joueurPossede;if(g.compensation=0,g.deals=h.joueurPossede.findOthersInterestProprietes(this,h),0==g.deals.length){var k=this.findUnterestsProprietes(),l=0;if(null!=k&&null!=k.proprietes&&k.proprietes.length>0)for(var m=0;m<k.proprietes.length&&l/h.achat<.7;m++){var n=k.proprietes[m];this.strategie.interetPropriete(n)||null!=n.groupe&&n.groupe.equals(h.groupe)||(g.deals.push(n),l+=n.achat)}l/h.achat<.8&&(g.compensation=this.evalueCompensation(j,h,d,i)-l)}else{var o=this.chooseMonnaiesEchange(g,g.monnaiesEchange,!0,c>=2,i);null==o||0==o.length?(g.compensation=this.evalueCompensation(j,h,d,i),g.deals=null):g.deals=o}if((null==g.deals||0==g.deals.length)&&0==g.compensation)for(var p=this.findOthersProperties(b),l=0,m=0;m<p.length&&l/h.achat<.7;m++){var n=p[m];this.strategie.interetPropriete(n)||(null==g.deals&&(g.deals=[]),g.deals.push(n),l+=n.achat)}(null!=g.deals&&g.deals.length>0||null!=g.compensation&&g.compensation>0)&&e.push(g)}else $.trigger("monopoly.debug",{message:"Le joueur ne demande pas "+h.nom})}if(0!=e.length)for(var q in e){var f=e[q],r={terrains:null==f.deals?[]:f.deals,compensation:f.compensation};try{return GestionEchange.init(this,f.maison.joueurPossede,f.maison,a),void GestionEchange.propose(r)}catch(s){return console.log(s),void a()}}a()},this._canAskTerrain=function(a){var b=this._getLastProposition(a);if(null!=b){var c=3+Math.round(1e3*Math.random()%3);return b.nbTours+c<globalStats.nbTours}return!0},this._getLastProposition=function(a){return null!=this.rejectedPropositions&&null!=this.rejectedPropositions[a.id]?this.rejectedPropositions[a.id][this.rejectedPropositions[a.id].length-1]:null},this.traiteRequeteEchange=function(a,b,c){if(!(null!=c.terrains&&0!=c.terrains.length||null!=c.compensation&&0!=c.compensation))return GestionEchange.reject(this);var d=this.findOthersInterestProprietes(a),e=this._calculatePropositionValue(b,a,c,d);if(e.critere>=3)return GestionEchange.accept(this);if(e.critere<=0)return GestionEchange.reject(this);var f={terrains:[],compensation:0},g=0;do f=this._calculateContreProposition(a,c,f,e.recommandations,b,d),e=this._calculatePropositionValue(b,a,f,d);while(e.critere<3&&g++<3);return e.critere<3?GestionEchange.reject(this):GestionEchange.contrePropose(f,this)},this._calculateContreProposition=function(a,b,c,d,e,f){if(1==d.TERRAIN_DISPO||1==d.TERRAIN_NON_LISTE){for(var g=0,h=0;h<f.length&&(f[h].maison.groupe.equals(e.groupe)||(c.terrains.push(f[h].maison),g+=f[h].maison.achat,!(g>e.achat)));h++);if(g<e.achat&&1==d.TERRAIN_NON_LISTE)for(var i=!1,h=0;h<b.length&&!i;h++)if(c.terrains.contains(b.terrains[h])||(c.terrains.push(b.terrains[h]),i=!0),!i){a.findUnterestsProprietes();uselessProprietes.proprietes.length>0&&c.terrains.push(uselessProprietes.proprietes[0])}}return 1==d.ARGENT_INSUFFISANT&&(c.compensation+=e.achat/2),c},this._calculatePropositionValue=function(a,b,c,d){for(var e=[],f=!1,g=0;g<d.length;g++)a.groupe.equals(d[g].maison.groupe)&&(f=!0);var h=0,i=0;if(null!=c.terrains&&c.terrains.length>0){var j=!1;for(var k in c.terrains){for(var l=c.terrains[k],m=null,g=0;g<d.length;g++)d[g].maison.equals(l)&&(m=g);null!=m&&(h+=1+(d.length-m)/d.length,j=!0),h+=l.achat/a.achat}j||(e.TERRAIN_NON_LISTE=1)}else if(null!=d&&d.length>0){var n=d.length-(f?1:0);h-=n,e.TERRAIN_DISPO=1}null!=c.compensation?(i=c.compensation/a.achat,this.montant<c.compensation?i+=Math.min(1.5,c.compensation/this.montant-1):e.ARGENT_INSUFFISANT=1):e.NO_ARGENT=1;var o=this.strategie.acceptSwapTerrain(a,b,d,f),p=(h+i)*o;return $.trigger("monopoly.debug",{message:"Criteres : "+p+" "+h+" "+i}),{critere:p,recommandations:e,others:d}},this.traiteContreProposition=function(a,b,c){if(0==a.terrains.length&&0==a.compensation)return GestionEchange.reject(this);var d=this.findOthersInterestProprietes(b),e=null;if(a.terrains.length>0)var f={terrains:[c],compensation:-1*a.compensation},g=a.terrains[0],e=this._calculatePropositionValue(g,b,f,d);else e={critere:2};return e.critere>3?GestionEchange.accept(this):GestionEchange.reject(this)},this.evalueCompensation=function(a,b,c,d){var e=this.comportement.getBudget(this,null!=c&&c>2),f=Math.min(e,b.achat);if(null!=d&&d.proposition.compensation>=f){f=Math.min(this.montant,d.proposition.compensation*this.comportement.getFactorForProposition());var g=(14-Math.log(b.achat))*b.achat;f=Math.min(f,g)}return Math.round(Math.max(0,f))},this.isDangerous=function(a){var b=this.argent/a.maisons[0].prixMaison/a.fiches.length,c=a.maisons[0].loyers[b]/1e5,d=this.findGroupes(),e=!1;for(var f in d)d[f].isVoisin(a)&&(e=!0);var g=(b+c)*(e?2:1);return g>=5},this.chooseMonnaiesEchange=function(a,b,c,d,e){if(null==b||0==b.length)return[];var f=[],g=0;for(var h in b)if(!a.joueurPossede.isDangerous(b[h].groupe)||!c)if(0==g)f.push(b[h]),g+=b[h].achat;else{var i=Math.abs(1-a.achat/g)/Math.abs(1-a.achat(g+b[h].achat));i>1&&(f.push(b[h]),g+=b[h].achat)}return 0!=f.length||d||!c&&null==e?f:this.chooseMonnaiesEchange(a,b,joueur,!1,d)},this.initEnchere=function(a,b){if(!this.equals(b.joueurPossede)){if(null!=this.currentEchange)throw"Impossible de gerer une nouvelle enchere";var c=this.strategie.interetGlobal(b,this,!0),d=this.comportement.getMaxBudgetForStrategie(this,c.interet);this.currentEnchere={transaction:a,terrain:b,budgetMax:d,joueurInteresse:c.joueur}}},this.updateInfoEnchere=function(a,b){},this.updateEnchere=function(a,b,c,d){if(a==this.currentEnchere.transaction&&!this.equals(d)){var e=IA_TIMEOUT*(Math.random()+1),f=this;setTimeout(function(){if(null!=f.currentEnchere)if(c>f.currentEnchere.budgetMax||null!=f.currentEnchere.joueurInteresse&&!f.currentEnchere.joueurInteresse.equals(d))GestionEnchere.exitEnchere(f);else try{GestionEnchere.doEnchere(f,c,b)}catch(a){}},e)}},this.notifyExitEnchere=function(a){},this.endEnchere=function(){this.currentEnchere=null,GestionEnchere.checkEndNotify(this)},this.doBlocage=function(){return GestionJoueur.forEach(function(a){if(!this.equals(this)){var b=a.findGroupes();if(b.size()>0){var c=0,d=0;for(var e in b){var f=b[e];count+=f.proprietes.length;for(var g in f.proprietes){var h=f.proprietes[g];c+=5-h.nbMaison,d+=(5-h.nbMaison)*h.prixMaison}}var i=d/c*3;if(c>3&&i<a.montant)return!0}}},this),!1},this.resolveProblemeArgent=function(a,b){$.trigger("monopoly.debug",{message:"Resoud probleme argent"});var c=this,d=[];for(var e in this.maisons){var f=this.maisons[e];0!=f.statutHypotheque||f.isGroupeeAndBuild()||d.push(f)}var g=function(a){switch(a.type){case"gare":return-1;case"compagnie":return-2;default:return a.isTerrain()?a.groupe.getInfos(c):0}};d.sort(function(a,b){var c=g(a),d=g(b);return c-d}),$.trigger("monopoly.debug",{message:"PHASE 1"});for(var e=0;e<d.length&&this.montant<a;e++){var f=d[e];f.hypotheque()}if(this.montant<a){$.trigger("monopoly.debug",{message:"PHASE 2"});var h=[];try{h=this.getGroupsToConstruct("ASC",.1)}catch(i){}for(var j in h){var k=h[j],l=k.proprietes;l.sort(function(a,b){return a.nbMaison==b.nbMaison?0:a.nbMaison<b.nbMaison?1:-1});for(var m=0,n=0,o=0,p=0;this.montant<a&&n<l.length&&o++<100;){var q=l[m];0==q.nbMaison?n++:q.sellMaison(this)&&(p++,this.gagner(q.prixMaison/2,!0)),m=(m+1)%l.length}if(this.montant>a){p>0&&$.trigger("monopoly.vendMaison",{joueur:this,nbMaison:p}),$.trigger("refreshPlateau");break}}}if(this.montant<a){var d=[];for(var e in this.maisons){var f=this.maisons[e];0==f.statutHypotheque&&d.push(f)}d.sort(function(a,b){return a.achat-b.achat});for(var e=0;e<d.length&&this.montant<a;e++){var f=d[e];f.hypotheque()}this.montant<a&&(this.doDefaite(),b&&b())}return this.setArgent(this.montant-a),this.bloque=!1,b&&b(),!0},this.getNbGroupConstructibles=function(){var a=0,b=[];for(var c in this.maisons){var d=this.maisons[c];d.isGroupee()&&null==b[d.groupe.nom]&&(a++,b[d.groupe.nom]=1)}return a},this.getGroupsToConstruct=function(a,b){var c=this.findGroupes();
if(0==c.size())throw"Impossible";var d=this.comportement.getNextProprietesVisitees(this,b),e=0;for(var f in c){var g=c[f];g.proba=0,g.rentabilite=0,g.lessThree=0,g.interetGlobal=0;for(var h in g.proprietes){var i=g.proprietes[h];e++,null!=d[i.id]&&(g.proba+=3*d[i.id].proba),g.rentabilite+=i.getRentabilite(),g.lessThree+=i.nbMaison<=3?.5:0}}var j=[];for(var f in c){var g=c[f];g.interetGlobal=g.proba+g.rentabilite+(g.lessThree>0?.5:0),j.push(g)}var k="ASC"==a?1:-1,l="ASC"==a?-1:1;return j.sort(function(a,b){return a.interetGlobal==b.interetGlobal?0:a.interetGlobal>b.interetGlobal?k:l}),j},this.hasConstructedGroups=function(a){var b=a||0,c=this.findGroupes();for(var d in c)if(c[d].group.getAverageConstructions()>b)return!0;return!1},this.rebuyHypotheque=function(){var a=this.findMaisonsHypothequees();if(!(null==a||0==a.length&&this.getNbGroupConstructibles()>0&&!this.hasConstructedGroups(3)))for(var b=0;b<a.length&&this.montant>7*a[b].achatHypotheque;)a[b++].leveHypotheque()},this.buildConstructions=function(){var a=this.comportement.getBudget(this);if(!(5e3>a)){var b=[];try{b=this.getGroupsToConstruct("DESC",.1);for(var c in b)b[c].proprietes.sort(function(a,b){return a.nbMaison==b.nbMaison?a.achat==b.achat?0:a.achat<b.achat?1:-1:a.nbMaison>b.nbMaison?1:-1})}catch(d){return}for(var e=!1,f=0,g=0,h=3,i={maison:0,hotel:0,terrains:[]};a>=5e3&&!e;){var j=b[g],k=j.proprietes[f];if(k.nbMaison>=h)if(null==j.treat?j.treat=1:j.treat++,j.treat==j.proprietes.length){if(g++,f=0,g>=b.length)if(3==h){h=5;for(var l in b)b[l].treat=0;g=0}else e=!0}else f=(f+1)%j.proprietes.length;else try{k.buyMaison(this,!0),a-=k.prixMaison,this.payer(k.prixMaison),4==k.nbMaison?i.hotel++:i.maison++,i.terrains[j.proprietes[f].id]=j.proprietes[f],f=(f+1)%j.proprietes.length}catch(d){e=!0}}$.trigger("monopoly.acheteConstructions",{joueur:this,achats:i}),$("body").trigger("refreshPlateau")}},this.changeStrategie=function(){var a=this.strategie.getStatsProprietes();if(a.color.pourcent<40&&this.countInterestProperties()<=2&&!this.isFamilyFree()){$.trigger("monopoly.debug",{message:this.nom+" cherche une nouvelle strategie"});for(var b in GestionStrategie.getAll()){var c=GestionStrategie.create(b);if(c.name!=this.strategie.name){var d=c.getStatsProprietes();if(d.color.pourcent>50)return $.trigger("monopoly.debug",{message:this.nom+" change de stratégie : "+this.strategie.name+" => "+c.name}),void(this.strategie=c)}}}},this.countInterestProperties=function(){for(var a=0,b=0;b<this.maisons.length;b++)this.strategie.groups.contains(this.maisons[b].color)&&a++;return a},this.isFamilyFree=function(){var a=new Array;for(var b in this.maisons){var c=this.maisons[b];if(!a[c.groupe.nom]){a[c.groupe.nom]=!0;var d=!0;for(var e in c.groupe.fiches){var f=c.groupe.fiches[e];f.statut==ETAT_LIBRE||this.equals(f.joueurPossede)||(d=!1)}if(d)return!0}}return!1},this.actionAvantDesPrison=function(a){var b=this;setTimeout(function(){var c=b.getOutPrison();c?null!=a["Utiliser carte"]?a["Utiliser carte"]():a.Payer():a.Attendre()},IA_TIMEOUT)},this.getOutPrison=function(){var a=this.comportement.getLoyerMoyen(this),b=this.getGroupesPossibles();return this.findGroupes().size()>=2?!1:b.length>0&&a.montant<.3*this.montant?!0:a.nb>=4&&a.montant>.15*this.montant?!1:!0},this.gererAchat=function(a){a.click()},this.init()}function Joueur(a,b,c,d){this.numero=a,this.id=a,this.nom=b||"",this.color=c,this.montant=d,this.maisons=new Array,this.enPrison=!1,this.pion=null,this.nbDouble=0,this.bloque=!1,this.defaite=!1,this.tourDefaite=null,this.cartesSortiePrison=[],this.canPlay=!0,this.equals=function(a){return null==a?!1:this.numero==a.numero},this.save=function(){var a={canPlay:this.canPlay,id:this.id,nom:this.nom,color:this.color,montant:this.montant,enPrison:this.enPrison,bloque:this.bloque,defaite:this.defaite,cartesPrison:this.cartesSortiePrison.length,position:this.pion.position,axe:this.pion.axe};return this.saveMore(a),a},this.load=function(a){for(var b in a)null!=this[b]&&(this[b]=a[b]);this.setArgent(this.montant),this.loadMore(a),this.pion.goDirectToCell(a.axe,a.position)},this.saveMore=function(){},this.loadMore=function(a){},this.utiliseCarteSortiePrison=function(){if(0==this.cartesSortiePrison.length)throw"Impossible d'utiliser cette carte";this.cartesSortiePrison[this.cartesSortiePrison.length-1].joueurPossede=null,this.cartesSortiePrison.splice(this.cartesSortiePrison.length-1,1)},this.getStats=function(){var a={prison:this.pion.stats.prison,tour:this.pion.stats.tour,argent:this.montant,argentDispo:this.montant,argentDispoHypo:this.montant,hotel:0,maison:0,strategie:null!=this.strategie?this.strategie.toString():"-",comportement:null!=this.comportement?this.comportement.name:"-"};for(var b in this.maisons){var c=this.maisons[b];a.hotel+=parseInt(1==c.hotel?1:0),a.maison+=parseInt(0==c.hotel?c.nbMaison:0),a.argentDispo+=c.statutHypotheque?0:(c.isTerrain()?c.nbMaison*(c.prixMaison/2):0)+c.achat/2,a.argentDispoHypo+=c.isGroupee()||c.statutHypotheque?0:c.achat/2}return a},this.select=function(){this.div&&this.div.find("div:first").addClass("joueurCourant"),this.enPrison||(this.nbDouble=0),this.joue()},this.getPosition=function(){return{pos:this.pion.position,axe:this.pion.axe}},this.traiteRequeteEchange=function(a,b,c){CommunicationDisplayer.show(a,this,b,c,this)},this.traiteContreProposition=function(a,b,c){CommunicationDisplayer.showContreProposition(a)},this.notifyAcceptProposition=function(a){CommunicationDisplayer.showAccept(a)},this.notifyRejectProposition=function(a){CommunicationDisplayer.showReject(a)},this.initEnchere=function(a,b){GestionEnchereDisplayer.display(b,this)},this.updateInfoEnchere=function(a,b){GestionEnchereDisplayer.updateInfo(a,b,!1)},this.notifyExitEnchere=function(a){GestionEnchereDisplayer.showJoueurExit(a)},this.updateEnchere=function(a,b,c,d,e){e&&GestionEnchereDisplayer.clean(),GestionEnchereDisplayer.updateInfo(c,d,!0,{transaction:a,jeton:b})},this.endEnchere=function(a,b){GestionEnchereDisplayer.displayCloseOption(a,b)},this.getMaisonsGrouped=function(){var a=[];for(var b in this.maisons){var c=this.maisons[b];null==c.groupe?null==a.others?a.others={groupe:"Autres",color:"black",terrains:[c]}:a.others.terrains.push(c):null==a[c.groupe.nom]?a[c.groupe.nom]={groupe:c.groupe.nom,color:c.groupe.color,terrains:[c]}:a[c.groupe.nom].terrains.push(c)}return a},this.getGroupesPossibles=function(){var a=[];for(var b in this.maisons){var c=this.maisons[b];if(!c.isGroupee()){var d={libre:0,adversaire:0};for(var e in c.groupe.fiches){var f=c.groupe.fiches[e];this.equals(f.joueurPossede)||(f.statut==ETAT_LIBRE?d.libre++:d.adversaire++)}1==d.libre&&0==d.adversaire&&a.push(c.color)}}return a},this.cherchePlacement=function(a){for(var b=0;b<this.maisons.length;b++)if(this.maisons[b].color==a.color)return this.maisons[b].input;return null},this.joueDes=function(a){var b=this.pion.deplaceValeursDes(a);this.joueSurCase(b)},this.joueSurCase=function(a){this.pion["goto"](a.axe,a.pos,doActions)},this.joue=function(){},this.choisiDes=function(a,b,c){if(c){var d=[{title:a+" + "+b,fct:function(){c(a+b)}},{title:a,fct:function(){c(a)}},{title:b,fct:function(){c(b)}}],e="Quel(s) dé(s) vous choisissez";InfoMessage.createGeneric(this,"Vous prenez le bus","green",e,d)}},this.choisiCase=function(a){InfoMessage.create(this,"Triple dé","green","Choisissez votre case",function(){InitMonopoly.plateau.enableMouse(a)})},this.actionApresDes=function(a,b){},this.actionAvantDesPrison=function(a){},this.acheteMaison=function(a,b){if(b=b||a.achat,null==a||b>this.montant)throw"Achat de la maison impossible";a.isLibre()&&(this._drawTitrePropriete(a),a.vendu(this),this.payer(b))},this.refuseMaison=function(a,b){$.trigger("monopoly.visiteMaison",{joueur:GestionJoueur.getJoueurCourant(),maison:a}),VARIANTES.enchereAchat?this._enchereByBanque(a,b):b&&b()},this._enchereByBanque=function(a,b){GestionEnchere.init(a,a.achat,!0,b)},this._drawTitrePropriete=function(a){var b=this.cherchePlacement(a),c='<input type="button" id="idInputFiche'+a.id+'" class="ui-corner-all fiche color_'+a.color.substring(1)+'" value="'+a.nom+'" id="fiche_'+a.id+'"/>';null!=b?b.after(c):this.div.append(c),a.input=$('input[id="idInputFiche'+a.id+'"]'),1==a.statutHypotheque&&a.input.addClass("hypotheque"),a.input.click(function(){FicheDisplayer.openDetail(GestionFiche.getById(a.id),$(this))})},this.getSwapProperiete=function(a){a.input.remove(),a.input=null,this._drawTitrePropriete(a),a.joueurPossede&&a.joueurPossede.removeMaison(a),a.setJoueurPossede(this)},this.removeMaison=function(a){for(var b=0;b<this.maisons.length;b++)if(this.maisons[b].equals(a))return void this.maisons.splice(b,1)},this.goPrison=function(){this.enPrison=!0,this.div.addClass("jail"),this.nbDouble=0,this.pion.goPrison(function(){GestionJoueur.change()}),$.trigger("monopoly.goPrison",{joueur:this})},this.exitPrison=function(){this.enPrison=!1,this.nbDouble=0,this.div.removeClass("jail"),$.trigger("monopoly.exitPrison",{joueur:this})},this.isEnPrison=function(){return this.enPrison},this.setDiv=function(a){this.div=a,this.setArgent(this.montant)},this.setArgent=function(a){NaN==a&&console.log("error montant"),this.montant=a,$(".compte-banque",this.div).text(a)},this.payerParcGratuit=function(a,b,c){try{this.payer(b,function(){VARIANTES.parcGratuit&&a.payer(b),c&&c()})}catch(d){c&&c()}},this.setPion=function(a,b){this.pion=new Pion(a,this,b)},this.isSolvable=function(a){return this.getStats().argentDispo>=a},this.payer=function(a,b){if(this.getStats().argentDispo<a)throw this.doDefaite(),"Le joueur "+this.nom+" est insolvable";if(a>this.montant){this.bloque=!0;this.resolveProblemeArgent(a,b)}else this.setArgent(this.montant-a),b&&b()},this.payerTo=function(a,b,c){argentDispo=this.getStats().argentDispo;try{this.payer(a,function(){return b.gagner(a),null!=c?c():void GestionJoueur.change()})}catch(d){null!=b&&b.gagner(argentDispo),GestionJoueur.change()}},this.gagner=function(a){this.setArgent(this.montant+a)},this.doDefaite=function(){for(var a in this.maisons)this.maisons[a].libere();$.trigger("refreshPlateau"),this.maisons=[],$("input",this.div).remove(),this.pion.remove(),$(".joueurCourant",this.div).removeAttr("style").addClass("defaite"),this.setArgent(0),this.defaite=!0,this.tourDefaite=globalStats.nbTours,$.trigger("monopoly.defaite",{joueur:this})},this.resolveProblemeArgent=function(a,b){this.montant-=a;var c=this;InfoMessage.create(this,"Attention","red","Vous n'avez pas les fonds necessaires, il faut trouver de l'argent",function(){var a=function(a){c.montant<0?(InfoMessage.create(c,"Attention","red","Impossible, il faut trouver les fonds avant de fermer"),a.preventDefault()):(c.bloque=!1,c.setArgent(c.montant),b&&b())};GestionTerrains.open(!0,a)});return!0},this.getFichePosition=function(){return GestionFiche.getById(this.pion.axe+"-"+this.pion.position)},this.findMaisonsHypothecables=function(){for(var a=[],b=0;b<this.maisons.length;b++){var c=this.maisons[b];if(0==c.statutHypotheque&&0==c.nbMaison){for(var d=!0,e=0;e<this.maisons.length;e++)this.maisons[e].color==c.color&&this.maisons[e].nbMaison>0&&(d=!1);d&&a.push(c)}}return a},this.findMaisonsHypothequees=function(){for(var a=[],b=0;b<this.maisons.length;b++)1==this.maisons[b].statutHypotheque&&a.push(this.maisons[b]);return a},this.findGroupes=function(){for(var a=new Array,b=new Array,c=[],d=0;d<this.maisons.length;d++){var e=this.maisons[d];if(1==e.isTerrain()&&null!=e.groupe)if(1==a[e.color]);else if(null==b[e.color]){var f=e.groupe.getInfos(this);0==f.free&&0==f.adversaire&&0==f.hypotheque?(a[e.color]=!0,c[e.color]={color:e.color,group:e.groupe,proprietes:e.groupe.fiches}):b[e.color]=!0}}return c},this.findOthersInterestProprietes=function(a,b){var c=[],d=[];for(var e in this.maisons){var f=this.maisons[e];if(null==d[f.groupe.color]){var g=f.groupe.getInfos(this);if(0==g.free&&(1==g.adversaire||g.nbAdversaires>1))for(var h in g.maisons)null!=a&&!a.equals(g.maisons[h].joueurPossede)||null!=b&&b.groupe.equals(g.maisons[h].groupe)||(b&&f.groupe.color==b.groupe.color?console.log("Meme groupe, rejet",f.groupe.color,f.groupe.color==b.groupe.color):c.push({maison:g.maisons[h],nb:g.maisons.length}));d[f.groupe.color]=!0}}var i=this.findGroupes(),j=this;return c.sort(function(a,b){var c=a.nb/b.nb,d=a.maison.getRentabiliteBrute()/b.maison.getRentabiliteBrute(),e=1,f=1;for(var g in i)i[g].group.isVoisin(a.maison.groupe)&&e++,i[g].group.isVoisin(b.maison.groupe)&&f++;var h=e/f,k=1;if(null!=j.strategie){var l=j.strategie.interetPropriete(a.maison),m=j.strategie.interetPropriete(b.maison);l!=m&&(k=l?.5:2)}var n=1;a.maison.isTerrain()!=b.maison.isTerrain()&&(n=a.maison.isTerrain()?.5:4);var o=c*d*h*k*n;return o-1}),c},this.findUnterestsProprietes=function(){var a=[],b=[];for(var c in this.maisons){var d=this.maisons[c];d.isTerrain()||(a.push(d),null==b[d.groupe.nom]?b[d.groupe.nom]=1:b[d.groupe.nom]++)}return{proprietes:a,nbByGroups:b}},this.findOthersProperties=function(a){var b=[],c=[];for(var d in a)c[a[d].id]=1;for(var e in this.maisons){var f=this.maisons[e];f.isTerrain()&&!f.isGroupee()&&null==c[f.id]&&b.push(f)}return b},this.findMaisonsConstructibles=function(){for(var a=new Array,b=new Array,c=new Array,d=0;d<this.maisons.length;d++){var e=this.maisons[d];if(1==e.isTerrain())if(1==b[e.color])a.push(e);else if(null==c[e.color]){var f=!0;for(var g in e.groupe.fiches){var h=e.groupe.fiches[g];1!=h.isTerrain()||null!=h.joueurPossede&&h.joueurPossede.equals(this)&&1!=h.statutHypotheque||(f=!1)}f?(b[e.color]=!0,a[a.length]=e):c[e.color]=!0}}return a}}function Pion(a,b,c){this.axe=2,this.position=0,this.joueur=b,this.stats={tour:0,prison:0,positions:[]},this.pion=DrawerFactory.getPionJoueur(a,DrawerFactory.dimensions.largeurPion,c),Drawer.addRealTime(this.pion),this.remove=function(){Drawer.removeComponent(this.pion)},this.goPrison=function(a){this.stats.prison++,this.goDirectToCell(3,0,a)},this.deplaceValeursDes=function(a){for(var b=this.position+a,c=this.axe;0>b;)b+=10,c=(c+3)%4;for(;b>=10;)b-=10,c=(c+1)%4;return{pos:b,axe:c}},this["goto"]=function(a,b,c){var d=a+"-"+b;null==this.stats.positions[d]?this.stats.positions[d]=1:this.stats.positions[d]++,$.trigger("monopoly.debug",{message:GestionJoueur.getJoueurCourant().nom+" est en "+this.axe+"-"+this.position+" et va en "+d});var e=10*this.axe+this.position,f=10*a+b;(20>e&&f>20||e>f&&(20>e||f>20))&&this.treatCaseDepart(),this.axe=a,this.position=b,this.pion["goto"](a,b,c,!0)},this.treatCaseDepart=function(){this.stats.tour++,this.joueur.gagner(InitMonopoly.plateau.infos.montantDepart||2e4)},this.goDirectToCell=function(a,b,c){this.axe=a,this.position=b,this.pion.gotoDirect(a,b,c)}}function Strategie(a,b,c,d,e){this.groups=a,this.agressif=b,this.interetGare=null==e?Math.round(1e3*Math.random())%3==0?!0:!1:e,this.name=c,this.id=d,this.groups.contains=function(a){for(var b in this)if(this[b]==a)return!0;return!1},this.getStatsProprietes=function(){for(var a={color:{total:0,libre:0,achete:0,pourcent:0},all:{total:0,libre:0,achete:0,pourcent:0}},b=GestionFiche.iteratorTerrains();b.hasNext();){var c=b.next();null!=c.statut&&(a.all.total++,c.statut==ETAT_LIBRE?a.all.libre++:a.all.achete++,this.groups.contains(c.color)&&(a.color.total++,c.statut==ETAT_LIBRE?a.color.libre++:a.color.achete++))}return a.color.pourcent=a.color.libre/a.color.total*100,a.all.pourcent=a.all.libre/a.all.total*100,a},this.interetGlobal=function(a,b,c){var d=this.interetPropriete(a),e=this.statutGroup(a,b,c),f=e.statut,g={interet:1};return 0==d&&0==f&&(g={interet:.2}),0==d&&2==f&&(g={interet:this.agressif,joueur:e.joueur}),1==d&&3==f&&(g={interet:4}),0==d&&3==f&&(g={interet:2}),1==d&&5==f&&(g={interet:1.5}),c&&(g={interet:this.interetProprieteInStrategie(a)}),a.isTerrain()||(g.interet/=2),g},this.interetProprieteInStrategie=function(a){var b=this.getStatsProprietes();return.5+parseFloat(Math.log(Math.min(100-b.color.pourcent,32.5)/50+1).toFixed(2))},this.interetPropriete=function(a){for(var b in this.groups)if(this.groups[b]==a.color||"gare"==a.type&&this.interetGare)return!0;return!1},this.statutGroup=function(a,b,c){var d=0,e=0,f=null,g=0,h=0;for(var i in a.groupe.fiches){var j=a.groupe.fiches[i];d++,j.statut==ETAT_LIBRE?e++:(j.joueurPossede.equals(b)?h++:(null==f||j.joueurPossede.equals(f))&&g++,f=j.joueurPossede)}return e==d?{statut:0}:1==e&&g==d-1?{statut:2,joueur:f}:1!=e&&!c||h!=d-1?h>0&&e>0?{statut:5}:e>0?{statut:1}:{statut:4}:{statut:3}},this.acceptSwapTerrain=function(a,b,c,d){var e=GestionJoueur.getNb()>2;if(1==d&&1==c.length||a.isGroupee())return 0;for(var f in c)c[f].maison.joueurPossede.equals(a.joueurPossede)||(e=!1);var g=b.findGroupes().size();return 0==g&&0==c.length&&e?2==this.agressif?.5:1:g>=2&&e?this.agressif>0?0:.5:0==g?1.5:g>=2&&this.agressif>0?.5:1},this.toString=function(){return this.name+(this.interetGare?' <img src="img/little_train.png" style="width:20px;height:16px;"/>':"")}}function CheapStrategie(){Strategie.call(this,["#812B5C","#119AEB","#73316F","#D16E2D"],0,"Econome",0)}function MediumStrategie(){Strategie.call(this,["#73316F","#D16E2D","#D32C19","#E6E018"],1,"Normal",1)}function HardStrategie(){Strategie.call(this,["#D32C19","#E6E018","#11862E","#132450"],2,"Luxe",2)}function SmartStrategie(){Strategie.call(this,["#D16E2D","#D32C19","#E6E018"],2,"Futé",3,!0)}function CrazyStrategie(){Strategie.call(this,["#812B5C","#119AEB","#73316F","#D16E2D","#D32C19","#E6E018","#11862E","#132450"],4,"Dingue",3,!0)}function PlateauCase(a,b,c){this.axe=a,this.pos=b,this.id=a+"-"+b,this.type=c,this.isTerrain=function(){return"terrain"==this.type},this.isPropriete=function(){return"terrain"==this.type||"gare"==this.type||"compagnie"==this.type}}function ParcGratuit(a,b){PlateauCase.call(this,a,b,"parc"),this.montant=null,this._titre="Parc Gratuit",this.drawing=DrawerFactory.getCaseSpeciale(0,this._titre),Drawer.add(this.drawing),this.setMontant=function(a){this.montant=a,this.drawing.titre=this._titre+(this.montant>0?"\n"+CURRENCY+" "+this.montant:""),$.trigger("refreshPlateau"),$("#idMontantParc > span").text(this.montant)},this.payer=function(a){this.setMontant(this.montant+a)},this.action=function(){var a=this;return InfoMessage.create(GestionJoueur.getJoueurCourant(),"Parc gratuit","lightblue","Vous gagnez "+this.montant+" "+CURRENCY,function(b){b.joueur.gagner(b.montant),a.setMontant(0),GestionJoueur.change()},{joueur:GestionJoueur.getJoueurCourant(),montant:this.montant})},this.setMontant(0)}function CaseActionSpeciale(a,b,c,d,e){this.titre=a,this.actionSpeciale=b,PlateauCase.call(this,c,d,e),this.drawing=DrawerFactory.getCaseSpeciale(c,a),Drawer.add(this.drawing),this.action=function(){$.trigger("monopoly.visiteTerrain",{joueur:GestionJoueur.getJoueurCourant(),maison:{color:"black",nom:this.titre}}),this.actionSpeciale()}}function SimpleCaseSpeciale(a,b,c,d,e,f){PlateauCase.call(this,c,d,e),this.montant=b,this.drawing=DrawerFactory.getCase(d,c,null,a,CURRENCY+" "+b,f),Drawer.add(this.drawing),this.action=function(){return InfoMessage.create(GestionJoueur.getJoueurCourant(),a,"lightblue","Vous devez payer la somme de "+b+" "+CURRENCY,function(a){a.joueur.payerParcGratuit(InitMonopoly.plateau.parcGratuit,a.montant,function(){GestionJoueur.change()})},{joueur:GestionJoueur.getJoueurCourant(),montant:b})}}function CaseChance(a,b,c,d){PlateauCase.call(this,a,b,"carte"),this.nom="carte chance",this.cartes=d,this.drawing=DrawerFactory.getCase(b,a,null,InitMonopoly.plateau.titles.chance,null,c),Drawer.add(this.drawing),this.action=function(){if(0==this.cartes.length)throw"Aucune carte chance";var a=Math.round(1e3*Math.random())%this.cartes.length,b=this.cartes[a];return"prison"!=b.carte.type||b.carte.isLibre()||(b=this.cartes[a+1%this.cartes.length]),b.action()}}function CaseCaisseDeCommunaute(a,b,c,d){PlateauCase.call(this,a,b,"carte"),this.nom="carte caisse de communauté",this.cartes=d,this.drawing=DrawerFactory.getCase(b,a,null,InitMonopoly.plateau.titles.communaute,null,c),Drawer.add(this.drawing),this.action=function(){if(0==this.cartes.length)throw"Aucune carte caisse de communaute";var a=Math.round(1e3*Math.random())%this.cartes.length,b=this.cartes[a];return"prison"!=b.carte.type||b.carte.isLibre()||(b=this.cartes[(a+1)%this.cartes.length]),b.action()}}function Groupe(a,b){this.nom=a,this.color=b,this.fiches=[],this.groupePrecedent=null,this.groupeSuivant=null,this.equals=function(a){return null==a?!1:this.color==a.color},this.getVoisins=function(){return[this.groupePrecedent,this.groupeSuivant]},this.isVoisin=function(a){return null!=this.groupePrecedent&&this.groupePrecedent.equals(a)||null!=this.groupeSuivant&&this.groupeSuivant.equals(a)},this.equals=function(a){return this.color==a.color},this.add=function(a){return this.fiches.push(a),a.groupe=this,this},this.isGroupee=function(){if(null==this.fiches||0==this.fiches.length)return!1;for(var a=this.fiches[0].joueurPossede,b=0;b<this.fiches.length;b++){if(null==this.fiches[b].joueurPossede||!this.fiches[b].joueurPossede.equals(a))return!1;a=this.fiches[b].joueurPossede}return!0},this.isBuild=function(){if(null==this.fiches||0==fiches.length)return!1;for(var a=0;a<this.fiches.length;a++)if(this.fiches[a].nbMaison>0)return!0;return!1},this.getAverageConstructions=function(){for(var a=0,b=0;b<this.fiches.length;b++)a+=this.fiches[b].nbMaison;return a/this.fiches.length},this.getConstructions=function(){for(var a={maison:0,hotel:0},b=0;b<this.fiches.length;b++)this.fiches[b].hotel?a.hotel++:a.maison+=this.fiches[b].nbMaison;return a},this.getInfos=function(a){for(var b={free:0,joueur:0,adversaire:0,nbAdversaires:0,maisons:[],hypotheque:0},c=[],d=0;d<this.fiches.length;d++){var e=this.fiches[d];e.statut==ETAT_LIBRE?b.free++:(e.statutHypotheque&&b.hypotheque++,a.equals(e.joueurPossede)?b.joueur++:(b.adversaire++,b.maisons.push(e),c[e.joueurPossede.id]=1))}return b.nbAdversaires=c.size(),b},this.getNb=function(){return null==this.fiches?0:this.fiches.length}}function Fiche(a,b,c,d,e,f,g,h){PlateauCase.call(this,a,b,"terrain"),this.nom=d,this.groupe=null,this.color=c[0],this.secondColor=2==c.length?c[1]:c[0],this.achat=e,this.montantHypotheque=e/2,this.achatHypotheque=1.1*this.montantHypotheque,this.loyer=f,this.loyerHotel=null!=f&&6==f.length?f[5]:0,this.prixMaison=g,this.statut=ETAT_LIBRE,this.joueurPossede=null,this.statutHypotheque=!1,this.fiche=$("#fiche"),this.nbMaison=0,this.hotel=!1,this.maisons=new Array;var i=this;this.input=null,this.drawing=DrawerFactory.getCase(b,a,this.color,this.nom,CURRENCY+" "+e,h),Drawer.add(this.drawing),this.equals=function(a){return null==a?!1:this.id==a.id},this.save=function(){return{id:this.id,statut:this.statut,joueur:null!=this.joueurPossede?this.joueurPossede.id:null,nb:this.nbMaison,hypotheque:this.statutHypotheque}},this.load=function(a){var b=null!=a.joueur?GestionJoueur.getById(a.joueur):null;null!=b&&(this.setJoueurPossede(b,!0),b._drawTitrePropriete(this)),this.id=a.id,this.statut=a.statut,this.setNbMaison(a.nb,!0),a.nb>0&&(5==a.nb?GestionConstructions.buyHotels(1):GestionConstructions.buyHouses(a.nb)),this.statutHypotheque=a.hypotheque,1==this.statutHypotheque&&this.input.addClass("hypotheque")},this.setJoueurPossede=function(a,b){this.joueurPossede=a,this.drawing.setJoueur(a),this.joueurPossede.maisons.push(this),b||$.trigger("refreshPlateau")},this.vendu=function(a){this.statut=ETAT_ACHETE,this.setJoueurPossede(a),$.trigger("monopoly.acheteMaison",{joueur:a,maison:this})},this.libere=function(){this.statut=ETAT_LIBRE,this.statutHypotheque=!1,this.joueurPossede=null,this.drawing.setJoueur(null),this.setNbMaison(0,!0),this.hotel=!1,$.trigger("refreshPlateau")},this.getRentabilite=function(){var a=10;if(!this.isTerrain()||this.nbMaison>=3)return 0;for(var b=this.groupe.fiches,c=0,d=0;d<b.length;d++)c+=b[d].nbMaison;return this.loyer[3]/Math.max((3*b.length-c)*this.prixMaison,1)/a},this.getRentabiliteBrute=function(){return this.isTerrain()?this.loyer[3]/(this.achat+3*this.prixMaison):0},this.hypotheque=function(){if(null==this.input||this.statut!=ETAT_ACHETE||this.nbMaison>0)throw"Impossible d'hypothequer ce terrain";this.statutHypotheque=!0,this.input.addClass("hypotheque"),this.joueurPossede.gagner(this.montantHypotheque),$.trigger("monopoly.hypothequeMaison",{joueur:this.joueurPossede,maison:this})},this.leveHypotheque=function(){if(null!=this.input&&this.statut==ETAT_ACHETE&&0!=this.statutHypotheque){var a=Math.round(this.achatHypotheque);if(this.joueurPossede.montant<a)throw"Impossible de lever l'hypotheque";this.statutHypotheque=!1,this.joueurPossede.payer(a),this.input.removeClass("hypotheque"),$.trigger("monopoly.leveHypothequeMaison",{joueur:this.joueurPossede,maison:this})}},this.isLibre=function(){return this.statut==ETAT_LIBRE},this.isConstructed=function(){return this.nbMaison>0},this.setNbMaison=function(a,b){this.nbMaison=a,this.drawing.setNbMaison(a),5==this.nbMaison?this.hotel=!0:this.hotel=!1,b||$.trigger("refreshPlateau")},this.action=function(){return this.fiche.dialog("option","title",d),null!=this.joueurPossede&&this.joueurPossede.equals(GestionJoueur.getJoueurCourant())?this.chezSoi():null!=this.joueurPossede&&0==this.statutHypotheque?this.payerLoyer():1==this.statutHypotheque?void GestionJoueur.change():this.openFiche()},this.chezSoi=function(){return $.trigger("monopoly.chezsoi",{joueur:this.joueurPossede,maison:this}),InfoMessage.create(GestionJoueur.getJoueurCourant(),"Vous etes "+this.nom,this.color,"Vous etes chez vous",function(){GestionJoueur.change()})},this.sellMaison=function(a,b){if(null==a||!this.joueurPossede.equals(a)||this.nbMaison<=0)return!1;if(5==this.nbMaison){if(!(GestionConstructions.getRestHouse()>=4))return;GestionConstructions.buyHouses(4),GestionConstructions.sellHotel(),this.hotel=!1}else GestionConstructions.sellHouse();return this.setNbMaison(this.nbMaison-1,b),!0},this.buyMaison=function(a,b){if(null!=a&&this.joueurPossede.equals(a)&&!(this.nbMaison>=5)){if(4==this.nbMaison&&!GestionConstructions.isFreeHotel()||this.nbMaison<4&&!GestionConstructions.isFreeHouse())throw"Pas de construction disponible";this.setNbMaison(this.nbMaison+1,b),5==this.nbMaison?(this.hotel=!0,GestionConstructions.buyHotel()):GestionConstructions.buyHouse()}},this.getLoyerFor=function(a){return a.equals(this.joueurPossede)?0:this.getLoyer()},this.getLoyer=function(){return this.statutHypotheque?0:1==this.hotel?this.loyerHotel:0==this.nbMaison&&this.isGroupee()?2*this.loyer[0]:this.loyer[this.nbMaison]},this.payerLoyer=function(){return InfoMessage.create(GestionJoueur.getJoueurCourant(),"Vous etes "+this.nom,this.color,"Vous etes chez "+this.joueurPossede.nom+" vous devez payez la somme de "+this.getLoyer()+" "+CURRENCY,function(a){$.trigger("monopoly.payerLoyer",{joueur:a.joueurPaye,maison:a.maison}),a.joueurPaye.payerTo(a.loyer,a.joueurLoyer)},{loyer:this.getLoyer(),joueurPaye:GestionJoueur.getJoueurCourant(),joueurLoyer:this.joueurPossede,maison:this})},this.noArgent=function(){},this.openFiche=function(){var a=this.getButtons();return this.fiche.dialog("option","buttons",a),FicheDisplayer.loadFiche(this),GestionJoueur.getJoueurCourant().canPlay&&this.fiche.dialog("open"),a},this.getButtons=function(){return this.statut==ETAT_LIBRE?GestionJoueur.getJoueurCourant().montant<this.achat?{"Pas assez d'argent":function(){GestionJoueur.getJoueurCourant().refuseMaison(i,function(){FicheDisplayer.closeFiche()})}}:{Acheter:function(){var a=GestionJoueur.getJoueurCourant();a.pion.axe+"-"+a.pion.position;a.acheteMaison(i),FicheDisplayer.closeFiche()},Refuser:function(){GestionJoueur.getJoueurCourant().refuseMaison(i,function(){FicheDisplayer.closeFiche()})}}:{Fermer:function(){FicheDisplayer.closeFiche()}}},this.isGroupee=function(){return null==this.groupe?!1:this.groupe.isGroupee()},this.isGroupeeAndBuild=function(){if(null==this.joueurPossede)return!1;for(var a=this.joueurPossede.findMaisonsConstructibles(),b=0;b<a.length;b++)if(a[b].color==this.color&&a[b].nbMaison>0)return!0;return!1}}function FicheGare(a,b,c,d,e,f,g){Fiche.call(this,a,b,c,d,e,f,null,g),this.type="gare",this.getLoyer=function(){if(null!=this.joueurPossede){for(var a=-1,b=0;b<this.joueurPossede.maisons.length;b++)"gare"==this.joueurPossede.maisons[b].type&&a++;return this.loyer[a]}return 0}}function FicheCompagnie(a,b,c,d,e,f,g){Fiche.call(this,a,b,c,d,e,f,null,g),this.fiche=$("#ficheCompagnie"),this.type="compagnie",this.getLoyer=function(){var a=GestionDes.total();if(null!=this.joueurPossede){for(var b=-1,c=0;c<this.joueurPossede.maisons.length;c++)"compagnie"==this.joueurPossede.maisons[c].type&&b++;return this.loyer[b]*a}return this.loyer[0]*a}}function CarteAction(a,b,c,d,e){this.carte=b,this.action=function(){return InfoMessage.create(GestionJoueur.getJoueurCourant(),c,d,a,function(c){$.trigger("monopoly."+e+".message",{joueur:GestionJoueur.getJoueurCourant(),message:a}),b.action(GestionJoueur.getJoueurCourant())},{})}}function CarteChance(a,b){CarteAction.call(this,a,b,InitMonopoly.plateau.titles.chance,"lightblue","chance")}function CarteCaisseDeCommunaute(a,b){CarteAction.call(this,a,b,InitMonopoly.plateau.titles.communaute,"pink","caissecommunaute")}function doActions(){var a=GestionFiche.getById(GestionJoueur.getJoueurCourant().pion.axe+"-"+GestionJoueur.getJoueurCourant().pion.position);if(null==a)return void GestionJoueur.change();var b=a.action();GestionJoueur.getJoueurCourant().actionApresDes(b,a)}function GestionDesImpl(){this.nbAnimation=8,this.cube={des1:null,des2:null},this.des1=0,this.des2=0,this.nbDouble=0,this.rollColor="#000000",this.init=function(a){this._init(a)},this._init=function(a){this.cube.des1=DrawerFactory.getDes(150,200,50),this.cube.des2=DrawerFactory.getDes(210,200,50),Drawer.addRealTime(this.cube.des1),Drawer.addRealTime(this.cube.des2),this.rollColor=a},this.resetDouble=function(){this.nbDouble=0},this._rand=function(){return Math.round(1e3*Math.random())%6+1},this.isSpecificAction=function(){return!1},this.doSpecificAction=function(){},this.before=function(a){if(GestionJoueur.getJoueurCourant().enPrison){var b=InfoMessage.createPrison(GestionJoueur.getJoueurCourant(),GestionJoueur.getJoueurCourant().nbDouble,function(){a()});GestionJoueur.getJoueurCourant().actionAvantDesPrison(b)}else a()},this.treatPrison=function(a){var b=GestionJoueur.getJoueurCourant(),c=this;if(this.isDouble()){MessageDisplayer.write(GestionJoueur.getJoueurCourant(),a+" et sort de prison");var d=InfoMessage.create(GestionJoueur.getJoueurCourant(),"Libere de prison","lightblue","Vous etes liberes de prison grace a un double",function(){GestionJoueur.getJoueurCourant().exitPrison(),c.endLancer()},{});return void GestionJoueur.getJoueurCourant().actionApresDes(d,null)}if(2==b.nbDouble){MessageDisplayer.write(b,a+" et sort de prison en payant "+CURRENCY+" 5.000");var d=InfoMessage.create(b,"Libere de prison","lightblue","Vous etes liberes de prison, mais vous devez payer "+CURRENCY+" 5.000 !",function(){b.payerParcGratuit(InitMonopoly.plateau.parcGratuit,5e3,function(){b.exitPrison(),c.endLancer()})},{});return void b.actionApresDes(d,null)}MessageDisplayer.write(b,a+" et reste en prison"),b.nbDouble++;var d=InfoMessage.create(b,"Tour "+b.nbDouble,"red","Vous restez en prison, vous n'avez pas fait de double.",function(){GestionJoueur.change()},{});return void b.actionApresDes(d,null)},this.after=function(){var a="lance les dés et fait "+this.total()+" ("+this.combinaisonDes()+") ";if(1==GestionJoueur.getJoueurCourant().enPrison)return void this.treatPrison(a);if(this.isDouble()){if(!this.treatDouble(a))return}else MessageDisplayer.write(GestionJoueur.getJoueurCourant(),a);this.endLancer()},this.combinaisonDes=function(){return this.des1+" et "+this.des2},this.treatDouble=function(a){return this._doTreatDouble(a)},this._doTreatDouble=function(a){var b=this;if(this.nbDouble>=2){var c=InfoMessage.create(GestionJoueur.getJoueurCourant(),"Allez en prison","red","Vous avez fait 3 doubles, vous allez en prison",function(){MessageDisplayer.write(GestionJoueur.getJoueurCourant(),a+", a fait 3 doubles et va en prison"),$("#informationsCentrale").text("3eme double, allez en PRISON"),
b.des2++,GestionJoueur.getJoueurCourant().goPrison()},{});return GestionJoueur.getJoueurCourant().actionApresDes(c,null),!1}return this.nbDouble++,MessageDisplayer.write(GestionJoueur.getJoueurCourant(),a+" et rejoue"),!0},this.endLancer=function(){GestionJoueur.getJoueurCourant().joueDes(this.total()),this.showReload()},this.showReload=function(){this.isDouble()?$("#idReloadDice").show():$("#idReloadDice").hide()},this.continuePlayer=function(){return this.isDouble()},this.isDouble=function(){return this.des1==this.des2},this.lancer=function(){var a=this;this.before(function(){a._randDes(),$("#idReloadDice").hide(),a._anime()})},this._randDes=function(){this.des1=this._rand(),this.des2=this._rand()},this._anime=function(){$(".action-joueur").attr("disabled","disabled").addClass("disabled");var a=this.nbAnimation,b=this,c=setInterval(function(){return a--<0?(clearInterval(c),b._drawCubes(b.des1,b.des2,b.desRapide),void b.after()):void b._drawCubes(b._rand(),b._rand(),b._rand()%3+1,b.rollColor)},100)},this._drawCubes=function(a,b,c,d){this.cube.des1.setValue(a,d),this.cube.des2.setValue(b,d)},this.total=function(){return this.des1+this.des2}}function GestionDesRapideImpl(){GestionDesImpl.call(this),this.cube.desRapide=null,this.desRapide,this.init=function(a){this._init(a),this.cube.desRapide=DrawerFactory.getDesRapide(112,210,35),Drawer.addRealTime(this.cube.desRapide)},this.isSpecificAction=function(){return!GestionJoueur.joueurCourant.enPrison&&this._isMonopolyMan()},this.doSpecificAction=function(){this.desRapide=0;var a=GestionJoueur.getJoueurCourant().getPosition(),b=GestionFiche.isFreeFiches()?GestionFiche.getNextFreeTerrain(a):GestionFiche.getNextTerrain(a);$.trigger("monopoly.derapide.mrmonopoly",{joueur:GestionJoueur.getJoueurCourant(),maison:b}),GestionJoueur.getJoueurCourant().joueSurCase(b)},this._randDes=function(){this.des1=this._rand(),this.des2=this._rand(),GestionJoueur.getJoueurCourant().enPrison?this.desRapide=0:this.desRapide=this._rand()},this.total=function(){var a=this.des1+this.des2;return!this.isDouble()&&this._isValue()&&(a+=this.desRapide),a},this.continuePlayer=function(){return this.isDouble()&&!this.isTriple()},this.isTriple=function(){return this.des1==this.des2&&this.des2==this.desRapide&&this.des1<=3},this.combinaisonDes=function(){if(this.isTriple())return"triple "+this.des1;var a=this.des1+", "+this.des2;return this.isDouble()?a:a+" et "+(this._isBus()?" Bus":this._isMonopolyMan()?"Mr Monopoly":this.desRapide)},this.treatDouble=function(a){return this.isTriple()?void GestionJoueur.getJoueurCourant().choisiCase(function(a){GestionJoueur.getJoueurCourant().joueSurCase(a),$.trigger("monopoly.derapide.triple",{joueur:GestionJoueur.getJoueurCourant(),maison:a})}):(this.desRapide=0,this._doTreatDouble(a))},this._isBus=function(){return 4==this.desRapide||6==this.desRapide},this._isMonopolyMan=function(){return 5==this.desRapide},this._isValue=function(){return this.desRapide<=3},this.endLancer=function(){if(this.showReload(),!this.isTriple()){if(!this.isDouble()&&this._isBus())return void GestionJoueur.getJoueurCourant().choisiDes(this.des1,this.des2,function(a){$.trigger("monopoly.derapide.bus",{joueur:GestionJoueur.getJoueurCourant(),total:a}),GestionJoueur.getJoueurCourant().joueDes(a)});this.isDouble()&&(this.desRapide=0),GestionJoueur.getJoueurCourant().joueDes(this.total())}},this._drawCubes=function(a,b,c,d){this.cube.des1.setValue(a,d),this.cube.des2.setValue(b,d),GestionJoueur.getJoueurCourant().enPrison?this.cube.desRapide.setValue(0,d):this.cube.desRapide.setValue(c,d)}}function buy(a){for(var b in a)GestionJoueur.getJoueurCourant().acheteMaison(GestionFiche.getById(a[b]))}var CURRENT_ID_COMPONENT=0,DrawerHelper={fromDegresToRad:function(a){return a/180*Math.PI},drawCircle:function(a,b,c,d,e){a.fillStyle=b,a.strokeColor=e||b,a.beginPath(),a.arc(d.x,d.y,c,0,2*Math.PI),a.fill(),a.closePath()},drawArcCircle:function(a,b,c,d,e,f){a.beginPath(),a.fillStyle=b,a.moveTo(d.x,d.y),a.arc(d.x,d.y,c,e,f),a.fill(),a.closePath()},drawImage:function(a,b,c,d,e,f,g){a.save(),a.translate(c,d),a.rotate(g);try{a.drawImage(b,0,0,e,f)}catch(h){}a.restore()},_splitLine:function(a){if(a.some(function(a){return-1!=a.indexOf("\n")})){var b=[];a.forEach(function(a){-1!=a.indexOf("\n")?a.split("\n").forEach(function(a){b.push(a)}):b.push(a)}),a=b}return a},writeText:function(a,b,c,d,e,f,g,h){var i=g||DrawerFactory.dimensions.largeur;e.fillStyle=DrawerFactory.getInfo("textColor")||"#000000",e.font="200 "+(null!=f?f:"7")+"pt Arial";var j=this._splitLine([a]),k=[];j.forEach(function(a){if(e.measureText(a).width>i-5){for(var b=a.split(" "),c=[],d=0,f=0;f<b.length;f++)d>0&&e.measureText(c[d-1]).width+e.measureText(b[f]).width<i-5?c[d-1]=c[d-1]+" "+b[f]:c[d++]=b[f];c.forEach(function(a){k.push(a)})}else k.push(a)}),j=k,e.save(),e.translate(b,c),e.rotate(d);for(var l=12,m=0;m<j.length;m++){var n;switch(h){case"left":n=0;break;case"right":n=i-e.measureText(j[m]).width;break;default:n=(i-e.measureText(j[m]).width)/2}e.fillText(j[m],n,m*l)}e.font="6pt Times news roman",e.restore()}},DrawerFactory={instances:[],type:null,infos:{},dimensions:{largeur:65,largeurPion:20,hauteur:100,bordure:40,plateauSize:800,innerPlateauSize:220},init:function(){return this},setType:function(a){this.type=a},addInfo:function(a,b){this.infos[a]=b},getInfo:function(a){return this.infos[a]},addInstance:function(a){this.instances[a.type]=a},getDes:function(a,b,c){return this._instantiate("des",arguments)},getDesRapide:function(a,b,c){return this._instantiate("desRapide",arguments)},getCase:function(a,b,c,d,e,f){return this._instantiate("standardCase",arguments)},getCaseSpeciale:function(a,b){return this._instantiate("specialCase",arguments)},getPionJoueur:function(a){return this._instantiate("pionJoueur",arguments)},getPlateau:function(a,b,c,d,e){return this._instantiate("plateau",arguments)},endPlateau:function(){return this._instantiate("endPlateau",arguments)},_instantiate:function(a,b){if(null==this.instances[this.type])throw"Creation, type : "+this.type+" inconnu";if(null==this.instances[this.type][a])return null;var c={};return this.instances[this.type][a].apply(c,b),c}}.init(),Drawer={components:new Array,height:0,width:0,interval:null,intervalRT:null,canvas:null,intervals:[],canvasRT:null,add:function(a,b){null!=a&&(a.getId=function(){return Drawer.canvas.canvas.id},a.order=null==b?0:b,Drawer.components.push(a))},addRealTime:function(a){a.getId=function(){return Drawer.canvasRT.canvas.id},Drawer.components.push(a)},removeComponent:function(a){for(var b=0;b<this.components.length;b++)if(this.components[b].id==a.id)return void this.components.splice(b,1)},clear:function(a){a.clearRect(0,0,this.width,this.height)},refresh:function(a){Drawer.clear(a);for(var b=0;b<Drawer.components.length;b++)Drawer.components[b].getId()===a.canvas.id&&Drawer.components[b].draw(a)},setFrequency:function(a,b){null!=Drawer.intervals[b.canvas.id]&&clearInterval(Drawer.intervals[b.canvas.id]),Drawer.intervals[b.canvas.id]=setInterval(function(){Drawer.refresh(b)},a)},init:function(a,b){return this.components.sort(function(a,b){return a.order-b.order}),this.width=a,this.height=b,this.canvas=document.getElementById("canvas").getContext("2d"),this.canvasRT=document.getElementById("canvas_rt").getContext("2d"),this.canvas.strokeStyle="#AA0000",this.canvasRT.strokeStyle="#AA0000",this.refresh(this.canvas),this.setFrequency(50,this.canvasRT),$.bind("refreshPlateau",function(){Drawer.refresh(Drawer.canvas)}),this}};$(function(){initSquareInstance()});var pasAngle=2*Math.PI/40,nbJoueurs=0;$(function(){initCircleInstance()});var CarteActionFactory={get:function(a){switch(a.type){case"taxe":return new PayerCarte(a.montant,InitMonopoly.plateau.parcGratuit);case"prime":return new GagnerCarte(a.montant);case"goto":return new GotoCarte(a.axe,a.pos,a.direct);case"move":return new MoveNbCarte(a.nb);case"prison":return new PrisonCarte;case"birthday":return new BirthdayCarte(a.montant);case"repair":return new ReparationsCarte(a.hotel,a.maison)}throw"Type inconnu"}},GestionComportement={comportements:[CheapComportement,MediumComportement,HardComportement],create:function(a){return new this.comportements[a]},createRandom:function(){return this.create(Math.round(1e3*Math.random())%this.comportements.length)},getAll:function(){return this.comportements},length:function(){return this.comportements.length}},GestionJoueur={colorsJoueurs:["#383C89","#A6193E","#C58F01","#086B3D","#B9B29B","#663300"],imgJoueurs:[],joueurs:[],joueurCourant:null,getJoueurCourant:function(){return this.joueurCourant},getNb:function(){return this.joueurs.length},createAndLoad:function(a,b,c,d){var e=this.create(a,b,c);return e.load(d),e},create:function(a,b,c){var d="joueur"+b,e=this.colorsJoueurs[b],f=this.imgJoueurs[b],g=InitMonopoly.plateau.infos.argentJoueurDepart,h=a?new JoueurOrdinateur(b,c,e,g):h=new Joueur(b,c,e,g),i=$('<hr/><div id="'+d+'"><div class="joueur-bloc"><span class="joueur-name">'+h.nom+'</span> : <span class="compte-banque"></span> '+CURRENCY+'<span class="info-joueur" title="Info joueur" data-idjoueur="'+b+'"><img src="img/info-user2.png" style="cursor:pointer;width:24px;float:right"/></span></div></div>');return $(".panneau_joueur").append(i),h.setDiv($('div[id="'+d+'"]')),h.setPion(e,f),$("#"+d+" > div.joueur-bloc").css("backgroundImage","linear-gradient(to right,white 50%,"+e+")"),$.trigger("monopoly.newPlayer",{joueur:h}),this.joueurs.push(h),h},getById:function(a){var b=parseInt(a);for(var c in this.joueurs)if(this.joueurs[c].numero==b)return this.joueurs[c];return null},change:function(a){if(null!=a){var b=this.getById(a);if(null!=b)return this._select(b)}if(!GestionEchange.running){var b=null;try{b=this.next()}catch(c){return this._showVainqueur(c),c}return null==b?null:(GestionDes.isDouble()||GestionDes.resetDouble(),this._select(b),null)}},_showVainqueur:function(a){$.trigger("monopoly.victoire",{joueur:a});var b=this.joueurs.filter(function(a){return a.defaite});b.sort(function(a,b){return a.tourDefaite==b.tourDefaite?b.numero-a.numero:b.tourDefaite-a.tourDefaite});var c="Le joueur "+a.nom+" a gagné en "+this._formatTempsJeu(globalStats.heureDebut)+".<br/>";c+="1 - "+a.nom+"<br/>";for(var d=0;d<b.length;d++)c+=d+2+" - "+b[d].nom+"<br/>";var e=this._calculateScore(a);InfoMessage.create(this.joueurCourant,"Fin de partie : "+e+" Points","green",c,null,null,!0)},_calculateScore:function(a){var b=a.getStats(),c=b.argent/1e4,d=a.maisons.length*this.joueurs.length/4,e=b.hotel/12+b.maison/32,f=b.tour*this.joueurs.length,g=1;this.joueurs.forEach(function(b){g+=b.equals(a)?0:b.pion.stats.tour});var h=(f-g)*c*d*e;return Math.round(h)},_formatTempsJeu:function(a){var b=Math.round(((new Date).getTime()-a)/1e3);if(60>b)return c+" sec";var c=b%60;return b=Math.round(b/60),b+" min et "+c+" sec"},_select:function(a){$(".action-joueur").removeAttr("disabled").removeClass("disabled"),VARIANTES.echangeApresVente&&GestionFiche.isFreeFiches()&&$("#idEchangeTerrains").attr("disabled","disabled").addClass("disabled"),a.equals(this.joueurCourant)||($(".joueurCourant").removeClass("joueurCourant"),null!=this.joueurCourant&&this.joueurCourant.pion.pion.setSelected(!1)),this.joueurCourant=a,this.joueurCourant.pion.pion.setSelected(!0),a.select()},getWinner:function(){var a,b=0;for(var c in this.joueurs)this.joueurs[c].defaite===!0?b++:a=this.joueurs[c];return b==this.joueurs.length-1?a:null},next:function(){if(null==this.joueurCourant)return this.joueurs[0];if(this.joueurCourant.bloque)return null;var a=this.getWinner();if(null!=a)throw a;var b=this.joueurCourant;if(!GestionDes.continuePlayer()&&!GestionDes.isSpecificAction()){var c=0;for(b=this.joueurs[(b.numero+1)%this.joueurs.length];1==b.defaite&c++<this.joueurs.length;)b=this.joueurs[(b.numero+1)%this.joueurs.length];b.numero<this.joueurCourant.numero&&globalStats.nbTours++}return GestionDes.isSpecificAction()?(GestionDes.doSpecificAction(),null):b},forEach:function(a,b){this.joueurs.forEach(a,b)}},GestionStrategie={strategies:[CheapStrategie,MediumStrategie,HardStrategie,SmartStrategie,CrazyStrategie],create:function(a){return new this.strategies[a]},createRandom:function(){return this.create(Math.round(1e3*Math.random())%this.strategies.length)},getAll:function(){return this.strategies},length:function(){return this.strategies.length}},ETAT_LIBRE=0,ETAT_ACHETE=1,GestionFiche={fiches:[],keys:[],_calculateStrId:function(a){return 10*parseInt(a.substr(0,1))+parseInt(a.substr(2,3))},_calculateId:function(a){return 10*a.axe+a.pos},getById:function(a){return this.fiches[this._calculateStrId(a)]},get:function(a){return this.fiches[this._calculateId(a)]},getPrison:function(){return this.fiches[this._calculateId({axe:1,pos:0})]},getDepart:function(){return this.fiches[this._calculateId({axe:2,pos:0})]},add:function(a){var b=this._calculateStrId(a.id);this.fiches[b]=a,this.keys.push(b)},getFreeFiches:function(){return this.fiches.filter(function(a){return a.statut==ETAT_LIBRE})},isFreeFiches:function(){return this.fiches.some(function(a){return a.statut==ETAT_LIBRE})},getNextFreeTerrain:function(a){return this._getNextFiche(a,function(a){return a.isPropriete()&&a.statut==ETAT_LIBRE})},getNextTerrain:function(a){return this._getNextFiche(a,function(a){return a.isPropriete()})},_getNextFiche:function(a,b){var c={position:a.pos,axe:a.axe};do{var c=this.nextPos(c.axe,c.position),d=this.get({axe:c.axe,pos:c.position});if(null==b||b(d))return d}while(a.axe!=c.axe||a.pos!=c.position);return null},iterator:function(){return{pointer:0,hasNext:function(){return this.pointer<GestionFiche.keys.length},next:function(){return GestionFiche.fiches[GestionFiche.keys[this.pointer++]]}}},iteratorTerrains:function(){var a=[];for(var b in this.fiches)this.fiches[b].isPropriete()&&a.push(b);return this._buildIterator(a)},getTerrainsLibres:function(){var a=[];for(var b in this.fiches)this.fiches[b].isPropriete()&&this.fiches[b].statut==ETAT_LIBRE&&a.push(b);return this._buildIterator(a)},_buildIterator:function(a){return{pointer:0,keys:a,hasNext:function(){return this.pointer<this.keys.length},next:function(){return GestionFiche.fiches[this.keys[this.pointer++]]}}},nextPos:function(a,b){return b++,10==b&&(a=(a+1)%4,b=0),{position:b,axe:a}}},FicheDisplayer={detailFiche:null,fiche:null,ficheCompagnie:null,currentFiche:null,init:function(){this.fiche=$("#fiche"),this.detailFiche=this.fiche.clone(),this.detailFiche.attr("id","idDetailFiche").hide(),$("body").append(this.detailFiche),this.ficheCompagnie=$("#ficheCompagnie"),this.fiche.dialog({autoOpen:!1,title:"Fiche",width:280,height:410,modal:!0,resizable:!1,close:function(){FicheDisplayer.close()}}),this.fiche.prev().css("background","url()"),this.ficheCompagnie.dialog({autoOpen:!1,title:"Fiche",width:280,height:350,modal:!0,resizable:!1,close:function(){FicheDisplayer.close()}}),this.ficheCompagnie.prev().css("background","url()")},openDetail:function(a,b){return null!=this.currentFiche&&this.currentFiche.axe==a.axe&&this.currentFiche.pos==a.pos?void(0==$(":visible",this.detailFiche).length?this.detailFiche.slideDown():this.detailFiche.slideUp()):null==this.currentFiche||this.currentFiche.axe==a.axe&&this.currentFiche.pos==a.pos?(this.loadDetailFiche(a),b.after(this.detailFiche),this.detailFiche.slideDown(),void(this.currentFiche=a)):(this.currentFiche=null,void this.detailFiche.slideUp(300,function(){FicheDisplayer.openDetail(a,b)}))},close:function(){GestionJoueur.change()},closeDetail:function(){this.detailFiche.slideUp()},loadFiche:function(a){this._load(a,this.fiche,"FFFFFF"),a.fiche.prev().css("background-color",a.color)},loadDetailFiche:function(a){this._load(a,this.detailFiche,a.secondColor)},_load:function(a,b,c){$('td[name^="loyer"]',b).each(function(){$(this).text(a.loyer[parseInt($(this).attr("name").substring(5))])}),$('td[name]:not([name^="loyer"]),span[name]:not([name^="loyer"])',b).each(function(){$(this).html(a[$(this).attr("name")])}),$(b).css("backgroundColor",c),"gare"==a.type?$("#loyer0",b).text(parseInt(a.getLoyer())):$("#loyer0",b).text(1==a.isGroupee()?2*parseInt(a.loyer[0]):a.loyer[0]),$("tr",b).removeClass("nbMaisons"),$(".infos-group",b).removeClass("nbMaisons"),$("#loyer"+a.nbMaison,b).parent().addClass("nbMaisons"),0==a.nbMaison&&1==a.isGroupee()&&$(".infos-group",b).addClass("nbMaisons"),"gare"==a.type?$(".maison",b).hide():$(".maison",b).show()},closeFiche:function(){this.fiche.dialog("isOpen")?this.fiche.dialog("close"):this.ficheCompagnie.dialog("isOpen")?this.ficheCompagnie.dialog("close"):this.close()}},CommunicationDisplayer={panel:null,joueur:null,init:function(a){this.panel=$("#"+a),this.panel.dialog({autoOpen:!1,title:"Echange",width:400})},show:function(a,b,c,d,e){this.showPropose(a,b,c,d,e),this.addMessage("Que souhaitez vous faire",[{nom:"Accepter",action:function(){CommunicationDisplayer.close(),GestionEchange.accept(CommunicationDisplayer.joueur)}},{nom:"Refuser",action:function(){CommunicationDisplayer.close(),GestionEchange.reject(CommunicationDisplayer.joueur)}},{nom:"Négocier",action:function(){CommunicationDisplayer._showContrePanel(a)}}],!0)},showPropose:function(a,b,c,d,e){this.joueur=e,this.panel.dialog("option","title","Echange entre "+a.nom+" et "+b.nom),$(".proposition,.communications",this.panel).empty(),$(".proposition",this.panel).append('<div>Terrain : <span style="font-weight:bold;color:'+c.color+'">'+c.nom+"</div>"),this._showProposition($(".proposition",this.panel),d),$(".communications",this.panel).empty(),this.panel.dialog("open")},_showContrePanel:function(a,b){var c=a.getMaisonsGrouped(),d=$('<div class="contreProposition"></div>');for(var e in c){var f=c[e],g=$('<div style="font-weight:bold;color:'+f.color+'">Groupe '+f.groupe+"<br/></div>");for(var h in f.terrains){var i=f.terrains[h];g.append('<input type="checkbox" value="'+i.id+'" id="chk_id_'+i.id+'"/><label for="chk_id_'+i.id+'">'+i.nom+"</label><br/>")}d.append(g)}d.append('Argent : <input class="argent" type="text"/>'),$(".communications",this.panel).append(d),this.addMessage("Quelle est votre contreproposition",[{nom:"Proposer",action:function(){CommunicationDisplayer._doContreproposition(CommunicationDisplayer.joueur)}},{nom:"Rejeter",action:function(){CommunicationDisplayer.close(),GestionEchange.reject(CommunicationDisplayer.joueur)}}],!0)},_doContreproposition:function(a){var b={terrains:[],compensation:0};$(".contreProposition:last :checkbox:checked",this.panel).each(function(){var a=GestionFiche.getById($(this).val());null!=a&&b.terrains.push(a)});var c=$(".contreProposition:last :text.argent",this.panel).val();""!=c&&(b.compensation=parseInt(c)),GestionEchange.contrePropose(b,a)},_showProposition:function(a,b){if(a.append("Proposition : "),b.terrains.length>0)for(var c in b.terrains){var d=b.terrains[c];a.append('<div style="padding-left:20px;color:'+d.color+'">'+d.nom+"</div>")}a.append('<div style="padding-left:20px;">Argent : '+CURRENCY+" "+b.compensation+"</div>")},showAccept:function(a){this.addMessage('La proposition a été <span style="color:green">acceptée</span>',[{nom:"Fermer",action:function(){CommunicationDisplayer.close(),a&&a()}}])},showReject:function(a){this.addMessage('La proposition a été <span style="color:red">rejetée</span>.',[{nom:"Fermer",action:function(){CommunicationDisplayer.close(),a&&a()}}])},showContreProposition:function(a){this.addMessage("Une contreproposition a été faite",[{nom:"Refuser",action:function(){CommunicationDisplayer.close(),GestionEchange.reject(CommunicationDisplayer.joueur)}},{nom:"Accepter",action:function(){CommunicationDisplayer.close(),GestionEchange.accept(CommunicationDisplayer.joueur)}}]),this._showProposition($(".communications",this.panel),a)},addMessage:function(a,b,c){if(c||$(".communications",this.panel).append("<hr/>"),$(".communications",this.panel).append("<p>"+a+"</p>"),null!=b&&b.length>0){var d=[];for(var e in b){var f=b[e],g={text:f.nom,click:f.action};d.push(g)}this.panel.dialog("option","buttons",d),this.open()}},close:function(){this.panel.dialog("close")},open:function(){this.panel.dialog("open")}},MessageDisplayer={div:null,order:0,init:function(a){this.div=$("#"+a),this.bindEvents()},write:function(a,b){MessageDisplayer.order++;var c=DEBUG?" ("+MessageDisplayer.order+")":"";this.div.prepend('<div><span style="color:'+a.color+'">'+a.nom+"</span> : "+b+c+"</div>")},_buildTerrain:function(a){return null==a?"":'<span style="font-weight:bold;color:'+a.color+'">'+a.nom+"</span>"},_buildProposition:function(a){if(null==a)return"";var b="";if(a.terrains.length>0)for(var c=0;c<a.terrains.length;c++)b+=this._buildTerrain(a.terrains[c])+", ";return a.compensation>0&&(b+=" compensation : "+a.compensation+" "+CURRENCY),b},bindEvents:function(){$.bind("monopoly.save",function(a,b){MessageDisplayer.write({color:"green",nom:"info"},"sauvegarde de la partie ("+b.name+")")}).bind("monopoly.depart",function(a,b){MessageDisplayer.write(b.joueur,"s'arrête sur la case départ et gagne "+b.montant+" "+CURRENCY)}).bind("monopoly.enchere.init",function(a,b){MessageDisplayer.write(null!=b.joueur?b.joueur:{color:"black",nom:"La banque"},"met aux enchères "+MessageDisplayer._buildTerrain(b.maison))}).bind("monopoly.enchere.fail",function(a,b){MessageDisplayer.write({color:"red",nom:"Commissaire priseur"},"le terrain "+MessageDisplayer._buildTerrain(b.maison)+" n'a pas trouvé preneur")}).bind("monopoly.enchere.success",function(a,b){MessageDisplayer.write(b.joueur,"achète aux enchères le terrain "+MessageDisplayer._buildTerrain(b.maison)+" pour "+CURRENCY+" "+b.montant)}).bind("monopoly.caissecommunaute.message",function(a,b){MessageDisplayer.write(b.joueur,"carte caisse de communauté : "+b.message)}).bind("monopoly.chance.message",function(a,b){MessageDisplayer.write(b.joueur,"carte chance : "+b.message)}).bind("monopoly.acheteMaison",function(a,b){MessageDisplayer.write(b.joueur,"achète "+MessageDisplayer._buildTerrain(b.maison))}).bind("monopoly.chezsoi",function(a,b){MessageDisplayer.write(b.joueur,"tombe sur "+MessageDisplayer._buildTerrain(b.maison)+". Il est chez lui.")}).bind("monopoly.visiteMaison",function(a,b){MessageDisplayer.write(b.joueur,"tombe sur "+MessageDisplayer._buildTerrain(b.maison))}).bind("monopoly.vendMaison",function(a,b){MessageDisplayer.write(b.joueur,"vends "+b.nbMaison+" maison(s)</span>")}).bind("monopoly.payerLoyer",function(a,b){var c=b.maison,d='<span style="font-weight:bold;color:'+c.color+'">'+c.nom+"</span>",e='<span style="color:'+c.joueurPossede.color+'">'+c.joueurPossede.nom+"</span>";MessageDisplayer.write(b.joueur,"tombe sur "+d+" et paye "+c.getLoyer()+" "+CURRENCY+" à "+e)}).bind("monopoly.newPlayer",function(a,b){MessageDisplayer.write(b.joueur,"rentre dans la partie")}).bind("monopoly.hypothequeMaison",function(a,b){MessageDisplayer.write(b.joueur,"hypothèque "+MessageDisplayer._buildTerrain(b.maison))}).bind("monopoly.leveHypothequeMaison",function(a,b){MessageDisplayer.write(b.joueur,"lève l'hypothèque de "+MessageDisplayer._buildTerrain(b.maison))}).bind("monopoly.goPrison",function(a,b){MessageDisplayer.write(b.joueur,"va en prison")}).bind("monopoly.derapide.bus",function(a,b){MessageDisplayer.write(b.joueur," prend le bus et fait "+b.total)}).bind("monopoly.derapide.triple",function(a,b){MessageDisplayer.write(b.joueur," fait un triple et choisi d'aller à "+MessageDisplayer._buildTerrain(b.maison))}).bind("monopoly.derapide.mrmonopoly",function(a,b){MessageDisplayer.write(b.joueur," fait un Mr Monopoly et va sur "+MessageDisplayer._buildTerrain(b.maison))}).bind("monopoly.exitPrison",function(a,b){MessageDisplayer.write(b.joueur,"sort de prison")}).bind("monopoly.acheteConstructions",function(a,b){var c="",d=b.achats;if(d.maison>0?c+="achète "+d.maison+" maison(s) ":d.maison<0&&(c+="vend "+-1*d.maison+" maison(s) "),d.hotel>0?c+=(""!=c?" et ":"")+"achète "+d.hotel+" hôtel(s) ":d.hotel<0&&(c+=(""!=c?" et ":"")+"vend "+-1*d.hotel+" hôtel(s) "),null!=d.terrains&&d.terrains.size()>0){c+=" sur ";for(var e in d.terrains)c+=MessageDisplayer._buildTerrain(d.terrains[e])+", "}""!=c&&MessageDisplayer.write(b.joueur,c)}).bind("monopoly.echange.init",function(a,b){var c="souhaite obtenir "+MessageDisplayer._buildTerrain(b.maison)+" auprès de "+b.maison.joueurPossede.nom;MessageDisplayer.write(b.joueur,c)}).bind("monopoly.echange.propose",function(a,b){MessageDisplayer.write(b.joueur,"propose : "+MessageDisplayer._buildProposition(b.proposition))}).bind("monopoly.echange.accept",function(a,b){MessageDisplayer.write(b.joueur,"accepte la proposition")}).bind("monopoly.echange.reject",function(a,b){MessageDisplayer.write(b.joueur,"rejete la proposition")}).bind("monopoly.echange.contrepropose",function(a,b){MessageDisplayer.write(b.joueur,"fait une contre-proposition : "+MessageDisplayer._buildProposition(b.proposition))}).bind("monopoly.defaite",function(a,b){MessageDisplayer.write(b.joueur,"a perdu et quitte la partie")}).bind("monopoly.victoire",function(a,b){MessageDisplayer.write(b.joueur,"a gagné la partie")}).bind("monopoly.debug",function(a,b){DEBUG&&MessageDisplayer.write({color:"red",nom:"debug"},b.message)})}},InfoMessage={div:null,init:function(a){this.div=$("#"+a)},_initMessage:function(a,b,c){$.trigger("monopoly.debug",{message:c}),this.div.prev().css("background-color",a),this.div.dialog("option","title",b),this.div.empty(),this.div.append(c)},createGeneric:function(a,b,c,d,e){this._initMessage(c,b,d),this.div.unbind("dialogclose.message").bind("dialogclose.message",function(){InfoMessage.div.dialog("open")});var f={};return e.forEach(function(a){f[a.title]=function(){InfoMessage.div.unbind("dialogclose.message"),InfoMessage.div.dialog("close"),a.fct()}}),this.div.dialog("option","buttons",f),(a.canPlay||forceshow)&&this.div.dialog("open"),f},create:function(a,b,c,d,e,f,g){this._initMessage(c,b,d);var h={Ok:function(){InfoMessage.close()}};return this.div.unbind("dialogclose.message").bind("dialogclose.message",function(){InfoMessage.div.unbind("dialogclose.message"),null!=e&&e(f)}),null!=e&&this.div.dialog("option","buttons",h),(a.canPlay||g)&&this.div.dialog("open"),h},close:function(){this.div.dialog("isOpen")?this.div.dialog("close"):(this.div.trigger("dialogclose.message"),this.div.trigger("dialogclose.prison"))},createPrison:function(a,b,c){this._initMessage("red","Vous êtes en prison depuis "+b+" tours.","Vous êtes en prison, que voulez vous faire");var d={Payer:function(){a.payer(5e3),a.exitPrison(),InfoMessage.close()},Attendre:function(){InfoMessage.close()}};return a.cartesSortiePrison.length>0&&(d["Utiliser carte"]=function(){a.utiliseCarteSortiePrison(),a.exitPrison(),InfoMessage.close()}),this.div.dialog("option","buttons",d),this.div.bind("dialogclose.prison",function(){InfoMessage.div.unbind("dialogclose.prison"),c()}),a.canPlay&&this.div.dialog("open"),d}};Object.defineProperty(Array.prototype,"size",{value:function(){var a=0;for(var b in this)a++;return a},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"contains",{value:function(a){for(var b in this)if(this[b]==a)return!0;return!1},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"filter",{value:function(a){var b=[];for(var c in this)a(this[c])&&b.push(this[c]);return b},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"some",{value:function(a){for(var b in this)if(a(this[b]))return!0;return!1},writable:!1,enumerable:!1,configurable:!1}),$.bind=function(a,b){return $("body").bind(a,b),$("body")},$.trigger=function(a,b){$("body").trigger(a,b)};var GestionEnchere={terrain:null,callback:null,miseDepart:0,ventePerte:!1,pasVente:2e3,joueurLastEnchere:null,lastEnchere:0,nextMontantEnchere:0,currentJeton:0,joueursExit:[],endAckJoueurs:[],transaction:0,init:function(a,b,c,d){this.terrain=a,this.callback=d,this.miseDepart=b,this.lastEnchere=0,this.endAckJoueurs=[],this.nextMontantEnchere=b,this.ventePerte=c,this.joueurLastEnchere=null,this.currentJeton=0,this.joueursExit=[],this.transaction++,$.trigger("monopoly.enchere.init",{maison:this.terrain,joueur:this.terrain.joueurPossede}),GestionJoueur.forEach(function(a){a.initEnchere(this.transaction,this.terrain,this.miseDepart)},this),this.runEnchere()},computeEncherisseurs:function(){var a=[],b=[];return GestionJoueur.forEach(function(c){c.equals(this.terrain.joueurPossede)||c.equals(this.joueurLastEnchere)||null!=this.joueursExit[c.nom]||0!=c.defaite?b.push(c):a.push(c)},this),{encherisseurs:a,observers:b}},runEnchere:function(a){for(var b=this.computeEncherisseurs(),c=0;c<b.encherisseurs.length;c++)b.encherisseurs[c].updateEnchere(this.transaction,this.currentJeton,this.nextMontantEnchere,this.joueurLastEnchere,a);for(var c=0;c<b.observers.length;c++)b.observers[c].updateInfoEnchere(this.nextMontantEnchere,this.joueurLastEnchere)},exitEnchere:function(a){null==this.joueursExit[a.nom]&&(this.joueursExit[a.nom]=a,GestionJoueur.forEach(function(b){b.notifyExitEnchere(a)}),this.checkEndEnchere()&&this.manageEndEnchere())},checkEndEnchere:function(){return this.joueursExit.size()>=GestionJoueur.getNb()||this.joueursExit.size()>=GestionJoueur.getNb()-1&&(null!=this.terrain.joueurPossede||null!=this.joueurLastEnchere)||this.joueursExit.size()>=GestionJoueur.getNb()-2&&null!=this.joueurLastEnchere&&null!=this.terrain.joueurPossede?!0:!1},doEnchere:function(a,b,c){if(c<this.currentJeton)throw"Trop lent, une enchere a deja ete faite";a.equals(this.joueurLastEnchere)||(this.currentJeton++,this.joueurLastEnchere=a,this.lastEnchere=b,this.nextMontantEnchere=this.lastEnchere+this.pasVente,this.checkEndEnchere()?this.manageEndEnchere():this.runEnchere())},checkEnchere:function(a){a>=this.currentJeton&&this.manageEndEnchere()},manageEndEnchere:function(){null==this.joueurLastEnchere?this.ventePerte&&this.nextMontantEnchere-this.pasVente>this.miseDepart/2?(this.nextMontantEnchere-=this.pasVente,this.joueursExit=[],this.runEnchere(!0)):($.trigger("monopoly.enchere.fail",{maison:this.terrain}),this.endEnchere()):(null==this.terrain.joueurPossede?this.joueurLastEnchere.acheteMaison(this.terrain,this.lastEnchere):(this.joueurLastEnchere.payerTo(this.lastEnchere,this.terrain.joueurPossede),this.joueurLastEnchere.getSwapProperiete(this.terrain)),$.trigger("monopoly.enchere.success",{joueur:this.joueurLastEnchere,maison:this.terrain,montant:this.lastEnchere}),this.endEnchere())},endEnchere:function(){this.terrain=null,GestionJoueur.forEach(function(a){a.endEnchere(this.lastEnchere,this.joueurLastEnchere)},this)},checkEndNotify:function(a){this.endAckJoueurs[a.numero]=!0,this.endAckJoueurs.size()>=GestionJoueur.getNb()&&this.doCallback()},doCallback:function(){this.callback&&this.callback()}},GestionEnchereDisplayer={panel:null,currentMontant:0,currentEncherisseur:null,terrain:null,displayer:null,init:function(a){this.panel=$("#"+a),this.panel.dialog({title:"Mise au enchere",autoOpen:!1})},display:function(a,b){this.terrain=a,this.displayer=b,$(".proprietaire",this.panel).text(null!=a.joueurPossede?a.joueurPossede.nom:"Banque"),$(".terrain",this.panel).text(a.nom).css("color",a.color),$(".list_exit",this.panel).empty(),$(".list_encherisseurs",this.panel).empty(),$(".messages",this.panel).empty(),this.panel.dialog("open")},displayCloseOption:function(a,b){null!=b?($(".montant",this.panel).text(a),$(".montant",this.panel).css("color","green"),$(".last_encherisseur",this.panel).text(b.nom),b.equals(this.displayer)?$(".messages",this.panel).append("Vous avez remporté l'enchère"):$(".messages",this.panel).append(b.nom+" a remporté l'enchère")):$(".montant",this.panel).css("color","red"),this.panel.dialog("option","buttons",[{text:"Fermer",click:function(){GestionEnchereDisplayer.close()}}])},clean:function(){$(".list_exit",this.panel).empty()},showJoueurExit:function(a){$(".list_exit",this.panel).append(a.nom+" est sorti<br/>")},exitEnchere:function(){this.panel.dialog("option","buttons",[])},close:function(){GestionEnchere.doCallback(),this.panel.dialog("close")},updateInfo:function(a,b,c,d){
if(c&&null==d)throw"Impossible de gerer l'enchere";if(null!=this.currentMontant&&null!=this.currentEncherisseur&&($(".list_encherisseurs",this.panel).prepend("<p>"+CURRENCY+" "+this.currentMontant+" : "+this.currentEncherisseur.nom+"</p>"),$(".list_encherisseurs > p:gt(3)",this.panel).remove()),this.currentMontant=a,this.currentEncherisseur=b,$(".montant",this.panel).text(a),$(".montant",this.panel).animate({color:"red"},200).animate({color:"black"},2e3),null!=b&&$(".last_encherisseur",this.panel).text(b.nom),c){var e=[{text:"Encherir",click:function(){GestionEnchere.doEnchere(GestionEnchereDisplayer.displayer,a,d.jeton)}},{text:"Quitter",click:function(){GestionEnchere.exitEnchere(GestionEnchereDisplayer.displayer)}}];this.panel.dialog("option","buttons",e)}else this.panel.dialog("option","buttons",[])}},EchangeDisplayer={panel:null,selectJoueurs:null,listTerrainsJoueur:null,listTerrainsAdversaire:null,joueur:null,init:function(a,b,c,d){this.panel=$("#"+a),this.selectJoueurs=$("#"+b),this.listTerrainsJoueur=$("#"+c),this.listTerrainsAdversaire=$("#"+d),this.panel.dialog({title:"Echange de terrains",autoOpen:!1,width:400,buttons:{Annuler:function(){EchangeDisplayer.close()},Proposer:function(){EchangeDisplayer.propose()}}}),GestionJoueur.forEach(function(a){this.selectJoueurs.append('<option value="'+a.id+'">'+a.nom+"</option>")},this),this.selectJoueurs.change(function(){$("option:not(:first),optgroup",EchangeDisplayer.listTerrainsAdversaire).remove();var a=GestionJoueur.getById(EchangeDisplayer.selectJoueurs.val());if(null!=a){var b=a.getMaisonsGrouped();for(var c in b){var d=b[c],e=$('<optgroup label="Groupe '+d.groupe+'" style="color:'+d.color+'"></optGroup>');for(var f in d.terrains){var g=d.terrains[f];e.append('<option value="'+g.id+'">'+g.nom+"</option>")}EchangeDisplayer.listTerrainsAdversaire.append(e)}}})},open:function(a){this.joueur=a,this.selectJoueurs.find("option:not(:visible)").show(),this.selectJoueurs.find('option[value="'+a.id+'"]').hide(),this.listTerrainsJoueur.empty();var b=a.getMaisonsGrouped();for(var c in b){var d=b[c],e=$('<div style="font-weight:bold;color:'+d.color+'">Groupe '+d.groupe+"<br/></div>");for(var f in d.terrains){var g=d.terrains[f];e.append('<input type="checkbox" value="'+g.id+'" id="chk_id_'+g.id+'"/><label for="chk_id_'+g.id+'">'+g.nom+"</label><br/>")}EchangeDisplayer.listTerrainsJoueur.append(e)}this.panel.dialog("open")},propose:function(){var a=GestionJoueur.getById(EchangeDisplayer.selectJoueurs.val()),b=GestionFiche.getById(this.listTerrainsAdversaire.val());if(null!=a&&null!=b){GestionEchange.init(this.joueur,a,b,null);var c={terrains:[],compensation:0};$(":checkbox:checked",this.listTerrainsJoueur).each(function(){c.terrains.push(GestionFiche.getById($(this).val()))}),""!=$("#idArgentProposition").val()&&(c.compensation=parseInt($("#idArgentProposition").val())),this.close(),CommunicationDisplayer.showPropose(this.joueur,a,b,c,this.joueur),GestionEchange.propose(c)}},close:function(){this.panel.dialog("close"),$("option",this.selectJoueurs).removeAttr("selected")}},GestionEchange={running:!1,demandeur:null,proprietaire:null,terrain:null,proposition:null,initialProposition:null,endCallback:null,init:function(a,b,c,d){if(this.running)throw"Transaction impossible, une transaction est deja en cours.";this.running=!0,this.demandeur=a,this.proprietaire=b,this.terrain=c,this.endCallback=d,$.trigger("monopoly.echange.init",{joueur:a,maison:c})},end:function(){this.running=!1,this.demandeur=null,this.proprietaire=null,this.terrain=null,null!=this.endCallback&&this.endCallback(),this.endCallback=null},propose:function(a){this.proposition=a,this.initialProposition=a,$.trigger("monopoly.echange.propose",{joueur:GestionEchange.demandeur,proposition:a}),this.proprietaire.traiteRequeteEchange(this.demandeur,this.terrain,a)},contrePropose:function(a,b){$.trigger("monopoly.echange.contrepropose",{joueur:this.proprietaire,proposition:a}),this.proposition=a,b.equals(this.demandeur)?this.proprietaire.traiteContreProposition(a,b,this.terrain):this.demandeur.traiteContreProposition(a,b,this.terrain)},abort:function(){this.end()},accept:function(a){$.trigger("monopoly.echange.accept",{joueur:a}),a.equals(this.demandeur)?this.proprietaire.notifyAcceptProposition(function(){GestionEchange._doAccept()}):this.demandeur.notifyAcceptProposition(function(){GestionEchange._doAccept()})},_doAccept:function(){if(this.demandeur.getSwapProperiete(this.terrain),null!=this.proposition.compensation&&this.demandeur.payerTo(this.proposition.compensation,this.proprietaire),null!=this.proposition.terrains&&this.proposition.terrains.length>0)for(var a in this.proposition.terrains)this.proprietaire.getSwapProperiete(this.proposition.terrains[a]);this.end()},reject:function(a){$.trigger("monopoly.echange.reject",{joueur:a}),a.equals(this.demandeur)?this.proprietaire.notifyRejectProposition(function(){GestionEchange.end()},this.terrain,this.initialProposition):this.demandeur.notifyRejectProposition(function(){GestionEchange.end()},this.terrain,this.proposition)}},GestionConstructions={nbInitHouse:32,nbInitHotel:12,nbSellHouse:0,nbSellHotel:0,reset:function(){this.nbInitHouse=32,this.nbInitHotel=12,this.nbSellHouse=0,this.nbSellHotel=0},isFreeHouse:function(){return this.nbInitHouse>this.nbSellHouse},isFreeHotel:function(a){if(null==a)return this.nbInitHotel>this.nbSellHotel;var b=4-a;return this.nbInitHotel>this.nbSellHotel&this.nbInitHouse>=this.nbSellHouse+b},getRestHouse:function(){return this.nbInitHouse-this.nbSellHouse},getRestHotel:function(){return this.nbInitHotel-this.nbSellHotel},sellHotel:function(){this.nbSellHotel--},sellHouse:function(){this.nbSellHouse--},buyHouse:function(){if(!this.isFreeHouse())throw"Impossible d'acheter une maison.";this.nbSellHouse++},buyHouses:function(a){if(a>this.getRestHouse())throw"Impossible d'acheter les maisons.";this.nbSellHouse+=a},buyHotels:function(a){if(a>this.getRestHotel())throw"Impossible d'acheter les hotels.";this.nbSellHotel+=a},buyHotel:function(){if(!this.isFreeHouse())throw"Impossible d'acheter un hotel.";this.nbSellHotel++,this.nbSellHouse-=4},simulateBuy:function(a){var b={achat:{maison:0,hotel:0},reste:{maison:this.nbInitHouse-this.nbSellHouse,hotel:this.nbInitHotel-this.nbSellHotel}},c={venteMaison:function(a,b){if("maison"==a.from.type&&"maison"==a.to.type&&a.from.nb>a.to.nb){var c=a.from.nb-a.to.nb;b.achat.maison-=c,b.reste.maison+=c,a.done=!0}},achatHotel:function(b,d){if("maison"==b.from.type&&"hotel"==b.to.type){for(var e in a){var f=a[e];f.color==b.color&&"maison"==f.from.type&&"maison"==f.to.type&&4==f.to.nb&&c.achatMaison(f,d)}var g=4-b.from.nb;if(g>d.reste.maison)return void(d.reste.maison-=g);d.reste.hotel--,d.achat.hotel++,d.reste.maison+=b.from.nb,d.achat.maison-=b.from.nb,b.done=!0}},venteHotel:function(a,b){if("hotel"==a.from.type&&"maison"==a.to.type){if(a.to.nb>b.reste.maison)return void(b.reste.maison-=a.to.nb);b.reste.hotel++,b.achat.hotel--,b.reste.maison-=a.to.nb,b.achat.maison+=a.to.nb,a.done=!0}},achatMaison:function(a,b){if("maison"==a.from.type&&"maison"==a.to.type&&a.from.nb<a.to.nb){var c=a.from.nb-a.to.nb;b.achat.maison-=c,b.reste.maison+=c,a.done=!0}}};for(var d in c){var e=c[d];for(var f in a){var g=a[f];if(null==g.done)try{e(g,b)}catch(h){return console.log("exception"),b}}}return b}},GestionTerrains={maisonsToLever:[],changesConstructions:[],cout:0,totalRestant:0,divCout:null,divArgentRestant:null,banqueroute:!1,panel:null,open:function(a,b){a?this.banqueroute=!0:this.banqueroute=!1,b?this.panel.unbind("dialogbeforeclose").bind("dialogbeforeclose",b):this.panel.unbind("dialogbeforeclose"),this.panel.dialog("open")},reset:function(){this.Hypotheque.reset(),this.LeverHypotheque.reset(),this.Constructions.reset(),this.cout=0,$("#coutAchats > span[name]").text(0),$(".currency-value").text(CURRENCY),this.update()},init:function(a){this.divArgentRestant=$(a.idArgentRestant),this.divCout=$(a.idCout),this.Hypotheque.init(a.idTerrains,a.idHypotheque),this.LeverHypotheque.init(a.idTerrainsHypotheque),this.Constructions.init(a.idTerrainsConstructibles,a.idCoutAchat,a.idConstructions),this.panel=$(a.idPanel),this.panel.dialog({width:800,height:600,title:"Gestion des maisons",modal:!0,buttons:{Fermer:function(){GestionTerrains.closePanel()},Valider:function(){GestionTerrains.valider()}},autoOpen:!1,open:function(){GestionTerrains.load()}})},load:function(){this.reset(),this.Hypotheque.load(),this.LeverHypotheque.load(),this.Constructions.load()},addCout:function(a){this.cout+=a,this.update()},update:function(){this.Hypotheque.update();var a=this.Constructions.update();this.divCout.text(this.cout-a.cout+" "+CURRENCY),this.totalRestant=GestionJoueur.getJoueurCourant().montant+this.cout-a.cout,this.divArgentRestant.text(this.totalRestant+" "+CURRENCY)},verify:function(){try{if(GestionTerrains.totalRestant<0)throw"Operation impossible : pas assez d'argent";GestionTerrains.Constructions.verify()}catch(a){return InfoMessage.create(GestionJoueur.getJoueurCourant(),"Attention","red",a),!1}return!0},valider:function(){this.verify()&&(this.Constructions.vendre(),this.Hypotheque.valider(),this.LeverHypotheque.valider(),this.Constructions.acheter(),this.closePanel())},closePanel:function(){this.panel.dialog("close")},Hypotheque:{table:[],select:null,div:null,init:function(a,b){this.select=$("select",a),this.div=$(b)},reset:function(){this.table=[],this.select.empty(),this.div.empty(),$("#idHypothequeAction").unbind("click").bind("click",function(){GestionTerrains.Hypotheque.add()})},valider:function(){for(var a in this.table)this.table[a].hypotheque()},update:function(){$("option[data-color]",this.select).removeAttr("disabled");var a=GestionTerrains.Constructions.getGroupesConstruits();for(var b in a)$('option[data-color="'+a[b]+'"]',this.select).attr("disabled","disabled")},load:function(){var a=GestionJoueur.getJoueurCourant().findMaisonsHypothecables();a.forEach(function(a){GestionTerrains.Hypotheque.addOption(a)})},addGroup:function(a){for(var b in a.proprietes)this.addOption(a.proprietes[b])},addOption:function(a){if(!(this.select.find('option[value="'+a.id+'"]').length>0)){var b=$("<option data-color='"+a.color+"' value='"+a.id+"'>"+a.nom+" (+"+a.montantHypotheque+" "+CURRENCY+")</option>");b.data("fiche",a),this.select.append(b)}},add:function(){var a=$("option:selected",this.select),b=a.data("fiche");this.table[b.id]=b;var c=$("<div>"+b.nom+"</div>"),d=$('<button style="margin-right:5px">Annuler</button>'),e=this;d.click(function(){e.addOption(b),$(this).parent().remove(),GestionTerrains.addCout(-b.montantHypotheque),delete e.table[b.id];var a=[];for(var c in e.table)a.push(e.table[c].color.substring(1));GestionTerrains.Constructions.showByColors(a)}),c.prepend(d),this.div.append(c),$("option:selected",this.select).remove(),GestionTerrains.addCout(b.montantHypotheque),GestionTerrains.Constructions.removeByColor(b.color)}},LeverHypotheque:{div:null,table:[],init:function(a){this.div=$(a+" > div")},reset:function(){this.div.empty(),this.table=[]},valider:function(){for(var a in this.table)this.table[a].leveHypotheque()},load:function(){var a=GestionJoueur.getJoueurCourant().findMaisonsHypothequees();$(a).each(function(){var a=this,b=$("<div>"+this.nom+"</div>"),c=$('<button style="margin-right:5px">Lever</button>');c.click(function(){GestionTerrains.LeverHypotheque.lever($(this),a)}),b.prepend(c),GestionTerrains.LeverHypotheque.div.append(b)})},lever:function(a,b){a.attr("disabled","disabled"),this.table.push(b),GestionTerrains.addCout(-Math.round(1.1*b.montantHypotheque))}},Constructions:{table:[],div:null,infos:null,simulation:null,resteConstructions:null,init:function(a,b,c){this.div=$(a),this.infos=$(b),this.resteConstructions=$(c)},verify:function(){var a=[];$("select[data-color]",this.div).each(function(){var b=$(this).get(0).dataset.color;null==a[b]&&(a[b]={min:5,max:0}),a[b].min=Math.min(a[b].min,$(this).val()),a[b].max=Math.max(a[b].max,$(this).val())});for(var b in a)if(a[b].max-a[b].min>1)throw"Il faut equilibrer les maisons";if(this.simulation.reste.maison<0||this.simulation.reste.hotel<0)throw"Impossible d'acheter, il n'a y pas assez de maison / hotel disponibles"},valider:function(){for(var a in this.table){var b=this.table[a];b.propriete.setNbMaison(b.nbMaison),GestionJoueur.getJoueurCourant().payer(b.cout)}null==this.simulation||0==this.simulation.achat.maison&&0==this.simulation.achat.hotel||(GestionConstructions.buyHouses(this.simulation.achat.maison),GestionConstructions.buyHotels(this.simulation.achat.hotel),$.trigger("monopoly.acheteConstructions",{joueur:GestionJoueur.getJoueurCourant(),achats:this.simulation.achat}))},acheter:function(){for(var a in this.table){var b=this.table[a];b.propriete.nbMaison<b.nbMaison&&(b.propriete.setNbMaison(b.nbMaison),GestionJoueur.getJoueurCourant().payer(b.cout))}null==this.simulation||0==this.simulation.achat.maison&&0==this.simulation.achat.hotel||(GestionConstructions.buyHouses(this.simulation.achat.maison),GestionConstructions.buyHotels(this.simulation.achat.hotel),$.trigger("monopoly.acheteConstructions",{joueur:GestionJoueur.getJoueurCourant(),achats:this.simulation.achat}))},vendre:function(){for(var a in this.table){var b=this.table[a];b.propriete.nbMaison>b.nbMaison&&(b.propriete.setNbMaison(b.nbMaison),GestionJoueur.getJoueurCourant().payer(b.cout))}},reset:function(){this.table=[],this.div.empty()},getGroupesConstruits:function(){var a=[];return $("select[data-color]:has(option:selected[value!=0])",this.div).each(function(){a.push($(this).attr("data-color"))}),a},update:function(){var a={nbMaison:0,nbHotel:0,cout:0},b=[];for(var c in this.table){var d=GestionFiche.getById(c),e={from:{},to:{},group:d.color};d.hotel?(e.from.type="hotel",e.from.nb=1):(e.from.type="maison",e.from.nb=parseInt(d.nbMaison));var f=this.table[c];a.cout+=f.cout,f.hotel>0?(e.to.type="hotel",e.to.nb=1):(e.to.type="maison",e.to.nb=f.nbMaison),a.nbMaison+=f.nbMaison||0,a.nbHotel+=f.hotel||0,b.push(e)}return $("span[name]",this.infos).each(function(){$(this).text(a[$(this).attr("name")])}),this.simulation=GestionConstructions.simulateBuy(b),$('span[name="nbMaison"]',this.resteConstructions).text(this.simulation.reste.maison),$('span[name="nbHotel"]',this.resteConstructions).text(this.simulation.reste.hotel),a},removeByColor:function(a){this.div.find('div[class*="-'+a.substring(1)+'"]').hide()},showByColors:function(a){var b="div";for(var c in a)b+=':not([class*="-'+a[c]+'"])';this.div.find(b).show()},load:function(){var a=GestionJoueur.getJoueurCourant().findGroupes();for(var b in a){var c=$('<div style="cursor:pointer" class="group-'+b.substring(1)+'">Groupe <span style="color:'+b+';font-weight:bold">'+a[b].proprietes[0].groupe.nom+"</span></div>");c.data("color",b.substring(1)),c.click(function(){var a="div.propriete-"+$(this).data("color");0==$(a+":visible",this.div).length?$(a,this.div).slideDown():$(a,this.div).slideUp()}),this.div.append(c);var d=a[b];for(var e in d.proprietes){var f=a[b].proprietes[e],g=$('<div class="propriete propriete-'+f.color.substring(1)+'"></div>');g.append('<span style="color:'+f.color+'" class="title-propriete">'+f.nom+"</span>");var h=$('<select data-color="'+f.color+'" class="'+(5==f.nbMaison?"hotel":"maison")+'"></select>');h.data("propriete",f),h.data("group",d);for(var i=0;i<=(GestionTerrains.banqueroute?f.nbMaison:5);i++)h.append('<option class="'+(5==i?"hotel":"maison")+'" value="'+i+'" '+(f.nbMaison==i?"selected":"")+">x "+(5==i?1:i)+"</option>");var j=this;h.change(function(){var a=$(this).data("propriete");if(a.nbMaison==$(this).val())return delete j.table[a.id],$("~span",this).text(""),void GestionTerrains.update();var b=5==$(this).val()?{hotel:1}:{maison:parseInt($(this).val())-a.nbMaison};b.propriete=a,b.nbMaison=parseInt($(this).val()),b.cout=$(this).val()>a.nbMaison?($(this).val()-a.nbMaison)*a.prixMaison:($(this).val()-a.nbMaison)*a.prixMaison/2,$(this).removeClass().addClass(5==$(this).val()?"hotel":"maison"),$("~span",this).text(b.cout),j.table[a.id]=b,GestionTerrains.update();var c=0,d=$(this).data("group");GestionTerrains.Constructions.div.find('select[data-color="'+a.color+'"]').each(function(){c+=parseInt($(this).val())}),0==c&&GestionTerrains.Hypotheque.addGroup(d)}),g.append(h).append("<span></span> "+CURRENCY),$(this.div).append(g)}}}}},Sauvegarde={prefix:"monopoly.",suffix:".save",currentSauvegardeName:null,isSauvegarde:function(){return null!=this.currentSauvegardeName},save:function(a){this.currentSauvegardeName=null!=a?this.getSauvegardeName(a):this.currentSauvegardeName||this.getSauvegardeName();var b=[];GestionJoueur.forEach(function(a){a.save&&b.push(a.save())});for(var c=[],d=GestionFiche.iteratorTerrains();d.hasNext();)c.push(d.next().save());var e={joueurs:b,fiches:c,joueurCourant:GestionJoueur.getJoueurCourant().id,variantes:VARIANTES,nbTours:globalStats.nbTours,plateau:InitMonopoly.plateau.name};this._putStorage(this.currentSauvegardeName,e),$.trigger("monopoly.save",{name:this.currentSauvegardeName})},load:function(a){this.currentSauvegardeName=a;var b=this._getStorage(a);InitMonopoly.plateau.load(b.plateau||"data-monopoly.json",function(){b.joueurs.forEach(function(a,b){GestionJoueur.createAndLoad(!a.canPlay,b,a.nom,a)}),b.fiches.forEach(function(a){GestionFiche.getById(a.id).load(a)}),$.trigger("refreshPlateau"),VARIANTES=b.variantes||VARIANTES,globalStats.nbTours=b.nbTours||0,InitMonopoly.afterCreateGame(),GestionJoueur.change(b.joueurCourant)})},"delete":function(a){localStorage.removeItem(a)},_putStorage:function(a,b){localStorage[a]=JSON.stringify(b)},_getStorage:function(a){if(null==localStorage[a])throw"Aucune sauvegarde";var b=localStorage[a];return JSON.parse(b)},autoSave:function(){},findSauvegardes:function(){var a="^"+this.prefix+"(.*)"+this.suffix+"$",b=[];for(var c in localStorage){var d=new RegExp(a,"g").exec(c);null!=d&&b.push({value:c,label:d[1]})}return b},getSauvegardeName:function(a){return this.prefix+(null==a||""==a?(new Date).getTime():a)+this.suffix}},DEBUG=!1,IA_TIMEOUT=1e3,VARIANTES={caseDepart:!1,parcGratuit:!1,enchereAchat:!1,echangeApresVente:!1,desRapide:!1,tourAchat:!1},configJeu=[{nom:"Classique strict",config:[!1,!1,!0,!0,!1]},{nom:"Classique",config:[!1,!1,!1,!1,!1]},{nom:"Variante 1",config:[!0,!0,!1,!1,!1]}],globalStats={nbTours:0,heureDebut:new Date,positions:[]},CURRENCY="F.",GestionDes={gestionDes:null,init:function(a){this.gestionDes.init(a)},lancer:function(){this.gestionDes.lancer()},isDouble:function(){return this.gestionDes.isDouble()},continuePlayer:function(){return this.gestionDes.continuePlayer()},resetDouble:function(){return this.gestionDes.resetDouble()},total:function(){return this.gestionDes.total()},isSpecificAction:function(){return this.gestionDes.isSpecificAction()},doSpecificAction:function(){return this.gestionDes.doSpecificAction()}},InitMonopoly={plateaux:null,listSauvegarde:null,panelPartie:null,plateauName:null,infoPlateau:null,init:function(a){DEBUG=a,this.panelPartie=$("#idPanelCreatePartie"),MessageDisplayer.init("idInfoBox"),InfoMessage.init("message"),FicheDisplayer.init(),this.initPanels(),GestionEnchereDisplayer.init("idEncherePanel"),CommunicationDisplayer.init("idCommunicationEchange"),GestionTerrains.init({idArgentRestant:"#idArgentRestant",idCout:"#idCoutTotal",idPanel:"#housesPanel",idTerrains:"#idTerrains",idHypotheque:"#toHypotheque",idTerrainsHypotheque:"#idTerrainsHypotheques",idTerrainsConstructibles:"#idTerrainsConstructibles",idCoutAchat:"#coutAchats",idConstructions:"#resteConstructions"}),DEBUG?this.plateau.load("data-monopoly.json",function(){InitMonopoly._createGame({},{})}):this.showPanel()},plateau:{infos:null,titles:{},name:null,parcGratuit:null,cartes:{caisseCommunaute:[],chance:[]},drawing:null,load:function(a,b,c){this._temp_load_data=c,$.ajax({url:"data/"+a,dataType:"json",context:this,success:function(c){if(this._temp_load_data,null==c.plateau)throw"Erreur avec le plateau "+a;this.name=a;var d=$.extend(!0,{},c,this._temp_load_data||{});c.extend?this.load(c.extend,b,d):this._build(d,b)},error:function(b,c,d){alert("Le plateau "+a+" n'existe pas (data/"+a+")")}})},_build:function(a,b){$(":checkbox[name]","#idVariantes").each(function(){VARIANTES[$(this).attr("name")]=$(this).is(":checked")}),this.infos=a.plateau;var c=DrawerFactory.dimensions.plateauSize;DrawerFactory.addInfo("defaultImage",a.images["default"]||{}),DrawerFactory.addInfo("textColor",this.infos.textColor||"#000000"),DrawerFactory.addInfo("backgroundColor",this.infos.backgroundColor||"#FFFFFF"),this.infos.argentJoueurDepart=this.infos.argent||15e4,this.infos.montantDepart=this.infos.depart||2e4,this.infos.colors&&(GestionJoueur.colorsJoueurs=this.infos.colors),this.infos.imgJoueurs&&(GestionJoueur.imgJoueurs=this.infos.imgJoueurs),"circle"==this.infos.type&&(DrawerFactory.setType("circle"),$(".graphic_element,.title").addClass("circle"),$("#idSavePanel").arctext({radius:80,dir:1}),$("#idSubTitle").hide(),$("#idInfoBox").unbind("mousewheel").bind("mousewheel",function(a,b){var c=$("#idInfoBox").scrollTop()+b*a.deltaFactor*-.7;$("#idInfoBox").scrollTop(c),a.preventDefault()})),CURRENCY=a.currency,this.titles=a.titles,this.infos.nomsJoueurs=this.infos.nomsJoueurs||[],GestionDes.gestionDes=VARIANTES.desRapide?new GestionDesRapideImpl:new GestionDesImpl,GestionDes.init(this.infos.rollColor),$("#idLancerDes").click(function(){GestionDes.lancer()}),this.drawing=DrawerFactory.getPlateau(0,0,c,c,this.infos.backgroundColor),Drawer.add(this.drawing,0),this._draw(a),Drawer.add(DrawerFactory.endPlateau(),2),Drawer.init(c,c),b&&b()},_buildCartes:function(a,b){return null!=a?a.cartes.map(function(a){return new b(a.nom,CarteActionFactory.get(a))}):[]},_draw:function(a){$("#idSubTitle").text(this.infos.subtitle),this.parcGratuit=null;var b=[],c=[],d=this;this.cartes.chance=this._buildCartes(a.chance,CarteChance),this.cartes.caisseCommunaute=this._buildCartes(a.communaute,CarteCaisseDeCommunaute),$(a.fiches).each(function(){var e=null;switch(null!=this.colors&&this.colors.length>0&&null==c[this.colors[0]]&&(c[this.colors[0]]=new Groupe(this.groupe,this.colors[0])),this.type){case"propriete":e=new Fiche(this.axe,this.pos,this.colors,this.nom,this.prix,this.loyers,this.prixMaison),c[this.colors[0]].add(e);break;case"compagnie":e=new FicheCompagnie(this.axe,this.pos,this.colors,this.nom,this.prix,this.loyers,a.images[this.img]||a.images.compagnie),c[this.colors[0]].nom="Compagnie",c[this.colors[0]].add(e);break;case"gare":e=new FicheGare(this.axe,this.pos,this.colors,this.nom,this.prix,this.loyers,a.images.gare),c[this.colors[0]].nom="Gare",c[this.colors[0]].add(e);break;case"chance":e=new CaseChance(this.axe,this.pos,a.images.chance,d.cartes.chance);break;case"communaute":e=new CaseCaisseDeCommunaute(this.axe,this.pos,a.images.caisseDeCommunaute,d.cartes.caisseCommunaute);break;case"taxe":e=new SimpleCaseSpeciale(this.nom,this.prix,this.axe,this.pos,"taxe",a.images.taxe);break;case"prison":e=new CaseActionSpeciale(this.nom,function(){GestionJoueur.getJoueurCourant().goPrison()},this.axe,this.pos,"prison");break;case"special":e=new CaseActionSpeciale(this.nom,function(){GestionJoueur.change()},this.axe,this.pos,"special");break;case"parc":d.parcGratuit=new ParcGratuit(this.axe,this.pos),e=d.parcGratuit;break;case"depart":e=new CaseActionSpeciale(this.nom,function(){var a=VARIANTES.caseDepart?2*InitMonopoly.plateau.infos.montantDepart:InitMonopoly.plateau.infos.montantDepart;GestionJoueur.getJoueurCourant().gagner(a),$.trigger("monopoly.depart",{joueur:GestionJoueur.getJoueurCourant(),montant:a}),GestionJoueur.change()},this.axe,this.pos,"depart")}null!=e&&(GestionFiche.add(e),null!=e.color&&null==b[e.color]&&($("style","head").prepend(".color_"+e.color.substring(1)+"{color:white;font-weight:bold;background-color:"+e.color+";}\n"),b[e.color]=1))}),this._calculateVoisins()},_calculateVoisins:function(){for(var a=null,b=0;42>b;b++){var c=Math.floor(b/10)%4,d=b%40-10*c,e=GestionFiche.get({axe:c,pos:d});null!=e.groupe&&e.isTerrain()&&(null==a&&(a=e.groupe),a.equals(e.groupe)||(e.groupe.groupePrecedent=a,a.groupeSuivant=e.groupe,a=e.groupe))}},enableMouse:function(a){this.drawing.enableCaseDetect(a)}},showPanel:function(){this._loadPlateaux(),this._configSauvegardePanel(),this.panelPartie.dialog({title:"Monopoly",closeOnEscape:!1,modal:!0,width:400,buttons:[{text:"Valider",click:function(){InitMonopoly._loadOrCreateGame()}}]})},_loadOrCreateGame:function(){""!=this.listSauvegarde.val()?(Sauvegarde.load(this.listSauvegarde.val()),this.panelPartie.dialog("close")):(this.plateau.load($("#idSelectPlateau").val(),function(){var a={};$("#idPartie",this.panelPartie).find("select[name],:text[name]").each(function(){a[$(this).attr("name")]=$(this).val()}),$("#idPartie",this.panelPartie).find(":checkbox[name]").each(function(){a[$(this).attr("name")]=$(this).is(":checked")}),InitMonopoly._createGame(a)}),this.panelPartie.dialog("close"))},_createGame:function(a){var b=this.plateau.infos.nomsJoueurs.length>0?this.plateau.infos.nomsJoueurs[0]:"";a=$.extend({},{nbPlayers:0,nbRobots:0,waitTimeIA:1,joueur:b},a);for(var c=0;c<a.nbPlayers;c++){var d="Joueur "+(c+1);0==c&&""!=a.joueur?d=a.joueur:this.plateau.infos.nomsJoueurs.length>c&&(d=this.plateau.infos.nomsJoueurs[c]),GestionJoueur.create(c>=a.nbPlayers-a.nbRobots,c,d)}this.afterCreateGame(),GestionJoueur.change(),IA_TIMEOUT=a.waitTimeIA||IA_TIMEOUT},afterCreateGame:function(){$(".info-joueur").tooltip({content:function(){var a=GestionJoueur.getById($(this).data("idjoueur")).getStats();return $("span[name]","#infoJoueur").each(function(){$(this).html(a[$(this).attr("name")])}),$("#infoJoueur").html()}}),EchangeDisplayer.init("idPanelEchange","idSelectJoueurs","idListTerrainsJoueur","idListTerrainsAdversaire")},_loadPlateaux:function(){this.plateaux=$("#idSelectPlateau"),$.ajax({url:"data/plateaux.json",dataType:"json",context:this,success:function(a){null!=a&&null!=a.plateaux&&a.plateaux.forEach(function(a){this.plateaux.append('<option value="'+a.url+'">'+a.name+"</option>")},this)}})},_configSauvegardePanel:function(){var a=Sauvegarde.findSauvegardes();this.listSauvegarde=$("#idSauvegardes");var b=this;a.length>0&&(a.forEach(function(a){this.listSauvegarde.append('<option value="'+a.value+'">'+a.label+"</option>")},this),$("#idDeleteSauvegarde").unbind("click").bind("click",function(){$("option:selected",b.listSauvegarde).length>0&&confirm("Etes vous sur de vouloir supprimer cette sauvegarde : "+b.listSauvegarde.val())&&(Sauvegarde["delete"](b.listSauvegarde.val()),$("option:selected",b.listSauvegarde).remove())}),$("#idLoadSauvegarde").unbind("click").bind("click",function(){""!=b.listSauvegarde.val()&&(Sauvegarde.load(b.listSauvegarde.val()),b.panelPartie.dialog("close"))}))},initPanels:function(){$("#message").dialog({autoOpen:!1}),$("#message").prev().css("background","url()"),$("#idSavePanel").click(function(){var a=Sauvegarde.isSauvegarde()?null:prompt("Nom de la sauvegarde (si vide, defini par defaut)");Sauvegarde.save(a)}),$("#achatMaisons").dialog({autoOpen:!1,title:"Achat de maisons /hotels",width:500,height:300}),$("#idTerrainsLibres").dialog({autoOpen:!1,title:"Liste des terrains libre",width:350,height:300,buttons:[{text:"Fermer",click:function(){$("#idTerrainsLibres").dialog("close")}}],open:function(){InitMonopoly._showFreeTerrains()}})},_showFreeTerrains:function(){$("#idTerrainsLibres").empty();for(var a=GestionFiche.getTerrainsLibres();a.hasNext();){var b=a.next();$("#idTerrainsLibres").append('<div style="font-weight:bold;color:'+b.color+'">'+b.nom+"</div>")}}};