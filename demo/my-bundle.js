(()=>{"use strict";var e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};function t(e,s){let i={...e};return Object.keys(s).forEach((e=>{null==i[e]||"object"!=typeof s[e]||Array.isArray(s[e])?i[e]=s[e]:i[e]=t(i[e],s[e])})),i}function s(){document.querySelectorAll(".action-joueur").forEach((e=>{e.classList.add("disabled"),e.setAttribute("disabled","disabled")}))}e.d({},{wA:()=>Ue,eM:()=>Ge,X2:()=>Ne,c_:()=>Re,lQ:()=>Xe,AM:()=>Ve,oZ:()=>Ze,RS:()=>Ke,pZ:()=>ze}),Object.defineProperty(Array.prototype,"size",{value:function(){let e=0;for(let t in this)e++;return e},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"contains",{value:function(e){for(let t in this)if(this[t]===e)return!0;return!1},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"filter",{value:function(e){const t=[];for(const s in this)e(this[s])&&t.push(this[s]);return t},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"some",{value:function(e){for(let t in this)if(e(this[t]))return!0;return!1},writable:!1,enumerable:!1,configurable:!1});const i=new class{constructor(){this.observers={}}network(e){this.send("event.network",e)}debug(e){this.send("monopoly.debug",e)}refresh(){this.send("refreshPlateau")}send(e,t={}){const s=this.observers[e];null!=s&&s.forEach((e=>e(t)))}observe(e,t){let s=this.observers[e];null==s&&(s=[],this.observers[e]=s),s.push(t)}watchRefresh(e){this.observe("refreshPlateau",e)}};let o=0,n={fontWeight:200,setFontWeight(e){this.fontWeight=e},fromDegresToRad:function(e){return e/180*Math.PI},drawCircle:function(e,t,s,i,o=t){e.fillStyle=t,e.strokeColor=o,e.beginPath(),e.arc(i.x,i.y,s,0,2*Math.PI),e.fill(),e.closePath()},drawArcCircle:function(e,t,s,i,o,n){e.beginPath(),e.fillStyle=t,e.moveTo(i.x,i.y),e.arc(i.x,i.y,s,o,n),e.fill(),e.closePath()},drawImage:function(e,t,s,i,o,n,r){e.save(),e.translate(s,i),e.rotate(r);try{e.drawImage(t,0,0,o,n)}catch(e){}e.restore()},_splitLine:function(e){if(e.some((function(e){return-1!==e.indexOf("\n")}))){let t=[];e.forEach((function(e){-1!==e.indexOf("\n")?e.split("\n").forEach((function(e){t.push(e)})):t.push(e)})),e=t}return e},writeText:function(e,t,s,i,o,n="7",r=a.dimensions.largeur,u){o.fillStyle=a.getInfo("textColor")||"#000000",o.font=`${this.fontWeight} `+n+"pt Arial";let l=this._splitLine([e]),h=[];l.forEach((function(e){if(o.measureText(e).width>r-5){let t=e.split(" "),s=[],i=0;for(let e=0;e<t.length;e++)i>0&&o.measureText(s[i-1]).width+o.measureText(t[e]).width<r-5?s[i-1]=s[i-1]+" "+t[e]:s[i++]=t[e];s.forEach((function(e){h.push(e)}))}else h.push(e)})),l=h,o.save(),o.translate(t,s),o.rotate(i);for(let e=0;e<l.length;e++){let t;switch(u){case"left":t=0;break;case"right":t=r-o.measureText(l[e]).width;break;default:t=(r-o.measureText(l[e]).width)/2}o.fillText(l[e],t,12*e)}o.font="6pt Times news roman",o.restore()}};class r{constructor(){this.id=o++}draw(){throw"Not implemented"}}let a={instances:[],type:null,infos:{},dimensions:{largeur:65,largeurPion:20,hauteur:100,bordure:40,plateauSize:800,innerPlateauSize:220,nbCases:10,textSize:7},setNbCases(e=10){this.dimensions.nbCases=e,this.computeDimensions()},computeDimensions(){this.dimensions.largeur=570/(this.dimensions.nbCases-1)+2,this.dimensions.hauteur=(this.dimensions.plateauSize-570-20)/2,this.dimensions.textSize=Math.round(this.dimensions.largeur/10)},init:function(){return this},setType:function(e){this.type=e},addInfo:function(e,t){this.infos[e]=t},getInfo:function(e){return this.infos[e]},addInstance:function(e){this.instances[e.type]=e},getDes:function(e,t,s){return this._instantiate("des",arguments)},getDesRapide:function(e,t,s){return this._instantiate("desRapide",arguments)},getCase:function(e,t,s,i,o,n){return this._instantiate("standardCase",arguments)},getCaseSpeciale:function(e,t){return this._instantiate("specialCase",arguments)},getPionJoueur:function(e){return this._instantiate("pionJoueur",arguments)},getPlateau:function(e,t,s,i,o){return this._instantiate("plateau",arguments)},endPlateau:function(){return this._instantiate("endPlateau",arguments)},_instantiate:function(e,t){if(null==this.instances[this.type])throw"Creation, type : "+this.type+" inconnu";return null==this.instances[this.type][e]?null:new this.instances[this.type][e](...t)}}.init(),u={components:[],height:0,width:0,interval:null,intervalRT:null,canvas:null,canvasRT:null,intervals:[],reset:function(){this.components=[],this.canvas&&this.clear(this.canvas),this.canvasRT&&this.clear(this.canvasRT)},add:function(e,t){null!=e&&(e.getId=function(){return u.canvas.canvas.id},e.order=null==t?0:t,u.components.push(e))},addRealTime:function(e){e.getId=function(){return u.canvasRT.canvas.id},u.components.push(e)},removeComponent:function(e){for(let t=0;t<this.components.length;t++)if(this.components[t].id===e.id)return void this.components.splice(t,1)},clear:function(e){e.clearRect(0,0,this.width,this.height)},refresh:function(e){u.clear(e);for(let t=0;t<u.components.length;t++)u.components[t].getId()===e.canvas.id&&u.components[t].draw(e)},setFrequency:function(e,t){null!=u.intervals[t.canvas.id]&&clearInterval(u.intervals[t.canvas.id]),u.intervals[t.canvas.id]=setInterval((function(){u.refresh(t)}),e)},init:function(e,t){if(null!=document.getElementById("canvas"))return this.components.sort((function(e,t){return e.order-t.order})),this.width=e,this.height=t,this.canvas=document.getElementById("canvas").getContext("2d"),this.canvasRT=document.getElementById("canvas_rt").getContext("2d"),this.canvas.strokeStyle="#AA0000",this.canvasRT.strokeStyle="#AA0000",this.refresh(this.canvas),this.setFrequency(50,this.canvasRT),i.watchRefresh((()=>u.refresh(u.canvas))),this}},l={terrain:null,callback:null,miseDepart:0,ventePerte:!1,pasVente:2e3,joueurLastEnchere:null,lastEnchere:0,nextMontantEnchere:0,currentJeton:0,joueursExit:[],endAckJoueurs:[],transaction:0,setPasVente(e){this.pasVente=e},init:function(e,t,s,o){this.terrain=e,this.callback=o,this.miseDepart=t,this.lastEnchere=0,this.endAckJoueurs=[],this.nextMontantEnchere=t,this.ventePerte=s,this.joueurLastEnchere=null,this.currentJeton=0,this.joueursExit=[],this.transaction++,i.send("monopoly.enchere.init",{maison:this.terrain,joueur:this.terrain.joueurPossede}),ue.forEach((e=>e.initEnchere(this.transaction,this.terrain,this.miseDepart))),this.runEnchere()},computeEncherisseurs:function(){let e=[],t=[];return ue.forEach((s=>{s.equals(this.terrain.joueurPossede)||s.equals(this.joueurLastEnchere)||null!=this.joueursExit[s.nom]||!1!==s.defaite?t.push(s):e.push(s)})),{encherisseurs:e,observers:t}},runEnchere:function(e=!1){let t=this.computeEncherisseurs();for(let s=0;s<t.encherisseurs.length;s++)t.encherisseurs[s].updateEnchere(this.transaction,this.currentJeton,this.nextMontantEnchere,this.joueurLastEnchere,e);for(let e=0;e<t.observers.length;e++)t.observers[e].updateInfoEnchere(this.nextMontantEnchere,this.joueurLastEnchere)},exitEnchere:function(e){null==this.joueursExit[e.nom]&&(this.joueursExit[e.nom]=e,ue.forEach((function(t){t.notifyExitEnchere(e)})),this.checkEndEnchere()&&this.manageEndEnchere())},checkEndEnchere:function(){return this.joueursExit.size()>=ue.getNb()||this.joueursExit.size()>=ue.getNb()-1&&(null!=this.terrain.joueurPossede||null!=this.joueurLastEnchere)||this.joueursExit.size()>=ue.getNb()-2&&null!=this.joueurLastEnchere&&null!=this.terrain.joueurPossede},doEnchere:function(e,t,s){if(s<this.currentJeton)throw"Trop lent, une enchere a deja ete faite";e.equals(this.joueurLastEnchere)||(this.currentJeton++,this.joueurLastEnchere=e,this.lastEnchere=t,this.nextMontantEnchere=this.lastEnchere+this.pasVente,this.checkEndEnchere()?this.manageEndEnchere():this.runEnchere())},checkEnchere:function(e){e>=this.currentJeton&&this.manageEndEnchere()},manageEndEnchere:function(){null==this.joueurLastEnchere?this.ventePerte&&this.nextMontantEnchere-this.pasVente>this.miseDepart/2?(this.nextMontantEnchere-=this.pasVente,this.joueursExit=[],this.runEnchere(!0)):(i.send("monopoly.enchere.fail",{maison:this.terrain}),this.endEnchere()):(null==this.terrain.joueurPossede?this.joueurLastEnchere.acheteMaison(this.terrain,this.lastEnchere):(this.joueurLastEnchere.payerTo(this.lastEnchere,this.terrain.joueurPossede),this.joueurLastEnchere.getSwapProperiete(this.terrain)),i.send("monopoly.enchere.success",{joueur:this.joueurLastEnchere,maison:this.terrain,montant:this.lastEnchere}),this.endEnchere())},endEnchere:function(){this.terrain=null,ue.forEach((e=>e.endEnchere(this.lastEnchere,this.joueurLastEnchere)))},checkEndNotify:function(e){this.endAckJoueurs[e.numero]=!0,this.endAckJoueurs.size()>=ue.getNb()&&this.doCallback()},doCallback:function(){this.callback&&this.callback()}},h={panel:null,currentMontant:0,currentEncherisseur:null,terrain:null,displayer:null,init:function(e){this.panel=document.getElementById(e)},display:function(e,t){this.terrain=e,this.displayer=t,this.panel.querySelector(".proprietaire").innerHTML=null!=e.joueurPossede?e.joueurPossede.nom:"Banque",this.panel.querySelector(".terrain").innerHTML=e.nom,this.panel.querySelector(".terrain").style.setProperty("color",e.color),this.panel.querySelector(".list_exit").innerHTML="",this.panel.querySelector(".list_encherisseurs").innerHTML="",this.panel.querySelector(".messages").innerHTML="",p.close(),p.open(this.panel,{title:"Mise au enchère",width:360,height:267})},displayCloseOption:function(e,t){null!=t?(this.panel.querySelector(".montant").innerHTML=e,this.panel.querySelector(".montant").style.setProperty("color","green"),this.panel.querySelector(".last_encherisseur").innerHTML=t.nom,t.equals(this.displayer)?this.panel.querySelector(".messages").append(document.createTextNode("Vous avez remporté l'enchère")):this.panel.querySelector(".messages").append(document.createTextNode(`${t.nom} a remporté l'enchère`))):this.panel.querySelector(".montant").style.setProperty("color","red"),p.updateButtons({Fermer:()=>h.close()})},clean:function(){this.panel.querySelector(".list_exit").innerHTML=""},showJoueurExit:function(e){this.panel.querySelector(".list_exit").insertAdjacentHTML("beforeend",`<div>${e.nom} est sorti</div>`)},exitEnchere:function(){p.clearButtons()},close:function(){l.doCallback(),p.close()},updateInfo:function(e,t,s,i){if(s&&null==i)throw"Impossible de gerer l'enchere";if(null!=this.currentMontant&&null!=this.currentEncherisseur&&(this.panel.querySelector(".list_encherisseurs").insertAdjacentHTML("afterbegin",`<p> ${Ue}  ${this.currentMontant} : ${this.currentEncherisseur.nom}</p>`),this.panel.querySelectorAll(".list_encherisseurs > p").forEach(((e,t)=>{t>3&&e.remove()}))),this.currentMontant=e,this.currentEncherisseur=t,this.panel.querySelector(".montant").innerHTML=e,null!=t&&(this.panel.querySelector(".last_encherisseur").innerHTML=t.nom),s){let t={Encherir:()=>l.doEnchere(h.displayer,e,i.jeton),Quitter:()=>l.exitEnchere(h.displayer)};p.updateButtons(t)}else p.clearButtons()}};const c={joueur:null,init:function(e,t,s,i){this.panel=document.getElementById(e),this.selectJoueurs=document.getElementById(t),this.listTerrainsJoueur=document.getElementById(s),this.listTerrainsAdversaire=document.getElementById(i),ue.forEach((e=>this.selectJoueurs.insertAdjacentHTML("beforeend",`<option value="${e.id}">${e.nom}</option>`))),this.selectJoueurs.onchange=e=>{this.listTerrainsAdversaire.querySelectorAll("optgroup").forEach((e=>e.remove()));const t=ue.getById(e.currentTarget.value);null!=t&&Object.values(t.maisons.getMaisonsGrouped()).forEach((e=>{let t=document.createElement("optgroup");t.label=`Groupe ${e.groupe}`,t.style.setProperty("color",e.color),e.terrains.forEach((e=>t.insertAdjacentHTML("beforeend",`<option value="${e.id}">${e.nom}</option>`))),c.listTerrainsAdversaire.append(t)}))}},open:function(e){this.joueur=e,this.selectJoueurs.querySelectorAll("option").forEach((e=>e.style.setProperty("display",""))),this.selectJoueurs.querySelector(`option[value="${e.id}"]`).style.setProperty("display","none"),this.listTerrainsJoueur.innerHTML="",f.showNativeTerrainByGroup(c.listTerrainsJoueur,e);const t={Annuler:()=>c.close(),Proposer:()=>c.propose()};p.open(this.panel,{title:"Echange de terrains",width:400,height:600,buttons:t})},propose:function(){let e=ue.getById(c.selectJoueurs.value),t=G.getById(this.listTerrainsAdversaire.value);if(null==e||null==t)return;d.init(this.joueur,e,t,null);let s={terrains:[],compensation:0};this.listTerrainsJoueur.querySelectorAll("input:checked").forEach((e=>s.terrains.push(G.getById(e.value)))),s.compensation=parseInt(document.getElementById("idArgentProposition").value)||0,this.close(),d.propose(s)},close:function(){p.close(),this.selectJoueurs.value=""}};let d={running:!1,demandeur:null,proprietaire:null,terrain:null,proposition:null,initialProposition:null,endCallback:null,init:function(e,t,s,o){if(this.running)throw"Transaction impossible, une transaction est deja en cours.";this.running=!0,this.demandeur=e,this.proprietaire=t,this.terrain=s,this.endCallback=o,i.send("monopoly.echange.init",{joueur:e,maison:s})},end:function(){this.running=!1,this.demandeur=null,this.proprietaire=null,this.terrain=null,null!=this.endCallback&&this.endCallback(),this.endCallback=null},propose:function(e){this.proposition=e,this.initialProposition=e,i.send("monopoly.echange.propose",{joueur:d.demandeur,proposition:e}),this.proprietaire.traiteRequeteEchange(this.demandeur,this.terrain,e)},contrePropose:function(e,t){i.send("monopoly.echange.contrepropose",{joueur:this.proprietaire,proposition:e}),this.proposition=e,t.equals(this.demandeur)?this.proprietaire.traiteContreProposition(e,t,this.terrain):this.demandeur.traiteContreProposition(e,t,this.terrain)},abort:function(){this.end()},accept:function(e){i.send("monopoly.echange.accept",{joueur:e}),e.equals(this.demandeur)?this.proprietaire.notifyAcceptProposition((function(){d._doAccept()})):this.demandeur.notifyAcceptProposition((function(){d._doAccept()}))},_doAccept:function(){if(this.demandeur.getSwapProperiete(this.terrain),null!=this.proposition.compensation&&this.demandeur.payerTo(this.proposition.compensation,this.proprietaire),null!=this.proposition.terrains&&this.proposition.terrains.length>0)for(const e in this.proposition.terrains)this.proprietaire.getSwapProperiete(this.proposition.terrains[e]);this.end()},reject:function(e){i.send("monopoly.echange.reject",{joueur:e}),e.equals(this.demandeur)?this.proprietaire.notifyRejectProposition((function(){d.end()}),this.terrain,this.initialProposition):this.demandeur.notifyRejectProposition((function(){d.end()}),this.terrain,this.proposition)}};const p=new class{open(e,{title:t="",buttons:s={},width:i,height:o,colorTitle:n="",colorButtons:r=""}){this.current=e,e.style.setProperty("display","");const a=document.querySelector("#idMessagePanel");a.style.setProperty("display","block");const u=a.querySelector(".title-panel");u.textContent=t,""===t?u.style.setProperty("display","none"):(u.style.setProperty("background-color",n),u.style.setProperty("display","")),this.setSize(a,i,o);const l=a.querySelector(".buttons");l.before(e),l.style.setProperty("background-color",r),Object.entries(s).map(m).forEach((e=>l.append(e))),document.querySelector("body").append(a)}clearButtons(){this.updateButtons({})}updateButtons(e){const t=document.getElementById("idMessagePanel").querySelector(".buttons");t.innerHTML="",Object.entries(e).map(m).forEach((e=>t.append(e)))}close(e=(()=>{})){if(null==this.current)return e(),!1;this.current.style.setProperty("display","none"),document.querySelector("body").append(this.current);const t=document.querySelector("#idMessagePanel");return t.style.setProperty("display","none"),t.querySelector(".buttons").textContent="",this.current=null,e(),!0}setSize(e,t,s){const i=e.querySelector(".wrapper-panel");i.style.setProperty("width",`${t}px`),i.style.setProperty("height",`${s}px`),i.style.setProperty("left",`calc(50% - ${t/2}px)`)}updateTitle(e){document.querySelector("#idMessagePanel").querySelector(".title-panel").textContent=e}};function m([e,t]){const s=document.createElement("button");return s.textContent=e,s.onclick=t,s}const g={detailFiche:null,detailJunior:null,detailFicheCompagnie:null,fiche:null,ficheJunior:null,currentFiche:null,init:function(){this.fiche=document.querySelector("#fiche"),this.ficheJunior=document.querySelector("#ficheJunior"),this.detailFiche=this._cloneFiche(this.fiche,"idDetailFiche"),this.detailFicheJunior=this._cloneFiche(this.ficheJunior,"idDetailFicheJunior"),this.detailFicheCompagnie=this._cloneFiche(document.querySelector("#ficheCompagnie"),"ficheCompagnie")},_cloneFiche(e,t){const s=e.cloneNode(!0);return s.id=t,s.classList.add("detail-fiche"),s.style.setProperty("display","none"),document.querySelector("body").append(s),s},openDetail:function(e,t){let s="compagnie"===e.type?this.detailFicheCompagnie:"junior"===e.type?this.detailFicheJunior:this.detailFiche;return null!=this.currentFiche&&this.currentFiche.axe===e.axe&&this.currentFiche.pos===e.pos?"none"===s.style.display?s.style.setProperty("display","block"):s.style.setProperty("display","none"):null==this.currentFiche||this.currentFiche.axe===e.axe&&this.currentFiche.pos===e.pos?(t.after(s),this.loadDetailFiche(e,s),s.style.setProperty("display","block"),void(this.currentFiche=e)):(this.currentFiche=null,s.style.setProperty("display","none"),document.querySelector("body").insertAdjacentHTML("afterend",s),this.openDetail(e,t))},close:function(){ue.change()},loadFiche:function(e){this._load(e,"junior"===e.type?this.ficheJunior:this.fiche,e.secondColor)},loadDetailFiche:function(e,t){this._load(e,t,e.secondColor)},_name:function(e){return e.getAttribute("class")},_load:function(e,t,s){t.style.setProperty("background-color",s),t.querySelectorAll('td[class^="loyer"]').forEach((t=>t.innerHTML=e.loyer[parseInt(this._name(t).substring(5))])),t.querySelectorAll('td[class]:not([class^="loyer"]), span[class]:not([class^="loyer"])').forEach((t=>t.innerHTML=e[this._name(t)])),t.querySelectorAll(".loyer0").forEach((t=>t.innerHTML="gare"===e.type?e.getLoyer():!0===e.isGrouped()?2*parseInt(e.loyer[0]):e.loyer[0])),t.querySelectorAll("tr, .infos-group").forEach((e=>e.classList.remove("nbMaisons"))),t.querySelectorAll(`.loyer${e.nbMaison}`).forEach((e=>e.parentElement.classList.add("nbMaisons"))),0===e.nbMaison&&!0===e.isGrouped()&&t.querySelector(".infos-group").classList.add("nbMaisons"),t.querySelectorAll(".maison").forEach((t=>t.style.setProperty("display","gare"===e.type?"none":"")))},closeFiche:function(){p.close(),this.close()}};let f={panel:null,joueur:null,init:function(e){this.panel=document.getElementById(e)},show:function(e,t,s,i,o){this.showPropose(e,t,s,i,o),this.addMessage("Que souhaitez vous faire",[{nom:"Accepter",action:()=>{f.close(),d.accept(f.joueur)}},{nom:"Refuser",action:()=>{f.close(),d.reject(f.joueur)}},{nom:"Négocier",action:()=>f._showContrePanel(e)}],!0)},showPropose:function(e,t,s,i,o){this.joueur=o,this.demandeur=e,p.updateTitle(`Echange entre ${e.nom} et ${t.nom}`),this.panel.querySelectorAll(".proposition,.communications").forEach((e=>e.innerHTML="")),this.panel.querySelector(".proposition").insertAdjacentHTML("beforeend",`<div>Terrain : <span style="font-weight:bold;color:${s.color}">${s.nom}</div>`),this._showProposition(this.panel.querySelector(".proposition"),i)},showNativeTerrainByGroup(e,t){this.panel.querySelector(".communications").innerHTML="",Object.values(t.maisons.getMaisonsGrouped()).forEach((t=>{const s=document.createElement("div");s.classList.add("group-propriete"),s.style.setProperty("color",t.color),s.insertAdjacentHTML("beforeend",`<div>Groupe ${t.groupe}</div>`),t.terrains.forEach((e=>s.insertAdjacentHTML("beforeend",`<input type="checkbox" value="${e.id}" id="chk_id_${e.id}"/><label for="chk_id_${e.id}">${e.nom}</label><br/>`))),e.append(s)}))},_showContrePanel:function(e,t){const s=document.createElement("div");s.classList.add("contreProposition"),this.showNativeTerrainByGroup(s,e),s.insertAdjacentHTML("beforeend",'Argent : <input class="argent" type="text"/>'),this.panel.querySelector(".communications").append(s),this.addMessage("Quelle est votre contreproposition ?",[{nom:"Proposer",action:()=>f._doContreproposition(f.joueur)},{nom:"Rejeter",action:()=>{f.close(),d.reject(f.joueur)}}],!0)},_doContreproposition:function(e){let t={terrains:[],compensation:0};this.panel.querySelectorAll(".contreProposition :checked").forEach((e=>{let s=G.getById(e.value);null!=s&&t.terrains.push(s)})),t.compensation=parseInt(document.querySelector('.contreProposition input[type="text"].argent').value)||0,d.contrePropose(t,e)},_showProposition:(e,t)=>{if(e.append(document.createTextNode("Proposition : ")),t.terrains.length>0)for(let s in t.terrains){let i=t.terrains[s];e.insertAdjacentHTML("beforeend",`<div style="padding-left:20px;color:${i.color}">${i.nom}</div>`)}e.insertAdjacentHTML("beforeend",`<div style="padding-left:20px;">Argent : ${Ue} ${t.compensation}</div>`)},showAccept:function(e=(()=>{})){this.addMessage('La proposition a été <span style="color:green">acceptée</span>',[{nom:"Fermer",action:()=>{f.close(),e()}}])},showReject:function(e=(()=>{})){this.addMessage('La proposition a été <span style="color:red">rejetée</span>.',[{nom:"Fermer",action:()=>{f.close(),e()}}])},showContreProposition:function(e){this.addMessage("Une contreproposition a été faite",[{nom:"Refuser",action:()=>{f.close(),d.reject(f.joueur)}},{nom:"Accepter",action:()=>{f.close(),d.accept(f.joueur)}}]),this._showProposition(this.panel.querySelector(".communications"),e)},addMessage:function(e,t,s){if(s||this.panel.querySelector(".communications").append(document.createElement("hr")),this.panel.querySelector(".communications").insertAdjacentHTML("beforeend",`<p style="font-weight: bold">${e}</p>`),null!=t&&t.length>0){let e=[];t.forEach((t=>e[t.nom]=t.action)),p.updateButtons(e),this.open()}},close:function(){p.close()},open:function(){p.open(this.panel,{title:`Echange de terrain par ${null!=this.demandeur?this.demandeur.nom:""}`,height:507,width:400})}},y={div:null,order:0,init:function(e,t){this.div=document.getElementById(e),this.div.innerHTML="",t||this.bindEvents()},write:function(e,t){y.order++;let s=Ge?" ("+y.order+")":"";this.div.insertAdjacentHTML("afterbegin",`<div><span style="color:${e.color}">${e.nom}</span> : ${t}${s}</div>`)},_buildProposition:function(e){if(null==e)return"";let t="";return null!=e.terrains&&e.terrains.length>0&&(t=e.terrains.reduce(((e,t)=>this.events._buildTerrain(t)+", "+e),"")),e.compensation>0&&(t+=` compensation : ${e.compensation} ${Ue}`),t},events:{write(e,t){y.write(e,t)},_buildTerrain:function(e){return null==e?"":`<span style="font-weight:bold;color:${e.color}">${e.nom}</span>`},people:(e,t="black")=>({color:t,nom:e}),save(e){this.write(this.people("info","green"),`sauvegarde de la partie (${e.name})`)},depart(e){this.write(e.joueur,`s'arrête sur la case départ et gagne ${e.montant} ${Ue}`)},initEnchere(e){this.write(null!=e.joueur?e.joueur:this.people("La banque"),`met aux enchères  ${this._buildTerrain(e.maison)}`)},failEnchere(e){this.write(this.people("Commissaire priseur","red"),`le terrain ${this._buildTerrain(e.maison)} n'a pas trouvé preneur`)},successEnchere(e){this.write(e.joueur,`achète aux enchères le terrain ${this._buildTerrain(e.maison)} pour ${Ue} ${e.montant}`)},message(e){},caisseCommunaute(e){this.write(e.joueur,`carte caisse de communauté : ${e.message}`)},chance(e){this.write(e.joueur,`carte chance : ${e.message}`)},achete(e){this.write(e.joueur,`achète ${this._buildTerrain(e.maison)}`)},home(e){this.write(e.joueur,`tombe sur ${this._buildTerrain(e.maison)} . Il est chez lui.`)},visite(e){this.write(e.joueur,`tombe sur ${this._buildTerrain(e.maison)}`)},vend(e){this.write(e.joueur,`vends ${e.nbMaison} maison(s)</span>`)},exit(e){this.write(e.joueur,"s'est déconnecté</span>")},loyer(e){let t=e.maison,s=`<span style="font-weight:bold;color:${t.color}"> ${t.nom}</span>`,i=`<span style="color:${t.joueurPossede.color}">${t.joueurPossede.nom}</span>`;this.write(e.joueur,`tombe sur ${s} et paye ${t.getLoyer()} ${Ue} à ${i}`)},start(){this.write(this.people("Monopoly"),"La partie peut commencer")},player(e){"Distant"===e.joueur.type?this.write(this.people("Monopoly"),"un siège est disponible"):this.write(e.joueur,"rentre dans la partie")},hypotheque(e){this.write(e.joueur,`hypothèque ${this._buildTerrain(e.maison)}`)},leveHypotheque(e){this.write(e.joueur,`lève l'hypothèque de ${this._buildTerrain(e.maison)}`)},prison(e){this.write(e.joueur,"va en prison")},lanceDes(e){let t=`lance les dés et fait ${e.total} (${e.combinaison})`;null!=e.prison&&(!0===e.prison.sortie?(t+=" et sort de prison",e.prison.montant>0&&(t+=` en payant ${Ue} ${e.prison.montant}`)):t+=" et reste en prison"),null!=e.double&&(!0===e.double.triple&&(t+=", a fait 3 doubles et va en prison"),!0===e.double.replay&&(t+=" et rejoue")),this.write(e.joueur,t)},desBus(e){this.write(e.joueur,` prend le bus et fait ${e.total}`)},desMrMonopoly(e){this.write(e.joueur,` fait un Mr Monopoly et va sur ${this._buildTerrain(e.maison)}`)},desTriple(e){this.write(e.joueur,` fait un triple et choisi d'aller à ${this._buildTerrain(e.maison)}`)},sortiePrison(e){let t="sort de prison";!0===e.paye&&(t+=" en payant"),!0===e.carte&&(t+=" en utilisant une carte sortie de prison"),e.paye||e.carte||(t+=" en faisant un double"),this.write(e.joueur,t)},construit(e){let t="",s=e.achats;if(s.maison>0?t+=`achète ${s.maison} maison(s) `:s.maison<0&&(t+=`vend ${-1*s.maison} maison(s) `),s.hotel>0?t+=(""!==t?" et ":"")+`achète ${s.hotel}  hôtel(s) `:s.hotel<0&&(t+=(""!==t?" et ":"")+`vend ${-1*s.hotel} hôtel(s) `),null!=s.terrains&&s.terrains.size()>0){t+=" sur ";for(let e in s.terrains)t+=this._buildTerrain(s.terrains[e])+", "}""!==t&&this.write(e.joueur,t)},initEchange(e){let t=`souhaite obtenir ${this._buildTerrain(e.maison)} auprès de ${e.maison.joueurPossede.nom}`;this.write(e.joueur,t)},proposeEchange(e){this.write(e.joueur,`propose : ${y._buildProposition(e.proposition)}`)},accepteEchange(e){this.write(e.joueur,"accepte la proposition")},rejetteEchange(e){this.write(e.joueur,"rejete la proposition")},contreEchange(e){this.write(e.joueur,`fait une contre-proposition ${y._buildProposition(e.proposition)}`)},defaite(e){this.write(e.joueur,"a perdu et quitte la partie")},victoire(e){this.write(e.joueur,"a gagné la partie")},waitPlayers(e){this.write(this.people("Monopoly"),`Partie n°${e.idGame} créée, en attente de ${e.nb} joueur(s)...`)},debug(e){Ge&&this.write(this.people("debug","red"),e.message)}},bindEvents:function(){i.observe("monopoly.save",(e=>this.events.save(e))),i.observe("monopoly.start",(()=>this.events.start())),i.observe("monopoly.depart",(e=>this.events.depart(e))),i.observe("monopoly.exit",(e=>this.events.exit(e))),i.observe("monopoly.enchere.init",(e=>this.events.initEnchere(e))),i.observe("monopoly.enchere.fail",(e=>this.events.failEnchere(e))),i.observe("monopoly.enchere.success",(e=>this.events.successEnchere(e))),i.observe("monopoly.caissecommunaute.message",(e=>this.events.caisseCommunaute(e))),i.observe("monopoly.chance.message",(e=>this.events.chance(e))),i.observe("monopoly.acheteMaison",(e=>this.events.achete(e))),i.observe("monopoly.chezsoi",(e=>this.events.home(e))),i.observe("monopoly.visiteMaison",(e=>this.events.visite(e))),i.observe("monopoly.vendMaison",(e=>this.events.vend(e))),i.observe("monopoly.payerLoyer",(e=>this.events.loyer(e))),i.observe("monopoly.newPlayer",(e=>this.events.player(e))),i.observe("monopoly.hypothequeMaison",(e=>this.events.hypotheque(e))),i.observe("monopoly.leveHypothequeMaison",(e=>this.events.leveHypotheque(e))),i.observe("monopoly.goPrison",(e=>this.events.prison(e))),i.observe("monopoly.derapide.bus",(e=>this.events.desBus(e))),i.observe("monopoly.derapide.triple",(e=>this.events.desTriple(e))),i.observe("monopoly.derapide.mrmonopoly",(e=>this.events.desMrMonopoly(e))),i.observe("monopoly.exitPrison",(e=>this.events.sortiePrison(e))),i.observe("monopoly.acheteConstructions",(e=>this.events.construit(e))),i.observe("monopoly.echange.init",(e=>this.events.initEchange(e))),i.observe("monopoly.echange.propose",(e=>this.events.proposeEchange(e))),i.observe("monopoly.echange.accept",(e=>this.events.accepteEchange(e))),i.observe("monopoly.echange.reject",(e=>this.events.rejetteEchange(e))),i.observe("monopoly.echange.contrepropose",(e=>this.events.contreEchange(e))),i.observe("monopoly.defaite",(e=>this.events.defaite(e))),i.observe("monopoly.victoire",(e=>this.events.victoire(e))),i.observe("monopoly.waitingPlayers",(e=>this.events.waitPlayers(e))),i.observe("monopoly.debug",(e=>this.events.debug(e)))}};const b=new class{init(e){this.div=document.getElementById(e)}_debug(e,t){i.debug({message:t})}createGeneric(e,t,s,i,o){this._debug(t,i),this.div.innerHTML=i;let n={};return o.forEach((e=>n[e.title]=()=>{p.close(),e.fct()})),(e.canPlay||forceshow)&&p.open(this.div,{title:t,colorTitle:s,buttons:n,height:220,width:400}),n}create(e,t,s,i,o=(()=>{}),n,r,a={}){this._debug(t,i),this.div.innerHTML=i;const u={Ok:function(){p.close((()=>o(n)))}};for(let e in a)u[e]=a[e];return(e.canPlay||r)&&p.open(this.div,{title:t,colorTitle:s,buttons:u,height:220,width:400}),u}close(e=(()=>{})){this.div.dialog("isOpen")&&this.div.dialog("close"),e()}createPrison(e,t,s,i){this.div.innerHTML="Vous êtes en prison, que voulez vous faire";const o=`Vous êtes en prison depuis ${s} tours.`;this._debug(o,message);const n={Payer:function(){t.payer(e),t.exitPrison({paye:!0,notify:!0}),p.close(i)},Attendre:()=>p.close(i)};return t.cartesSortiePrison.length>0&&(n["Utiliser carte"]=()=>{t.utiliseCarteSortiePrison(),t.exitPrison({carte:!0,notify:!0}),p.close(i)}),t.canPlay&&p.open(this.div,{title:o,buttons:n,colorTitle:"red",height:220,width:400}),n}};let v={nbInitHouse:32,nbInitHotel:12,nbSellHouse:0,nbSellHotel:0,reset:function(){this.nbInitHouse=32,this.nbInitHotel=12,this.nbSellHouse=0,this.nbSellHotel=0},isFreeHouse:function(){return this.nbInitHouse>this.nbSellHouse},isFreeHotel:function(e){if(null==e)return this.nbInitHotel>this.nbSellHotel;const t=4-e;return this.nbInitHotel>this.nbSellHotel&this.nbInitHouse>=this.nbSellHouse+t},getRestHouse:function(){return this.nbInitHouse-this.nbSellHouse},getRestHotel:function(){return this.nbInitHotel-this.nbSellHotel},sellHotel:function(){this.nbSellHotel--},sellHouse:function(){this.nbSellHouse--},buyHouse:function(){if(!this.isFreeHouse())throw"Impossible d'acheter une maison.";this.nbSellHouse++},buyHouses:function(e){if(e>this.getRestHouse())throw"Impossible d'acheter les maisons.";this.nbSellHouse+=e},buyHotels:function(e){if(e>this.getRestHotel())throw"Impossible d'acheter les hotels.";this.nbSellHotel+=e},buyHotel:function(){if(!this.isFreeHouse())throw"Impossible d'acheter un hotel.";this.nbSellHotel++,this.nbSellHouse-=4},simulateBuy:function(e){let t={achat:{maison:0,hotel:0},reste:{maison:this.nbInitHouse-this.nbSellHouse,hotel:this.nbInitHotel-this.nbSellHotel}},s={venteMaison:function(e,t){"maison"===e.from.type&&"maison"===e.to.type&&e.from.nb>e.to.nb&&i(e,t)},achatHotel:function(t,i){if("maison"===t.from.type&&"hotel"===t.to.type){for(let o in e){let n=e[o];n.color===t.color&&"maison"===n.from.type&&"maison"===n.to.type&&4===n.to.nb&&s.achatMaison(n,i)}const o=4-t.from.nb;if(o>i.reste.maison)return void(i.reste.maison-=o);i.reste.hotel--,i.achat.hotel++,i.reste.maison+=t.from.nb,i.achat.maison-=t.from.nb,t.done=!0}},venteHotel:function(e,t){if("hotel"===e.from.type&&"maison"===e.to.type){if(e.to.nb>t.reste.maison)return void(t.reste.maison-=e.to.nb);t.reste.hotel++,t.achat.hotel--,t.reste.maison-=e.to.nb,t.achat.maison+=e.to.nb,e.done=!0}},achatMaison:function(e,t){"maison"===e.from.type&&"maison"===e.to.type&&e.from.nb<e.to.nb&&i(e,t)}},i=(e,t)=>{let s=e.from.nb-e.to.nb;t.achat.maison-=s,t.reste.maison+=s,e.done=!0};for(let i in s){let o=s[i];for(let s in e){let i=e[s];if(null==i.done)try{o(i,t)}catch(e){return console.log("exception",e),t}}}return t}};function P(e){return fetch(e).then((e=>e.json()))}function w(e,t=""){return fetch(e,{method:"POST",body:t}).then((e=>e.json()))}let x={gestionDes:null,init:function(e){this.gestionDes.init(e)},lancer:function(){this.gestionDes.lancer()},isDouble:function(){return this.gestionDes.isDouble()},continuePlayer:function(){return this.gestionDes.continuePlayer()},resetDouble:function(){return this.gestionDes.resetDouble()},total:function(){return this.gestionDes.total()},isSpecificAction:function(){return this.gestionDes.isSpecificAction()},doSpecificAction:function(){return this.gestionDes.doSpecificAction()}};class j{throw(e){let t=[];for(let s=0;s<e;s++)t[s]=this.throwOne();return new Promise((e=>e(t)))}throwOne(){return Math.round(1e3*Math.random())%6+1}}class M{throw(e){return function(e){return P(`dices?nb=${e}`)}(e)}}let C={instance:new j,useLocal(){this.instance=new j},useRemote(){this.instance=new M},throw(e){return this.instance.throw(e)}};class S{constructor(e,t){this.parcGratuit=t,this.nbAnimation=8,this.cube={des1:null,des2:null},this.des1=0,this.des2=0,this.nbDouble=0,this.rollColor="#000000",this.montantPrison=e}init(e){this._init(e)}_init(e){this.cube.des1=a.getDes(150,200,50),this.cube.des2=a.getDes(210,200,50),u.addRealTime(this.cube.des1),u.addRealTime(this.cube.des2),this.rollColor=e}resetDouble(){this.nbDouble=0}_rand(){return Math.round(1e3*Math.random())%6+1}isSpecificAction(){return!1}doSpecificAction(){}before(e){if(ue.getJoueurCourant().enPrison){let t=b.createPrison(this.montantPrison,ue.getJoueurCourant(),ue.getJoueurCourant().nbDouble,(function(){e()}));ue.getJoueurCourant().actionAvantDesPrison(t)}else e()}treatPrison(){let e=ue.getJoueurCourant();if(this.isDouble()){let t=b.create(e,"Libere de prison","lightblue","Vous etes liberes de prison grace a un double",(()=>{e.exitPrison({notrigger:!0,notify:!0}),this.endLancer()}),{});return this.nbDouble++,e.actionApresDes(t,null),{prison:{sortie:!0,montant:0},end:!0}}if(2===e.nbDouble){let t=`Vous etes liberes de prison, mais vous devez payer ${Ue} ${this.montantPrison} !`,s=b.create(e,"Libere de prison","lightblue",t,(()=>{e.payerParcGratuit(this.parcGratuit,this.montantPrison,(()=>{e.exitPrison({notrigger:!0,paye:!0,notify:!0}),this.endLancer()}))}),{});return e.actionApresDes(s,null),{prison:{sortie:!0,montant:this.montantPrison},end:!0}}{e.nbDouble++;let t=b.create(e,`Tour ${e.nbDouble}`,"red","Vous restez en prison, vous n'avez pas fait de double.",(()=>ue.change()),{});return e.actionApresDes(t,null),{prison:{sortie:!1},end:!0}}}after(){let e={total:this.total(),combinaison:this.combinaisonDes(),joueur:ue.getJoueurCourant()};!0===ue.getJoueurCourant().enPrison?e=t(e,this.treatPrison()):this.isDouble()&&(e=t(e,this.treatDouble())),y.events.lanceDes(e),this.notifyDices(e),!0!==e.end&&this.endLancer()}combinaisonDes(){return this.des1+" et "+this.des2}treatDouble(){return this._doTreatDouble()}_doTreatDouble(){if(this.nbDouble>=2){let e=b.create(ue.getJoueurCourant(),"Allez en prison","red","Vous avez fait 3 doubles, vous allez en prison",(()=>{this.des2++,ue.getJoueurCourant().goPrison()}),{});return ue.getJoueurCourant().actionApresDes(e,null),{double:{status:!1,triple:!0},end:!0}}return this.nbDouble++,{double:{status:!0,replay:!0}}}endLancer(){ue.getJoueurCourant().joueDes(this.total()),this.showReload()}showReload(){document.getElementById("idReloadDice").style.setProperty("display",this.isDouble()?"":"none")}continuePlayer(){return this.isDouble()}isDouble(){return this.des1===this.des2}lancer(){this.before((()=>{this._randDes(),document.getElementById("idReloadDice").style.setProperty("display","none"),this._anime()}))}notifyDices(e){ue.getJoueurCourant().notifyDices([this.des1,this.des2,0],e)}setDices(e,t){this.des1=e,this.des2=t}async _randDes(){await C.throw(2).then((e=>this.setDices(e[0],e[1])))}_anime(){s();let e=Re.quickMove?-1:this.nbAnimation;const t=this,i=setInterval((function(){if(e--<0)return clearInterval(i),t._drawCubes(t.des1,t.des2,t.desRapide),void t.after();t._drawCubes(t._rand(),t._rand(),t._rand()%3+1,t.rollColor)}),100)}setAndShowDices(e,t){null!=e.prison&&null!=e.prison.sortie&&!1===e.prison.sortie&&ue.getJoueurCourant().nbDouble++,e.joueur=t,this.setDices(e.dice1,e.dice2,e.quickDice),this._drawCubes(e.dice1,e.dice2,e.quickDice),e.total=this.total(),e.combinaison=this.combinaisonDes(),y.events.lanceDes(e)}_drawCubes(e,t,s,i="black"){this.cube.des1.setValue(e,i),this.cube.des2.setValue(t,i)}total(){return this.des1+this.des2}}class E extends S{constructor(e,t){super(e,t),this.cube.desRapide=null,this.desRapide=0}init(e){this._init(e),this.cube.desRapide=a.getDesRapide(270,210,35),u.addRealTime(this.cube.desRapide)}isSpecificAction(){return!ue.joueurCourant.enPrison&&this._isMonopolyMan()}doSpecificAction(){this.desRapide=0;let e=ue.getJoueurCourant().getPosition(),t=G.isFreeFiches()?G.getNextFreeTerrain(e):G.getNextTerrain(e);i.send("monopoly.derapide.mrmonopoly",{joueur:ue.getJoueurCourant(),maison:t}),ue.getJoueurCourant().joueSurCase(t)}setDices(e,t,s){this.des1=e,this.des2=t,ue.getJoueurCourant().enPrison||ue.getJoueurCourant().isFirstRound()?this.desRapide=0:this.desRapide=s}notifyDices(e){ue.getJoueurCourant().notifyDices([this.des1,this.des2,this.desRapide],e)}async _randDes(){await C.throw(3).then((e=>this.setDices(e[0],e[1],e[2])))}total(){let e=this.des1+this.des2;return!this.isDouble()&&this._isValue()&&(e+=this.desRapide),e}continuePlayer(){return this.isDouble()&&!this.isTriple()}isTriple(){return this.des1===this.des2&&this.des2===this.desRapide&&this.des1<=3}combinaisonDes(){if(this.isTriple())return"triple "+this.des1;const e=this.des1+", "+this.des2;return this.isDouble()?e:e+" et "+(this._isBus()?" Bus":this._isMonopolyMan()?"Mr Monopoly":this.desRapide)}treatDouble(){return this.isTriple()?(ue.getJoueurCourant().choisiCase((e=>{ue.getJoueurCourant().joueSurCase(e),i.send("monopoly.derapide.triple",{joueur:ue.getJoueurCourant(),maison:e})})),{double:{status:!0}}):(this.desRapide=0,this._doTreatDouble())}_isBus(){return 5===this.desRapide}_isMonopolyMan(){return 4===this.desRapide||6===this.desRapide}_isValue(){return this.desRapide<=3}showReload(){document.getElementById("idReloadDice").style.setProperty("display",this.isDouble()&&!this.isTriple()?"":"none")}endLancer(){this.showReload(),this.isTriple()||(this.isDouble()||!this._isBus()?(this.isDouble()&&(this.desRapide=0,document.getElementById("idReloadDice").style.setProperty("display","")),ue.getJoueurCourant().joueDes(this.total())):ue.getJoueurCourant().choisiDes(this.des1,this.des2,(function(e){i.send("monopoly.derapide.bus",{joueur:ue.getJoueurCourant(),total:e}),ue.getJoueurCourant().joueDes(e)})))}_drawCubes(e,t,s,i){this.cube.des1.setValue(e,i),this.cube.des2.setValue(t,i),this.isDouble()&&!this.isTriple()&&(s=0),ue.getJoueurCourant().enPrison?this.cube.desRapide.setValue(0,i):this.cube.desRapide.setValue(s,i)}}class q{constructor(e,t,s){this.axe=e,this.pos=t,this.id=e+"-"+t,this.type=s}isTerrain(){return"terrain"===this.type}isPropriete(){return"terrain"===this.type||"junior"===this.type||"gare"===this.type||"compagnie"===this.type}}class T extends q{constructor(e,t){super(e,t,"parc"),this.montant=null,this._titre="Parc Gratuit",this.nom=this._titre,this.drawing=a.getCaseSpeciale(0,this._titre),u.add(this.drawing),this.setMontant(0)}setMontant(e){this.montant=e,this.drawing.titre=this._titre+(this.montant>0?"\n"+Ue+" "+this.montant:""),i.refresh(),document.getElementById("idMontantParc").querySelector("span").innerText=this.montant}payer(e){this.setMontant(this.montant+e)}action(){return b.create(ue.getJoueurCourant(),"Parc gratuit","lightblue","Vous gagnez "+this.montant+" "+Ue,(e=>{e.joueur.gagner(e.montant),this.setMontant(0),ue.change()}),{joueur:ue.getJoueurCourant(),montant:this.montant})}}class I extends q{constructor(e,t,s,i,o){super(s,i,o),this.titre=e,this.nom=e,this.actionSpeciale=t,this.drawing=a.getCaseSpeciale(s,e),u.add(this.drawing)}action(){i.send("monopoly.visiteTerrain",{joueur:ue.getJoueurCourant(),maison:{color:"black",nom:this.titre}}),this.actionSpeciale()}}class D extends I{constructor(e,t,s,i){super(e,(()=>this.actionSpe()),t,s,"depart"),this.montant=i}actionSpe(){let e=(Re.caseDepart?2:1)*this.montant;ue.getJoueurCourant().gagner(e),i.send("monopoly.depart",{joueur:ue.getJoueurCourant(),montant:e}),ue.change()}}class _ extends q{constructor(e,t,s,i,o,n,r){super(s,i,o),this.montant=t,this.titre=e,this.plateauMonopoly=r,this.drawing=a.getCase(i,s,null,e,Ue+" "+t,n),u.add(this.drawing)}action(){return b.create(ue.getJoueurCourant(),this.titre,"lightblue","Vous devez payer la somme de "+this.montant+" "+Ue,(e=>{e.joueur.payerParcGratuit(this.plateauMonopoly.parcGratuit,e.montant,(function(){ue.change()}))}),{joueur:ue.getJoueurCourant(),montant:this.montant})}}class A extends q{constructor(e,t,s,i,o,n="carte chance"){super(e,t,"carte"),this.nom=n,this.cartes=i,this.drawing=a.getCase(t,e,null,o,null,s),u.add(this.drawing)}action(){if(0===this.cartes.length)throw`Aucune ${this.nom}`;let e=Math.round(1e3*Math.random())%this.cartes.length,t=this.cartes[e];return"prison"!==t.actionCarte.type||t.actionCarte.isLibre()||(t=this.cartes[(e+1)%this.cartes.length]),t.action()}}class H extends A{constructor(e,t,s,i,o){super(e,t,s,i,o,"carte caisse de communauté")}}class L{constructor(e,t){this.nom=e,this.color=t,this.fiches=[],this.groupePrecedent=null,this.groupeSuivant=null}equals(e){return null!=e&&this.color===e.color}getVoisins(){return[this.groupePrecedent,this.groupeSuivant]}isVoisin(e){return null!=this.groupePrecedent&&this.groupePrecedent.equals(e)||null!=this.groupeSuivant&&this.groupeSuivant.equals(e)}add(e){return this.fiches.push(e),e.groupe=this,this}isGrouped(){if(null==this.fiches||0===this.fiches.length)return!1;let e=this.fiches[0].joueurPossede;for(let t=0;t<this.fiches.length;t++){if(null==this.fiches[t].joueurPossede||!this.fiches[t].joueurPossede.equals(e))return!1;e=this.fiches[t].joueurPossede}return!0}isBuild(){if(null==this.fiches||0===fiches.length)return!1;for(let e=0;e<this.fiches.length;e++)if(this.fiches[e].nbMaison>0)return!0;return!1}getAverageConstructions(){let e=0;for(let t=0;t<this.fiches.length;t++)e+=this.fiches[t].nbMaison;return e/this.fiches.length}getConstructions(){let e={maison:0,hotel:0};for(let t=0;t<this.fiches.length;t++)this.fiches[t].hotel?e.hotel++:e.maison+=this.fiches[t].nbMaison;return e}getInfos(e){let t={free:0,joueur:0,adversaire:0,nbAdversaires:0,maisons:[],hypotheque:0},s=[],i=0;for(let o=0;o<this.fiches.length;o++){let n=this.fiches[o];0===n.statut?t.free++:(n.statutHypotheque&&t.hypotheque++,e.equals(n.joueurPossede)?t.joueur++:(t.adversaire++,t.maisons.push(n),1!==s[n.joueurPossede.id]&&i++,s[n.joueurPossede.id]=1))}return t.nbAdversaires=i,t}getNb(){return null==this.fiches?0:this.fiches.length}}class k{constructor(e,t){this.panel=document.querySelector(t),this.fiche=e,this.name=""}updateName(e){this.name=e}open(){const e=this.getButtons();return g.loadFiche(this.fiche),ue.getJoueurCourant().canPlay&&p.open(this.panel,{buttons:e,title:this.fiche.nom,width:250,height:365,colorTitle:this.fiche.color,colorButtons:this.fiche.secondColor}),e}getButtons(){return 0===this.fiche.statut?ue.getJoueurCourant().montant<this.fiche.achat?{"Pas assez d'argent":()=>ue.getJoueurCourant().refuseMaison(this.fiche,(()=>g.closeFiche()))}:{Acheter:()=>{ue.getJoueurCourant().acheteMaison(this.fiche),g.closeFiche()},Refuser:()=>ue.getJoueurCourant().refuseMaison(this.fiche,(()=>g.closeFiche()))}:{Fermer:()=>g.closeFiche()}}}class F extends q{constructor(e,t,s,i){super(e,t,"terrain"),this.id=G.buildId(this),this.nom=i,this.groupe=null,this.color=s[0],this.secondColor=2===s.length?s[1]:s[0],this.statut=0,this.joueurPossede=null,this.statutHypotheque=!1,this.fiche=new k(this,"#fiche"),this.nbMaison=0,this.hotel=!1,this.maisons=[],this.input=null}setCosts(e,t,s){return this.achat=e,this.montantHypotheque=e/2,this.achatHypotheque=1.1*this.montantHypotheque,this.loyer=t,this.loyerHotel=null!=t&&6===t.length?t[5]:0,this.prixMaison=s,this}setCostsAndDraw(e,t,s,i){return this.setCosts(e,t,s),this.drawing=a.getCase(this.pos,this.axe,this.color,this.nom,Ue+" "+e,i),u.add(this.drawing),this}equals(e){return null!=e&&this.id===e.id}save(){return{id:this.id,statut:this.statut,joueur:null!=this.joueurPossede?this.joueurPossede.id:null,nb:this.nbMaison,hypotheque:this.statutHypotheque}}getNbPropertiesOfType(){let e=-1;for(let t=0;t<this.joueurPossede.maisons.maisons.length;t++)this.joueurPossede.maisons.maisons[t].type===this.type&&e++;return e}load(e){const t=null!=e.joueur?ue.getById(e.joueur):null;null!=t&&(this.setJoueurPossede(t,!0),t._drawTitrePropriete(this)),this.id=e.id,this.statut=e.statut,this.setNbMaison(e.nb,!0),e.nb>0&&(5===e.nb?v.buyHotels(1):v.buyHouses(e.nb)),this.statutHypotheque=e.hypotheque,!0===this.statutHypotheque&&this.input.classList.add("hypotheque")}setJoueurPossede(e,t){this.joueurPossede=e,null!=this.drawing&&this.drawing.setJoueur(e),this.joueurPossede.maisons.add(this),this.joueurPossede.updateMaisonsByGroup(),t||i.refresh()}vendu(e){this.statut=1,this.setJoueurPossede(e),i.send("monopoly.acheteMaison",{joueur:e,maison:this})}libere(){this.statut=0,this.statutHypotheque=!1,this.joueurPossede=null,null!=this.drawing&&this.drawing.setJoueur(null),this.setNbMaison(0,!0),this.hotel=!1,i.refresh()}getRentabilite(){if(!this.isTerrain()||this.nbMaison>=3)return 0;{let e=this.groupe.fiches,t=0;for(let s=0;s<e.length;s++)t+=e[s].nbMaison;return this.loyer[3]/Math.max((3*e.length-t)*this.prixMaison,1)/10}}getRentabiliteBrute(){return this.isTerrain()?this.loyer[3]/(this.achat+3*this.prixMaison):0}hypotheque(){if(null==this.input||1!==this.statut||this.nbMaison>0)throw"Impossible d'hypothequer ce terrain";this.joueurPossede.gagner(this.montantHypotheque),this.joueurPossede.notifyHypotheque(this),this.doHypotheque()}doHypotheque(){this.statutHypotheque=!0,this.input.classList.add("hypotheque"),i.send("monopoly.hypothequeMaison",{joueur:this.joueurPossede,maison:this})}leveHypotheque(){if(null==this.input||1!==this.statut||!1===this.statutHypotheque)return;const e=Math.round(this.achatHypotheque);if(this.joueurPossede.montant<e)throw"Impossible de lever l'hypotheque";this.joueurPossede.payer(e),this.notifyLeveHypotheque(),this.doLeveHypotheque()}notifyLeveHypotheque(){}doLeveHypotheque(){this.statutHypotheque=!1,this.input.classList.remove("hypotheque"),i.send("monopoly.leveHypothequeMaison",{joueur:this.joueurPossede,maison:this})}isLibre(){return 0===this.statut}setNbMaison(e,t){this.nbMaison=e,null!=this.drawing&&this.drawing.setNbMaison(e),this.hotel=5===this.nbMaison,t||i.refresh()}action(){return this.fiche.updateName(this.nom),null!=this.joueurPossede&&this.joueurPossede.equals(ue.getJoueurCourant())?this.chezSoi():null!=this.joueurPossede&&!1===this.statutHypotheque?this.payerLoyer():!0===this.statutHypotheque?ue.change():this.fiche.open()}chezSoi(){return i.send("monopoly.chezsoi",{joueur:this.joueurPossede,maison:this}),b.create(ue.getJoueurCourant(),"Vous etes "+this.nom,this.color,"Vous etes chez vous",(()=>ue.change()))}sellMaison(e,t){if(null==e||!this.joueurPossede.equals(e)||this.nbMaison<=0)return!1;if(5===this.nbMaison){if(!(v.getRestHouse()>=4))return;v.buyHouses(4),v.sellHotel(),this.hotel=!1}else v.sellHouse();return this.setNbMaison(this.nbMaison-1,t),!0}buyMaison(e,t){if(null!=e&&this.joueurPossede.equals(e)&&!(this.nbMaison>=5)){if(4===this.nbMaison&&!v.isFreeHotel()||this.nbMaison<4&&!v.isFreeHouse())throw"Pas de construction disponible";this.setNbMaison(this.nbMaison+1,t),5===this.nbMaison?(this.hotel=!0,v.buyHotel()):v.buyHouse()}}getLoyerFor(e){return e.equals(this.joueurPossede)?0:this.getLoyer()}getLoyer(){return this.statutHypotheque?0:!0===this.hotel?this.loyerHotel:0===this.nbMaison&&this.isGrouped()?2*this.loyer[0]:this.loyer[this.nbMaison]}payerLoyer(){return b.create(ue.getJoueurCourant(),"Vous etes "+this.nom,this.color,"Vous etes chez "+this.joueurPossede.nom+" vous devez payez la somme de "+this.getLoyer()+" "+Ue,(function(e){i.send("monopoly.payerLoyer",{joueur:e.joueurPaye,maison:e.maison}),i.network({kind:"loyer",player:ue.getJoueurCourant().id,maison:G.buildId(e.maison)}),e.joueurPaye.payerTo(e.loyer,e.joueurLoyer)}),{loyer:this.getLoyer(),joueurPaye:ue.getJoueurCourant(),joueurLoyer:this.joueurPossede,maison:this})}isGrouped(){return null!=this.groupe&&this.groupe.isGrouped()}isGroupedAndBuild(){if(null===this.joueurPossede)return!1;let e=this.joueurPossede.maisons.findMaisonsConstructibles();for(let t=0;t<e.length;t++)if(e[t].color===this.color&&e[t].nbMaison>0)return!0;return!1}}class $ extends F{constructor(e,t,s,i){super(e,t,s,i),this.fiche=new k(this,"#ficheJunior"),this.type="junior"}}class J extends F{constructor(e,t,s,i){super(e,t,s,i),this.type="gare"}getLoyer(){if(null!=this.joueurPossede){let e=this.getNbPropertiesOfType();return this.loyer[e]}return 0}}class B extends F{constructor(e,t,s,i){super(e,t,s,i),this.fiche=new k(this,"#ficheCompagnie"),this.type="compagnie"}getLoyer(){let e=x.total();if(null!=this.joueurPossede){let t=this.getNbPropertiesOfType();return this.loyer[t]*e}return this.loyer[0]*e}}let G={fiches:[],keys:[],buildId:e=>e.axe+"-"+e.pos,_calculateStrId:function(e){return parseInt(e.substr(0,1))*a.dimensions.nbCases+parseInt(e.substr(2,3))},_calculateId:function(e){return e.axe*a.dimensions.nbCases+e.pos},getById:function(e){return this.fiches[this._calculateStrId(e)]},get:function(e){return this.fiches[this._calculateId(e)]},getPrison:function(){return this.fiches[this._calculateId({axe:1,pos:0})]},getDepart:function(){return this.fiches[this._calculateId({axe:2,pos:0})]},add:function(e){let t=this._calculateStrId(e.id);this.fiches[t]=e,this.keys.push(t)},getFreeFiches:function(){return this.fiches.filter((function(e){return 0===e.statut}))},isFreeFiches:function(){return this.fiches.some((function(e){return 0===e.statut}))},getNextFreeTerrain:function(e){return this._getNextFiche(e,(function(e){return e.isPropriete()&&0===e.statut}))},getNextTerrain:function(e){return this._getNextFiche(e,(function(e){return e.isPropriete()}))},getGroups:function(){let e=[];return this.fiches.filter((e=>null!=e.groupe)).forEach((t=>e[t.groupe.nom]=t.groupe.color)),e},_getNextFiche:function(e,t){let s={position:e.pos,axe:e.axe};do{s=this.nextPos(s.axe,s.position);const e=this.get({axe:s.axe,pos:s.position});if(null==t||t(e))return e}while(e.axe!==s.axe||e.pos!==s.position);return null},iterator:function(){return{pointer:0,hasNext:function(){return this.pointer<G.keys.length},next:function(){return G.fiches[G.keys[this.pointer++]]}}},iteratorTerrains:function(){let e=[];for(let t in this.fiches)this.fiches[t].isPropriete()&&e.push(t);return this._buildIterator(e)},getTerrainsLibres:function(){let e=[];for(let t in this.fiches)this.fiches[t].isPropriete()&&0===this.fiches[t].statut&&e.push(t);return this._buildIterator(e)},_buildIterator:function(e){return{pointer:0,keys:e,hasNext:function(){return this.pointer<this.keys.length},next:function(){return G.fiches[this.keys[this.pointer++]]}}},nextPos:function(e,t){return 10==++t&&(e=(e+1)%4,t=0),{position:t,axe:e}}};function N(e,t,s,o=2e4){this.axe=2,this.position=0,this.joueur=t,this.montantDepart=o,this.stats={tour:0,prison:0,positions:[]},this.pion=a.getPionJoueur(e,a.dimensions.largeurPion,s,this.joueur),u.addRealTime(this.pion),this.remove=function(){u.removeComponent(this.pion)},this.goPrison=function(e){this.stats.prison++,this.goDirectToCell(3,0,e)},this.deplaceValeursDes=function(e){let t=this.position+e,s=this.axe;for(;t<0;)t+=a.dimensions.nbCases,s=(s+3)%4;for(;t>=a.dimensions.nbCases;)t-=a.dimensions.nbCases,s=(s+1)%4;return{pos:t,axe:s}},this.goto=function(e,t,s,o=Re.quickMove,n=!0){let r=e+"-"+t;null==this.stats.positions[r]?this.stats.positions[r]=1:this.stats.positions[r]++,null!=ue.getJoueurCourant()&&i.debug({message:`${ue.getJoueurCourant().nom} est en ${this.axe} - ${this.position} et va en ${r}`});let u=this.axe*a.dimensions.nbCases+this.position,l=e*a.dimensions.nbCases+t,h=2*a.dimensions.nbCases;n&&(u<h&&l>h||u>l&&(u<h||l>h))&&this.treatCaseDepart(),this.axe=e,this.position=t,this.pion.goto(e,t,s,!1,o)},this.treatCaseDepart=function(){this.stats.tour++,this.joueur.gagner(this.montantDepart)},this.goDirectToCell=function(e,t,s){this.axe=e,this.position=t,this.pion.gotoDirect(e,t,s)}}const R={maisonsToLever:[],changesConstructions:[],cout:0,totalRestant:0,divCout:null,divArgentRestant:null,banqueroute:!1,panel:null,beforeClose:()=>!0,open:function(e,t=(()=>!0)){this.banqueroute=e,this.beforeClose=t,this.load();const s={Valider:()=>this.valider()};e||(s.Fermer=()=>this.closePanel()),this.panel.querySelector(".warning-message").innerHTML="",p.open(this.panel,{title:"Gestion des maisons",width:800,height:600,buttons:s})},reset:function(){this.Hypotheque.reset(),this.LeverHypotheque.reset(),this.Constructions.reset(),this.cout=0,document.querySelector("#coutAchats > span[name]").innerHTML="0",document.querySelector(".currency-value").innerHTML=Ue,this.update()},init:function(e){this.divArgentRestant=document.querySelector(e.idArgentRestant),this.divCout=document.querySelector(e.idCout),this.Hypotheque.init(e.idTerrains,e.idHypotheque),this.LeverHypotheque.init(e.idTerrainsHypotheque),this.Constructions.init(e.idTerrainsConstructibles,e.idCoutAchat,e.idConstructions),this.panel=document.querySelector(e.idPanel)},load:function(){this.reset(),this.Hypotheque.load(),this.LeverHypotheque.load(),this.Constructions.load()},addCout:function(e){this.cout+=e,this.update()},update:function(){this.Hypotheque.update();let e=this.Constructions.update();this.divCout.innerHTML=`${this.cout-e.cout} ${Ue}`,this.totalRestant=ue.getJoueurCourant().montant+this.cout-e.cout,this.divArgentRestant.innerHTML=`${this.totalRestant} ${Ue}`},verify:function(){try{if(R.totalRestant<0)throw"Operation impossible : pas assez d'argent";return R.Constructions.verify(),!0}catch(e){return this.panel.querySelector(".warning-message").innerHTML=e,!1}},valider:function(){this.verify()&&(this.Constructions.vendre(),this.Hypotheque.valider(),this.LeverHypotheque.valider(),this.Constructions.acheter(),this.closePanel())},closePanel:function(){this.beforeClose()&&p.close()},Hypotheque:{table:[],select:null,div:null,init:function(e,t){this.select=document.querySelector(`${e} select`),this.div=document.querySelector(t)},reset:function(){this.table=[],this.select.innerHTML="",this.div.innerHTML="",document.getElementById("idHypothequeAction").onclick=()=>this.add()},valider:function(){for(const e in this.table)this.table[e].hypotheque()},update:function(){this.select.querySelectorAll("option[data-color]").forEach((e=>e.removeAttribute("disabled"))),R.Constructions.getGroupesConstruits().forEach((e=>{this.select.querySelectorAll(`option[data-color="${e}"]`).forEach((e=>e.setAttribute("disabled","disabled")))}))},load:function(){ue.getJoueurCourant().maisons.findMaisonsHypothecables().forEach((function(e){R.Hypotheque.addOption(e)}))},addGroup:function(e){e.proprietes.forEach((e=>this.addOption(e)))},addOption:function(e){if(this.select.querySelectorAll(`option[value="${e.id}"]`).length>0)return;let t=`<option data-color='${e.color}' value='${e.id}'>${e.nom} (${e.montantHypotheque} ${Ue})</option>`;this.select.insertAdjacentHTML("beforeend",t)},add:function(){const e=G.getById(this.select.value);this.table[e.id]=e;const t=document.createElement("div");t.append(document.createTextNode(e.nom));const s=document.createElement("button");s.append(document.createTextNode("Annuler")),s.style.setProperty("margin-right","5px"),s.onclick=()=>{this.addOption(e),s.parentNode.remove(),R.addCout(-e.montantHypotheque),delete this.table[e.id];let t=Object.values(this.table).map((e=>e.color.substring(1)));R.Constructions.showByColors(t)},t.prepend(s),this.div.append(t),this.select.querySelector(`option[value="${e.id}"]`).remove(),R.addCout(e.montantHypotheque),R.Constructions.removeByColor(e.color)}},LeverHypotheque:{div:null,table:[],init:function(e){this.div=document.querySelector(`${e} > div`)},reset:function(){this.div.innerHTML="",this.table=[]},valider:function(){for(const e in this.table)this.table[e].leveHypotheque()},load:function(){ue.getJoueurCourant().maisons.findMaisonsHypothequees().forEach((e=>{const t=document.createElement("div");t.append(document.createTextNode(e.nom));const s=document.createElement("button");s.style.setProperty("margin-right","5px"),s.append(document.createTextNode("Lever")),s.onclick=()=>R.LeverHypotheque.lever(s,e),t.prepend(s),R.LeverHypotheque.div.append(t)}))},lever:function(e,t){e.setAttribute("disabled","disabled"),this.table.push(t),R.addCout(-Math.round(1.1*t.montantHypotheque))}},Constructions:{table:[],div:null,infos:null,simulation:null,resteConstructions:null,init:function(e,t,s){this.div=document.querySelector(e),this.infos=document.querySelector(t),this.resteConstructions=document.querySelector(s)},verify:function(){let e=[];this.div.querySelectorAll("select[data-color]").forEach((t=>{const s=t.getAttribute("data-color");null==e[s]&&(e[s]={min:5,max:0}),e[s].min=Math.min(e[s].min,t.value),e[s].max=Math.max(e[s].max,t.value)}));for(const t in e)if(e[t].max-e[t].min>1)throw"Il faut equilibrer les maisons";if(this.simulation.reste.maison<0||this.simulation.reste.hotel<0)throw"Impossible d'acheter, il n'a y pas assez de maison / hotel disponibles"},valider:function(){for(let e in this.table){let t=this.table[e];t.propriete.setNbMaison(t.nbMaison),ue.getJoueurCourant().payer(t.cout)}this._doBuyConstructions()},_doBuyConstructions:function(){null==this.simulation||0===this.simulation.achat.maison&&0===this.simulation.achat.hotel||(v.buyHouses(this.simulation.achat.maison),v.buyHotels(this.simulation.achat.hotel),i.send("monopoly.acheteConstructions",{joueur:ue.getJoueurCourant(),achats:this.simulation.achat}))},acheter:function(){for(const e in this.table){let t=this.table[e];t.propriete.nbMaison<t.nbMaison&&(t.propriete.setNbMaison(t.nbMaison),ue.getJoueurCourant().payer(t.cout))}this._doBuyConstructions()},vendre:function(){for(const e in this.table){let t=this.table[e];t.propriete.nbMaison>t.nbMaison&&(t.propriete.setNbMaison(t.nbMaison),ue.getJoueurCourant().payer(t.cout))}},reset:function(){this.table=[],this.div.innerHTML=""},getGroupesConstruits:function(){return Array.from(this.div.querySelectorAll('select:has(option:not([value="0"]):checked)')).map((e=>e.getAttribute("data-color"))).reduce(((e,t)=>(e.add(t),e)),new Set)},update:function(){let e={nbMaison:0,nbHotel:0,cout:0},t=[];for(let s in this.table){let i=G.getById(s),o={from:{},to:{},group:i.color};i.hotel?(o.from.type="hotel",o.from.nb=1):(o.from.type="maison",o.from.nb=parseInt(i.nbMaison));let n=this.table[s];e.cout+=n.cout,n.hotel>0?(o.to.type="hotel",o.to.nb=1):(o.to.type="maison",o.to.nb=n.nbMaison),e.nbMaison+=n.nbMaison||0,e.nbHotel+=n.hotel||0,t.push(o)}return this.simulation=v.simulateBuy(t),this.infos.querySelector("span.nbMaison").innerHTML=this.simulation.achat.maison,this.infos.querySelector("span.nbHotel").innerHTML=this.simulation.achat.hotel,this.resteConstructions.querySelector("span.nbMaison").innerHTML=this.simulation.reste.maison,this.resteConstructions.querySelector("span.nbHotel").innerHTML=this.simulation.reste.hotel,e},removeByColor:function(e){this.div.querySelectorAll(`div[class*="-${e.substring(1)}"]`).forEach((e=>e.style.setProperty("display","none")))},showByColors:function(e){let t="div";e.forEach((e=>t+=`:not([class*="-${e}"])`)),this.div.querySelectorAll(t).forEach((e=>e.style.setProperty("display","")))},_displayProprietesOfGroup:function(e){for(let t in e.proprietes){const s=e.proprietes[t],i=document.createElement("div");i.classList.add("propriete",`propriete-${s.color.substring(1)}`),i.insertAdjacentHTML("beforeend",`<span style="color:${s.color}" class="title-propriete">${s.nom}</span>`);const o=document.createElement("select");o.setAttribute("data-color",s.color),o.setAttribute("data-propriete",s.id),o.classList.add(5===s.nbMaison?"hotel":"maison");for(let e=0;e<=(R.banqueroute?s.nbMaison:5);e++)o.insertAdjacentHTML("beforeend",`<option class="${5===e?"hotel":"maison"}" value="${e}" ${s.nbMaison===e?"selected":""}>x ${5===e?1:e}</option>`);const n=document.createElement("span");o.onchange=()=>{let t=parseInt(o.value);if(s.nbMaison===t)return delete this.table[s.id],n.innerHTML="",void R.update();const i=5===t?{hotel:1}:{maison:t-s.nbMaison};i.propriete=s,i.nbMaison=t,i.cout=t>s.nbMaison?(t-s.nbMaison)*s.prixMaison:(t-s.nbMaison)*s.prixMaison/2,o.removeAttribute("class"),o.classList.add(5===t?"hotel":"maison"),n.innerHTML=i.cout,this.table[s.id]=i,R.update(),0===this.div.querySelectorAll(`select[data-color="${s.color}"] option:checked:not([value="0"])`).length&&R.Hypotheque.addGroup(e)},i.append(o),i.append(n),i.insertAdjacentHTML("beforeend",` ${Ue}`),this.div.append(i)}},load:function(){let e=ue.getJoueurCourant().maisons.findConstructiblesGroupes();for(let t in e){const s=`<div class="group-${t.substring(1)}">Groupe <span style="color:${t};font-weight:bold">${e[t].group.nom}</span></div>`;this.div.insertAdjacentHTML("beforeend",s),this._displayProprietesOfGroup(e[t])}}}};class z{constructor(e,t=[]){this.joueur=e,this.maisons=[],t.forEach((e=>this.add(e)))}add(e){e.joueurPossede=this.joueur,e.statut=1,this.maisons.push(e)}remove(e){let t=this.maisons.findIndex((t=>t.equals(e)));-1!==t&&(e.statut=0,e.joueurPossede=null,this.maisons.splice(t,1))}getGroupesPossibles(){let e=new Set;return this.maisons.filter((e=>!e.isGrouped())).filter((e=>1===e.groupe.fiches.filter((e=>!this.joueur.equals(e.joueurPossede))).reduce(((e,t)=>e+(0===t.statut?1:10)),0))).forEach((t=>e.add(t.color))),Array.from(e)}getMaisonsGrouped(){const e=[];return this.maisons.forEach((t=>{null==t.groupe?void 0===e.others?e.others={groupe:"Autres",color:"black",terrains:[t]}:e.others.terrains.push(t):void 0===e[t.groupe.nom]?e[t.groupe.nom]={groupe:t.groupe.nom,color:t.groupe.color,terrains:[t]}:e[t.groupe.nom].terrains.push(t)})),e}findMaisonsByGroup(){let e=[];return this.maisons.forEach((t=>{null==e[t.groupe.nom]&&(e[t.groupe.nom]=[]),e[t.groupe.nom].push(t)})),e}findMaisonsHypothecables(){return this.maisons.filter((e=>!1===e.statutHypotheque&&0===e.nbMaison&&!this.maisons.some((t=>t.color===e.color&&t.nbMaison>0))))}findMaisonsHypothequees(){return this.maisons.filter((e=>e.statutHypotheque))}findConstructiblesGroupes(){const e=[],t=[];return this.maisons.filter((e=>!0===e.isTerrain()&&null!=e.groupe)).forEach((s=>{if(void 0===e[s.color]){let i=s.groupe.getInfos(this.joueur);0===i.free&&0===i.adversaire&&0===i.hypotheque?t[s.color]={color:s.color,group:s.groupe,proprietes:s.groupe.fiches}:e[s.color]=!0}})),t}findOthersInterestProprietes(e,t,s){let i=[],o=[];this.maisons.forEach((s=>{if(void 0===o[s.groupe.color]){let n=s.groupe.getInfos(this.joueur);0===n.free&&(1===n.adversaire||n.nbAdversaires>1)&&n.maisons.filter((s=>(void 0===e||e.equals(s.joueurPossede))&&(null==t||!t.groupe.equals(s.groupe)))).filter((()=>!(t&&s.groupe.color===t.groupe.color))).forEach((e=>i.push({maison:e,nb:n.maisons.length}))),o[s.groupe.color]=!0}}));let n=this.findConstructiblesGroupes();return i.sort(((e,t)=>this._computeScoreInterest(e,t,n,s))),i}_computeScoreInterest(e,t,s,i){let o=e.nb/t.nb,n=e.maison.getRentabiliteBrute()/t.maison.getRentabiliteBrute(),r=1,a=1;for(let i in s)s[i].group.isVoisin(e.maison.groupe)&&r++,s[i].group.isVoisin(t.maison.groupe)&&a++;let u=r/a,l=1;if(null!=i){let s=i.interetPropriete(e.maison);s!==i.interetPropriete(t.maison)&&(l=s?.5:2)}let h=1;return e.maison.isTerrain()!==t.maison.isTerrain()&&(h=e.maison.isTerrain()?.5:4),o*n*u*l*h-1}findUnterestsProprietes(){const e=[];let t=this.maisons.filter((e=>!e.isTerrain()));return t.forEach((t=>{void 0===e[t.groupe.nom]?e[t.groupe.nom]=1:e[t.groupe.nom]++})),{proprietes:t,nbByGroups:e}}findOthersProperties(e){const t=[];for(let s in e)t[e[s].maison.color]=1;return this.maisons.filter((e=>e.isTerrain()&&!e.isGrouped()&&void 0===t[e.color]))}findMaisonsConstructibles(){const e=[],t=[],s=[];return this.maisons.filter((e=>e.isTerrain())).forEach((i=>{!0===t[i.color]?e.push(i):void 0===s[i.color]&&(i.groupe.fiches.some((e=>e.isTerrain()&&(!this.joueur.equals(e.joueurPossede)||!0===e.statutHypotheque)))?s[i.color]=!0:(t[i.color]=!0,e[e.length]=i))})),e}libere(){this.maisons.forEach((e=>e.libere())),this.maisons=[]}cherchePlacement(e){const t=this.maisons.find((t=>t.color===e.color));return t?t.input:null}}class O{constructor(e){this.joueur=e}save(){let e={canPlay:this.joueur.canPlay,id:this.joueur.id,nom:this.joueur.nom,color:this.joueur.color,montant:this.joueur.montant,enPrison:this.joueur.enPrison,nbDouble:this.joueur.nbDouble,bloque:this.joueur.bloque,defaite:this.joueur.defaite,cartesPrison:this.joueur.cartesSortiePrison.length,position:this.joueur.pion.position,axe:this.joueur.pion.axe};return this.saveMore(e),e}load(e){for(let t in e)null!=this[t]&&(this[t]=e[t]);if(this.joueur.setArgent(e.montant),this.loadMore(e),this.joueur.pion.goDirectToCell(e.axe,e.position),this.joueur.defaite){const e=this.joueur.div.querySelector(".joueur-bloc");e.removeAttribute("style"),e.classList.add("defaite")}return this.joueur}saveMore(){}loadMore(e){}}class V{constructor(e,t="",s,i,o=0){this.numero=e,this.type="Local",this.id=e,this.nom=t,this.color=s,this.montant=i,this.maisons=new z(this),this.enPrison=!1,this.pion=null,this.nbDouble=0,this.bloque=!1,this.defaite=!1,this.tourDefaite=null,this.cartesSortiePrison=[],this.canPlay=!0,this.montantDepart=o,this.enableMouseFunction=()=>{},this.saver=new O(this)}setEnableMouseFunction(e){this.enableMouseFunction=e}equals(e){return null!=e&&this.numero===e.numero}isSlotFree(){return!1}utiliseCarteSortiePrison(){if(0===this.cartesSortiePrison.length)throw"Impossible d'utiliser cette carte";this.cartesSortiePrison[this.cartesSortiePrison.length-1].joueurPossede=null,this.cartesSortiePrison.splice(this.cartesSortiePrison.length-1,1)}isFirstRound(){return 0===this.pion.stats.tour}getStats(){let e={type:this.type,prison:this.pion.stats.prison,tour:this.pion.stats.tour,argent:this.montant,argentDispo:this.montant,argentDispoHypo:this.montant,hotel:0,maison:0,strategie:null!=this.strategie?this.strategie.toString():"-",comportement:null!=this.comportement?this.comportement.name:"-"};for(const t in this.maisons.maisons){const s=this.maisons.maisons[t];e.hotel+=!0===s.hotel?1:0,e.maison+=parseInt(!1===s.hotel?s.nbMaison:0),e.argentDispo+=s.statutHypotheque?0:(s.isTerrain()?s.nbMaison*(s.prixMaison/2):0)+s.achat/2,e.argentDispoHypo+=s.isGrouped()||s.statutHypotheque?0:s.achat/2}return e}select(){this.div.classList.add("joueurCourant"),this.enPrison||(this.nbDouble=0),this.joue()}notifySelect(){}notifyDices(e){}lancerDes(){x.lancer()}getPosition(){return{pos:this.pion.position,axe:this.pion.axe}}traiteRequeteEchange(e,t,s){f.show(e,this,t,s,this)}traiteContreProposition(e){f.showContreProposition(e)}notifyAcceptProposition(e){f.showAccept(e)}notifyRejectProposition(e){f.showReject(e)}initEnchere(e,t){h.display(t,this)}updateInfoEnchere(e,t){h.updateInfo(e,t,!1)}notifyExitEnchere(e){h.showJoueurExit(e)}updateEnchere(e,t,s,i,o){o&&h.clean(),h.updateInfo(s,i,!0,{transaction:e,jeton:t})}endEnchere(e,t){h.displayCloseOption(e,t)}joueDes(e){this.moveTo(e)}moveTo(e){const t=this.pion.deplaceValeursDes(e);this.joueSurCase(t)}joueSurCase(e,t,s=!0){this.pion.goto(e.axe,e.pos,(()=>Xe(this)),t,s)}joueSurCaseNoAction(e){this.pion.goto(e.axe,e.pos,(()=>{}))}joue(){}choisiDes(e,t,s){if(!s)return;let i=[{title:e+" + "+t,fct:()=>s(e+t)},{title:e,fct:()=>s(e)},{title:t,fct:()=>s(t)}];b.createGeneric(this,"Vous prenez le bus","green","Quel(s) dé(s) vous choisissez",i)}choisiCase(e){b.create(this,"Triple dé","green","Choisissez votre case",(()=>{this.enableMouseFunction(e)}))}actionApresDes(){}actionAvantDesPrison(){}acheteMaison(e,t=e.achat){if(void 0===e||t>this.montant)throw"Achat de la maison impossible";e.isLibre()&&(this.showAcheteMaison(e),this.payer(t),this.notifyAcheteMaison(e,t))}showAcheteMaison(e){this._drawTitrePropriete(e),e.vendu(this)}refuseMaison(e,t=(()=>{})){i.send("monopoly.visiteMaison",{joueur:ue.getJoueurCourant(),maison:e}),this.notifyMessage("monopoly.visiteMaison","",{maison:e.id}),Re.enchereAchat?this._enchereByBanque(e,t):t()}_enchereByBanque(e,t){l.init(e,e.achat,!0,t)}_drawTitrePropriete(e){let t=this.maisons.cherchePlacement(e),s=`<input type="button" id="idInputFiche${e.id}" class="ui-corner-all fiche color_${e.color.substring(1)}" value="${e.nom}" id="fiche_${e.id}"/>`;null!=t?t.insertAdjacentHTML("afterend",s):this.div.insertAdjacentHTML("beforeend",s),e.input=document.querySelector(`input[id="idInputFiche${e.id}"]`),!0===e.statutHypotheque&&e.input.classList.add("hypotheque"),e.input.onclick=()=>g.openDetail(G.getById(e.id),e.input)}getSwapProperiete(e){e.input.remove(),e.input=null,this._drawTitrePropriete(e),e.joueurPossede&&e.joueurPossede.maisons.remove(e),e.setJoueurPossede(this)}goPrison(e=!0){this.showPrison(),this.nbDouble=0,e&&this.notifyPrison(),this.pion.goPrison((()=>ue.change())),i.send("monopoly.goPrison",{joueur:this})}showPrison(){this.enPrison=!0,this.div.querySelector(".joueur-id").classList.add("jail")}exitPrison(e={notrigger:!1,notify:!0,paye:!1,carte:!1}){this.enPrison=!1,this.nbDouble=0,this.div.querySelector(".joueur-id").classList.remove("jail"),e.notify&&this.notifyExitPrison(e.paye,e.carte),e.notrigger||i.send("monopoly.exitPrison",{joueur:this,paye:e.paye,carte:e.carte})}isEnPrison(){return this.enPrison}setDiv(e){this.div=e,this.setArgent(this.montant)}setArgent(e){if(void 0===e)throw"error montant";this.montant=e,this.div.querySelector(".compte-banque").textContent=e}payerParcGratuit(e,t,s=(()=>{})){try{this.payer(t,(()=>{Re.parcGratuit&&e.payer(t),s()}))}catch(e){s()}}setPion(e,t,s){this.pion=new N(e,this,t,s)}isSolvable(e){return this.getStats().argentDispo>=e}payer(e,t=(()=>{})){if(this.getStats().argentDispo<e)throw this.doDefaite(),"Le joueur "+this.nom+" est insolvable";this.notifyPay(e),this.montant-e<0?(this.bloque=!0,this.resolveProblemeArgent(e,t)):(this.setArgent(this.montant-e),t())}notifyAcheteMaison(e,t){}notifyHypotheque(){}notifyLeveHypotheque(){}notifyPay(){}notifyMessage(){}notifyPrison(){W.goPrison(this)}notifyExitPrison(e=!1,t=!1){W.exitPrison(this,e,t)}payerTo(e,t,s){let i=this.getStats().argentDispo;try{this.payer(e,(()=>{if(t.gagner(e),null!=s)return s();ue.change()}))}catch(e){null!=t&&t.gagner(i),ue.change()}}gagner(e){this.setArgent(this.montant+e)}doDefaite(){this.maisons.libere(),i.refresh(),this.updateMaisonsByGroup(),this.div.querySelectorAll("input").forEach((e=>e.remove())),this.pion.remove(),this.div.querySelector(".joueur-bloc").classList.add("defaite"),this.setArgent(0),this.defaite=!0,this.tourDefaite=Ve.nbTours,i.send("monopoly.defaite",{joueur:this})}resolveProblemeArgent(e,t){return this.montant-=e,b.create(this,"Attention","red","Vous n'avez pas les fonds necessaires, il faut trouver de l'argent",(()=>{R.open(!0,(e=>this.montant<0?(b.create(this,"Attention","red","Impossible, il faut trouver les fonds avant de fermer"),!1):(this.bloque=!1,this.setArgent(this.montant),t(),!0)))})),!0}updateMaisonsByGroup(){let e=this.maisons.findMaisonsByGroup();const t=this.div.querySelector(".count-property");t.querySelector(".counter-group").innerHTML=0;for(const s in e){let i=s.replace(/ /g,"");t.querySelector(`.counter-group.${i}`).innerHTML=e[s].length}}endTurn(){}}class U extends V{constructor(e,t,s,i,o){super(e,t,s,i,o)}moveTo(e){const t=this.pion.deplaceValeursDes(e);W.moveTo(G.buildId(t),this),this.joueSurCase(t)}joueSurCase(e,t,s=!0,i=!1){super.joueSurCase(e,t,s),i&&W.moveTo(G.buildId(e),this)}actionApresDes(e){}gagner(e){this.setArgent(this.montant+e),W.gagner(e,this)}notifyPay(e){W.payer(e,this)}notifyMessage(e,t,s){W.notifyMessage(e,t,this,s)}notifyHypotheque(e){W.hypotheque(e,this)}notifyLeveHypotheque(e){W.leveHypotheque(e,this)}notifySelect(){W.notifySelect(this)}notifyAcheteMaison(e,t){W.notifyAcheteMaison(e,t,this)}notifyDices(e,t){W.dices(e,t,this)}}let W={askDices(e){i.network({kind:"launchDices",player:e.id})},dices(e,s,o){delete s.joueur;const n=t({kind:"dices",player:o.id,dice1:e[0],dice2:e[1],quickDice:e[2]},s);i.network(n)},hypotheque(e,t){i.network({kind:"hypotheque",terrain:e.id,player:t.id})},leveHypotheque(e,t){i.network({kind:"leveHypotheque",terrain:e.id,player:t.id})},move(e,t){i.network({kind:"move",player:t.id,nb:e})},moveTo(e,t){i.network({kind:"moveTo",player:t.id,to:e})},notifySelect(e){i.network({kind:"change",player:e.id})},goPrison(e){i.network({kind:"prison",player:e.id})},exitPrison(e,t,s){i.network({kind:"exitPrison",player:e.id,paye:t,carte:s})},payer(e,t){i.network({kind:"tax",player:t.id,montant:e})},gagner(e,t){i.network({kind:"earn",player:t.id,montant:e})},notifyAcheteMaison(e,t,s){i.network({kind:"buy",player:s.id,terrain:e.id,montant:t})},notifyMessage(e,t,s,o={}){i.network({kind:"message",player:s.id,libelle:t,name:e,...o})},notifyEnd(){i.network({kind:"end"})}};class Q extends U{constructor(e,t,s,i,o){super(e,t,s,i,o)}lancerDes(){x.gestionDes.before((()=>W.askDices(this)))}notifySelect(){}endTurn(){W.notifyEnd()}notifyDices(e){}}class Y extends V{constructor(e,t,s,i,o){super(e,t,s,i,o),this.canPlay=!1,this.type="Distant",this.free=!0}isSlotFree(){return this.free}setPlayer(e){this.nom=e,this.free=!1,this.div.querySelector(".joueur-name").innerHTML=this.nom}notifyPay(e){W.payer(e,this)}}class X extends Y{constructor(e,t,s,i,o){super(e,t,s,i,o)}notifySelect(){W.notifySelect(this)}notifyDices(e,t){W.dices(e,t,this),null!=t.prison&&(t.prison.sortie?ue.getJoueurCourant().exitPrison():ue.change())}moveTo(e){let t=this.pion.deplaceValeursDes(e);W.moveTo(G.buildId(t),this),this.joueSurCase(t)}}class Z{constructor(e,t,s,i,o=Math.round(1e3*Math.random())%3==0){this.groups=e,this.agressif=t,this.interetGare=o,this.name=s,this.id=i}_containGroup(e){for(let t in this.groups)if(this.groups[t]===e)return!0;return!1}getStatsProprietes(){let e={color:{total:0,libre:0,achete:0,pourcent:0},all:{total:0,libre:0,achete:0,pourcent:0}},t=G.iteratorTerrains();for(;t.hasNext();){let s=t.next();null!=s.statut&&(e.all.total++,0===s.statut?e.all.libre++:e.all.achete++,this._containGroup(s.color)&&(e.color.total++,0===s.statut?e.color.libre++:e.color.achete++))}return e.color.pourcent=e.color.libre/e.color.total*100,e.all.pourcent=e.all.libre/e.all.total*100,e}interetGlobal(e,t,s){let i=this.interetPropriete(e),o=this.statutGroup(e,t,s),n=o.statut,r={interet:1};return!1===i&&0===n&&(r={interet:.2}),!1===i&&2===n&&(r={interet:this.agressif,joueur:o.joueur}),!0===i&&3===n&&(r={interet:4}),!1===i&&3===n&&(r={interet:2}),!0===i&&5===n&&(r={interet:1.5}),s&&(r={interet:this.interetProprieteInStrategie(e)}),e.isTerrain()||(r.interet/=2),r}interetProprieteInStrategie(){let e=this.getStatsProprietes();return.5+parseFloat(Math.log(Math.min(100-e.color.pourcent,32.5)/50+1).toFixed(2))}interetPropriete(e){for(let t in this.groups)if(this.groups[t]===e.color||"gare"===e.type&&this.interetGare)return!0;return!1}statutGroup(e,t,s){let i=0,o=0,n=null,r=0,a=0;for(let s in e.groupe.fiches){let u=e.groupe.fiches[s];i++,0===u.statut?o++:(u.joueurPossede.equals(t)?a++:(null==n||u.joueurPossede.equals(n))&&r++,n=u.joueurPossede)}return o===i?{statut:0}:1===o&&r===i-1?{statut:2,joueur:n}:1!==o&&!s||a!==i-1?a>0&&o>0?{statut:5}:o>0?{statut:1}:{statut:4}:{statut:3}}acceptSwapTerrain(e,t,s,i){let o=ue.getNb()>2;if(!0===i&&1===s.length||e.isGrouped())return 0;for(let t in s)s[t].maison.joueurPossede.equals(e.joueurPossede)||(o=!1);let n=t.maisons.findConstructiblesGroupes().size();return 0===n&&0===s.length&&o?2===this.agressif?.5:1:n>=2&&o?this.agressif>0?0:.5:0===n?1.5:n>=2&&this.agressif>0?.5:1}toString(){return this.name+(this.interetGare?' <img src="img/little_train.png" style="width:20px;height:16px;"/>':"")}}let K={strategies:[class extends Z{constructor(){super(["#812B5C","#119AEB","#73316F","#D16E2D"],0,"Econome",0)}},class extends Z{constructor(){super(["#73316F","#D16E2D","#D32C19","#E6E018"],1,"Normal",1)}},class extends Z{constructor(){super(["#D32C19","#E6E018","#11862E","#132450"],2,"Luxe",2)}},class extends Z{constructor(){super(["#D16E2D","#D32C19","#E6E018"],2,"Futé",3,!0)}},class extends Z{constructor(){super(["#812B5C","#119AEB","#73316F","#D16E2D","#D32C19","#E6E018","#11862E","#132450"],4,"Dingue",3,!0)}}],create:function(e){return new this.strategies[e]},createRandom:function(){return this.create(Math.round(1e3*Math.random())%this.strategies.length)},getAll:function(){return this.strategies},length:function(){return this.strategies.length}};class ee{constructor(e,t,s){this.risque=e,this.probaDes=[0,2.77,5.55,8.33,11.1,13.8,16.7,13.8,11.1,8.33,5.55,2.77],this.name=t,this.id=s}getRisqueTotal(e,t){return this.calculMargeMontant(e,t)*(this.calculRisque(e,e.montant)/100+1)}getMaxBudgetForStrategie(e,t){let s=t/(this.calculRisque(e,e.montant)/100+1),i=this.findCoutFromFixMarge(e,s);return i+=Math.round(.1*i*((1e3*Math.random()%10-5)/10)),Math.min(i,e.montant-e.minimumPriceHouse())}getFactorForProposition(){return 1+this.risque}getBudget(e,t){let s=e.montant;(!0===t||this.risque>.6)&&(s=e.getStats().argentDispoHypo);let i=this.plusFortLoyer(e),o=this.calculRisque(e,s);return Math.round((e.montant-i*(1-this.risque*this.risque))*(1-o/100))}getNextProprietesVisitees(e){let t=[];return ue.forEach((s=>{if(!s.equals(e))for(let i=1;i<12;i++){let o=G.get(s.pion.deplaceValeursDes(i));o.isTerrain()&&null!=o.joueurPossede&&o.joueurPossede.equals(e)&&(null!=t[o.id]?t[o.id].proba+=this.probaDes[i]/100:t[o.id]={proba:this.probaDes[i]/100,maison:o})}}),this),t}calculMargeMontant(e,t){return t/e.montant/this.risque}findCoutFromFixMarge(e,t){return t*this.risque*e.montant}calculRisque(e,t){let s=e.pion.position,i=e.pion.axe,o=0;for(let n=1;n<=12;n++){let r=G.nextPos(i,s);i=r.axe,s=r.position;let a=G.getById(i+"-"+s);null!=a&&null!=a.getLoyer&&null!=a.joueurPossede&&!a.joueurPossede.equals(e)&&a.getLoyer()>t*this.risque&&(o+=this.probaDes[n-1])}return o}plusFortLoyer(e){let t=e.montantDepart,s=G.iteratorTerrains();for(;s.hasNext();){let i=s.next();null!=i.getLoyer&&null!=i.joueurPossede&&!e.equals(i.joueurPossede)&&i.getLoyer()>t&&(t=i.getLoyer())}return t}getLoyerMoyen(e){let t=e.montantDepart,s=1,i=G.iteratorTerrains();for(;i.hasNext();){let o=i.next();null==o.getLoyer||null==o.joueurPossede||e.equals(o.joueurPossede)||(t+=o.getLoyer(),s++)}return{montant:t/s,nb:s}}}let te={comportements:[class extends ee{constructor(){super(.25,"Prudent",0)}},class extends ee{constructor(){super(.5,"Normal",1)}},class extends ee{constructor(){super(.8,"Fou",2)}}],create:function(e){return new this.comportements[e]},createRandom:function(){return this.create(Math.round(1e3*Math.random())%this.comportements.length)},getAll:function(){return this.comportements},length:function(){return this.comportements.length}};const se="TERRAIN_NON_LISTE",ie="TERRAIN_DISPO",oe="ARGENT_INSUFFISANT";class ne extends O{constructor(e){super(e)}saveMore(e){e.comportement=this.joueur.comportement.id,e.strategie=this.joueur.strategie.id,e.rejectedPropositions=[];for(let t in this.joueur.rejectedPropositions){let s=this.joueur.rejectedPropositions[t][this.joueur.rejectedPropositions[t].length-1].proposition,i=[];s.terrains.forEach((e=>i.push(e.id))),e.rejectedPropositions.push({id:t,proposition:{compensation:s.compensation,terrains:i}})}}loadMore(e){if(this.joueur.init(e.strategie,e.comportement),this.joueur.rejectedPropositions=[],null!=e.rejectedPropositions)for(let t in e.rejectedPropositions){let s=e.rejectedPropositions[t].proposition,i=[];if(null!=s.terrains)for(let e in s.terrains)i.push(G.getById(s.terrains[e]));this.joueur.rejectedPropositions[e.rejectedPropositions[t].id]=[{proposition:{compensation:s.compensation,terrains:i}}]}}}class re extends V{constructor(e,t,s,i,o){super(e,t,s,i,o),this.type="Ordinateur",this.threasholdMontant=.65*i,this.canPlay=!1,this.strategie=null,this.comportement=null,this.nom=t,this.rejectedPropositions=[],this.saver=new ne(this),this.init()}init(e,t){this.strategie=void 0===e?K.createRandom():K.create(e),this.comportement=void 0===t?te.createRandom():te.create(t)}joue(){this.changeStrategie(),this.echangeProprietes((()=>{this.buildConstructions(),this.rebuyHypotheque(),i.debug({message:`joueur ${this.nom} joue`}),x.lancer()}))}choisiCase(e){let t,s=G.getFreeFiches(),i=null;s.forEach((function(e){let s=this.strategie.interetGlobal(e,this,!1).interet;0!==s&&(void 0===t||s>t)&&(t=s,i=e)}),this),null!=i?e(i):this.getOutPrison()?e(G.getDepart()):e(G.getPrison())}choisiDes(e,t,s){let i={fiche:this.pion.deplaceValeursDes(e),total:e},o={fiche:this.pion.deplaceValeursDes(t),total:t},n={fiche:this.pion.deplaceValeursDes(e+t),total:e+t},r=-1e3,a=0;[i,o,n].forEach((e=>{let t=this._analyseCase(G.get(e.fiche));t>r&&(a=e.total,r=t)})),s(a)}_analyseCase(e){let t=0;switch(!0===e.isPropriete()&&(t=0===e.statut?this.strategie.interetGlobal(e,this,!1).interet:e.getLoyerFor(this)/-1e3),e.type){case"prison":t=this.getOutPrison()?-2:1;break;case"taxe":t=-1*e.montant/1e3;break;case"depart":t=.5}return t}actionApresDes(e,t){if(void 0===e||null==e)return;let s=this;setTimeout((function(){if(null!=e.Acheter&&null!=t){let o=s.strategie.interetGlobal(t).interet,n=s.comportement.getRisqueTotal(s,t.achat);if(i.debug({message:"Strategie : "+o+" "+n}),o>n)return i.debug({message:"IA Achete"}),void e.Acheter()}for(let t in e)if("Acheter"!==t)return void e[t]()}),Ne)}notifyAcceptProposition(e){e&&e()}notifyRejectProposition(e,t,s){void 0===this.rejectedPropositions[t.id]&&(this.rejectedPropositions[t.id]=[]),this.rejectedPropositions[t.id].push({nbTours:Ve.nbTours,proposition:s}),e()}addIsolateHouse(e,t){let s=this.maisons.findUnterestsProprietes(),i=0;if(s.proprietes.length>0)for(let o=0;o<s.proprietes.length&&i/e.achat<.7;o++){let n=s.proprietes[o];this.strategie.interetPropriete(n)||null!=n.groupe&&n.groupe.equals(e.groupe)||(t.deals.push(n),i+=n.achat)}return i}echangeProprietes(e=(()=>{})){if(Re.echangeApresVente&&G.isFreeFiches())return e();let t=this.maisons.findOthersInterestProprietes();if(0===t.length)return e();const s=this.maisons.findConstructiblesGroupes().length,o=Math.pow(1/(1+s),2);let n=[];for(let e in t){let r=t[e],a=r.maison;if(this._canAskTerrain(a)){let e=this._getLastProposition(a),i=a.joueurPossede;if(r.compensation=0,r.deals=a.joueurPossede.maisons.findOthersInterestProprietes(this,a),0===r.deals.length){let t=this.addIsolateHouse(a,r);t/a.achat<.8&&(r.compensation=this.evalueCompensation(i,a,o,e)-t)}else{const t=this.chooseMonnaiesEchange(r,r.monnaiesEchange,!0,s>=2,e);void 0===t||0===t.length?(r.compensation=this.evalueCompensation(i,a,o,e),r.deals=null):r.deals=t}if((null==r.deals||0===r.deals.length)&&0===r.compensation){const e=this.maisons.findOthersProperties(t);let s=0;for(let t=0;t<e.length&&s/a.achat<.7;t++){const i=e[t];this.strategie.interetPropriete(i)||(null==r.deals&&(r.deals=[]),r.deals.push(i),s+=i.achat)}}(null!=r.deals&&r.deals.length>0||null!=r.compensation&&r.compensation>0)&&n.push(r)}else i.debug({message:"Le joueur ne demande pas "+a.nom})}this.doPropositionToPlayer(n,e)}doPropositionToPlayer(e,t){if(0===e.length)return t();for(let s in e){let i=e[s],o={terrains:null==i.deals?[]:i.deals,compensation:i.compensation};try{return d.init(this,i.maison.joueurPossede,i.maison,t),void d.propose(o)}catch(e){return console.log(e),t()}}}_canAskTerrain(e){const t=this._getLastProposition(e);if(null!=t){const e=3+Math.round(1e3*Math.random()%3);return t.nbTours+e<Ve.nbTours}return!0}_getLastProposition(e){return null!=this.rejectedPropositions&&null!=this.rejectedPropositions[e.id]?this.rejectedPropositions[e.id][this.rejectedPropositions[e.id].length-1]:null}traiteRequeteEchange(e,t,s){if(!(void 0!==s.terrains&&0!==s.terrains.length||void 0!==s.compensation&&0!==s.compensation))return d.reject(this);let i=this.maisons.findOthersInterestProprietes(e),o=this._calculatePropositionValue(t,e,s,i);if(o.critere>=3)return d.accept(this);if(o.critere<=0)return d.reject(this);let n={terrains:[],compensation:0},r=0;do{n=this._calculateContreProposition(e,s,n,o.recommandations,t,i),o=this._calculatePropositionValue(t,e,n,i)}while(o.critere<3&&r++<3);return o.critere<3?d.reject(this):d.contrePropose(n,this)}_calculateContreProposition(e,t,s,i,o,n){if(1===i[ie]||1===i[se]){let r=0;for(let e=0;e<n.length&&(n[e].maison.groupe.equals(o.groupe)||(s.terrains.push(n[e].maison),r+=n[e].maison.achat,!(r>o.achat)));e++);if(r<o.achat&&1===i[se]){let i=!1;for(let o=0;o<t.length&&!i;o++)if(s.terrains.contains(t.terrains[o])||(s.terrains.push(t.terrains[o]),i=!0),!i){let t=e.maisons.findUnterestsProprietes();t.proprietes.length>0&&s.terrains.push(t.proprietes[0])}}}return 1===i[oe]&&(s.compensation+=o.achat/2),s}_calculatePropositionValue(e,t,s,o){let n=[],r=o.some((t=>e.groupe.equals(t.maison.groupe))),a=0,u=0;if(null!=s.terrains&&s.terrains.length>0){let t=!1;for(let i in s.terrains){let n=s.terrains[i],r=null;for(let e=0;e<o.length;e++)o[e].maison.equals(n)&&(r=e);null!=r&&(a+=1+(o.length-r)/o.length,t=!0),a+=n.achat/e.achat}t||(n[se]=1)}else null!=o&&o.length>0&&(a-=o.length-(r?1:0),n[ie]=1);null!=s.compensation?(u=s.compensation/e.achat,this.montant<s.compensation?u+=Math.min(1.5,s.compensation/this.montant-1):n[oe]=1):n.NO_ARGENT=1;let l=(a+u)*this.strategie.acceptSwapTerrain(e,t,o,r);return i.debug({message:"Criteres : "+l+" "+a+" "+u}),{critere:l,recommandations:n,others:o}}traiteContreProposition(e,t,s){if(0===e.terrains.length&&0===e.compensation)return d.reject(this);let i,o=this.maisons.findOthersInterestProprietes(t);if(e.terrains.length>0){let n={terrains:[s],compensation:-1*e.compensation},r=e.terrains[0];i=this._calculatePropositionValue(r,t,n,o)}else i={critere:2};return i.critere>3?d.accept(this):d.reject(this)}evalueCompensation(e,t,s,i){let o=this.comportement.getBudget(this,null!=s&&s>2),n=Math.min(o,t.achat);if(null!=i&&i.proposition.compensation>=n){n=Math.min(this.montant,i.proposition.compensation*this.comportement.getFactorForProposition());let e=(14-Math.log(t.achat))*t.achat;n=Math.min(n,e)}return Math.round(Math.max(0,n))}isDangerous(e){let t=this.argent/e.maisons[0].prixMaison/e.fiches.length,s=e.maisons[0].loyers[t]/this.threasholdMontant,i=this.maisons.findConstructiblesGroupes(),o=!1;for(let t in i)i[t].isVoisin(e)&&(o=!0);return(t+s)*(o?2:1)>=5}chooseMonnaiesEchange(e,t,s,i,o){if(void 0===t||0===t.length)return[];let n=[],r=0;for(let i in t)e.joueurPossede.isDangerous(t[i].groupe)&&s||(0===r||Math.abs(1-e.achat/r)/Math.abs(1-e.achat(r+t[i].achat))>1)&&(n.push(t[i]),r+=t[i].achat);return 0!==n.length||i||!s&&null==o?n:this.chooseMonnaiesEchange(e,t,joueur,!1,i)}initEnchere(e,t){if(this.equals(t.joueurPossede))return;if(null!=this.currentEchange)throw"Impossible de gerer une nouvelle enchere";let s=this.strategie.interetGlobal(t,this,!0),i=this.comportement.getMaxBudgetForStrategie(this,s.interet);this.currentEnchere={transaction:e,terrain:t,budgetMax:i,joueurInteresse:s.joueur}}updateInfoEnchere(e,t){}updateEnchere(e,t,s,i){if(e!==this.currentEnchere.transaction)return;if(this.equals(i))return;let o=Ne*(Math.random()+1);setTimeout((()=>{if(void 0!==this.currentEnchere)if(s>this.currentEnchere.budgetMax||null!=this.currentEnchere.joueurInteresse&&!this.currentEnchere.joueurInteresse.equals(i))l.exitEnchere(this);else try{l.doEnchere(this,s,t)}catch(e){}}),o)}notifyExitEnchere(e){}endEnchere(){this.currentEnchere=null,l.checkEndNotify(this)}doBlocage(){return ue.forEach((function(e){if(!this.equals(this)){let t=e.maisons.findConstructiblesGroupes();if(t.size()>0){let s=0,i=0;for(let e in t){let o=t[e];for(let e in o.proprietes){let t=o.proprietes[e];s+=5-t.nbMaison,i+=(5-t.nbMaison)*t.prixMaison}}if(s>3&&i/s*3<e.montant)return!0}}}),this),!1}_buildSortScore(e){switch(e.type){case"gare":return-1;case"compagnie":return-2;default:return e.isTerrain()?e.groupe.getInfos(this).joueur:0}}propertiesSortByDescImportance(){return this.maisons.maisons.filter((e=>!1===e.statutHypotheque&&!e.isGroupedAndBuild())).sort(((e,t)=>this._buildSortScore(e)-this._buildSortScore(t)))}resolveProblemeArgent(e,t){i.debug({message:"Resoud probleme argent"});let s=this.propertiesSortByDescImportance();i.debug({message:"PHASE 1"});for(let t=0;t<s.length&&this.montant<e;t++)s[t].hypotheque();if(this.montant<e){i.debug({message:"PHASE 2"});let t=this.getGroupsToConstruct("ASC",.1);for(let s in t){let o=t[s].proprietes;o.sort(((e,t)=>e.nbMaison===t.nbMaison?0:e.nbMaison<t.nbMaison?1:-1));let n=0,r=0,a=0,u=0;for(;this.montant<e&&r<o.length&&a++<100;){let e=o[n];0===e.nbMaison?r++:e.sellMaison(this)&&(u++,this.gagner(e.prixMaison/2,!0)),n=(n+1)%o.length}if(this.montant>e){u>0&&i.send("monopoly.vendMaison",{joueur:this,nbMaison:u}),i.refresh();break}}}if(this.montant<e){let t=this.maisons.maisons.filter((e=>!1===e.statutHypotheque));t.sort(((e,t)=>e.achat-t.achat));for(let s=0;s<t.length&&this.montant<e;s++)t[s].hypotheque()}return this.setArgent(this.montant-e),this.bloque=!1,t(),!0}getNbGroupConstructibles(){return this.maisons.maisons.filter((e=>e.isGrouped())).reduce(((e,t)=>(e.add(t.groupe.nom),e)),new Set).size}getGroupsToConstruct(e,t){let s=this.maisons.findConstructiblesGroupes();if(0===s.size())return[];let i=this.comportement.getNextProprietesVisitees(this,t);for(let e in s){let t=s[e];t.proba=0,t.rentabilite=0,t.lessThree=0,t.interetGlobal=0;for(let e in t.proprietes){let s=t.proprietes[e];null!=i[s.id]&&(t.proba+=3*i[s.id].proba),t.rentabilite+=s.getRentabilite(),t.lessThree+=s.nbMaison<=3?.5:0}}let o=[];for(let e in s){let t=s[e];t.interetGlobal=t.proba+t.rentabilite+(t.lessThree>0?.5:0),o.push(t)}let n="ASC"===e?1:-1,r="ASC"===e?-1:1;return o.sort(((e,t)=>e.interetGlobal===t.interetGlobal?0:e.interetGlobal>t.interetGlobal?n:r)),o}hasConstructedGroups(e=0){let t=this.maisons.findConstructiblesGroupes();for(let s in t)if(t[s].group.getAverageConstructions()>e)return!0;return!1}rebuyHypotheque(){let e=this.maisons.findMaisonsHypothequees();if(void 0===e||0===e.length&&this.getNbGroupConstructibles()>0&&!this.hasConstructedGroups(3))return;let t=0;for(;t<e.length&&this.montant>7*e[t].achatHypotheque;)e[t++].leveHypotheque()}minimumPriceHouse(){return 0===this.maisons.maisons.length?0:this.maisons.maisons.reduce(((e,t)=>e.prixMaison<t.prixMaison?e:t),Number.MAX_SAFE_INTEGER).prixMaison}buildConstructions(){if(0===this.maisons.maisons.length)return;let e=this.comportement.getBudget(this);if(e<this.minimumPriceHouse())return;let t=this.getGroupsToConstruct("DESC",.1);if(0===t.length)return;for(let e in t)t[e].proprietes.sort((function(e,t){return e.nbMaison===t.nbMaison?e.achat===t.achat?0:e.achat<t.achat?1:-1:e.nbMaison>t.nbMaison?1:-1}));let s=!1,o=0,n=0,r=3,a={maison:0,hotel:0,terrains:[]};for(;e>=5e3&&!s;){let i=t[n],u=i.proprietes[o];if(u.nbMaison>=r)if(void 0===i.treat?i.treat=1:i.treat++,i.treat===i.proprietes.length){if(n++,o=0,n>=t.length)if(3===r){r=5;for(let e in t)t[e].treat=0;n=0}else s=!0}else o=(o+1)%i.proprietes.length;else try{u.buyMaison(this,!0),e-=u.prixMaison,this.payer(u.prixMaison),4===u.nbMaison?a.hotel++:a.maison++,a.terrains[i.proprietes[o].id]=i.proprietes[o],o=(o+1)%i.proprietes.length}catch(e){s=!0}}i.send("monopoly.acheteConstructions",{joueur:this,achats:a}),i.refresh()}changeStrategie(){if(this.strategie.getStatsProprietes().color.pourcent<40&&this.countInterestProperties()<=2&&!this.isFamilyFree()){i.debug({message:this.nom+" cherche une nouvelle strategie"});for(let e in K.getAll()){let t=K.create(e);if(t.name!==this.strategie.name&&t.getStatsProprietes().color.pourcent>50)return i.debug({message:this.nom+" change de stratégie : "+this.strategie.name+" => "+t.name}),void(this.strategie=t)}}}countInterestProperties(){return this.maisons.maisons.filter((e=>this.strategie.groups.contains(e.color))).length}isFamilyFree(){let e=[];for(let t in this.maisons.maisons){let s=this.maisons.maisons[t];if(!e[s.groupe.nom]){e[s.groupe.nom]=!0;let t=!0;for(let e in s.groupe.fiches){let i=s.groupe.fiches[e];0===i.statut||this.equals(i.joueurPossede)||(t=!1)}if(t)return!0}}return!1}actionAvantDesPrison(e){setTimeout((()=>{this.getOutPrison()?null!=e["Utiliser carte"]?e["Utiliser carte"]():e.Payer():e.Attendre()}),Ne)}getOutPrison(){let e=this.comportement.getLoyerMoyen(this),t=this.maisons.getGroupesPossibles();return!(this.maisons.findConstructiblesGroupes().size()>=2)&&(t.length>0&&e.montant<.3*this.montant||!(e.nb>=4&&e.montant>.15*this.montant))}gererAchat(e){e.click()}}class ae extends re{constructor(e,t,s,i,o){super(e,t,s,i,o)}moveTo(e){let t=this.pion.deplaceValeursDes(e);W.moveTo(G.buildId(t),this),this.joueSurCase(t)}notifyDices(e,t){W.dices(e,t,this)}notifySelect(){W.notifySelect(this)}notifyAcheteMaison(e,t){W.notifyAcheteMaison(e,t,this)}gagner(e){this.setArgent(this.montant+e),W.gagner(e,this)}notifyPay(e){W.payer(e,this)}}let ue={colorsJoueurs:["#383C89","#A6193E","#C58F01","#086B3D","#B9B29B","#663300"],imgJoueurs:[],joueurs:[],joueurCourant:null,getJoueurCourant(){return this.joueurCourant},setColors(e){null!=e&&(this.colorsJoueurs=e)},setImgJoueurs(e){null!=e&&(this.imgJoueurs=e)},getNbJoueurs(){return this.joueurs.length},getNb(){return this.joueurs.reduce(((e,t)=>e+(t.defaite?0:1)),0)},createAndLoad(e,t,s,i,o){let n=e?le.getRobotPlayer():le.getCurrentPlayer();return this.create(n,t,s,i.defaite,0,o).saver.load(i)},init(){document.querySelectorAll(".panneau_joueur").forEach((e=>e.innerHTML="")),this.joueurs=[],this.joueurCourant=null},lancerDes(){this.joueurCourant.lancerDes()},displayLineByGroupsAsElement(){let e=G.getGroups();const t=`calc((45vw - ${5*(e.size()+1)}px) / ${e.size()+1})`;e.size();let s=document.createElement("div");s.classList.add("count-property");for(let i in e){let o=i.replace(/ /g,"");s.insertAdjacentHTML("beforeend",`<span class="counter-group ${o}" style="width:${t};background-color:${e[i]};">0</span>`)}return s},create(e,t,s,o,n,r){let a=`joueur${t}`,u=this.colorsJoueurs[t],l=this.imgJoueurs[t],h=new e(t,s,u,n,r);h.enPrison=!1,h.defaite=o,h.setEnableMouseFunction(le.mouseFunction);const c=document.querySelector(".player_"+(t%2==0?"left":"right")),d=document.createElement("div");return d.id=a,o&&d.classList.add("defaite"),d.insertAdjacentHTML("beforeend",`<div class="joueur-bloc"><span class="joueur-id"><span class="joueur-name">${h.nom}</span> : <span class="compte-banque"></span> ${Ue}</span><span class="info-joueur" title="Info joueur" data-idjoueur="${t}"><img src="img/info-user2.png" style="cursor:pointer;width:24px;float:right"/></span></div>`),d.querySelectorAll("div.joueur-bloc").forEach((e=>e.style.setProperty("background-image",`linear-gradient(to right,white 50%,${u})`))),d.append(this.displayLineByGroupsAsElement()),c.insertAdjacentHTML("beforeend",'<hr style="border:solid 2px darkgray"/>'),c.append(d),h.setDiv(d),h.setPion(u,l,r),i.send("monopoly.newPlayer",{joueur:h}),this.joueurs.push(h),h},getByUniqueId(e){return this.joueurs.find((t=>null!=t.uniqueID&&t.uniqueID===e))},getById(e){return this.joueurs.find((t=>t.numero===parseInt(e)||t.playerID===e))},change(e){if(null!=this.joueurCourant&&this.joueurCourant.endTurn(),null!=e){let t=this.getById(e);if(null!=t)return t.notifySelect(),this._select(t)}if(d.running)return;let t=null;try{t=this.next(),null==t||null!=ue.getJoueurCourant()&&t.id===ue.getJoueurCourant().id||i.debug({message:`Change player to ${t.nom}`})}catch(e){return this._showVainqueur(e),null}if(null==t)return null;null!=ue.getJoueurCourant()&&t.id===ue.getJoueurCourant().id||(t.notifySelect(),x.resetDouble()),this._select(t)},getAvailableSlots(){return this.joueurs.filter((e=>e.isSlotFree()))},_showVainqueur(e){i.send("monopoly.victoire",{joueur:e});const t=this.joueurs.filter((function(e){return e.defaite}));t.sort(((e,t)=>e.tourDefaite===t.tourDefaite?t.numero-e.numero:t.tourDefaite-e.tourDefaite));let s=`Le joueur ${e.nom} a gagné en ${this._formatTempsJeu(Ve.heureDebut)}.<br/>`;s+=`1 - ${e.nom}<br/>`,s+=t.map(((e,t)=>`${t+2} - ${e.nom}`)).join("<br/>");let o=this._calculateScore(e);b.create(this.joueurCourant,`Fin de partie : ${o} Points`,"green",s,(()=>{}),null,!0,{Recommencer:()=>{p.close(),Ze()}})},_calculateScore(e){let t=e.getStats(),s=t.argent/1e4,i=e.maisons.maisons.length*this.joueurs.length/4,o=1+t.hotel/12+t.maison/32,n=(t.tour+1)*this.joueurs.length,r=1;this.joueurs.forEach((t=>{r+=t.equals(e)?0:t.pion.stats.tour}));let a=(n-r)*s*i*o;return Math.round(a)},_formatTempsJeu(e){let t=Math.round(((new Date).getTime()-e)/1e3);if(t<60)return t+" sec";const s=t%60;return t=Math.round(t/60),`${t} min et ${s} sec`},_select(e){e.canPlay?document.querySelectorAll(".action-joueur").forEach((e=>{e.classList.remove("disabled"),e.removeAttribute("disabled")})):s(),Re.echangeApresVente&&G.isFreeFiches()&&(document.getElementById("idEchangeTerrains").setAttribute("disabled","disabled"),document.getElementById("idEchangeTerrains").classList.add("disabled")),e.equals(this.joueurCourant)||(document.querySelectorAll(".joueurCourant").forEach((e=>e.classList.remove("joueurCourant"))),null!=this.joueurCourant&&null!=this.joueurCourant.pion&&this.joueurCourant.pion.pion.setSelected(!1)),this.joueurCourant=e,this.joueurCourant.pion.pion.setSelected(!0),e.select()},getWinner(){let e,t=0;for(let s in this.joueurs)!0===this.joueurs[s].defaite?t++:e=this.joueurs[s];return t===this.joueurs.length-1?e:null},next(){if(null==this.joueurCourant)return this.joueurs[0];if(this.joueurCourant.bloque)return null;let e=this.getWinner();if(null!=e)throw e;let t=this.joueurCourant;if(!x.continuePlayer()&&!x.isSpecificAction()){let e=0;for(t=this.joueurs[(t.numero+1)%this.joueurs.length];!0===t.defaite&&e++<this.joueurs.length;)t=this.joueurs[(t.numero+1)%this.joueurs.length];t.numero<this.joueurCourant.numero&&Ve.nbTours++}return x.isSpecificAction()?(x.doSpecificAction(),null):t},forEach(e,t){this.joueurs.forEach(e,t)}};window.gestion=ue;let le={network:!1,master:!0,setMouseFunction(e){this.mouseFunction=e},useNetwork(){this.network=!0},useLocal(){this.network=!1},setMaster(){this.master=!0},setSlave(){this.master=!1},getRobotPlayer(){return this.network?ae:re},getCurrentPlayer(){return this.network?this.master?U:Q:V},getOtherPlayer(){return this.network?this.master?X:Y:V}};class he{constructor(e){this.type=e}action(e){console.error("Not implemented "+e,this.type)}}class ce extends he{constructor(e,t){super("reparation"),this.tarifHotel=e,this.tarifMaison=t}action(e){let t=e.getStats(),s=t.hotel*this.tarifHotel+t.maison*this.tarifMaison;e.payer(s,(()=>ue.change()))}}class de extends he{constructor(e){super("birthday"),this.montant=e}action(e){let t=ue.joueurs.filter((t=>!e.equals(t)&&!t.defaite));t.forEach(((s,i)=>{s.payerTo(this.montant,e,(()=>{i===t.length-1&&ue.change()}))}))}}class pe extends he{constructor(e,t,s,i=!0){super("goto"),this.fiche={axe:e,pos:t},this.direct=s,this.primeDepart=i}action(e){e.joueSurCase(this.fiche,this.direct,this.primeDepart,!0)}}class me extends he{constructor(){super("prison"),this.joueurPossede=null}action(e){e.cartesSortiePrison.push(this),this.joueurPossede=e,ue.change()}isLibre(){return null==this.joueurPossede}}class ge extends he{constructor(e,t=!0,s=!0){super("move"),this.nb=e,this.direct=t,this.primeDepart=s}action(e){let t=e.pion.deplaceValeursDes(this.nb);e.joueSurCase(t,this.direct,this.primeDepart)}}class fe extends he{constructor(e,t){super("taxe"),this.plateauMonopoly=t,this.montant=e}action(e){e.payerParcGratuit(this.plateauMonopoly.parcGratuit,this.montant,(()=>ue.change()))}}class ye extends he{constructor(e){super("prime"),this.montant=e}action(e){e.gagner(this.montant),ue.change()}}let be={prefix:"monopoly.",suffix:".save",currentSauvegardeName:null,isSauvegarde:function(){return null!=this.currentSauvegardeName},save:function(e,t){this.currentSauvegardeName=null!=e?this.getSauvegardeName(e):this.currentSauvegardeName||this.getSauvegardeName(),this.saveWithName(this.currentSauvegardeName,t),i.send("monopoly.save",{name:this.currentSauvegardeName})},saveWithName:function(e,t){let s=[];ue.joueurs.filter((e=>e.saver)).forEach((e=>s.push(e.saver.save())));let i=[],o=G.iteratorTerrains();for(;o.hasNext();)i.push(o.next().save());let n={joueurs:s,fiches:i,joueurCourant:null!=ue.getJoueurCourant()?ue.getJoueurCourant().id:"",variantes:Re,options:t.options,nbTours:Ve.nbTours,plateau:t.name};this._putStorage(e,n)},load:function(e,s){this.currentSauvegardeName=e;let o=this._getStorage(e);ze(t(Re,o.variantes)),s.plateau.load(o.plateau||"data-monopoly.json",o.options,(function(){o.joueurs.forEach(((e,t)=>ue.createAndLoad(!e.canPlay,t,e.nom,e,s.plateau.infos.montantDepart))),o.fiches.forEach((e=>G.getById(e.id).load(e))),i.refresh(),Ve.nbTours=o.nbTours||0,s.afterCreateGame(),ue.change(o.joueurCourant)}))},delete:function(e){localStorage.removeItem(e)},_putStorage:function(e,t){localStorage[e]=JSON.stringify(t)},_getStorage:function(e){if(null==localStorage[e])throw"Aucune sauvegarde";const t=localStorage[e];return JSON.parse(t)},autoSave:function(){},findSauvegardes:function(){let e="^"+this.prefix+"(.*)"+this.suffix+"$",t=[];for(let s in localStorage){let i=new RegExp(e,"g").exec(s);null!=i&&t.push({value:s,label:i[1]})}return t},getSauvegardeName:function(e){return this.prefix+(null==e||""===e?(new Date).getTime():e)+this.suffix}};class ve{constructor(e,t,s,i,o=!0){o&&(this.name=t,this.game=s,this.plateau=e,this.playerUniqueID=i,this.startSource(),this.listenLocalEvents())}startSource(){this.source=new EventSource(`/connect?name=${name}&game=${this.game}${this.playerUniqueID?`&player=${this.playerUniqueID}`:""}`),this.source.onerror=e=>{b.create({},"Connection impossible","red","Impossible de se connecter, le numéro de partie n'existe pas",(()=>Ke()),{},!0)},this.queueEvents.detectEndMove(),this.source.addEventListener("event",(e=>{this.queueEvents.add(JSON.parse(e.data))})),this.source.addEventListener("welcome",(e=>{null!=localStorage&&(localStorage.network_game=this.game),this.welcome(JSON.parse(e.data))}))}isMaster(){return!1}welcome(e){if(void 0===this.playerID){this.playerID=e.playerID;const t=`/event?game=${this.game}&playerID=${this.playerID}`;this.eventSender=new we(t,this.plateau,this.isMaster()),this.askJoin()}}askJoin(){let e={kind:"join",playerID:this.playerID,name:this.name};null!=this.playerUniqueID&&(e.uniqueID=this.playerUniqueID),this.eventSender.sendEvent(e)}listenLocalEvents(){i.observe("event.network",(e=>{this.debug("Receive local EVENT",e),this.eventSender.sendEvent(e)}))}create(e,t,s,i,o,n){let r={typeGame:i.quickDice?"quick":"classic"};return new Promise((a=>{let u=Ke(!1,!1);u.plateau.load(i.plateau,r,(()=>{le.useNetwork(),le.setSlave();for(let r=0;r<e;r++){let e=r===t?le.getCurrentPlayer():le.getOtherPlayer();ue.create(e,r,r===t?s:i.playersName[r],!1,o,n)}this.queueEvents.end(i),u.afterCreateGame(i.playersName),a()}))}))}debug(){Ge&&console.log(...arguments)}readEvent(e){let t=ue.getById(e.player);if("disconnected"!==e.kind&&"join"!==e.kind&&"connected"!==e.kind&&"end"!==e.kind&&null==t)throw`No player found for event ${e.kind}`;switch(e.kind){case"disconnected":this.debug("DISCONNECTED",e),this.disconnect(e);break;case"connected":return this.debug("CONNECTED",e),void this.connect(e,t);case"move":this.debug("MOVES",e),t.moveTo(e.nb);break;case"moveTo":this.debug("MOVES",e),t.joueSurCase(G.getById(e.to));break;case"tax":this.debug("TAX",e),t.setArgent(t.montant-e.montant);break;case"earn":this.debug("EARN",e),t.setArgent(t.montant+e.montant);break;case"hypotheque":this.debug("HYPOTHEQUE",e),G.getById(e.terrain).doHypotheque();break;case"leverHypotheque":this.debug("LEVER HYPOTHEQUE",e),G.getById(e.terrain).doLeveHypotheque();break;case"change":this.debug("CHANGE"),ue._select(t);break;case"jail":this.debug("JAIL"),t.goPrison();break;case"buyHouse":this.debug("BUY HOUSE"),G.getById(e.terrain).setNbMaison(e.nb);break;case"loyer":this.debug("LOYER"),i.send("monopoly.payerLoyer",{joueur:t,maison:G.getById(e.maison)});break;case"exit":this.debug("EXIT"),i.send("monopoly.exit",{joueur:t});break;case"message":this.debug("GOT MESSAGE",e),i.send(e.name,{joueur:t,message:e.libelle,maison:null==e.maison?null:G.getById(e.maison)});break;case"buy":this.debug("BUY",e),t.acheteMaison(G.getById(e.terrain),0);break;default:this.readMoreEvent(e,t)}this.queueEvents.end(e)}connect(e,t){Re.quickMove=e.quickMove,e.playerID===this.playerID?(this.create(e.nb,e.posPlayer,e.name,e,e.argentDepart,e.montantDepart).then((()=>this._updatePlayers(e))),localStorage.uniqueID=e.uniqueID):null!=t&&t.setPlayer(e.name)}_updatePlayers(e){""!==e.joueurCourant&&ue.change(e.joueurCourant),e.detailJoueurs.forEach((e=>{let t=ue.getById(e.id);t.setArgent(e.montant),t.joueSurCaseNoAction(e.position),e.enPrison&&t.showPrison(),t.nbDouble=e.nbDouble,e.maisons.forEach((e=>t.showAcheteMaison(G.get(e))))}))}disconnect(e){e.playerID===this.playerID&&(this.source.close(),b.create({canPlay:!0},"Impossible to connect game","red","You can't access monopoly game, no enough place",(()=>Ke())))}readMoreEvent(e,t){switch(e.kind){case"dices":x.gestionDes.setAndShowDices(e,t);break;case"prison":t.goPrison(!1);break;case"exitPrison":t.exitPrison({noTrigger:!1,paye:e.paye,carte:e.carte,notify:!1})}}queueEvents={parent:this,queue:[],add(e){1===this.queue.push(e)&&this.launch()},launch(){if(0===this.queue.length)return;let e=this.queue[0];this.parent.readEvent(e)},end(e,t){0===this.queue.length||e.kind!==this.queue[0].kind||"moveTo"===e.kind&&!0!==t||(this.queue.shift(),this.launch())},detectEndMove(){i.observe("move.end",(()=>this.end({kind:"moveTo"},!0)))}}}class Pe extends ve{constructor(e,t,s){super(s,e,t)}create(e,t,s,o,n,r){le.useNetwork(),le.setMaster();let a=e-t-1;for(let t=0;t<e;t++){let e,i=`Joueur ${t+1}`;0===t?(e=le.getCurrentPlayer(),""!==s&&(i=s)):(t<o.length&&void 0!==o[t]&&(i=o[t]),t<a+1&&(e=le.getOtherPlayer()),t>a&&(e=le.getRobotPlayer())),o[t]=i,ue.create(e,t,i,!1,n,r)}return a>0&&i.send("monopoly.waitingPlayers",{nb:a,idGame:this.game}),o}readMoreEvent(e,t){switch(e.kind){case"launchDices":C.throw(3).then((e=>{x.gestionDes.setDices(e[0],e[1],e[2]),x.gestionDes._drawCubes(e[0],e[1],e[2]),x.gestionDes.after()}));break;case"join":this.joinGame(e);break;case"end":ue.change();break;default:super.readMoreEvent(e,t)}}askJoin(){}rejoinGame(e){let t=ue.getByUniqueId(e.uniqueID);null==t&&console.log("Error non player"),t.playerID=e.playerID,y.write(t,"is rejoining the game"),this.eventSender.sendEvent(this.createGameInformations(t,e))}joinGame(e){if(null!=e.uniqueID)return this.rejoinGame(e);let t=ue.getAvailableSlots();if(0===t.length)return console.log("No more free spaces"),this.eventSender.sendEvent({kind:"disconnected",playerID:e.playerID});let s=t[0];s.setPlayer(e.name),s.playerID=e.playerID,s.uniqueID=`id_${btoa(1e8*Math.random())}`,y.write(s,"is joining the game"),this.createGameInformations(s,e),this.eventSender.sendEvent(this.createGameInformations(s,e)),1===t.length&&(ue.change(),i.send("monopoly.start"))}createGameInformations(e,t){return{kind:"connected",player:e.id,name:e.nom,posPlayer:e.numero,playerID:t.playerID,uniqueID:e.uniqueID,playersName:this.plateau.infos.realNames,plateau:this.plateau.name,quickMove:Re.quickMove,argentDepart:this.plateau.infos.argentJoueurDepart,montantDepart:this.plateau.infos.montantDepart,quickDice:this.plateau.isQuickDice(),nb:ue.getNbJoueurs(),joueurCourant:null!=ue.getJoueurCourant()?ue.getJoueurCourant().id:"",detailJoueurs:this.getPlayersInformations()}}getPlayersInformations(){return ue.joueurs.map((e=>({id:e.id,montant:e.montant,enPrison:e.enPrison,nbDouble:e.nbDouble,defaite:e.defaite,position:e.getPosition(),maisons:e.maisons.maisons.map((e=>({hotel:e.hotel,axe:e.axe,pos:e.pos,nbMaison:e.nbMaison,statutHypotheque:e.statutHypotheque})))})))}isMaster(){return!0}sendDices(e,t){this.eventSender.sendEvent({kind:"dices",player:t,dice1:e[0],dice2:e[1],quickDice:e[2]})}}class we{constructor(e,t,s=!1){this.url=e,this.isMaster=s,this.plateau=t}sendEvent(e){!function(e,t){w(e,JSON.stringify(t))}(this.url,e),this.isMaster&&be.saveWithName("lastest",this.plateau)}}class xe extends r{constructor(e,t,s,i){super(),this.axe=0,this.pos=0,this.x=0,this.y=0,this.joueur=i,this.color=e,this.isSelected=!1,this.largeur=t,this.currentInterval=null,this.img=null,null!=s&&(this.img=new Image,this.img.src=s,this.largeur+=6),this.init(2,0)}init(e,t){let s=e+"-"+t;this.axe=e,this.pos=t,this.x=G.getById(s).drawing.getCenter().x,this.y=G.getById(s).drawing.getCenter().y}draw(e){this.joueur.defaite||(this.isSelected&&(n.drawCircle(e,this.color,(this.largeur+22)/2,{x:this.x,y:this.y},"#FF0000"),n.drawCircle(e,"#FFFFFF",(this.largeur+18)/2,{x:this.x,y:this.y},"#FF0000")),null!=this.img?n.drawImage(e,this.img,this.x-this.largeur/2,this.y-this.largeur/2,this.largeur,this.largeur,0):n.drawCircle(e,this.color,this.largeur/2,{x:this.x,y:this.y},"#FF0000"),n.drawCircle(e,"#FFFFFF",2,{x:this.x,y:this.y},"#FF0000"))}setSelected(e){this.isSelected=e}goto(e,t,s,i,o=Re.quickMove){if(o)return this.gotoDirect(e,t,s);if(null!=this.currentInterval)return setTimeout((()=>this.goto(e,t,s,i)),500);if(i){let e=G.getById(this.axe+"-"+this.pos).drawing.getCenter();this.x=e.x,this.y=e.y}if(this.axe===e&&this.pos===t){let e=G.getById(this.axe+"-"+this.pos).drawing._decalagePion();return this.x=e.x,this.y=e.y,void(s&&s())}const n=this._toNextCase();let r="x";this.x===n.x&&(r="y");let a=Math.abs(n[r]-this[r]);const u=n[r]>this[r]?1:-1;this.currentInterval=setInterval((()=>{a>0?(this[r]+=5*u,a-=5):(this.y=n.y,this.x=n.x,clearInterval(this.currentInterval),this.currentInterval=null,this.goto(e,t,s))}),30)}gotoDirect(e,t,s){if(null==e||null==t)return;if(null!=this.currentInterval)return setTimeout((()=>this.gotoDirect(e,t,s)),500);let i=G.getById(this.axe+"-"+this.pos).drawing.getCenter(),o=G.getById(e+"-"+t).drawing.getCenter();if(i.x===o.x){let n=i.y>o.y?-1:1;this.currentInterval=setInterval((()=>{if(n<0&&this.y<=o.y||n>0&&this.y>=o.y)return this._endMove(e,t,s);this.y+=30*(n<0?-1:1)}),30)}else{let n=(i.y-o.y)/(i.x-o.x),r=o.y-n*o.x,a=i.x,u=i.x>o.x?-1:1;this.currentInterval=setInterval((()=>{if(u<0&&a<=o.x||u>0&&a>=o.x)return this.x=o.x,this.y=o.y,this._endMove(e,t,s);this.x=a,this.y=n*a+r,a+=30*(u<0?-1:1)}),30)}}_endMove(e,t,s=(()=>{})){this.axe=e,this.pos=t,clearInterval(this.currentInterval),this.currentInterval=null,s()}_toNextCase(){return this.pos++,this.pos>=a.dimensions.nbCases&&(this.axe=(this.axe+1)%4,this.pos=0),G.getById(this.axe+"-"+this.pos).drawing.getCenter()}}let je=[{axe:0,color:(e,t,s,i,o,n,r)=>e.fillRect(t,s+r-o,i,o),title:(e,t,s,i,o,r,u)=>n.writeText(i,t+r,s+u-o,Math.PI,e,a.dimensions.textSize),prix:(e,t,s,i,o,r)=>n.writeText(i,t+r,s+o,Math.PI,e,a.dimensions.textSize),image:(e,t,s,i,o,r,a,u,l)=>n.drawImage(e,i,t+r-a,s+u-o,i.width,i.height,l),maison:(e,t,s,i,o,r,a)=>n.drawImage(e,i,t+r-15*o-3,s+a-2,15,15,-Math.PI),hotel:(e,t,s,i,o,r,a)=>n.drawImage(e,i,t+o-r,s+a,18,18,-Math.PI),possede:(e,t,s,i,o,r)=>{n.drawArcCircle(e,i,o,{x:t+r,y:s},Math.PI/2,Math.PI),n.drawArcCircle(e,i,o,{x:t,y:s},0,Math.PI/2)}},{axe:1,color:(e,t,s,i,o,n)=>e.fillRect(t,s,o,n),title:(e,t,s,i,o,r)=>n.writeText(i,t+o,s+r,-Math.PI/2,e,a.dimensions.textSize),prix:(e,t,s,i,o,r,u)=>n.writeText(i,t+u-o,s+r,-Math.PI/2,e,a.dimensions.textSize),image:(e,t,s,i,o,r,a,u,l)=>n.drawImage(e,i,t+o,s+r-a,i.width,i.height,l),maison:(e,t,s,i,o,r)=>n.drawImage(e,i,t+3,s+r-2-15*o,15,15,-Math.PI/2),hotel:(e,t,s,i,o,r)=>n.drawImage(e,i,t,s+o-r,18,18,-Math.PI/2),possede:(e,t,s,i,o,r,a)=>{n.drawArcCircle(e,i,o,{x:t+a,y:s+r},Math.PI,3*Math.PI/2),n.drawArcCircle(e,i,o,{x:t+a,y:s},Math.PI/2,Math.PI)}},{axe:2,color:(e,t,s,i,o)=>e.fillRect(t,s,i,o),title:(e,t,s,i,o)=>n.writeText(i,t,s+o,0,e,a.dimensions.textSize),prix:(e,t,s,i,o,r,u)=>n.writeText(i,t,s+u-o,0,e,a.dimensions.textSize),image:(e,t,s,i,o,r,a,u,l)=>n.drawImage(e,i,t+a,s+o,i.width,i.height,l),maison:(e,t,s,i,o)=>n.drawImage(e,i,t+3+15*o,s+2,15,15,0),hotel:(e,t,s,i,o,r)=>n.drawImage(e,i,t+r,s,18,18,0),possede:(e,t,s,i,o,r,a)=>{n.drawArcCircle(e,i,o,{x:t,y:s+a},3*Math.PI/2,0),n.drawArcCircle(e,i,o,{x:t+r,y:s+a},Math.PI,3*Math.PI/2)}},{axe:3,color:(e,t,s,i,o,n,r)=>e.fillRect(t+r-o,s,o,n),title:(e,t,s,i,o,r,u)=>n.writeText(i,t+u-o,s,Math.PI/2,e,a.dimensions.textSize),prix:(e,t,s,i,o)=>n.writeText(i,t+o,s,Math.PI/2,e,a.dimensions.textSize),image:(e,t,s,i,o,r,a,u,l)=>n.drawImage(e,i,t+u-o,s+a,i.width,i.height,l),maison:(e,t,s,i,o,r,a)=>n.drawImage(e,i,t+a-3,s+2+15*o,15,15,Math.PI/2),hotel:(e,t,s,i,o,r,a)=>n.drawImage(e,i,t+a,s+r,18,18,Math.PI/2),possede:(e,t,s,i,o,r)=>{n.drawArcCircle(e,i,o,{x:t,y:s+r},3*Math.PI/2,0),n.drawArcCircle(e,i,o,{x:t,y:s},0,Math.PI/2)}}];class Me extends r{constructor(e,t,s,i,o,n){super(),this.data={},this.axe=t,this.color=s,this.title=i,this.prix=o,this.nbMaison=0,this.imgMaison=new Image,this.imgHotel=new Image,this.colorPossede=null,this.rayon=10,this.init(e,t,n)}setNbMaison(e){this.nbMaison=e}init(e,t,s){this.imgMaison.src="img/maison.png",this.imgHotel.src="img/hotel.png";let i=a.dimensions.plateauSize/2,o=a.dimensions.largeur,n=a.dimensions.hauteur,r=(a.dimensions.nbCases-1)/2,u=o*r;t%2==1?(this.data.height=o,this.data.width=n,1===t?(this.data.x=i+u,this.data.y=i+(e-r-1)*o):(this.data.x=i-u-n,this.data.y=i+(r-e)*o)):(this.data.height=n,this.data.width=o,2===t?(this.data.y=i+u,this.data.x=i+(r-e)*o):(this.data.y=i-u-n,this.data.x=i+(e-r-1)*o)),this._initImage(s)}_initImage(e){if(null!=e){let t=new Image;t.addEventListener("load",(()=>{i.refresh()})),t.src=e.src,t.height=e.height,t.width=e.width,t.margin=e.margin,this.data.image=t}}getCenter(){return{x:this.data.x+this.data.width/2,y:this.data.y+this.data.height/2}}draw(e){const t=a.dimensions.bordure/2,s=a.dimensions.largeur,i=a.dimensions.hauteur;e.strokeStyle="#000000",e.strokeRect(this.data.x,this.data.y,this.data.width,this.data.height);let o=je[this.axe];if(null!=this.color&&(e.fillStyle=this.color,o.color(e,this.data.x,this.data.y,this.data.width,t,s,i)),null!=this.title){let n=12+(null!=this.color?t:0);o.title(e,this.data.x,this.data.y,this.title,n,s,i)}if(null!=this.prix&&o.prix(e,this.data.x,this.data.y,this.prix,5,s,i),null!=this.data.image){const n=Math.PI/2*((this.axe+2)%4),r=(s-this.data.image.width)/2,a=10+(null!=this.color?t:10)+(null!=this.title?10:0)+(this.data.image.margin||0);o.image(e,this.data.x,this.data.y,this.data.image,a,s,r,i,n)}if(this.nbMaison<=4){e.fillStyle="#00FF00";for(let t=0;t<this.nbMaison;t++)o.maison(e,this.data.x,this.data.y,this.imgMaison,t,s,i)}else{let t=(s-18)/2;o.hotel(e,this.data.x,this.data.y,this.imgHotel,s,t,i)}null!=this.colorPossede&&o.possede(e,this.data.x,this.data.y,this.colorPossede,this.rayon,s,i)}setJoueur(e){this.colorPossede=null,null!=e&&(this.colorPossede=e.color)}getNbJoueurs(){let e=0;return ue.forEach((function(t){e+=t.pion.axe===this.axe&&t.pion.position===this.pos?1:0}),this),e}_decalagePion(){const e=a.dimensions.bordure/2,t=20+(null!=this.color?e:0)+a.dimensions.largeurPion/2,s=this.getCenter();s.x+=5;let i=a.dimensions.largeurPion,o=(this.data.height-t)/3,n=this.getNbJoueurs();return this.axe%2==0?{x:s.x+(n%3-1)*o,y:n<3?s.y-i:s.y+i}:{x:n<3?s.x-i:s.x+i,y:s.y+(n%3-1)*o}}}class Ce extends Me{constructor(e,t){super(0,e,null,t,null,null),this.data={},this.init()}init(){let e=a.dimensions.largeur,t=a.dimensions.hauteur,s=a.dimensions.plateauSize/2,i=(a.dimensions.nbCases-1)/2,o=e*i;this.axe%2==1?1===this.axe?(this.data.x=s+o,this.data.y=s+-i*e-t):(this.data.x=s-o-t,this.data.y=s+i*e):2===this.axe?(this.data.y=s+o,this.data.x=s+i*e):(this.data.y=s-o-t,this.data.x=s-i*e-t),this.data.height=this.data.width=t}draw(e){e.strokeStyle="#000000",e.strokeRect(this.data.x,this.data.y,this.data.width,this.data.height),n.writeText(this.title,this.data.x,this.data.y+a.dimensions.hauteur/2,0,e,9,this.data.width)}}function Se(e){let t=new Image;return t.src=e,t}class Ee{constructor(e,t,s){this.value=0,this.coin=15,this.width=s,this.compute=s-2*this.coin,this.x=e,this.y=t}setValue(e,t="#000000"){this.value=e,this.color=t}draw2or3(e){Ee.drawPoint(e,this.x+.25*this.width,this.y+.75*this.width,this.width/5,this.color),Ee.drawPoint(e,this.x+.75*this.width,this.y+.25*this.width,this.width/5,this.color)}_drawMiddle(e){Ee.drawPoint(e,this.x+this.width/2,this.y+this.width/2,this.width/5,this.color)}draw(e){this._drawCadre(e),void 0!==this.value&&(this.value%2==1&&this._drawMiddle(e),1!==this.value&&this.draw2or3(e),this.value>=4&&this._drawBig(e,{c1:.75,c2:.25}),6===this.value&&this._drawBig(e,{c1:.5,c2:.5}))}_drawBig(e,t){Ee.drawPoint(e,this.x+.75*this.width,this.y+this.width*t.c1,this.width/5,this.color),Ee.drawPoint(e,this.x+.25*this.width,this.y+this.width*t.c2,this.width/5,this.color)}_drawCadre(e){e.strokeStyle="#000000",e.fillStyle="#000000",e.beginPath(),e.moveTo(this.x+this.coin,this.y),e.lineTo(this.x+this.coin+this.compute,this.y),e.bezierCurveTo(this.x+2*this.coin+this.compute,this.y,this.x+2*this.coin+this.compute,this.y+this.coin,this.x+2*this.coin+this.compute,this.y+this.coin),e.lineTo(this.x+2*this.coin+this.compute,this.y+this.coin+this.compute),e.bezierCurveTo(this.x+2*this.coin+this.compute,this.y+2*this.coin+this.compute,this.x+this.compute+this.coin,this.y+2*this.coin+this.compute,this.x+this.compute+this.coin,this.y+2*this.coin+this.compute),e.lineTo(this.x+this.coin,this.y+2*this.coin+this.compute),e.bezierCurveTo(this.x,this.y+2*this.coin+this.compute,this.x,this.y+this.coin+this.compute,this.x,this.y+this.coin+this.compute),e.lineTo(this.x,this.y+this.coin),e.bezierCurveTo(this.x,this.y,this.x+this.coin,this.y,this.x+this.coin,this.y),e.stroke(),e.closePath()}static drawPoint(e,t,s,i,o="#000000"){e.strokeStyle=o,e.fillStyle=o,e.beginPath(),e.arc(t,s,i/2,0,2*Math.PI),e.fill(),e.closePath()}}class qe extends Ee{constructor(e,t,s){super(e,t,s),this.imgBus=Se("img/bus.png"),this.imgMr=Se("img/mr_monopoly.png"),this.margin=.1*s}draw(e){if(this._drawCadre(e),void 0!==this.value&&(1!==this.value&&3!==this.value||this._drawMiddle(e),2!==this.value&&3!==this.value||this.draw2or3(e),this.value>=4)){let t=5===this.value?this.imgBus:this.imgMr;n.drawImage(e,t,this.x+this.margin,this.y+this.margin,this.width-this.margin,this.width-this.margin,0)}}}class Te extends r{constructor(e,t,s,i,o){super(),this.canvas=null,this.data={x:e,y:t,width:s,height:i,color:o}}draw(e){this.canvas=e,e.fillStyle=this.data.color,e.fillRect(this.data.x,this.data.y,this.data.width,this.data.height)}enableCaseDetect(e){let t=this;document.getElementById("canvas_rt").onmousedown=function(s){const i=this.parentNode;let o=t._findFiche(s.clientX-i.offsetLeft,s.clientY-i.offsetTop);null!=o&&(t.disableCaseDetect(),e(o))}}disableCaseDetect(){document.getElementById("canvas_rt").onmousedown=null}_findFiche(e,t){let s=null;return G.fiches.forEach((function(i){let o=i.drawing.data;e>=o.x&&e<=o.x+o.width&&t>=o.y&&t<=o.y+o.height&&(s=i)})),s}}!function(){const e={type:"square",standardCase:Me,specialCase:Ce,pionJoueur:xe,des:Ee,desRapide:qe,plateau:Te,endPlateau:null};a.addInstance(e),a.type=e.type}();let Ie=2*Math.PI/40,De=0;function _e(e,t){return{y:Math.sin(e)*t,x:Math.cos(e)*t}}function Ae(e,t){return(e+2)%4*10+t}class He extends r{constructor(e,t,s){super(),this.color=e,this.isSelected=!1,this.largeur=t/2,this.img=null,null!=s&&(this.img=new Image,this.img.src=s,this.largeur+=10),this.init(2,0)}init(e,t){let s=a.dimensions.plateauSize/2;this.pos=Ae(e,t),this._rayon=s-(70+De%3*25),this._angle=.5+.25*(De%2?1:-1),De++}draw(e){let t=a.dimensions.plateauSize/2,s=_e((this.pos+this._angle)*Ie,this._rayon);this.isSelected&&n.drawCircle(e,"#FFFFFF",(this.largeur+2)/2,{x:s.x+t,y:s.y+t},"#FF0000"),null!=this.img?n.drawImage(e,this.img,s.x+t-this.largeur/2,s.y+t-this.largeur/2,this.largeur,this.largeur,0):n.drawCircle(e,this.color,this.largeur,{x:s.x+t,y:s.y+t},"#FF0000")}setSelected(e){this.isSelected=e}_moveTo(e,t,s){this.pos!==e?setTimeout((()=>{this.pos=parseFloat((this.pos+s).toFixed(1)),this.pos>=40&&(this.pos=0),this._moveTo(e,t,s)}),30):t()}goto(e,t,s){if(Re.quickMove)return this.gotoDirect(e,t,s);let i=Ae(e,t);this._moveTo(i,s,.1)}gotoDirect(e,t,s){if(null==e||null==t)return;let i=Ae(e,t);this._moveTo(i,s,1)}}class Le extends r{constructor(e,t,s,i,o,n){super(),this.pos=Ae(t,e),this.color=s,this.title=i,this.prix=o,this.img=n,this.nbMaison=0,this.data={},this.imageMaison=new Image,this.imageHotel=new Image,this.joueurPossede=null,this.init()}setJoueur(e){this.joueurPossede=e}setNbMaison(e){this.nbMaison=e}init(){if(this.imageMaison.src="img/maison.png",this.imageHotel.src="img/hotel.png",null!=this.img){this.img=t(a.infos.defaultImage,this.img);let e=new Image;e.addEventListener("load",(()=>{i.refresh()})),e.src=this.img.src,e.height=Math.min(this.img.height,30),e.width=Math.min(this.img.width,40),e.margin=this.img.marginTop||0,e.marginLeft=this.img.marginLeft||0,e.rotate=this.img.rotate||0,this.pos>10&&this.pos<30&&(e.rotate=(e.rotate+180)%360,e.marginLeft=e.marginLeft+.5,e.margin=Math.max(0,e.margin-20)),this.data.image=e}}_drawColorGroup(e,t){let s=a.getInfo("backgroundColor");null!=this.color&&(e.beginPath(),e.fillStyle=this.color,e.moveTo(t.centre,t.centre),e.arc(t.centre,t.centre,t.centre,this.pos*Ie,(this.pos+1)*Ie),e.fill(),e.closePath(),e.beginPath(),e.fillStyle=s,e.moveTo(t.centre,t.centre),e.arc(t.centre,t.centre,t.centre-t.bordure,this.pos*Ie,(this.pos+1)*Ie),e.fill(),e.closePath())}_drawPossede(e,t){null!=this.joueurPossede&&(e.beginPath(),e.strokeStyle=this.joueurPossede.color,e.lineWidth=10,e.arc(t.centre,t.centre,t.centre-a.dimensions.innerPlateauSize+15,this.pos*Ie,(this.pos+1)*Ie),e.stroke(),e.closePath())}_writeText(e,t,s,i){n.writeText(t,s.p.x+s.centre,s.p.y+s.centre,i*Ie,e,9,s.length,s.align)}_drawTitle(e,t){null!=this.title&&(this.pos>10&&this.pos<30?(t.p=_e((this.pos+.7)*Ie,t.centre-t.bordure-5),t.align="left",this._writeText(e,this.title,t,(this.pos+20)%40+.8)):(t.length=Math.min(t.length,e.measureText(this.title).width+30),t.p=_e((this.pos+.3)*Ie,t.centre-t.length-t.bordure-5),t.align="right",this._writeText(e,this.title,t,this.pos+.2)))}_drawPrice(e,t){null!=this.prix&&(this.pos>10&&this.pos<30?(t.p=_e((this.pos+.15)*Ie,t.centre-t.bordure-5),t.align="left",this._writeText(e,this.prix,t,(this.pos+20)%40+.5)):(t.length=Math.min(t.length,e.measureText(this.prix).width+30),t.p=_e((this.pos+.9)*Ie,t.centre-t.length-t.bordure-5),t.align="right",this._writeText(e,this.prix,t,this.pos+.7)))}_drawHouses(e,t){if(this.nbMaison<=4)for(let s=0;s<this.nbMaison;s++){let i=_e((this.pos+.25*s)*Ie,t.centre-4);n.drawImage(e,this.imageMaison,t.centre+i.x,t.centre+i.y,16,16,this.pos*Ie+Math.PI/2)}else{let s=_e((this.pos+.4)*Ie,t.centre-4);n.drawImage(e,this.imageHotel,t.centre+s.x,t.centre+s.y,16,16,this.pos*Ie+Math.PI/2)}}_drawImage(e,t){if(null!=this.data.image){let s=_e((this.pos+this.data.image.marginLeft)*Ie,t.centre-t.bordure-5-this.data.image.margin),i=n.fromDegresToRad(this.data.image.rotate)+this.pos*Ie+Math.PI/2;n.drawImage(e,this.data.image,t.centre+s.x,t.centre+s.y,this.data.image.width,this.data.image.height,i)}}draw(e){let t=a.dimensions.plateauSize/2,s=a.dimensions.bordure/2,i=_e(this.pos*Ie,t),o=_e(this.pos*Ie,t-a.dimensions.innerPlateauSize);e.fillStyle="#FFFFFF",e.lineWidth=.5,e.moveTo(t-i.x,t-i.y),e.lineTo(t-o.x,t-o.y),e.stroke();let n={centre:t,bordure:s,length:140};this._drawColorGroup(e,n),this._drawTitle(e,n),this._drawPrice(e,n),this._drawImage(e,n),this._drawHouses(e,n),this._drawPossede(e,n)}}class ke extends r{constructor(e,t){super(),this.pos=Ae(e,0),this.title=t}draw(e){let t=a.dimensions.plateauSize/2,s=_e(this.pos*Ie,t),i=_e(this.pos*Ie,t-a.dimensions.innerPlateauSize),o=a.getInfo("backgroundColor");if(e.fillStyle=o,e.lineWidth=.5,e.moveTo(t-s.x,t-s.y),e.lineTo(t-i.x,t-i.y),e.stroke(),n.drawArcCircle(e,o,t,{x:t,y:t},this.pos*Ie,(this.pos+1)*Ie),null!=this.title)if(this.pos>10&&this.pos<30){let s=_e((this.pos+.5)*Ie,t-15);n.writeText(this.title,s.x+t,s.y+t,((this.pos+20)%40+.6)*Ie,e,9,120,"left")}else{let s=_e((this.pos+.6)*Ie,t-120-15);n.writeText(this.title,s.x+t,s.y+t,(this.pos+.2)*Ie,e,9,120,"right")}}}class Fe extends Ee{constructor(e,t,s){super(e+195,t+100,s)}}class $e extends qe{constructor(e,t,s){super(e+190,t+100,s)}}class Je extends r{constructor(e,t,s,i,o){super(),this.data={x:e,y:t,width:s,height:i,color:o}}draw(e){n.drawCircle(e,this.data.color,this.data.width/2,{x:this.data.width/2,y:this.data.width/2})}enableCaseDetect(e){const t=this;document.getElementById("canvas_rt").onmousedown=function(s){const i=s.clientX-this.parentNode.offsetLeft-this.width/2,o=-1*(s.clientY-this.parentNode.offsetTop-this.height/2);let n=Math.atan(o/i)/(2*Math.PI)*360;i<0?n+=180:o<0&&(n+=360);const r=(59-Math.floor(n/9))%40;t.disableCaseDetect(),e(G.fiches[r])}}disableCaseDetect(){document.getElementById("canvas_rt").onmousedown=null}}class Be extends r{constructor(){super()}draw(e){let t=a.dimensions.plateauSize/2,s=a.dimensions.innerPlateauSize;n.drawCircle(e,"#000000",t-s,{x:t,y:t}),n.drawCircle(e,"#FFFFFF",t-s-2,{x:t,y:t}),n.drawArcCircle(e,"#FF0000",t-s-2,{x:t,y:t},-Math.PI,0),n.drawCircle(e,"#FFFFFF",t-s-50,{x:t,y:t})}}!function(){let e={type:"circle",standardCase:Le,specialCase:ke,pionJoueur:He,des:Fe,desRapide:$e,plateau:Je,endPlateau:Be};a.addInstance(e)}();let Ge=!1,Ne=100,Re={caseDepart:!1,parcGratuit:!1,enchereAchat:!1,echangeApresVente:!1,desRapide:!1,tourAchat:!1,quickMove:!1};const ze=e=>Re=e;let Oe,Ve={nbTours:0,heureDebut:new Date,positions:[]},Ue="F.";class We{constructor(e,t,s,i,o){this.title=s,this.libelle=e,this.color=i,this.triggerLabel=o,this.actionCarte=t}action(){return b.create(ue.getJoueurCourant(),this.title,this.color,this.libelle,(()=>{let e=`monopoly.${this.triggerLabel}.message`;i.network({kind:"message",player:ue.getJoueurCourant().id,libelle:this.libelle,name:e}),i.send(e,{joueur:ue.getJoueurCourant(),message:this.libelle}),this.actionCarte.action(ue.getJoueurCourant())}),{})}}class Qe extends We{constructor(e,t,s){super(e,t,s,"lightblue","chance")}}class Ye extends We{constructor(e,t,s){super(e,t,s,"pink","caissecommunaute")}}function Xe(e=ue.getJoueurCourant()){let t=G.getById(e.pion.axe+"-"+e.pion.position);if(null==t)return ue.change();let s=t.action();e.actionApresDes(s,t),i.send("move.end")}function Ze(){if(null==Oe)return;let e=Oe.options;Oe=new st(!1),Oe.init(!0),new tt(Oe).restartGame(e)}function Ke(e=!1,t=!0){Oe=new st(e),Oe.init();let s=new tt(Oe);return t&&s.show(),Oe}class et{constructor(){this.infos=null,this.titles={},this.name=null,this.parcGratuit=null,this.cartes={caisseCommunaute:[],chance:[]},this.drawing=null}load(e,t,s,i){return t.nomPlateau=e,this.loadFullPath(`data/${e}`,t,s,i)}loadFullPath(e,t,s,i){this._temp_load_data=i,P(e).then((e=>this.managePlateauConfig(e,t,s))).catch((t=>{console.log(t),alert(`Le plateau ${e} n'existe pas`)}))}managePlateauConfig(e,s,i){if(null==e.plateau)throw"Erreur avec le plateau "+s.nomPlateau;this.name=s.nomPlateau;const o=t(e,this._temp_load_data||{});null!=e.extend?this.load(e.extend,s,i,o):this._build(o,s,i)}loadVariantes(){Array.from(document.querySelectorAll("#idVariantes input[type=checkbox][name]")).filter((e=>null==Re[e.name])).forEach((e=>Re[e.name]=e.checked))}_initBuild(e,t){this.infos=e.plateau,this.options=t,this.loadVariantes(),a.setNbCases(this.infos.nbCases),a.addInfo("defaultImage",e.images.default||{}),a.addInfo("textColor",this.infos.textColor||"#000000"),a.addInfo("backgroundColor",this.infos.backgroundColor||"#FFFFFF"),this.infos.argentJoueurDepart=this.infos.argent||15e4,this.infos.montantDepart=this.infos.depart||2e4,this.infos.montantPrison=this.infos.prison||5e3,Ue=e.currency,this.titles=e.titles||{},this.infos.nomsJoueurs=this.infos.nomsJoueurs||[]}_configureGraphics(){"circle"===this.infos.type?this._configureCircle():this.configureSquare()}_build(e,t,s=(()=>{})){this._initBuild(e,t),Re.parcGratuit&&document.getElementById("idMontantParc").style.setProperty("display",""),document.querySelectorAll(".action-normal").forEach((e=>e.style.setProperty("display",!0===this.infos.hideConstructions?"none":""))),ue.setColors(this.infos.colors),ue.setImgJoueurs(this.infos.imgJoueurs),this._configureGraphics(),x.gestionDes=this.isQuickDice()?new E(this.infos.montantPrison,this.parcGratuit):new S(this.infos.montantPrison,this.parcGratuit),x.init(this.infos.rollColor);let i=a.dimensions.plateauSize;this._createPlateauActions(),this.drawing=a.getPlateau(0,0,i,i,this.infos.backgroundColor),u.add(this.drawing,0),this._draw(e),u.add(a.endPlateau(),2),u.init(i,i),l.setPasVente(this.infos.montantDepart/10),s()}_createPlateauActions(){document.getElementById("idLancerDes").onclick=()=>ue.lancerDes(),document.getElementById("idOpenPanelHouses").onclick=()=>R.open(),document.getElementById("idEchangeTerrains").onclick=()=>c.open(ue.getJoueurCourant()),document.getElementById("idOpenFreeTerrains").onclick=()=>this.openTerrainsLibres()}openTerrainsLibres(){this._showFreeTerrains(),p.open(document.getElementById("idTerrainsLibres"),{title:"Liste des terrains libres",buttons:{Ok:()=>p.close()},height:367,width:350})}_showFreeTerrains(){const e=document.getElementById("idTerrainsLibres");e.innerHTML="";const t=G.getTerrainsLibres();for(;t.hasNext();){let s=t.next();e.insertAdjacentHTML("beforeEnd",`<div style="font-weight:bold;color:${s.color}">${s.nom}</div>`)}}isQuickDice(){return"quick"===this.options.typeGame}_configureCircle(){a.setType("circle"),document.querySelectorAll(".graphic_element,.title").forEach((e=>e.classList.add("circle"))),new CircleType(document.getElementById("idSavePanel")).radius(185),document.getElementById("idSubTitle").style.setProperty("display","none");const e=document.getElementById("idInfoBox");e.onwheel=function(t){e.scrollTop+=t.deltaY,t.preventDefault()}}configureSquare(){a.setType("square"),document.querySelectorAll(".graphic_element,.title").forEach((e=>e.classList.remove("circle")))}_buildCartes(e,t,s){return null!=e?e.cartes.map((e=>new t(e.nom,function(e,t){switch(e.type){case"taxe":return new fe(e.montant,t);case"prime":return new ye(e.montant);case"goto":return new pe(e.axe,e.pos,e.direct,e.primeDepart);case"move":return new ge(e.nb,e.direct,e.primeDepart);case"prison":return new me;case"birthday":return new de(e.montant);case"repair":return new ce(e.hotel,e.maison)}throw"Type inconnu"}(e,this),s))):[]}addToGroup(e,t,s,i){const o=e[t.colors[0]];return null==o.nom&&(o.nom=s),e[t.colors[0]].add(i),i}_createFiche(e,t,s){switch(e.type){case"propriete":return this.addToGroup(t,e,"Terrain",new F(e.axe,e.pos,e.colors,e.nom).setCostsAndDraw(e.prix,e.loyers,e.prixMaison));case"propriete-junior":return this.addToGroup(t,e,"Junior",new $(e.axe,e.pos,e.colors,e.nom).setCostsAndDraw(e.prix,[e.prix]));case"compagnie":return this.addToGroup(t,e,"Compagnie",new B(e.axe,e.pos,e.colors,e.nom).setCostsAndDraw(e.prix,e.loyers,null,s.images[e.img]||s.images.compagnie));case"gare":return this.addToGroup(t,e,"Gare",new J(e.axe,e.pos,e.colors,e.nom).setCostsAndDraw(e.prix,e.loyers,null,s.images.gare));case"chance":return new A(e.axe,e.pos,s.images.chance,this.cartes.chance,this.titles.chance);case"communaute":return new H(e.axe,e.pos,s.images.caisseDeCommunaute,this.cartes.caisseCommunaute,this.titles.communaute);case"taxe":return new _(e.nom,e.prix,e.axe,e.pos,"taxe",s.images.taxe,this);case"prison":return new I(e.nom,(()=>ue.getJoueurCourant().goPrison()),e.axe,e.pos,"prison");case"special":return new I(e.nom,(()=>ue.change()),e.axe,e.pos,"special");case"parc":return this.parcGratuit=new T(e.axe,e.pos),this.parcGratuit;case"depart":return new D(e.nom,e.axe,e.pos,this.infos.montantDepart)}throw"Impossible case"}_draw(e){document.getElementById("idSubTitle").innerHTML=this.infos.subtitle,this.parcGratuit=null;let t=[],s=[];this.cartes.chance=this._buildCartes(e.chance,Qe,this.titles.chance),this.cartes.caisseCommunaute=this._buildCartes(e.communaute,Ye,this.titles.communaute),e.fiches.forEach((i=>{null!=i.colors&&i.colors.length>0&&null==s[i.colors[0]]&&(s[i.colors[0]]=new L(i.groupe,i.colors[0]));let o=this._createFiche(i,s,e);null!=o&&(G.add(o),null!=o.color&&null==t[o.color]&&(document.querySelector("head style").prepend(`.color_${o.color.substring(1)}{color:white;font-weight:bold;background-color:${o.color};}\n`),t[o.color]=1))})),this._calculateVoisins(e.plateau.nbCases)}_calculateVoisins(e=10){let t=null,s=4*e;for(let i=0;i<s+2;i++){let o=Math.floor(i/e)%4,n=i%s-o*e,r=G.get({axe:o,pos:n});null!=r&&null!=r.groupe&&r.isTerrain()&&(null==t&&(t=r.groupe),t.equals(r.groupe)||(r.groupe.groupePrecedent=t,t.groupeSuivant=r.groupe,t=r.groupe))}}enableMouse(e){this.drawing.enableCaseDetect(e)}}class tt{constructor(e){this.monopoly=e,document.getElementById("idJoinNetworkGame").onclick=()=>this.createGame(!0),document.getElementById("idRejoinNetworkGame").onclick=()=>this.createRejoinGame()}show(){this.loadPlateaux(),this.loadSavedGames();const e=document.querySelector("#idPanelCreatePartie");p.open(e,{buttons:{"Créer la partie":()=>this.createGame()},title:"Jouer au MONOPOLY",width:600,height:595})}close(){p.close()}loadPlateaux(){this.plateaux=document.getElementById("idSelectPlateau"),P("data/plateaux.json").then((e=>{null!=e&&null!=e.plateaux&&e.plateaux.forEach((e=>this.plateaux.insertAdjacentHTML("beforeend",`<option value="${e.url}">${e.name}</option>`)))}))}loadSavedGames(){let e=be.findSauvegardes();this.listSauvegarde=document.getElementById("idSauvegardes"),this.listSauvegarde.querySelectorAll('option:not([value = ""])').forEach((e=>e.remove())),e.length>0&&(e.forEach((e=>this.listSauvegarde.insertAdjacentHTML("beforeend",`<option value="${e.value}">${e.label}</option>`))),document.getElementById("idDeleteSauvegarde").onclick=()=>{""!==this.listSauvegarde.value&&confirm(`Etes vous sur de vouloir supprimer cette sauvegarde : ${this.listSauvegarde.value}`)&&(be.delete(this.listSauvegarde.value),this.listSauvegarde.querySelector("option:checked").remove())},document.getElementById("idLoadSauvegarde").onclick=()=>{""!==this.listSauvegarde.value&&(be.load(this.listSauvegarde.value,this.monopoly),this.close())})}extractOptions(){let e={nbRobots:parseInt(document.querySelector("#idNbRobots").textContent),nbPlayers:parseInt(document.querySelector("#idNbPlayers").textContent),waitTimeIA:1};return document.getElementById("idGameType").querySelectorAll("input:checked").forEach((t=>e[t.name]=t.value)),e.joueur=document.getElementById("idNomJoueur").value||"",e}createRejoinGame(){return this.close(),this.monopoly.rejoinNetworkGame()}createGame(e=!1){if(e)return this.close(),this.monopoly.joinNetworkGame(document.getElementById("idNomJoueur").value,document.getElementById("idRemoteGame2").value);Re={},""!==this.listSauvegarde.value?be.load(this.listSauvegarde.value,this.monopoly):(this.monopoly.options=this.extractOptions(),this.monopoly.plateau.load(document.getElementById("idSelectPlateau").value,this.monopoly.options,(()=>this.monopoly._createGame(this.monopoly.options)))),this.close()}restartGame(e){this.monopoly.options=e,this.monopoly.plateau.load(document.getElementById("idSelectPlateau").value,e,(()=>this.monopoly._createGame(e)))}}class st{constructor(e){Ge=e,b.init("message"),g.init(),this.initPanels(),u.reset(),h.init("idEncherePanel"),f.init("idCommunicationEchange"),ue.init(),R.init({idArgentRestant:"#idArgentRestant",idCout:"#idCoutTotal",idPanel:"#housesPanel",idTerrains:"#idTerrains",idHypotheque:"#toHypotheque",idTerrainsHypotheque:"#idTerrainsHypotheques",idTerrainsConstructibles:"#idTerrainsConstructibles",idCoutAchat:"#coutAchats",idConstructions:"#resteConstructions"}),this.plateau=new et}init(e=!1){y.init("idInfoBox",e),le.setMouseFunction((e=>this.plateau.enableMouse(e))),Ge&&this.plateau.load("data-monopoly.json",(()=>this._createGame({})))}joinNetworkGame(e,t){this.remoteManager=new ve(this.plateau,e,t)}rejoinNetworkGame(){this.remoteManager=new ve(this.plateau,"",localStorage.network_game,localStorage.uniqueID)}_createNetworkGame(e){w("/createGame").then((t=>{this.remoteManager=new Pe(e.joueur,t.game,this.plateau);let s=this.remoteManager.create(e.nbPlayers,e.nbRobots,e.joueur,this.plateau.infos.nomsJoueurs,this.plateau.infos.argentJoueurDepart,this.plateau.infos.montantDepart);return this.afterCreateGame(s)}))}_createGame(e){return"true"===e.networkGame?this._createNetworkGame(e):this._createLocalGame(e)}_createLocalGame(e){let t=new Array(e.nbPlayers);for(let s=0;s<e.nbPlayers;s++){let i=`Joueur ${s+1}`;0===s&&""!==e.joueur?i=e.joueur:this.plateau.infos.nomsJoueurs.length>s&&(i=this.plateau.infos.nomsJoueurs[s]),t[s]=i;let o=s>=e.nbPlayers-e.nbRobots?le.getRobotPlayer():le.getCurrentPlayer();ue.create(o,s,i,!1,this.plateau.infos.argentJoueurDepart,this.plateau.infos.montantDepart)}this.afterCreateGame(t),ue.change(),Ne=Re.quickMove?10:e.waitTimeIA||Ne}addTooltip(e){const t=ue.getById(e.getAttribute("data-idjoueur"));e.onclick=()=>{const e=document.getElementById("infoJoueur"),s=t.getStats();e.querySelector(".player-name").innerHTML=t.nom,e.querySelector(".player-name").style.setProperty("color",t.color),e.querySelectorAll("span[data-name]").forEach((e=>e.innerHTML=s[e.getAttribute("data-name")])),p.open(e,{title:t.name,buttons:{Fermer:()=>p.close()},height:288,width:300})}}afterCreateGame(e=this.plateau.infos.nomJoueurs){this.plateau.infos.realNames=e,document.querySelectorAll(".info-joueur").forEach((e=>this.addTooltip(e))),c.init("idPanelEchange","idSelectJoueurs","idListTerrainsJoueur","idListTerrainsAdversaire")}initPanels(){document.getElementById("idSavePanel").onclick=()=>{let e=be.isSauvegarde()?null:prompt("Nom de la sauvegarde (si vide, defini par defaut)");be.save(e,this.plateau)},it||document.getElementById("idNetwork").style.setProperty("display","none")}}let it=!0;(async function(){return null!=localStorage&&null!=localStorage.network_game&&null!=localStorage.uniqueID&&"true"===await fetch(`/game/exist?id=${localStorage.network_game}`).then((e=>new Response(e.body).text()))})().then((e=>{document.getElementById("idRejoinNetworkGame").style.setProperty("display",e?"":"none")})),Ke(!1)})();