(()=>{var e={170:()=>{Object.defineProperty(Array.prototype,"size",{value:function(){let e=0;for(let t in this)e++;return e},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"contains",{value:function(e){for(let t in this)if(this[t]===e)return!0;return!1},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"filter",{value:function(e){var t=[];for(var i in this)e(this[i])&&t.push(this[i]);return t},writable:!1,enumerable:!1,configurable:!1}),Object.defineProperty(Array.prototype,"some",{value:function(e){for(let t in this)if(e(this[t]))return!0;return!1},writable:!1,enumerable:!1,configurable:!1})}},t={};function i(s){var o=t[s];if(void 0!==o)return o.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,i),n.exports}i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s={};(()=>{"use strict";i.d(s,{wA:()=>Qe,eM:()=>ze,X2:()=>Ve,c_:()=>Ue,lQ:()=>Ke,AM:()=>We,oZ:()=>et,RS:()=>tt}),i(170);const e=new class{constructor(){this.observers={}}network(e){this.send("event.network",e)}debug(e){this.send("monopoly.debug",e)}refresh(){this.send("refreshPlateau")}send(e,t={}){const i=this.observers[e];null!=i&&i.forEach((e=>e(t)))}observe(e,t){let i=this.observers[e];null==i&&(i=[],this.observers[e]=i),i.push(t)}watchRefresh(e){this.observe("refreshPlateau",e)}};let t=0,o={fontWeight:200,setFontWeight(e){this.fontWeight=e},fromDegresToRad:function(e){return e/180*Math.PI},drawCircle:function(e,t,i,s,o=t){e.fillStyle=t,e.strokeColor=o,e.beginPath(),e.arc(s.x,s.y,i,0,2*Math.PI),e.fill(),e.closePath()},drawArcCircle:function(e,t,i,s,o,n){e.beginPath(),e.fillStyle=t,e.moveTo(s.x,s.y),e.arc(s.x,s.y,i,o,n),e.fill(),e.closePath()},drawImage:function(e,t,i,s,o,n,r){e.save(),e.translate(i,s),e.rotate(r);try{e.drawImage(t,0,0,o,n)}catch(e){}e.restore()},_splitLine:function(e){if(e.some((function(e){return-1!==e.indexOf("\n")}))){let t=[];e.forEach((function(e){-1!==e.indexOf("\n")?e.split("\n").forEach((function(e){t.push(e)})):t.push(e)})),e=t}return e},writeText:function(e,t,i,s,o,n="7",a=r.dimensions.largeur,u){o.fillStyle=r.getInfo("textColor")||"#000000",o.font=`${this.fontWeight} `+n+"pt Arial";let h=this._splitLine([e]),l=[];h.forEach((function(e){if(o.measureText(e).width>a-5){let t=e.split(" "),i=[],s=0;for(let e=0;e<t.length;e++)s>0&&o.measureText(i[s-1]).width+o.measureText(t[e]).width<a-5?i[s-1]=i[s-1]+" "+t[e]:i[s++]=t[e];i.forEach((function(e){l.push(e)}))}else l.push(e)})),h=l,o.save(),o.translate(t,i),o.rotate(s);for(var c=0;c<h.length;c++){var d;switch(u){case"left":d=0;break;case"right":d=a-o.measureText(h[c]).width;break;default:d=(a-o.measureText(h[c]).width)/2}o.fillText(h[c],d,12*c)}o.font="6pt Times news roman",o.restore()}};class n{constructor(){this.id=t++}draw(){throw"Not implemented"}}let r={instances:[],type:null,infos:{},dimensions:{largeur:65,largeurPion:20,hauteur:100,bordure:40,plateauSize:800,innerPlateauSize:220,nbCases:10,textSize:7},setSize(e){$("#plateau").height(e+10).width(e+10),$("#canvas").width(e+10).height(e+10).attr("width",e+10).attr("height",e+10),$("#canvas_rt").width(e+10).height(e+10).attr("width",e+10).attr("height",e+10),this.dimensions.plateauSize=e,o.setFontWeight(800),this.computeDimensions()},setNbCases(e=10){this.dimensions.nbCases=e,this.computeDimensions()},computeDimensions(){this.dimensions.largeur=570/(this.dimensions.nbCases-1)+2,this.dimensions.hauteur=(this.dimensions.plateauSize-570-20)/2,this.dimensions.textSize=Math.round(this.dimensions.largeur/10)},init:function(){return this},setType:function(e){this.type=e},addInfo:function(e,t){this.infos[e]=t},getInfo:function(e){return this.infos[e]},addInstance:function(e){this.instances[e.type]=e},getDes:function(e,t,i){return this._instantiate("des",arguments)},getDesRapide:function(e,t,i){return this._instantiate("desRapide",arguments)},getCase:function(e,t,i,s,o,n){return this._instantiate("standardCase",arguments)},getCaseSpeciale:function(e,t){return this._instantiate("specialCase",arguments)},getPionJoueur:function(e){return this._instantiate("pionJoueur",arguments)},getPlateau:function(e,t,i,s,o){return this._instantiate("plateau",arguments)},endPlateau:function(){return this._instantiate("endPlateau",arguments)},_instantiate:function(e,t){if(null==this.instances[this.type])throw"Creation, type : "+this.type+" inconnu";return null==this.instances[this.type][e]?null:new this.instances[this.type][e](...t)}}.init(),a={components:[],height:0,width:0,interval:null,intervalRT:null,canvas:null,canvasRT:null,intervals:[],reset:function(){this.components=[],this.canvas&&this.clear(this.canvas),this.canvasRT&&this.clear(this.canvasRT)},add:function(e,t){null!=e&&(e.getId=function(){return a.canvas.canvas.id},e.order=null==t?0:t,a.components.push(e))},addRealTime:function(e){e.getId=function(){return a.canvasRT.canvas.id},a.components.push(e)},removeComponent:function(e){for(var t=0;t<this.components.length;t++)if(this.components[t].id===e.id)return void this.components.splice(t,1)},clear:function(e){e.clearRect(0,0,this.width,this.height)},refresh:function(e){a.clear(e);for(var t=0;t<a.components.length;t++)a.components[t].getId()===e.canvas.id&&a.components[t].draw(e)},setFrequency:function(e,t){null!=a.intervals[t.canvas.id]&&clearInterval(a.intervals[t.canvas.id]),a.intervals[t.canvas.id]=setInterval((function(){a.refresh(t)}),e)},init:function(t,i){if(null!=document.getElementById("canvas"))return this.components.sort((function(e,t){return e.order-t.order})),this.width=t,this.height=i,this.canvas=document.getElementById("canvas").getContext("2d"),this.canvasRT=document.getElementById("canvas_rt").getContext("2d"),this.canvas.strokeStyle="#AA0000",this.canvasRT.strokeStyle="#AA0000",this.refresh(this.canvas),this.setFrequency(50,this.canvasRT),e.watchRefresh((()=>a.refresh(a.canvas))),this}},u={terrain:null,callback:null,miseDepart:0,ventePerte:!1,pasVente:2e3,joueurLastEnchere:null,lastEnchere:0,nextMontantEnchere:0,currentJeton:0,joueursExit:[],endAckJoueurs:[],transaction:0,setPasVente(e){this.pasVente=e},init:function(t,i,s,o){this.terrain=t,this.callback=o,this.miseDepart=i,this.lastEnchere=0,this.endAckJoueurs=[],this.nextMontantEnchere=i,this.ventePerte=s,this.joueurLastEnchere=null,this.currentJeton=0,this.joueursExit=[],this.transaction++,e.send("monopoly.enchere.init",{maison:this.terrain,joueur:this.terrain.joueurPossede}),ce.forEach((e=>e.initEnchere(this.transaction,this.terrain,this.miseDepart))),this.runEnchere()},computeEncherisseurs:function(){let e=[],t=[];return ce.forEach((i=>{i.equals(this.terrain.joueurPossede)||i.equals(this.joueurLastEnchere)||null!=this.joueursExit[i.nom]||!1!==i.defaite?t.push(i):e.push(i)})),{encherisseurs:e,observers:t}},runEnchere:function(e=!1){let t=this.computeEncherisseurs();for(let i=0;i<t.encherisseurs.length;i++)t.encherisseurs[i].updateEnchere(this.transaction,this.currentJeton,this.nextMontantEnchere,this.joueurLastEnchere,e);for(let e=0;e<t.observers.length;e++)t.observers[e].updateInfoEnchere(this.nextMontantEnchere,this.joueurLastEnchere)},exitEnchere:function(e){null==this.joueursExit[e.nom]&&(this.joueursExit[e.nom]=e,ce.forEach((function(t){t.notifyExitEnchere(e)})),this.checkEndEnchere()&&this.manageEndEnchere())},checkEndEnchere:function(){return this.joueursExit.size()>=ce.getNb()||this.joueursExit.size()>=ce.getNb()-1&&(null!=this.terrain.joueurPossede||null!=this.joueurLastEnchere)||this.joueursExit.size()>=ce.getNb()-2&&null!=this.joueurLastEnchere&&null!=this.terrain.joueurPossede},doEnchere:function(e,t,i){if(i<this.currentJeton)throw"Trop lent, une enchere a deja ete faite";e.equals(this.joueurLastEnchere)||(this.currentJeton++,this.joueurLastEnchere=e,this.lastEnchere=t,this.nextMontantEnchere=this.lastEnchere+this.pasVente,this.checkEndEnchere()?this.manageEndEnchere():this.runEnchere())},checkEnchere:function(e){e>=this.currentJeton&&this.manageEndEnchere()},manageEndEnchere:function(){null==this.joueurLastEnchere?this.ventePerte&&this.nextMontantEnchere-this.pasVente>this.miseDepart/2?(this.nextMontantEnchere-=this.pasVente,this.joueursExit=[],this.runEnchere(!0)):(e.send("monopoly.enchere.fail",{maison:this.terrain}),this.endEnchere()):(null==this.terrain.joueurPossede?this.joueurLastEnchere.acheteMaison(this.terrain,this.lastEnchere):(this.joueurLastEnchere.payerTo(this.lastEnchere,this.terrain.joueurPossede),this.joueurLastEnchere.getSwapProperiete(this.terrain)),e.send("monopoly.enchere.success",{joueur:this.joueurLastEnchere,maison:this.terrain,montant:this.lastEnchere}),this.endEnchere())},endEnchere:function(){this.terrain=null,ce.forEach((e=>e.endEnchere(this.lastEnchere,this.joueurLastEnchere)))},checkEndNotify:function(e){this.endAckJoueurs[e.numero]=!0,this.endAckJoueurs.size()>=ce.getNb()&&this.doCallback()},doCallback:function(){this.callback&&this.callback()}},h={panel:null,currentMontant:0,currentEncherisseur:null,terrain:null,displayer:null,init:function(e){this.panel=$("#"+e),f(this.panel,{title:"Mise au enchere",position:{my:"center top",at:"center top",of:window},autoOpen:!1})},display:function(e,t){this.terrain=e,this.displayer=t,$(".proprietaire",this.panel).text(null!=e.joueurPossede?e.joueurPossede.nom:"Banque"),$(".terrain",this.panel).text(e.nom).css("color",e.color),$(".list_exit",this.panel).empty(),$(".list_encherisseurs",this.panel).empty(),$(".messages",this.panel).empty(),this.panel.dialog("open")},displayCloseOption:function(e,t){null!=t?($(".montant",this.panel).text(e),$(".montant",this.panel).css("color","green"),$(".last_encherisseur",this.panel).text(t.nom),t.equals(this.displayer)?$(".messages",this.panel).append("Vous avez remporté l'enchère"):$(".messages",this.panel).append(t.nom+" a remporté l'enchère")):$(".montant",this.panel).css("color","red"),this.panel.dialog("option","buttons",[{text:"Fermer",click:()=>h.close()}]),d(this.panel)},clean:function(){$(".list_exit",this.panel).empty()},showJoueurExit:function(e){$(".list_exit",this.panel).append(e.nom+" est sorti<br/>")},exitEnchere:function(){this.panel.dialog("option","buttons",[])},close:function(){u.doCallback(),this.panel.dialog("close")},updateInfo:function(e,t,i,s){if(i&&null==s)throw"Impossible de gerer l'enchere";if(null!=this.currentMontant&&null!=this.currentEncherisseur&&($(".list_encherisseurs",this.panel).prepend("<p>"+Qe+" "+this.currentMontant+" : "+this.currentEncherisseur.nom+"</p>"),$(".list_encherisseurs > p:gt(3)",this.panel).remove()),this.currentMontant=e,this.currentEncherisseur=t,$(".montant",this.panel).text(e),$(".montant",this.panel).animate({color:"red"},200).animate({color:"black"},2e3),null!=t&&$(".last_encherisseur",this.panel).text(t.nom),i){let t=[{text:"Encherir",click:()=>u.doEnchere(h.displayer,e,s.jeton)},{text:"Quitter",click:()=>u.exitEnchere(h.displayer)}];this.panel.dialog("option","buttons",t),d(this.panel)}else this.panel.dialog("option","buttons",[]),d(this.panel)}},l={panel:null,selectJoueurs:null,listTerrainsJoueur:null,listTerrainsAdversaire:null,joueur:null,init:function(e,t,i,s){this.panel=$("#"+e),this.selectJoueurs=$("#"+t),this.listTerrainsJoueur=$("#"+i),this.listTerrainsAdversaire=$("#"+s),f(this.panel,{title:"Echange de terrains",autoOpen:!1,position:{my:"center top",at:"center top",of:window},width:400,buttons:{Annuler:()=>l.close(),Proposer:()=>l.propose()}}),ce.forEach((e=>this.selectJoueurs.append(`<option value="${e.id}">${e.nom}</option>`))),this.selectJoueurs.change((function(){$("option:not(:first),optgroup",l.listTerrainsAdversaire).remove();let e=ce.getById(l.selectJoueurs.val());if(null!=e){let t=e.maisons.getMaisonsGrouped();for(let e in t){let i=t[e],s=$(`<optgroup label="Groupe ${i.groupe}" style="color:${i.color}"></optGroup>`);i.terrains.forEach((e=>s.append(`<option value="${e.id}">${e.nom}</option>`))),l.listTerrainsAdversaire.append(s)}}}))},open:function(e){this.joueur=e,this.selectJoueurs.find("option:not(:visible)").show(),this.selectJoueurs.find('option[value="'+e.id+'"]').hide(),this.listTerrainsJoueur.empty(),b.showTerrainByGroup(l.listTerrainsJoueur,e),this.panel.dialog("open")},propose:function(){let e=ce.getById(l.selectJoueurs.val()),t=O.getById(this.listTerrainsAdversaire.val());if(null==e||null==t)return;c.init(this.joueur,e,t,null);let i={terrains:[],compensation:0};$(":checkbox:checked",this.listTerrainsJoueur).each((function(){i.terrains.push(O.getById($(this).val()))})),""!==$("#idArgentProposition").val()&&(i.compensation=parseInt($("#idArgentProposition").val())),this.close(),b.showPropose(this.joueur,e,t,i,this.joueur),c.propose(i)},close:function(){this.panel.dialog("close"),$("option",this.selectJoueurs).removeAttr("selected")}},c={running:!1,demandeur:null,proprietaire:null,terrain:null,proposition:null,initialProposition:null,endCallback:null,init:function(t,i,s,o){if(this.running)throw"Transaction impossible, une transaction est deja en cours.";this.running=!0,this.demandeur=t,this.proprietaire=i,this.terrain=s,this.endCallback=o,e.send("monopoly.echange.init",{joueur:t,maison:s})},end:function(){this.running=!1,this.demandeur=null,this.proprietaire=null,this.terrain=null,null!=this.endCallback&&this.endCallback(),this.endCallback=null},propose:function(t){this.proposition=t,this.initialProposition=t,e.send("monopoly.echange.propose",{joueur:c.demandeur,proposition:t}),this.proprietaire.traiteRequeteEchange(this.demandeur,this.terrain,t)},contrePropose:function(t,i){e.send("monopoly.echange.contrepropose",{joueur:this.proprietaire,proposition:t}),this.proposition=t,i.equals(this.demandeur)?this.proprietaire.traiteContreProposition(t,i,this.terrain):this.demandeur.traiteContreProposition(t,i,this.terrain)},abort:function(){this.end()},accept:function(t){e.send("monopoly.echange.accept",{joueur:t}),t.equals(this.demandeur)?this.proprietaire.notifyAcceptProposition((function(){c._doAccept()})):this.demandeur.notifyAcceptProposition((function(){c._doAccept()}))},_doAccept:function(){if(this.demandeur.getSwapProperiete(this.terrain),null!=this.proposition.compensation&&this.demandeur.payerTo(this.proposition.compensation,this.proprietaire),null!=this.proposition.terrains&&this.proposition.terrains.length>0)for(var e in this.proposition.terrains)this.proprietaire.getSwapProperiete(this.proposition.terrains[e]);this.end()},reject:function(t){e.send("monopoly.echange.reject",{joueur:t}),t.equals(this.demandeur)?this.proprietaire.notifyRejectProposition((function(){c.end()}),this.terrain,this.initialProposition):this.demandeur.notifyRejectProposition((function(){c.end()}),this.terrain,this.proposition)}};function d(e){p++,e.data("inner-open-id",p),$("#actions").empty();let t=e.dialog("option","buttons");for(let e in t){let i=t[e];if(null!=i.text){let e=$(`<button>${i.text}</button>`);e.on("click",i.click),$("#actions").append(e)}else{let t=$(`<button>${e}</button>`);t.on("click",i),$("#actions").append(t)}}}let p=0;function m(e){p===$(e.currentTarget).data("inner-open-id")&&$("#actions").empty()}function g(e,t="Fiche",i=410){f(e,{autoOpen:!1,title:t,width:280,height:i,modal:!0,position:{my:"center top",at:"center top",of:window},resizable:!1,close:function(){y.close()}})}function f(e,t){if("open"===t)return function(e){d(e),e.off("dialogclose.wrapper").on("dialogclose.wrapper",(e=>m(e))),e.dialog("open")}(e);e.off("dialogopen.wrapper").on("dialogopen.wrapper",(()=>d(e))),e.off("dialogclose.wrapper").on("dialogclose.wrapper",(e=>m(e))),e.dialog(t)}let y={detailFiche:null,detailJunior:null,fiche:null,ficheJunior:null,ficheCompagnie:null,currentFiche:null,init:function(){this.fiche=$("#fiche"),this.ficheJunior=$("#ficheJunior"),this.detailFiche=this.fiche.clone(),this.detailFicheJunior=this.ficheJunior.clone(),this.detailFiche.attr("id","idDetailFiche").addClass("detail-fiche").hide(),this.detailFicheJunior.attr("id","idDetailFicheJunior").addClass("detail-fiche").hide(),$("body").append(this.detailFiche),$("body").append(this.detailFicheJunior),this.ficheCompagnie=$("#ficheCompagnie"),g(this.fiche),this.fiche.prev().css("background","url()"),g(this.ficheJunior),this.ficheJunior.prev().css("background","url()"),g(this.ficheCompagnie,"Fiche",350),this.ficheCompagnie.prev().css("background","url()")},openDetail:function(e,t){let i="junior"===e.type?this.detailFicheJunior:this.detailFiche;return null!=this.currentFiche&&this.currentFiche.axe===e.axe&&this.currentFiche.pos===e.pos?i.is(":visible")?i.slideUp():i.slideDown():null==this.currentFiche||this.currentFiche.axe===e.axe&&this.currentFiche.pos===e.pos?(this.loadDetailFiche(e,i),t.after(i),i.slideDown(),void(this.currentFiche=e)):(this.currentFiche=null,void i.slideUp(300,(function(){y.openDetail(e,t)})))},close:function(){ce.change()},loadFiche:function(e){this._load(e,"junior"===e.type?this.ficheJunior:this.fiche,"FFFFFF"),e.fiche.panel.prev().css("background-color",e.color)},loadDetailFiche:function(e,t){this._load(e,t,e.secondColor)},_load:function(e,t,i){$('td[name^="loyer"]',t).each((function(){$(this).text(e.loyer[parseInt($(this).attr("name").substring(5))])})),$('td[name]:not([name^="loyer"]),span[name]:not([name^="loyer"])',t).each((function(){$(this).html(e[$(this).attr("name")])})),$(t).css("backgroundColor",i),"gare"===e.type?$(".loyer0",t).text(parseInt(e.getLoyer())):$(".loyer0",t).text(!0===e.isGrouped()?2*parseInt(e.loyer[0]):e.loyer[0]),$("tr",t).removeClass("nbMaisons"),$(".infos-group",t).removeClass("nbMaisons"),$(".loyer"+e.nbMaison,t).parent().addClass("nbMaisons"),0===e.nbMaison&&!0===e.isGrouped()&&$(".infos-group",t).addClass("nbMaisons"),"gare"===e.type?$(".maison",t).hide():$(".maison",t).show()},closeFiche:function(){var e=!1;this.fiche.dialog("isOpen")&&(this.fiche.dialog("close"),e=!0),this.ficheCompagnie.dialog("isOpen")&&(this.ficheCompagnie.dialog("close"),e=!0),this.ficheJunior.dialog("isOpen")&&(this.ficheJunior.dialog("close"),e=!0),e||this.close()}},b={panel:null,joueur:null,init:function(e){this.panel=$("#"+e),f(this.panel,{autoOpen:!1,title:"Echange",width:400,position:{my:"center top",at:"center top",of:window}})},show:function(e,t,i,s,o){this.showPropose(e,t,i,s,o),this.addMessage("Que souhaitez vous faire",[{nom:"Accepter",action:function(){b.close(),c.accept(b.joueur)}},{nom:"Refuser",action:function(){b.close(),c.reject(b.joueur)}},{nom:"Négocier",action:function(){b._showContrePanel(e)}}],!0)},showPropose:function(e,t,i,s,o){this.joueur=o,this.panel.dialog("option","title",`Echange entre ${e.nom} et ${t.nom}`),$(".proposition,.communications",this.panel).empty(),$(".proposition",this.panel).append(`<div>Terrain : <span style="font-weight:bold;color:${i.color}">${i.nom}</div>`),this._showProposition($(".proposition",this.panel),s),$(".communications",this.panel).empty()},showTerrainByGroup(e,t){let i=t.maisons.getMaisonsGrouped();for(let t in i){let s=i[t],o=$(`<div style="font-weight:bold;color:${s.color}">Groupe ${s.groupe}<br/></div>`);for(let e in s.terrains){let t=s.terrains[e];o.append(`<input type="checkbox" value="${t.id}" id="chk_id_${t.id}"/><label for="chk_id_${t.id}">${t.nom}</label><br/>`)}e.append(o)}},_showContrePanel:function(e,t){let i=$('<div class="contreProposition"></div>');this.showTerrainByGroup(i,e),i.append('Argent : <input class="argent" type="text"/>'),$(".communications",this.panel).append(i),this.addMessage("Quelle est votre contreproposition",[{nom:"Proposer",action:()=>b._doContreproposition(b.joueur)},{nom:"Rejeter",action:()=>{b.close(),c.reject(b.joueur)}}],!0)},_doContreproposition:function(e){let t={terrains:[],compensation:0};$(".contreProposition:last :checkbox:checked",this.panel).each((function(){let e=GestionFiche.getById($(this).val());null!=e&&t.terrains.push(e)}));let i=$(".contreProposition:last :text.argent",this.panel).val();""!==i&&(t.compensation=parseInt(i)),c.contrePropose(t,e)},_showProposition:function(e,t){if(e.append("Proposition : "),t.terrains.length>0)for(let i in t.terrains){let s=t.terrains[i];e.append(`<div style="padding-left:20px;color:${s.color}">${s.nom}</div>`)}e.append(`<div style="padding-left:20px;">Argent : ${Qe} ${t.compensation}</div>`)},showAccept:function(e=(()=>{})){this.addMessage('La proposition a été <span style="color:green">acceptée</span>',[{nom:"Fermer",action:()=>{b.close(),e()}}])},showReject:function(e=(()=>{})){this.addMessage('La proposition a été <span style="color:red">rejetée</span>.',[{nom:"Fermer",action:()=>{b.close(),e()}}])},showContreProposition:function(e){this.addMessage("Une contreproposition a été faite",[{nom:"Refuser",action:()=>{b.close(),c.reject(b.joueur)}},{nom:"Accepter",action:()=>{b.close(),c.accept(b.joueur)}}]),this._showProposition($(".communications",this.panel),e)},addMessage:function(e,t,i){if(i||$(".communications",this.panel).append("<hr/>"),$(".communications",this.panel).append("<p>"+e+"</p>"),null!=t&&t.length>0){let e=[];for(let i in t){let s=t[i],o={text:s.nom,click:s.action};e.push(o)}this.panel.dialog("option","buttons",e),this.open()}},close:function(){this.panel.dialog("close")},open:function(){f(this.panel,"open")}},v={div:null,order:0,init:function(e){null==this.div&&(this.div=$("#"+e),this.bindEvents()),this.div.empty()},write:function(e,t){v.order++;let i=ze?" ("+v.order+")":"";this.div.prepend('<div><span style="color:'+e.color+'">'+e.nom+"</span> : "+t+i+"</div>")},_buildProposition:function(e){if(null==e)return"";let t="";return null!=e.terrains&&e.terrains.length>0&&(t=e.terrains.reduce(((e,t)=>this.events._buildTerrain(t)+", "+e),"")),e.compensation>0&&(t+=" compensation : "+e.compensation+" "+Qe),t},events:{write(e,t){v.write(e,t)},_buildTerrain:function(e){return null==e?"":`<span style="font-weight:bold;color:${e.color}">${e.nom}</span>`},people:(e,t="black")=>({color:t,nom:e}),save(e){this.write(this.people("info","green"),`sauvegarde de la partie (${e.name})`)},depart(e){this.write(e.joueur,`s'arrête sur la case départ et gagne ${e.montant} ${Qe}`)},initEnchere(e){this.write(null!=e.joueur?e.joueur:this.people("La banque"),`met aux enchères  ${this._buildTerrain(e.maison)}`)},failEnchere(e){this.write(this.people("Commissaire priseur","red"),`le terrain ${this._buildTerrain(e.maison)} n'a pas trouvé preneur`)},successEnchere(e){this.write(e.joueur,`achète aux enchères le terrain ${this._buildTerrain(e.maison)} pour ${Qe} ${e.montant}`)},message(e){},caisseCommunaute(e){this.write(e.joueur,`carte caisse de communauté : ${e.message}`)},chance(e){this.write(e.joueur,`carte chance : ${e.message}`)},achete(e){this.write(e.joueur,`achète ${this._buildTerrain(e.maison)}`)},home(e){this.write(e.joueur,`tombe sur ${this._buildTerrain(e.maison)} . Il est chez lui.`)},visite(e){this.write(e.joueur,`tombe sur ${this._buildTerrain(e.maison)}`)},vend(e){this.write(e.joueur,`vends ${e.nbMaison} maison(s)</span>`)},exit(e){this.write(e.joueur,"s'est déconnecté</span>")},loyer(e){let t=e.maison,i=`<span style="font-weight:bold;color:${t.color}"> ${t.nom}</span>`,s=`<span style="color:${t.joueurPossede.color}">${t.joueurPossede.nom}</span>`;this.write(e.joueur,`tombe sur ${i} et paye ${t.getLoyer()} ${Qe} à ${s}`)},start(){this.write(this.people("Monopoly"),"La partie peut commencer")},player(e){"Distant"===e.joueur.type?this.write(this.people("Monopoly"),"un siège est disponible"):this.write(e.joueur,"rentre dans la partie")},hypotheque(e){this.write(e.joueur,`hypothèque ${this._buildTerrain(e.maison)}`)},leveHypotheque(e){this.write(e.joueur,`lève l'hypothèque de ${this._buildTerrain(e.maison)}`)},prison(e){this.write(e.joueur,"va en prison")},lanceDes(e){let t=`lance les dés et fait ${e.total} (${e.combinaison})`;null!=e.prison&&(!0===e.prison.sortie?(t+=" et sort de prison",e.prison.montant>0&&(t+=` en payant ${Qe} ${e.prison.montant}`)):t+=" et reste en prison"),null!=e.double&&(!0===e.double.triple&&(t+=", a fait 3 doubles et va en prison"),!0===e.double.replay&&(t+=" et rejoue")),this.write(e.joueur,t)},desBus(e){this.write(e.joueur,` prend le bus et fait ${e.total}`)},desMrMonopoly(e){this.write(e.joueur,` fait un Mr Monopoly et va sur ${this._buildTerrain(e.maison)}`)},desTriple(e){this.write(e.joueur,` fait un triple et choisi d'aller à ${this._buildTerrain(e.maison)}`)},sortiePrison(e){let t="sort de prison";!0===e.paye&&(t+=" en payant"),!0===e.carte&&(t+=" en utilisant une carte sortie de prison"),e.paye||e.carte||(t+=" en faisant un double"),this.write(e.joueur,t)},construit(e){let t="",i=e.achats;if(i.maison>0?t+=`achète ${i.maison} maison(s) `:i.maison<0&&(t+=`vend ${-1*i.maison} + " maison(s) `),i.hotel>0?t+=(""!==t?" et ":"")+`achète ${i.hotel}  hôtel(s) `:i.hotel<0&&(t+=(""!==t?" et ":"")+`vend ${-1*i.hotel} hôtel(s) `),null!=i.terrains&&i.terrains.size()>0){t+=" sur ";for(let e in i.terrains)t+=this._buildTerrain(i.terrains[e])+", "}""!==t&&this.write(e.joueur,t)},initEchange(e){let t=`souhaite obtenir ${this._buildTerrain(e.maison)} auprès de ${e.maison.joueurPossede.nom}`;this.write(e.joueur,t)},proposeEchange(e){this.write(e.joueur,`propose : ${v._buildProposition(e.proposition)}`)},accepteEchange(e){this.write(e.joueur,"accepte la proposition")},rejetteEchange(e){this.write(e.joueur,"rejete la proposition")},contreEchange(e){this.write(e.joueur,`fait une contre-proposition ${v._buildProposition(e.proposition)}`)},defaite(e){this.write(e.joueur,"a perdu et quitte la partie")},victoire(e){this.write(e.joueur,"a gagné la partie")},waitPlayers(e){this.write(this.people("Monopoly"),`Partie n°${e.idGame} créée, en attente de ${e.nb} joueur(s)...`)},debug(e){ze&&this.write(this.people("debug","red"),e.message)}},bindEvents:function(){e.observe("monopoly.save",(e=>this.events.save(e))),e.observe("monopoly.start",(()=>this.events.start())),e.observe("monopoly.depart",(e=>this.events.depart(e))),e.observe("monopoly.exit",(e=>this.events.exit(e))),e.observe("monopoly.enchere.init",(e=>this.events.initEnchere(e))),e.observe("monopoly.enchere.fail",(e=>this.events.failEnchere(e))),e.observe("monopoly.enchere.success",(e=>this.events.successEnchere(e))),e.observe("monopoly.caissecommunaute.message",(e=>this.events.caisseCommunaute(e))),e.observe("monopoly.chance.message",(e=>this.events.chance(e))),e.observe("monopoly.acheteMaison",(e=>this.events.achete(e))),e.observe("monopoly.chezsoi",(e=>this.events.home(e))),e.observe("monopoly.visiteMaison",(e=>this.events.visite(e))),e.observe("monopoly.vendMaison",(e=>this.events.vend(e))),e.observe("monopoly.payerLoyer",(e=>this.events.loyer(e))),e.observe("monopoly.newPlayer",(e=>this.events.player(e))),e.observe("monopoly.hypothequeMaison",(e=>this.events.hypotheque(e))),e.observe("monopoly.leveHypothequeMaison",(e=>this.events.leveHypotheque(e))),e.observe("monopoly.goPrison",(e=>this.events.prison(e))),e.observe("monopoly.derapide.bus",(e=>this.events.desBus(e))),e.observe("monopoly.derapide.triple",(e=>this.events.desTriple(e))),e.observe("monopoly.derapide.mrmonopoly",(e=>this.events.desMrMonopoly(e))),e.observe("monopoly.exitPrison",(e=>this.events.sortiePrison(e))),e.observe("monopoly.acheteConstructions",(e=>this.events.construit(e))),e.observe("monopoly.echange.init",(e=>this.events.initEchange(e))),e.observe("monopoly.echange.propose",(e=>this.events.proposeEchange(e))),e.observe("monopoly.echange.accept",(e=>this.events.accepteEchange(e))),e.observe("monopoly.echange.reject",(e=>this.events.rejetteEchange(e))),e.observe("monopoly.echange.contrepropose",(e=>this.events.contreEchange(e))),e.observe("monopoly.defaite",(e=>this.events.defaite(e))),e.observe("monopoly.victoire",(e=>this.events.victoire(e))),e.observe("monopoly.waitingPlayers",(e=>this.events.waitPlayers(e))),e.observe("monopoly.debug",(e=>this.events.debug(e)))}},w={div:null,init:function(e){this.div=$("#"+e)},_initMessage:function(t,i,s){e.debug({message:s}),this.div.prev().css("background-color",t),this.div.dialog("option","title",i),this.div.empty(),this.div.append(s)},createGeneric:function(e,t,i,s,o){this._initMessage(i,t,s),this.div.unbind("dialogclose.message").bind("dialogclose.message",(function(){w.div.dialog("open")}));let n={};return o.forEach((function(e){n[e.title]=function(){w.div.unbind("dialogclose.message"),w.div.dialog("close"),e.fct()}})),this.div.dialog("option","buttons",n),(e.canPlay||forceshow)&&f(this.div,"open"),n},create:function(e,t,i,s,o=(()=>{}),n,r,a){this._initMessage(i,t,s);let u={Ok:function(){w.close((()=>o(n)))}};if(null!=a)for(let e in a)u[e]=a[e];return null!=o&&this.div.dialog("option","buttons",u),(e.canPlay||r)&&f(this.div,"open"),u},close:function(e=(()=>{})){this.div.dialog("isOpen")&&this.div.dialog("close"),e()},createPrison:function(e,t,i,s){this._initMessage("red","Vous êtes en prison depuis "+i+" tours.","Vous êtes en prison, que voulez vous faire");let o={Payer:function(){t.payer(e),t.exitPrison({paye:!0,notify:!0}),w.close(s)},Attendre:function(){w.close(s)}};return t.cartesSortiePrison.length>0&&(o["Utiliser carte"]=function(){t.utiliseCarteSortiePrison(),t.exitPrison({carte:!0,notify:!0}),w.close(s)}),this.div.dialog("option","buttons",o),t.canPlay&&f(this.div,"open"),o}},P={nbInitHouse:32,nbInitHotel:12,nbSellHouse:0,nbSellHotel:0,reset:function(){this.nbInitHouse=32,this.nbInitHotel=12,this.nbSellHouse=0,this.nbSellHotel=0},isFreeHouse:function(){return this.nbInitHouse>this.nbSellHouse},isFreeHotel:function(e){if(null==e)return this.nbInitHotel>this.nbSellHotel;var t=4-e;return this.nbInitHotel>this.nbSellHotel&this.nbInitHouse>=this.nbSellHouse+t},getRestHouse:function(){return this.nbInitHouse-this.nbSellHouse},getRestHotel:function(){return this.nbInitHotel-this.nbSellHotel},sellHotel:function(){this.nbSellHotel--},sellHouse:function(){this.nbSellHouse--},buyHouse:function(){if(!this.isFreeHouse())throw"Impossible d'acheter une maison.";this.nbSellHouse++},buyHouses:function(e){if(e>this.getRestHouse())throw"Impossible d'acheter les maisons.";this.nbSellHouse+=e},buyHotels:function(e){if(e>this.getRestHotel())throw"Impossible d'acheter les hotels.";this.nbSellHotel+=e},buyHotel:function(){if(!this.isFreeHouse())throw"Impossible d'acheter un hotel.";this.nbSellHotel++,this.nbSellHouse-=4},simulateBuy:function(e){let t={achat:{maison:0,hotel:0},reste:{maison:this.nbInitHouse-this.nbSellHouse,hotel:this.nbInitHotel-this.nbSellHotel}},i={venteMaison:function(e,t){"maison"===e.from.type&&"maison"===e.to.type&&e.from.nb>e.to.nb&&s(e,t)},achatHotel:function(t,s){if("maison"===t.from.type&&"hotel"===t.to.type){for(let o in e){let n=e[o];n.color===t.color&&"maison"===n.from.type&&"maison"===n.to.type&&4===n.to.nb&&i.achatMaison(n,s)}var o=4-t.from.nb;if(o>s.reste.maison)return void(s.reste.maison-=o);s.reste.hotel--,s.achat.hotel++,s.reste.maison+=t.from.nb,s.achat.maison-=t.from.nb,t.done=!0}},venteHotel:function(e,t){if("hotel"===e.from.type&&"maison"===e.to.type){if(e.to.nb>t.reste.maison)return void(t.reste.maison-=e.to.nb);t.reste.hotel++,t.achat.hotel--,t.reste.maison-=e.to.nb,t.achat.maison+=e.to.nb,e.done=!0}},achatMaison:function(e,t){"maison"===e.from.type&&"maison"===e.to.type&&e.from.nb<e.to.nb&&s(e,t)}},s=(e,t)=>{let i=e.from.nb-e.to.nb;t.achat.maison-=i,t.reste.maison+=i,e.done=!0};for(let s in i){let o=i[s];for(let i in e){let s=e[i];if(null==s.done)try{o(s,t)}catch(e){return console.log("exception",e),t}}}return t}};function x(e){return fetch(e).then((e=>e.json()))}function j(e,t=""){return fetch(e,{method:"POST",body:t}).then((e=>e.json()))}let C={gestionDes:null,init:function(e){this.gestionDes.init(e)},lancer:function(){this.gestionDes.lancer()},isDouble:function(){return this.gestionDes.isDouble()},continuePlayer:function(){return this.gestionDes.continuePlayer()},resetDouble:function(){return this.gestionDes.resetDouble()},total:function(){return this.gestionDes.total()},isSpecificAction:function(){return this.gestionDes.isSpecificAction()},doSpecificAction:function(){return this.gestionDes.doSpecificAction()}};class M{throw(e){let t=[];for(let i=0;i<e;i++)t[i]=this.throwOne();return new Promise((e=>e(t)))}throwOne(){return Math.round(1e3*Math.random())%6+1}}class D{throw(e){return function(e){return x(`dices?nb=${e}`)}(e)}}let S={instance:new M,useLocal(){this.instance=new M},useRemote(){this.instance=new D},throw(e){return this.instance.throw(e)}};class I{constructor(e,t){this.parcGratuit=t,this.nbAnimation=8,this.cube={des1:null,des2:null},this.des1=0,this.des2=0,this.nbDouble=0,this.rollColor="#000000",this.montantPrison=e}init(e){this._init(e)}_init(e){this.cube.des1=r.getDes(150,200,50),this.cube.des2=r.getDes(210,200,50),a.addRealTime(this.cube.des1),a.addRealTime(this.cube.des2),this.rollColor=e}resetDouble(){this.nbDouble=0}_rand(){return Math.round(1e3*Math.random())%6+1}isSpecificAction(){return!1}doSpecificAction(){}before(e){if(ce.getJoueurCourant().enPrison){let t=w.createPrison(this.montantPrison,ce.getJoueurCourant(),ce.getJoueurCourant().nbDouble,(function(){e()}));ce.getJoueurCourant().actionAvantDesPrison(t)}else e()}treatPrison(){let e=ce.getJoueurCourant();if(this.isDouble()){let t=w.create(e,"Libere de prison","lightblue","Vous etes liberes de prison grace a un double",(()=>{e.exitPrison({notrigger:!0,notify:!0}),this.endLancer()}),{});return this.nbDouble++,e.actionApresDes(t,null),{prison:{sortie:!0,montant:0},end:!0}}if(2===e.nbDouble){let t=`Vous etes liberes de prison, mais vous devez payer ${Qe} ${this.montantPrison} !`,i=w.create(e,"Libere de prison","lightblue",t,(()=>{e.payerParcGratuit(this.parcGratuit,this.montantPrison,(()=>{e.exitPrison({notrigger:!0,paye:!0,notify:!0}),this.endLancer()}))}),{});return e.actionApresDes(i,null),{prison:{sortie:!0,montant:this.montantPrison},end:!0}}{e.nbDouble++;let t=w.create(e,`Tour ${e.nbDouble}`,"red","Vous restez en prison, vous n'avez pas fait de double.",(()=>ce.change()),{});return e.actionApresDes(t,null),{prison:{sortie:!1},end:!0}}}after(){let e={total:this.total(),combinaison:this.combinaisonDes(),joueur:ce.getJoueurCourant()};!0===ce.getJoueurCourant().enPrison?e=$.extend(e,this.treatPrison()):this.isDouble()&&(e=$.extend(e,this.treatDouble())),v.events.lanceDes(e),this.notifyDices(e),!0!==e.end&&this.endLancer()}combinaisonDes(){return this.des1+" et "+this.des2}treatDouble(){return this._doTreatDouble()}_doTreatDouble(){if(this.nbDouble>=2){let e=w.create(ce.getJoueurCourant(),"Allez en prison","red","Vous avez fait 3 doubles, vous allez en prison",(()=>{this.des2++,ce.getJoueurCourant().goPrison()}),{});return ce.getJoueurCourant().actionApresDes(e,null),{double:{status:!1,triple:!0},end:!0}}return this.nbDouble++,{double:{status:!0,replay:!0}}}endLancer(){ce.getJoueurCourant().joueDes(this.total()),this.showReload()}showReload(){const e=$("#idReloadDice");e.hide(),this.isDouble()&&e.show()}continuePlayer(){return this.isDouble()}isDouble(){return this.des1===this.des2}lancer(){this.before((()=>{this._randDes(),$("#idReloadDice").hide(),this._anime()}))}notifyDices(e){ce.getJoueurCourant().notifyDices([this.des1,this.des2,0],e)}setDices(e,t){this.des1=e,this.des2=t}async _randDes(){await S.throw(2).then((e=>this.setDices(e[0],e[1])))}_anime(){$(".action-joueur").attr("disabled","disabled").addClass("disabled");let e=Ue.quickMove?-1:this.nbAnimation;const t=this,i=setInterval((function(){if(e--<0)return clearInterval(i),t._drawCubes(t.des1,t.des2,t.desRapide),void t.after();t._drawCubes(t._rand(),t._rand(),t._rand()%3+1,t.rollColor)}),100)}setAndShowDices(e,t){null!=e.prison&&null!=e.prison.sortie&&!1===e.prison.sortie&&ce.getJoueurCourant().nbDouble++,e.joueur=t,this.setDices(e.dice1,e.dice2,e.quickDice),this._drawCubes(e.dice1,e.dice2,e.quickDice),e.total=this.total(),e.combinaison=this.combinaisonDes(),v.events.lanceDes(e)}_drawCubes(e,t,i,s="black"){this.cube.des1.setValue(e,s),this.cube.des2.setValue(t,s)}total(){return this.des1+this.des2}}class E extends I{constructor(e,t){super(e,t),this.cube.desRapide=null,this.desRapide=0}init(e){this._init(e),this.cube.desRapide=r.getDesRapide(270,210,35),a.addRealTime(this.cube.desRapide)}isSpecificAction(){return!ce.joueurCourant.enPrison&&this._isMonopolyMan()}doSpecificAction(){this.desRapide=0;let t=ce.getJoueurCourant().getPosition(),i=O.isFreeFiches()?O.getNextFreeTerrain(t):O.getNextTerrain(t);e.send("monopoly.derapide.mrmonopoly",{joueur:ce.getJoueurCourant(),maison:i}),ce.getJoueurCourant().joueSurCase(i)}setDices(e,t,i){this.des1=e,this.des2=t,ce.getJoueurCourant().enPrison?this.desRapide=0:this.desRapide=i}notifyDices(e){ce.getJoueurCourant().notifyDices([this.des1,this.des2,this.desRapide],e)}async _randDes(){await S.throw(3).then((e=>this.setDices(e[0],e[1],this._rand())))}total(){let e=this.des1+this.des2;return!this.isDouble()&&this._isValue()&&(e+=this.desRapide),e}continuePlayer(){return this.isDouble()&&!this.isTriple()}isTriple(){return this.des1===this.des2&&this.des2===this.desRapide&&this.des1<=3}combinaisonDes(){if(this.isTriple())return"triple "+this.des1;const e=this.des1+", "+this.des2;return this.isDouble()?e:e+" et "+(this._isBus()?" Bus":this._isMonopolyMan()?"Mr Monopoly":this.desRapide)}treatDouble(){return this.isTriple()?(ce.getJoueurCourant().choisiCase((function(t){ce.getJoueurCourant().joueSurCase(t),e.send("monopoly.derapide.triple",{joueur:ce.getJoueurCourant(),maison:t})})),{double:{status:!0}}):(this.desRapide=0,this._doTreatDouble())}_isBus(){return 5===this.desRapide}_isMonopolyMan(){return 4===this.desRapide||6===this.desRapide}_isValue(){return this.desRapide<=3}showReload(){const e=$("#idReloadDice");e.hide(),this.isDouble()&&!this.isTriple()&&e.show()}endLancer(){this.showReload(),this.isTriple()||(this.isDouble()||!this._isBus()?(this.isDouble()&&(this.desRapide=0,$("#idReloadDice").show()),ce.getJoueurCourant().joueDes(this.total())):ce.getJoueurCourant().choisiDes(this.des1,this.des2,(function(t){e.send("monopoly.derapide.bus",{joueur:ce.getJoueurCourant(),total:t}),ce.getJoueurCourant().joueDes(t)})))}_drawCubes(e,t,i,s){this.cube.des1.setValue(e,s),this.cube.des2.setValue(t,s),this.isDouble()&&!this.isTriple()&&(i=0),ce.getJoueurCourant().enPrison?this.cube.desRapide.setValue(0,s):this.cube.desRapide.setValue(i,s)}}class T{constructor(e,t,i){this.axe=e,this.pos=t,this.id=e+"-"+t,this.type=i}isTerrain(){return"terrain"===this.type}isPropriete(){return"terrain"===this.type||"junior"===this.type||"gare"===this.type||"compagnie"===this.type}}class q extends T{constructor(e,t){super(e,t,"parc"),this.montant=null,this._titre="Parc Gratuit",this.nom=this._titre,this.drawing=r.getCaseSpeciale(0,this._titre),a.add(this.drawing),this.setMontant(0)}setMontant(t){this.montant=t,this.drawing.titre=this._titre+(this.montant>0?"\n"+Qe+" "+this.montant:""),e.refresh(),$("#idMontantParc > span").text(this.montant)}payer(e){this.setMontant(this.montant+e)}action(){return w.create(ce.getJoueurCourant(),"Parc gratuit","lightblue","Vous gagnez "+this.montant+" "+Qe,(e=>{e.joueur.gagner(e.montant),this.setMontant(0),ce.change()}),{joueur:ce.getJoueurCourant(),montant:this.montant})}}class _ extends T{constructor(e,t,i,s,o){super(i,s,o),this.titre=e,this.nom=e,this.actionSpeciale=t,this.drawing=r.getCaseSpeciale(i,e),a.add(this.drawing)}action(){e.send("monopoly.visiteTerrain",{joueur:ce.getJoueurCourant(),maison:{color:"black",nom:this.titre}}),this.actionSpeciale()}}class k extends _{constructor(e,t,i,s){super(e,(()=>this.actionSpe()),t,i,"depart"),this.montant=s}actionSpe(){let t=(Ue.caseDepart?2:1)*this.montant;ce.getJoueurCourant().gagner(t),e.send("monopoly.depart",{joueur:ce.getJoueurCourant(),montant:t}),ce.change()}}class A extends T{constructor(e,t,i,s,o,n,u){super(i,s,o),this.montant=t,this.titre=e,this.plateauMonopoly=u,this.drawing=r.getCase(s,i,null,e,Qe+" "+t,n),a.add(this.drawing)}action(){return w.create(ce.getJoueurCourant(),this.titre,"lightblue","Vous devez payer la somme de "+this.montant+" "+Qe,(e=>{e.joueur.payerParcGratuit(this.plateauMonopoly.parcGratuit,e.montant,(function(){ce.change()}))}),{joueur:ce.getJoueurCourant(),montant:this.montant})}}class F extends T{constructor(e,t,i,s,o,n="carte chance"){super(e,t,"carte"),this.nom=n,this.cartes=s,this.drawing=r.getCase(t,e,null,o,null,i),a.add(this.drawing)}action(){if(0===this.cartes.length)throw`Aucune ${this.nom}`;let e=Math.round(1e3*Math.random())%this.cartes.length,t=this.cartes[e];return"prison"!==t.actionCarte.type||t.actionCarte.isLibre()||(t=this.cartes[(e+1)%this.cartes.length]),t.action()}}class H extends F{constructor(e,t,i,s,o){super(e,t,i,s,o,"carte caisse de communauté")}}class J{constructor(e,t){this.nom=e,this.color=t,this.fiches=[],this.groupePrecedent=null,this.groupeSuivant=null}equals(e){return null!=e&&this.color===e.color}getVoisins(){return[this.groupePrecedent,this.groupeSuivant]}isVoisin(e){return null!=this.groupePrecedent&&this.groupePrecedent.equals(e)||null!=this.groupeSuivant&&this.groupeSuivant.equals(e)}equals(e){return this.color===e.color}add(e){return this.fiches.push(e),e.groupe=this,this}isGrouped(){if(null==this.fiches||0===this.fiches.length)return!1;let e=this.fiches[0].joueurPossede;for(let t=0;t<this.fiches.length;t++){if(null==this.fiches[t].joueurPossede||!this.fiches[t].joueurPossede.equals(e))return!1;e=this.fiches[t].joueurPossede}return!0}isBuild(){if(null==this.fiches||0===fiches.length)return!1;for(let e=0;e<this.fiches.length;e++)if(this.fiches[e].nbMaison>0)return!0;return!1}getAverageConstructions(){let e=0;for(let t=0;t<this.fiches.length;t++)e+=this.fiches[t].nbMaison;return e/this.fiches.length}getConstructions(){let e={maison:0,hotel:0};for(let t=0;t<this.fiches.length;t++)this.fiches[t].hotel?e.hotel++:e.maison+=this.fiches[t].nbMaison;return e}getInfos(e){let t={free:0,joueur:0,adversaire:0,nbAdversaires:0,maisons:[],hypotheque:0},i=[],s=0;for(let o=0;o<this.fiches.length;o++){let n=this.fiches[o];0===n.statut?t.free++:(n.statutHypotheque&&t.hypotheque++,e.equals(n.joueurPossede)?t.joueur++:(t.adversaire++,t.maisons.push(n),1!==i[n.joueurPossede.id]&&s++,i[n.joueurPossede.id]=1))}return t.nbAdversaires=s,t}getNb(){return null==this.fiches?0:this.fiches.length}}class G{constructor(e,t){this.panel=$(t),this.fiche=e,this.name=""}updateName(e){this.name=e,this.panel.dialog("option","title",this.name)}open(){const e=this.getButtons();return this.panel.dialog("option","buttons",this.getButtons()),y.loadFiche(this.fiche),ce.getJoueurCourant().canPlay&&f(this.panel,"open"),e}getButtons(){return 0===this.fiche.statut?ce.getJoueurCourant().montant<this.fiche.achat?{"Pas assez d'argent":()=>ce.getJoueurCourant().refuseMaison(this.fiche,(()=>y.closeFiche()))}:{Acheter:()=>{ce.getJoueurCourant().acheteMaison(this.fiche),y.closeFiche()},Refuser:()=>ce.getJoueurCourant().refuseMaison(this.fiche,(()=>y.closeFiche()))}:{Fermer:()=>y.closeFiche()}}}class R extends T{constructor(e,t,i,s){super(e,t,"terrain"),this.id=O.buildId(this),this.nom=s,this.groupe=null,this.color=i[0],this.secondColor=2===i.length?i[1]:i[0],this.statut=0,this.joueurPossede=null,this.statutHypotheque=!1,this.fiche=new G(this,"#fiche"),this.nbMaison=0,this.hotel=!1,this.maisons=[],this.input=null}setCosts(e,t,i){return this.achat=e,this.montantHypotheque=e/2,this.achatHypotheque=1.1*this.montantHypotheque,this.loyer=t,this.loyerHotel=null!=t&&6===t.length?t[5]:0,this.prixMaison=i,this}setCostsAndDraw(e,t,i,s){return this.setCosts(e,t,i),this.drawing=r.getCase(this.pos,this.axe,this.color,this.nom,Qe+" "+e,s),a.add(this.drawing),this}equals(e){return null!=e&&this.id===e.id}save(){return{id:this.id,statut:this.statut,joueur:null!=this.joueurPossede?this.joueurPossede.id:null,nb:this.nbMaison,hypotheque:this.statutHypotheque}}getNbPropertiesOfType(){let e=-1;for(let t=0;t<this.joueurPossede.maisons.maisons.length;t++)this.joueurPossede.maisons.maisons[t].type===this.type&&e++;return e}load(e){const t=null!=e.joueur?ce.getById(e.joueur):null;null!=t&&(this.setJoueurPossede(t,!0),t._drawTitrePropriete(this)),this.id=e.id,this.statut=e.statut,this.setNbMaison(e.nb,!0),e.nb>0&&(5===e.nb?P.buyHotels(1):P.buyHouses(e.nb)),this.statutHypotheque=e.hypotheque,!0===this.statutHypotheque&&this.input.addClass("hypotheque")}setJoueurPossede(t,i){this.joueurPossede=t,null!=this.drawing&&this.drawing.setJoueur(t),this.joueurPossede.maisons.add(this),this.joueurPossede.updateMaisonsByGroup(),i||e.refresh()}vendu(t){this.statut=1,this.setJoueurPossede(t),e.send("monopoly.acheteMaison",{joueur:t,maison:this})}libere(){this.statut=0,this.statutHypotheque=!1,this.joueurPossede=null,null!=this.drawing&&this.drawing.setJoueur(null),this.setNbMaison(0,!0),this.hotel=!1,e.refresh()}getRentabilite(){if(!this.isTerrain()||this.nbMaison>=3)return 0;{let e=this.groupe.fiches,t=0;for(let i=0;i<e.length;i++)t+=e[i].nbMaison;return this.loyer[3]/Math.max((3*e.length-t)*this.prixMaison,1)/10}}getRentabiliteBrute(){return this.isTerrain()?this.loyer[3]/(this.achat+3*this.prixMaison):0}hypotheque(){if(null==this.input||1!==this.statut||this.nbMaison>0)throw"Impossible d'hypothequer ce terrain";this.joueurPossede.gagner(this.montantHypotheque),this.joueurPossede.notifyHypotheque(this),this.doHypotheque()}doHypotheque(){this.statutHypotheque=!0,this.input.addClass("hypotheque"),e.send("monopoly.hypothequeMaison",{joueur:this.joueurPossede,maison:this})}leveHypotheque(){if(null==this.input||1!==this.statut||!1===this.statutHypotheque)return;let e=Math.round(this.achatHypotheque);if(this.joueurPossede.montant<e)throw"Impossible de lever l'hypotheque";this.joueurPossede.payer(e),this.notifyLeveHypotheque(),this.doLeveHypotheque()}notifyLeveHypotheque(){}doLeveHypotheque(){this.statutHypotheque=!1,this.input.removeClass("hypotheque"),e.send("monopoly.leveHypothequeMaison",{joueur:this.joueurPossede,maison:this})}isLibre(){return 0===this.statut}setNbMaison(t,i){this.nbMaison=t,null!=this.drawing&&this.drawing.setNbMaison(t),this.hotel=5===this.nbMaison,i||e.refresh()}action(){return this.fiche.updateName(this.nom),null!=this.joueurPossede&&this.joueurPossede.equals(ce.getJoueurCourant())?this.chezSoi():null!=this.joueurPossede&&!1===this.statutHypotheque?this.payerLoyer():!0===this.statutHypotheque?ce.change():this.fiche.open()}chezSoi(){return e.send("monopoly.chezsoi",{joueur:this.joueurPossede,maison:this}),w.create(ce.getJoueurCourant(),"Vous etes "+this.nom,this.color,"Vous etes chez vous",(()=>ce.change()))}sellMaison(e,t){if(null==e||!this.joueurPossede.equals(e)||this.nbMaison<=0)return!1;if(5===this.nbMaison){if(!(P.getRestHouse()>=4))return;P.buyHouses(4),P.sellHotel(),this.hotel=!1}else P.sellHouse();return this.setNbMaison(this.nbMaison-1,t),!0}buyMaison(e,t){if(null!=e&&this.joueurPossede.equals(e)&&!(this.nbMaison>=5)){if(4===this.nbMaison&&!P.isFreeHotel()||this.nbMaison<4&&!P.isFreeHouse())throw"Pas de construction disponible";this.setNbMaison(this.nbMaison+1,t),5===this.nbMaison?(this.hotel=!0,P.buyHotel()):P.buyHouse()}}getLoyerFor(e){return e.equals(this.joueurPossede)?0:this.getLoyer()}getLoyer(){return this.statutHypotheque?0:!0===this.hotel?this.loyerHotel:0===this.nbMaison&&this.isGrouped()?2*this.loyer[0]:this.loyer[this.nbMaison]}payerLoyer(){return w.create(ce.getJoueurCourant(),"Vous etes "+this.nom,this.color,"Vous etes chez "+this.joueurPossede.nom+" vous devez payez la somme de "+this.getLoyer()+" "+Qe,(function(t){e.send("monopoly.payerLoyer",{joueur:t.joueurPaye,maison:t.maison}),e.network({kind:"loyer",player:ce.getJoueurCourant().id,maison:O.buildId(t.maison)}),t.joueurPaye.payerTo(t.loyer,t.joueurLoyer)}),{loyer:this.getLoyer(),joueurPaye:ce.getJoueurCourant(),joueurLoyer:this.joueurPossede,maison:this})}isGrouped(){return null!=this.groupe&&this.groupe.isGrouped()}isGroupedAndBuild(){if(null===this.joueurPossede)return!1;let e=this.joueurPossede.maisons.findMaisonsConstructibles();for(let t=0;t<e.length;t++)if(e[t].color===this.color&&e[t].nbMaison>0)return!0;return!1}}class L extends R{constructor(e,t,i,s){super(e,t,i,s),this.fiche=new G(this,"#ficheJunior"),this.type="junior"}}class N extends R{constructor(e,t,i,s){super(e,t,i,s),this.type="gare"}getLoyer(){if(null!=this.joueurPossede){let e=this.getNbPropertiesOfType();return this.loyer[e]}return 0}}class B extends R{constructor(e,t,i,s){super(e,t,i,s),this.fiche=new G(this,$("#ficheCompagnie")),this.type="compagnie"}getLoyer(){let e=C.total();if(null!=this.joueurPossede){let t=this.getNbPropertiesOfType();return this.loyer[t]*e}return this.loyer[0]*e}}let O={fiches:[],keys:[],buildId:e=>e.axe+"-"+e.pos,_calculateStrId:function(e){return parseInt(e.substr(0,1))*r.dimensions.nbCases+parseInt(e.substr(2,3))},_calculateId:function(e){return e.axe*r.dimensions.nbCases+e.pos},getById:function(e){return this.fiches[this._calculateStrId(e)]},get:function(e){return this.fiches[this._calculateId(e)]},getPrison:function(){return this.fiches[this._calculateId({axe:1,pos:0})]},getDepart:function(){return this.fiches[this._calculateId({axe:2,pos:0})]},add:function(e){let t=this._calculateStrId(e.id);this.fiches[t]=e,this.keys.push(t)},getFreeFiches:function(){return this.fiches.filter((function(e){return 0===e.statut}))},isFreeFiches:function(){return this.fiches.some((function(e){return 0===e.statut}))},getNextFreeTerrain:function(e){return this._getNextFiche(e,(function(e){return e.isPropriete()&&0===e.statut}))},getNextTerrain:function(e){return this._getNextFiche(e,(function(e){return e.isPropriete()}))},getGroups:function(){let e=[];return this.fiches.filter((e=>null!=e.groupe)).forEach((t=>e[t.groupe.nom]=t.groupe.color)),e},_getNextFiche:function(e,t){let i={position:e.pos,axe:e.axe};do{i=this.nextPos(i.axe,i.position);var s=this.get({axe:i.axe,pos:i.position});if(null==t||t(s))return s}while(e.axe!==i.axe||e.pos!==i.position);return null},iterator:function(){return{pointer:0,hasNext:function(){return this.pointer<O.keys.length},next:function(){return O.fiches[O.keys[this.pointer++]]}}},iteratorTerrains:function(){let e=[];for(let t in this.fiches)this.fiches[t].isPropriete()&&e.push(t);return this._buildIterator(e)},getTerrainsLibres:function(){let e=[];for(let t in this.fiches)this.fiches[t].isPropriete()&&0===this.fiches[t].statut&&e.push(t);return this._buildIterator(e)},_buildIterator:function(e){return{pointer:0,keys:e,hasNext:function(){return this.pointer<this.keys.length},next:function(){return O.fiches[this.keys[this.pointer++]]}}},nextPos:function(e,t){return 10==++t&&(e=(e+1)%4,t=0),{position:t,axe:e}}};function z(t,i,s,o=2e4){this.axe=2,this.position=0,this.joueur=i,this.montantDepart=o,this.stats={tour:0,prison:0,positions:[]},this.pion=r.getPionJoueur(t,r.dimensions.largeurPion,s,this.joueur),a.addRealTime(this.pion),this.remove=function(){a.removeComponent(this.pion)},this.goPrison=function(e){this.stats.prison++,this.goDirectToCell(3,0,e)},this.deplaceValeursDes=function(e){let t=this.position+e,i=this.axe;for(;t<0;)t+=r.dimensions.nbCases,i=(i+3)%4;for(;t>=r.dimensions.nbCases;)t-=r.dimensions.nbCases,i=(i+1)%4;return{pos:t,axe:i}},this.goto=function(t,i,s,o=Ue.quickMove,n=!0){let a=t+"-"+i;null==this.stats.positions[a]?this.stats.positions[a]=1:this.stats.positions[a]++,null!=ce.getJoueurCourant()&&e.debug({message:`${ce.getJoueurCourant().nom} est en ${this.axe} - ${this.position} et va en ${a}`});let u=this.axe*r.dimensions.nbCases+this.position,h=t*r.dimensions.nbCases+i,l=2*r.dimensions.nbCases;n&&(u<l&&h>l||u>h&&(u<l||h>l))&&this.treatCaseDepart(),this.axe=t,this.position=i,this.pion.goto(t,i,s,!1,o)},this.treatCaseDepart=function(){this.stats.tour++,this.joueur.gagner(this.montantDepart)},this.goDirectToCell=function(e,t,i){this.axe=e,this.position=t,this.pion.gotoDirect(e,t,i)}}let V={maisonsToLever:[],changesConstructions:[],cout:0,totalRestant:0,divCout:null,divArgentRestant:null,banqueroute:!1,panel:null,open:function(e,t){this.banqueroute=!!e,t?this.panel.unbind("dialogbeforeclose").bind("dialogbeforeclose",t):this.panel.unbind("dialogbeforeclose"),this.panel.dialog("open")},reset:function(){this.Hypotheque.reset(),this.LeverHypotheque.reset(),this.Constructions.reset(),this.cout=0,$("#coutAchats > span[name]").text(0),$(".currency-value").text(Qe),this.update()},init:function(e){this.divArgentRestant=$(e.idArgentRestant),this.divCout=$(e.idCout),this.Hypotheque.init(e.idTerrains,e.idHypotheque),this.LeverHypotheque.init(e.idTerrainsHypotheque),this.Constructions.init(e.idTerrainsConstructibles,e.idCoutAchat,e.idConstructions),this.panel=$(e.idPanel),f(this.panel,{width:800,height:600,position:{my:"center top",at:"center top",of:window},title:"Gestion des maisons",modal:!0,buttons:{Fermer:()=>this.closePanel(),Valider:()=>this.valider()},autoOpen:!1,open:()=>this.load()})},load:function(){this.reset(),this.Hypotheque.load(),this.LeverHypotheque.load(),this.Constructions.load()},addCout:function(e){this.cout+=e,this.update()},update:function(){this.Hypotheque.update();let e=this.Constructions.update();this.divCout.text(this.cout-e.cout+" "+Qe),this.totalRestant=ce.getJoueurCourant().montant+this.cout-e.cout,this.divArgentRestant.text(this.totalRestant+" "+Qe)},verify:function(){try{if(V.totalRestant<0)throw"Operation impossible : pas assez d'argent";V.Constructions.verify()}catch(e){return w.create(ce.getJoueurCourant(),"Attention","red",e),!1}return!0},valider:function(){this.verify()&&(this.Constructions.vendre(),this.Hypotheque.valider(),this.LeverHypotheque.valider(),this.Constructions.acheter(),this.closePanel())},closePanel:function(){this.panel.dialog("close")},Hypotheque:{table:[],select:null,div:null,init:function(e,t){this.select=$("select",e),this.div=$(t)},reset:function(){this.table=[],this.select.empty(),this.div.empty(),$("#idHypothequeAction").unbind("click").bind("click",(function(){V.Hypotheque.add()}))},valider:function(){for(var e in this.table)this.table[e].hypotheque()},update:function(){$("option[data-color]",this.select).removeAttr("disabled");let e=V.Constructions.getGroupesConstruits();for(let t in e)$('option[data-color="'+e[t]+'"]',this.select).attr("disabled","disabled")},load:function(){ce.getJoueurCourant().maisons.findMaisonsHypothecables().forEach((function(e){V.Hypotheque.addOption(e)}))},addGroup:function(e){e.proprietes.forEach((e=>this.addOption(e)))},addOption:function(e){if(this.select.find('option[value="'+e.id+'"]').length>0)return;let t=$("<option data-color='"+e.color+"' value='"+e.id+"'>"+e.nom+" (+"+e.montantHypotheque+" "+Qe+")</option>");t.data("fiche",e),this.select.append(t)},add:function(){let e=$("option:selected",this.select).data("fiche");this.table[e.id]=e;let t=$("<div>"+e.nom+"</div>"),i=$('<button style="margin-right:5px">Annuler</button>');i.click((()=>{this.addOption(e),$(this).parent().remove(),V.addCout(-e.montantHypotheque),delete this.table[e.id];let t=[];for(let e in this.table)t.push(this.table[e].color.substring(1));V.Constructions.showByColors(t)})),t.prepend(i),this.div.append(t),$("option:selected",this.select).remove(),V.addCout(e.montantHypotheque),V.Constructions.removeByColor(e.color)}},LeverHypotheque:{div:null,table:[],init:function(e){this.div=$(e+" > div")},reset:function(){this.div.empty(),this.table=[]},valider:function(){for(var e in this.table)this.table[e].leveHypotheque()},load:function(){let e=ce.getJoueurCourant().maisons.findMaisonsHypothequees();$(e).each((function(){let e=this,t=$("<div>"+this.nom+"</div>"),i=$('<button style="margin-right:5px">Lever</button>');i.click((function(){V.LeverHypotheque.lever($(this),e)})),t.prepend(i),V.LeverHypotheque.div.append(t)}))},lever:function(e,t){e.attr("disabled","disabled"),this.table.push(t),V.addCout(-Math.round(1.1*t.montantHypotheque))}},Constructions:{table:[],div:null,infos:null,simulation:null,resteConstructions:null,init:function(e,t,i){this.div=$(e),this.infos=$(t),this.resteConstructions=$(i)},verify:function(){let e=[];$("select[data-color]",this.div).each((function(){var t=$(this).get(0).dataset.color;null==e[t]&&(e[t]={min:5,max:0}),e[t].min=Math.min(e[t].min,$(this).val()),e[t].max=Math.max(e[t].max,$(this).val())}));for(let t in e)if(e[t].max-e[t].min>1)throw"Il faut equilibrer les maisons";if(this.simulation.reste.maison<0||this.simulation.reste.hotel<0)throw"Impossible d'acheter, il n'a y pas assez de maison / hotel disponibles"},valider:function(){for(let e in this.table){let t=this.table[e];t.propriete.setNbMaison(t.nbMaison),ce.getJoueurCourant().payer(t.cout)}this._doBuyConstructions()},_doBuyConstructions:function(){null==this.simulation||0===this.simulation.achat.maison&&0===this.simulation.achat.hotel||(P.buyHouses(this.simulation.achat.maison),P.buyHotels(this.simulation.achat.hotel),bus.send("monopoly.acheteConstructions",{joueur:ce.getJoueurCourant(),achats:this.simulation.achat}))},acheter:function(){for(var e in this.table){let t=this.table[e];t.propriete.nbMaison<t.nbMaison&&(t.propriete.setNbMaison(t.nbMaison),ce.getJoueurCourant().payer(t.cout))}this._doBuyConstructions()},vendre:function(){for(var e in this.table){let t=this.table[e];t.propriete.nbMaison>t.nbMaison&&(t.propriete.setNbMaison(t.nbMaison),ce.getJoueurCourant().payer(t.cout))}},reset:function(){this.table=[],this.div.empty()},getGroupesConstruits:function(){let e=[];return $("select[data-color]:has(option:selected[value!=0])",this.div).each((function(){e.push($(this).attr("data-color"))})),e},update:function(){let e={nbMaison:0,nbHotel:0,cout:0},t=[];for(let i in this.table){let s=O.getById(i),o={from:{},to:{},group:s.color};s.hotel?(o.from.type="hotel",o.from.nb=1):(o.from.type="maison",o.from.nb=parseInt(s.nbMaison));let n=this.table[i];e.cout+=n.cout,n.hotel>0?(o.to.type="hotel",o.to.nb=1):(o.to.type="maison",o.to.nb=n.nbMaison),e.nbMaison+=n.nbMaison||0,e.nbHotel+=n.hotel||0,t.push(o)}return $("span[name]",this.infos).each((function(){$(this).text(e[$(this).attr("name")])})),this.simulation=P.simulateBuy(t),$('span[name="nbMaison"]',this.resteConstructions).text(this.simulation.reste.maison),$('span[name="nbHotel"]',this.resteConstructions).text(this.simulation.reste.hotel),e},removeByColor:function(e){this.div.find('div[class*="-'+e.substring(1)+'"]').hide()},showByColors:function(e){let t="div";for(let i in e)t+=':not([class*="-'+e[i]+'"])';this.div.find(t).show()},_displayProprietesOfGroup:function(e){for(let t in e.proprietes){let i=e.proprietes[t],s=$(`<div class="propriete propriete-${i.color.substring(1)}"></div>`);s.append(`<span style="color:${i.color}" class="title-propriete">${i.nom}</span>`);let o=$(`<select data-color="${i.color}" class="${5===i.nbMaison?"hotel":"maison"}"></select>`);o.data("propriete",i),o.data("group",e);for(let e=0;e<=(V.banqueroute?i.nbMaison:5);e++)o.append('<option class="'+(5===e?"hotel":"maison")+'" value="'+e+'" '+(i.nbMaison===e?"selected":"")+">x "+(5===e?1:e)+"</option>");o.change((e=>{let t=$(e.currentTarget),i=t.data("propriete"),s=parseInt(t.val());if(i.nbMaison===s)return delete this.table[i.id],$("~span",t).text(""),void V.update();let o=5===s?{hotel:1}:{maison:s-i.nbMaison};o.propriete=i,o.nbMaison=s,o.cout=s>i.nbMaison?(s-i.nbMaison)*i.prixMaison:(s-i.nbMaison)*i.prixMaison/2,t.removeClass().addClass(5===s?"hotel":"maison"),$("~span",t).text(o.cout),this.table[i.id]=o,V.update();var n=0,r=t.data("group");V.Constructions.div.find(`select[data-color="${i.color}"]`).each((function(){n+=s})),0===n&&V.Hypotheque.addGroup(r)})),s.append(o).append(`<span></span> ${Qe}`),$(this.div).append(s)}},load:function(){let e=ce.getJoueurCourant().maisons.findConstructiblesGroupes();for(let t in e){let i=$(`<div style="cursor:pointer" class="group-${t.substring(1)}">Groupe <span style="color:${t};font-weight:bold">${e[t].proprietes[0].groupe.nom}'</span></div>`);i.data("color",t.substring(1)),i.click((function(){let e="div.propriete-"+$(this).data("color");0===$(`${e}:visible`,this.div).length?$(e,this.div).slideDown():$(e,this.div).slideUp()})),this.div.append(i),this._displayProprietesOfGroup(e[t])}}}};class U{constructor(e,t=[]){this.joueur=e,this.maisons=[],t.forEach((e=>this.add(e)))}add(e){e.joueurPossede=this.joueur,e.statut=1,this.maisons.push(e)}remove(e){let t=this.maisons.findIndex((t=>t.equals(e)));-1!=t&&(e.statut=0,e.joueurPossede=null,this.maisons.splice(t,1))}getGroupesPossibles(){let e=new Set;return this.maisons.filter((e=>!e.isGrouped())).filter((e=>1===e.groupe.fiches.filter((e=>!this.joueur.equals(e.joueurPossede))).reduce(((e,t)=>e+(0===t.statut?1:10)),0))).forEach((t=>e.add(t.color))),Array.from(e)}getMaisonsGrouped(){var e=[];return this.maisons.forEach((t=>{null==t.groupe?void 0===e.others?e.others={groupe:"Autres",color:"black",terrains:[t]}:e.others.terrains.push(t):void 0===e[t.groupe.nom]?e[t.groupe.nom]={groupe:t.groupe.nom,color:t.groupe.color,terrains:[t]}:e[t.groupe.nom].terrains.push(t)})),e}findMaisonsByGroup(){let e=[];return this.maisons.forEach((t=>{null==e[t.groupe.nom]&&(e[t.groupe.nom]=[]),e[t.groupe.nom].push(t)})),e}findMaisonsHypothecables(){return this.maisons.filter((e=>!1===e.statutHypotheque&&0===e.nbMaison&&!this.maisons.some((t=>t.color===e.color&&t.nbMaison>0))))}findMaisonsHypothequees(){return this.maisons.filter((e=>e.statutHypotheque))}findConstructiblesGroupes(){var e=[],t=[];return this.maisons.filter((e=>!0===e.isTerrain()&&null!=e.groupe)).forEach((i=>{if(void 0===e[i.color]){let s=i.groupe.getInfos(this.joueur);0===s.free&&0===s.adversaire&&0===s.hypotheque?t[i.color]={color:i.color,group:i.groupe,proprietes:i.groupe.fiches}:e[i.color]=!0}})),t}findOthersInterestProprietes(e,t,i){let s=[],o=[];this.maisons.forEach((i=>{if(void 0===o[i.groupe.color]){let n=i.groupe.getInfos(this.joueur);0===n.free&&(1===n.adversaire||n.nbAdversaires>1)&&n.maisons.filter((i=>(void 0===e||e.equals(i.joueurPossede))&&(null==t||!t.groupe.equals(i.groupe)))).filter((()=>!(t&&i.groupe.color===t.groupe.color))).forEach((e=>s.push({maison:e,nb:n.maisons.length}))),o[i.groupe.color]=!0}}));let n=this.findConstructiblesGroupes();return s.sort(((e,t)=>this._computeScoreInterest(e,t,n,i))),s}_computeScoreInterest(e,t,i,s){let o=e.nb/t.nb,n=e.maison.getRentabiliteBrute()/t.maison.getRentabiliteBrute(),r=1,a=1;for(let s in i)i[s].group.isVoisin(e.maison.groupe)&&r++,i[s].group.isVoisin(t.maison.groupe)&&a++;let u=r/a,h=1;if(null!=s){let i=s.interetPropriete(e.maison);i!==s.interetPropriete(t.maison)&&(h=i?.5:2)}let l=1;return e.maison.isTerrain()!==t.maison.isTerrain()&&(l=e.maison.isTerrain()?.5:4),o*n*u*h*l-1}findUnterestsProprietes(){var e=[];let t=this.maisons.filter((e=>!e.isTerrain()));return t.forEach((t=>{void 0===e[t.groupe.nom]?e[t.groupe.nom]=1:e[t.groupe.nom]++})),{proprietes:t,nbByGroups:e}}findOthersProperties(e){var t=[];for(let i in e)t[e[i].maison.color]=1;return this.maisons.filter((e=>e.isTerrain()&&!e.isGrouped()&&void 0===t[e.color]))}findMaisonsConstructibles(){var e=[],t=[],i=[];return this.maisons.filter((e=>e.isTerrain())).forEach((s=>{!0===t[s.color]?e.push(s):void 0===i[s.color]&&(s.groupe.fiches.some((e=>e.isTerrain()&&(!this.joueur.equals(e.joueurPossede)||!0===e.statutHypotheque)))?i[s.color]=!0:(t[s.color]=!0,e[e.length]=s))})),e}libere(){this.maisons.forEach((e=>e.libere())),this.maisons=[]}cherchePlacement(e){for(let t=0;t<this.maisons.length;t++)if(this.maisons[t].color===e.color)return this.maisons[t].input;return null}}class W{constructor(e){this.joueur=e}save(){let e={canPlay:this.joueur.canPlay,id:this.joueur.id,nom:this.joueur.nom,color:this.joueur.color,montant:this.joueur.montant,enPrison:this.joueur.enPrison,nbDouble:this.joueur.nbDouble,bloque:this.joueur.bloque,defaite:this.joueur.defaite,cartesPrison:this.joueur.cartesSortiePrison.length,position:this.joueur.pion.position,axe:this.joueur.pion.axe};return this.saveMore(e),e}load(e){for(let t in e)null!=this[t]&&(this[t]=e[t]);return this.joueur.setArgent(e.montant),this.loadMore(e),this.joueur.pion.goDirectToCell(e.axe,e.position),this.joueur.defaite&&$(".joueurCourant",this.joueur.div).removeAttr("style").addClass("defaite"),this.joueur}saveMore(){}loadMore(e){}}class Q{constructor(e,t="",i,s,o=0){this.numero=e,this.type="Local",this.id=e,this.nom=t,this.color=i,this.montant=s,this.maisons=new U(this),this.enPrison=!1,this.pion=null,this.nbDouble=0,this.bloque=!1,this.defaite=!1,this.tourDefaite=null,this.cartesSortiePrison=[],this.canPlay=!0,this.montantDepart=o,this.enableMouseFunction=()=>{},this.saver=new W(this)}setEnableMouseFunction(e){this.enableMouseFunction=e}equals(e){return null!=e&&this.numero===e.numero}isSlotFree(){return!1}utiliseCarteSortiePrison(){if(0===this.cartesSortiePrison.length)throw"Impossible d'utiliser cette carte";this.cartesSortiePrison[this.cartesSortiePrison.length-1].joueurPossede=null,this.cartesSortiePrison.splice(this.cartesSortiePrison.length-1,1)}getStats(){let e={type:this.type,prison:this.pion.stats.prison,tour:this.pion.stats.tour,argent:this.montant,argentDispo:this.montant,argentDispoHypo:this.montant,hotel:0,maison:0,strategie:null!=this.strategie?this.strategie.toString():"-",comportement:null!=this.comportement?this.comportement.name:"-"};for(const t in this.maisons.maisons){const i=this.maisons.maisons[t];e.hotel+=!0===i.hotel?1:0,e.maison+=parseInt(!1===i.hotel?i.nbMaison:0),e.argentDispo+=i.statutHypotheque?0:(i.isTerrain()?i.nbMaison*(i.prixMaison/2):0)+i.achat/2,e.argentDispoHypo+=i.isGrouped()||i.statutHypotheque?0:i.achat/2}return e}select(){this.div&&this.div.find("div:first").addClass("joueurCourant"),this.enPrison||(this.nbDouble=0),this.joue()}notifySelect(){}notifyDices(e){}lancerDes(){C.lancer()}getPosition(){return{pos:this.pion.position,axe:this.pion.axe}}traiteRequeteEchange(e,t,i){b.show(e,this,t,i,this)}traiteContreProposition(e){b.showContreProposition(e)}notifyAcceptProposition(e){b.showAccept(e)}notifyRejectProposition(e){b.showReject(e)}initEnchere(e,t){h.display(t,this)}updateInfoEnchere(e,t){h.updateInfo(e,t,!1)}notifyExitEnchere(e){h.showJoueurExit(e)}updateEnchere(e,t,i,s,o){o&&h.clean(),h.updateInfo(i,s,!0,{transaction:e,jeton:t})}endEnchere(e,t){h.displayCloseOption(e,t)}joueDes(e){this.moveTo(e)}moveTo(e){const t=this.pion.deplaceValeursDes(e);this.joueSurCase(t)}joueSurCase(e,t,i=!0){this.pion.goto(e.axe,e.pos,(()=>Ke(this)),t,i)}joueSurCaseNoAction(e){this.pion.goto(e.axe,e.pos,(()=>{}))}joue(){}choisiDes(e,t,i){if(!i)return;let s=[{title:e+" + "+t,fct:()=>i(e+t)},{title:e,fct:()=>i(e)},{title:t,fct:()=>i(t)}];w.createGeneric(this,"Vous prenez le bus","green","Quel(s) dé(s) vous choisissez",s)}choisiCase(e){w.create(this,"Triple dé","green","Choisissez votre case",(()=>{this.enableMouseFunction(e)}))}actionApresDes(){}actionAvantDesPrison(){}acheteMaison(e,t=e.achat){if(void 0===e||t>this.montant)throw"Achat de la maison impossible";e.isLibre()&&(this.showAcheteMaison(e),this.payer(t),this.notifyAcheteMaison(e,t))}showAcheteMaison(e){this._drawTitrePropriete(e),e.vendu(this)}refuseMaison(t,i=(()=>{})){e.send("monopoly.visiteMaison",{joueur:ce.getJoueurCourant(),maison:t}),this.notifyMessage("monopoly.visiteMaison","",{maison:t.id}),Ue.enchereAchat?this._enchereByBanque(t,i):i()}_enchereByBanque(e,t){u.init(e,e.achat,!0,t)}_drawTitrePropriete(e){let t=this.maisons.cherchePlacement(e),i=`<input type="button" id="idInputFiche${e.id}" class="ui-corner-all fiche color_${e.color.substring(1)}" value="${e.nom}" id="fiche_${e.id}"/>`;null!=t?t.after(i):this.div.append(i),e.input=$('input[id="idInputFiche'+e.id+'"]'),!0===e.statutHypotheque&&e.input.addClass("hypotheque"),e.input.click((function(){y.openDetail(O.getById(e.id),$(this))}))}getSwapProperiete(e){e.input.remove(),e.input=null,this._drawTitrePropriete(e),e.joueurPossede&&e.joueurPossede.maisons.remove(e),e.setJoueurPossede(this)}goPrison(t=!0){this.showPrison(),this.nbDouble=0,t&&this.notifyPrison(),this.pion.goPrison((()=>ce.change())),e.send("monopoly.goPrison",{joueur:this})}showPrison(){this.enPrison=!0,this.div.addClass("jail")}exitPrison(t={notrigger:!1,notify:!0,paye:!1,carte:!1}){this.enPrison=!1,this.nbDouble=0,this.div.removeClass("jail"),t.notify&&this.notifyExitPrison(t.paye,t.carte),t.notrigger||e.send("monopoly.exitPrison",{joueur:this,paye:t.paye,carte:t.carte})}isEnPrison(){return this.enPrison}setDiv(e){this.div=e,this.setArgent(this.montant)}setArgent(e){if(void 0===e)throw"error montant";this.montant=e,$(".compte-banque",this.div).text(e)}payerParcGratuit(e,t,i=(()=>{})){try{this.payer(t,(()=>{Ue.parcGratuit&&e.payer(t),i()}))}catch(e){i()}}setPion(e,t,i){this.pion=new z(e,this,t,i)}isSolvable(e){return this.getStats().argentDispo>=e}payer(e,t=(()=>{})){if(this.getStats().argentDispo<e)throw this.doDefaite(),"Le joueur "+this.nom+" est insolvable";this.notifyPay(e),this.montant-e<0?(this.bloque=!0,this.resolveProblemeArgent(e,t)):(this.setArgent(this.montant-e),t())}notifyAcheteMaison(e,t){}notifyHypotheque(){}notifyLeveHypotheque(){}notifyPay(){}notifyMessage(){}notifyPrison(){X.goPrison(this)}notifyExitPrison(e=!1,t=!1){X.exitPrison(this,e,t)}payerTo(e,t,i){let s=this.getStats().argentDispo;try{this.payer(e,(()=>{if(t.gagner(e),null!=i)return i();ce.change()}))}catch(e){null!=t&&t.gagner(s),ce.change()}}gagner(e){this.setArgent(this.montant+e)}doDefaite(){this.maisons.libere(),e.refresh(),this.updateMaisonsByGroup(),$("input",this.div).remove(),this.pion.remove(),$(".joueurCourant",this.div).removeAttr("style").addClass("defaite"),this.setArgent(0),this.defaite=!0,this.tourDefaite=We.nbTours,e.send("monopoly.defaite",{joueur:this})}resolveProblemeArgent(e,t){return this.montant-=e,w.create(this,"Attention","red","Vous n'avez pas les fonds necessaires, il faut trouver de l'argent",(()=>{V.open(!0,(e=>{this.montant<0?(w.create(this,"Attention","red","Impossible, il faut trouver les fond\ts avant de fermer"),e.preventDefault()):(this.bloque=!1,this.setArgent(this.montant),t())}))})),!0}updateMaisonsByGroup(){let e=this.maisons.findMaisonsByGroup(),t=$(".count-property",this.div);for(var i in $(".counter-group",t).html(0),e){let s=i.replace(/ /g,"");$(`.counter-group.${s}`,t).html(e[i].length)}}endTurn(){}}class Y extends Q{constructor(e,t,i,s,o){super(e,t,i,s,o)}moveTo(e){const t=this.pion.deplaceValeursDes(e);X.moveTo(O.buildId(t),this),this.joueSurCase(t)}joueSurCase(e,t,i=!0,s=!1){super.joueSurCase(e,t,i),s&&X.moveTo(O.buildId(e),this)}actionApresDes(e){}gagner(e){this.setArgent(this.montant+e),X.gagner(e,this)}notifyPay(e){X.payer(e,this)}notifyMessage(e,t,i){X.notifyMessage(e,t,this,i)}notifyHypotheque(e){X.hypotheque(e,this)}notifyLeveHypotheque(e){X.leveHypotheque(e,this)}notifySelect(){X.notifySelect(this)}notifyAcheteMaison(e,t){X.notifyAcheteMaison(e,t,this)}notifyDices(e,t){X.dices(e,t,this)}}let X={askDices(t){e.network({kind:"launchDices",player:t.id})},dices(t,i,s){delete i.joueur;let o=$.extend({kind:"dices",player:s.id,dice1:t[0],dice2:t[1],quickDice:t[2]},i);e.network(o)},hypotheque(t,i){e.network({kind:"hypotheque",terrain:t.id,player:i.id})},leveHypotheque(t,i){e.network({kind:"leveHypotheque",terrain:t.id,player:i.id})},move(t,i){e.network({kind:"move",player:i.id,nb:t})},moveTo(t,i){e.network({kind:"moveTo",player:i.id,to:t})},notifySelect(t){e.network({kind:"change",player:t.id})},goPrison(t){e.network({kind:"prison",player:t.id})},exitPrison(t,i,s){e.network({kind:"exitPrison",player:t.id,paye:i,carte:s})},payer(t,i){e.network({kind:"tax",player:i.id,montant:t})},gagner(t,i){e.network({kind:"earn",player:i.id,montant:t})},notifyAcheteMaison(t,i,s){e.network({kind:"buy",player:s.id,terrain:t.id,montant:i})},notifyMessage(t,i,s,o={}){e.network({kind:"message",player:s.id,libelle:i,name:t,...o})},notifyEnd(){e.network({kind:"end"})}};class Z extends Y{constructor(e,t,i,s,o){super(e,t,i,s,o)}lancerDes(){C.gestionDes.before((()=>X.askDices(this)))}notifySelect(){}endTurn(){X.notifyEnd()}notifyDices(e){}}class K extends Q{constructor(e,t,i,s,o){super(e,t,i,s,o),this.canPlay=!1,this.type="Distant",this.free=!0}isSlotFree(){return this.free}setPlayer(e){this.nom=e,this.free=!1,$(".joueur-name",this.div).text(this.nom)}notifyPay(e){X.payer(e,this)}}class ee extends K{constructor(e,t,i,s,o){super(e,t,i,s,o)}notifySelect(){X.notifySelect(this)}notifyDices(e,t){X.dices(e,t,this),null!=t.prison&&(t.prison.sortie?ce.getJoueurCourant().exitPrison():ce.change())}moveTo(e){let t=this.pion.deplaceValeursDes(e);X.moveTo(O.buildId(t),this),this.joueSurCase(t)}}class te{constructor(e,t,i,s,o=Math.round(1e3*Math.random())%3==0){this.groups=e,this.agressif=t,this.interetGare=o,this.name=i,this.id=s}_containGroup(e){for(let t in this.groups)if(this.groups[t]===e)return!0;return!1}getStatsProprietes(){let e={color:{total:0,libre:0,achete:0,pourcent:0},all:{total:0,libre:0,achete:0,pourcent:0}},t=O.iteratorTerrains();for(;t.hasNext();){let i=t.next();null!=i.statut&&(e.all.total++,0===i.statut?e.all.libre++:e.all.achete++,this._containGroup(i.color)&&(e.color.total++,0===i.statut?e.color.libre++:e.color.achete++))}return e.color.pourcent=e.color.libre/e.color.total*100,e.all.pourcent=e.all.libre/e.all.total*100,e}interetGlobal(e,t,i){let s=this.interetPropriete(e),o=this.statutGroup(e,t,i),n=o.statut,r={interet:1};return!1===s&&0===n&&(r={interet:.2}),!1===s&&2===n&&(r={interet:this.agressif,joueur:o.joueur}),!0===s&&3===n&&(r={interet:4}),!1===s&&3===n&&(r={interet:2}),!0===s&&5===n&&(r={interet:1.5}),i&&(r={interet:this.interetProprieteInStrategie(e)}),e.isTerrain()||(r.interet/=2),r}interetProprieteInStrategie(){let e=this.getStatsProprietes();return.5+parseFloat(Math.log(Math.min(100-e.color.pourcent,32.5)/50+1).toFixed(2))}interetPropriete(e){for(let t in this.groups)if(this.groups[t]===e.color||"gare"===e.type&&this.interetGare)return!0;return!1}statutGroup(e,t,i){let s=0,o=0,n=null,r=0,a=0;for(let i in e.groupe.fiches){let u=e.groupe.fiches[i];s++,0===u.statut?o++:(u.joueurPossede.equals(t)?a++:(null==n||u.joueurPossede.equals(n))&&r++,n=u.joueurPossede)}return o===s?{statut:0}:1===o&&r===s-1?{statut:2,joueur:n}:1!==o&&!i||a!==s-1?a>0&&o>0?{statut:5}:o>0?{statut:1}:{statut:4}:{statut:3}}acceptSwapTerrain(e,t,i,s){let o=ce.getNb()>2;if(!0===s&&1===i.length||e.isGrouped())return 0;for(let t in i)i[t].maison.joueurPossede.equals(e.joueurPossede)||(o=!1);let n=t.maisons.findConstructiblesGroupes().size();return 0===n&&0===i.length&&o?2===this.agressif?.5:1:n>=2&&o?this.agressif>0?0:.5:0===n?1.5:n>=2&&this.agressif>0?.5:1}toString(){return this.name+(this.interetGare?' <img src="img/little_train.png" style="width:20px;height:16px;"/>':"")}}let ie={strategies:[class extends te{constructor(){super(["#812B5C","#119AEB","#73316F","#D16E2D"],0,"Econome",0)}},class extends te{constructor(){super(["#73316F","#D16E2D","#D32C19","#E6E018"],1,"Normal",1)}},class extends te{constructor(){super(["#D32C19","#E6E018","#11862E","#132450"],2,"Luxe",2)}},class extends te{constructor(){super(["#D16E2D","#D32C19","#E6E018"],2,"Futé",3,!0)}},class extends te{constructor(){super(["#812B5C","#119AEB","#73316F","#D16E2D","#D32C19","#E6E018","#11862E","#132450"],4,"Dingue",3,!0)}}],create:function(e){return new this.strategies[e]},createRandom:function(){return this.create(Math.round(1e3*Math.random())%this.strategies.length)},getAll:function(){return this.strategies},length:function(){return this.strategies.length}};class se{constructor(e,t,i){this.risque=e,this.probaDes=[0,2.77,5.55,8.33,11.1,13.8,16.7,13.8,11.1,8.33,5.55,2.77],this.name=t,this.id=i}getRisqueTotal(e,t){return this.calculMargeMontant(e,t)*(this.calculRisque(e,e.montant)/100+1)}getMaxBudgetForStrategie(e,t){let i=t/(this.calculRisque(e,e.montant)/100+1),s=this.findCoutFromFixMarge(e,i);return s+=Math.round(.1*s*((1e3*Math.random()%10-5)/10)),Math.min(s,e.montant-e.minimumPriceHouse())}getFactorForProposition(){return 1+this.risque}getBudget(e,t){let i=e.montant;(!0===t||this.risque>.6)&&(i=e.getStats().argentDispoHypo);let s=this.plusFortLoyer(e),o=this.calculRisque(e,i);return Math.round((e.montant-s*(1-this.risque*this.risque))*(1-o/100))}getNextProprietesVisitees(e){let t=[];return ce.forEach((i=>{if(!i.equals(e))for(let s=1;s<12;s++){let o=O.get(i.pion.deplaceValeursDes(s));o.isTerrain()&&null!=o.joueurPossede&&o.joueurPossede.equals(e)&&(null!=t[o.id]?t[o.id].proba+=this.probaDes[s]/100:t[o.id]={proba:this.probaDes[s]/100,maison:o})}}),this),t}calculMargeMontant(e,t){return t/e.montant/this.risque}findCoutFromFixMarge(e,t){return t*this.risque*e.montant}calculRisque(e,t){let i=e.pion.position,s=e.pion.axe,o=0;for(let n=1;n<=12;n++){let r=O.nextPos(s,i);s=r.axe,i=r.position;let a=O.getById(s+"-"+i);null!=a&&null!=a.getLoyer&&null!=a.joueurPossede&&!a.joueurPossede.equals(e)&&a.getLoyer()>t*this.risque&&(o+=this.probaDes[n-1])}return o}plusFortLoyer(e){let t=e.montantDepart,i=O.iteratorTerrains();for(;i.hasNext();){let s=i.next();null!=s.getLoyer&&null!=s.joueurPossede&&!e.equals(s.joueurPossede)&&s.getLoyer()>t&&(t=s.getLoyer())}return t}getLoyerMoyen(e){let t=e.montantDepart,i=1,s=O.iteratorTerrains();for(;s.hasNext();){let o=s.next();null==o.getLoyer||null==o.joueurPossede||e.equals(o.joueurPossede)||(t+=o.getLoyer(),i++)}return{montant:t/i,nb:i}}}let oe={comportements:[class extends se{constructor(){super(.25,"Prudent",0)}},class extends se{constructor(){super(.5,"Normal",1)}},class extends se{constructor(){super(.8,"Fou",2)}}],create:function(e){return new this.comportements[e]},createRandom:function(){return this.create(Math.round(1e3*Math.random())%this.comportements.length)},getAll:function(){return this.comportements},length:function(){return this.comportements.length}};const ne="TERRAIN_NON_LISTE",re="TERRAIN_DISPO",ae="ARGENT_INSUFFISANT";class ue extends W{constructor(e){super(e)}saveMore(e){e.comportement=this.joueur.comportement.id,e.strategie=this.joueur.strategie.id,e.rejectedPropositions=[];for(let t in this.joueur.rejectedPropositions){let i=this.joueur.rejectedPropositions[t][this.joueur.rejectedPropositions[t].length-1].proposition,s=[];i.terrains.forEach((e=>s.push(e.id))),e.rejectedPropositions.push({id:t,proposition:{compensation:i.compensation,terrains:s}})}}loadMore(e){if(this.joueur.init(e.strategie,e.comportement),this.joueur.rejectedPropositions=[],null!=e.rejectedPropositions)for(let t in e.rejectedPropositions){let i=e.rejectedPropositions[t].proposition,s=[];if(null!=i.terrains)for(let e in i.terrains)s.push(O.getById(i.terrains[e]));this.joueur.rejectedPropositions[e.rejectedPropositions[t].id]=[{proposition:{compensation:i.compensation,terrains:s}}]}}}class he extends Q{constructor(e,t,i,s,o){super(e,t,i,s,o),this.type="Ordinateur",this.threasholdMontant=.65*s,this.canPlay=!1,this.strategie=null,this.comportement=null,this.nom=t,this.rejectedPropositions=[],this.saver=new ue(this),this.init()}init(e,t){this.strategie=void 0===e?ie.createRandom():ie.create(e),this.comportement=void 0===t?oe.createRandom():oe.create(t)}joue(){this.changeStrategie(),this.echangeProprietes((()=>{this.buildConstructions(),this.rebuyHypotheque(),e.debug({message:`joueur ${this.nom} joue`}),C.lancer()}))}choisiCase(e){let t,i=O.getFreeFiches(),s=null;i.forEach((function(e){let i=this.strategie.interetGlobal(e,this,!1).interet;0!==i&&(void 0===t||i>t)&&(t=i,s=e)}),this),null!=s?e(s):this.getOutPrison()?e(O.getDepart()):e(O.getPrison())}choisiDes(e,t,i){let s={fiche:this.pion.deplaceValeursDes(e),total:e},o={fiche:this.pion.deplaceValeursDes(t),total:t},n={fiche:this.pion.deplaceValeursDes(e+t),total:e+t},r=-1e3,a=0;[s,o,n].forEach((e=>{let t=this._analyseCase(O.get(e.fiche));t>r&&(a=e.total,r=t)})),i(a)}_analyseCase(e){let t=0;switch(!0===e.isPropriete()&&(t=0===e.statut?this.strategie.interetGlobal(e,this,!1).interet:e.getLoyerFor(this)/-1e3),e.type){case"prison":t=this.getOutPrison()?-2:1;break;case"taxe":t=-1*e.montant/1e3;break;case"depart":t=.5}return t}actionApresDes(t,i){if(void 0===t||null==t)return;let s=this;setTimeout((function(){if(null!=t.Acheter&&null!=i){let o=s.strategie.interetGlobal(i).interet,n=s.comportement.getRisqueTotal(s,i.achat);if(e.debug({message:"Strategie : "+o+" "+n}),o>n)return e.debug({message:"IA Achete"}),void t.Acheter()}for(let e in t)if("Acheter"!==e)return void t[e]()}),Ve)}notifyAcceptProposition(e){e&&e()}notifyRejectProposition(e,t,i){void 0===this.rejectedPropositions[t.id]&&(this.rejectedPropositions[t.id]=[]),this.rejectedPropositions[t.id].push({nbTours:We.nbTours,proposition:i}),e()}addIsolateHouse(e,t){let i=this.maisons.findUnterestsProprietes(),s=0;if(i.proprietes.length>0){let o=i.proprietes;for(let i=0;i<o.length&&s/e.achat<.7;i++){let n=o[i];this.strategie.interetPropriete(n)||null!=n.groupe&&n.groupe.equals(e.groupe)||(t.deals.push(n),s+=n.achat)}}return s}echangeProprietes(t=(()=>{})){if(Ue.echangeApresVente&&O.isFreeFiches())return t();let i=this.maisons.findOthersInterestProprietes();if(0===i.length)return t();const s=this.maisons.findConstructiblesGroupes().length,o=Math.pow(1/(1+s),2);let n=[];for(let t in i){let a=i[t],u=a.maison;if(this._canAskTerrain(u)){let e=this._getLastProposition(u),t=u.joueurPossede;if(a.compensation=0,a.deals=u.joueurPossede.maisons.findOthersInterestProprietes(this,u),0===a.deals.length){let i=this.addIsolateHouse(u,a);i/u.achat<.8&&(a.compensation=this.evalueCompensation(t,u,o,e)-i)}else{const i=this.chooseMonnaiesEchange(a,a.monnaiesEchange,!0,s>=2,e);void 0===i||0===i.length?(a.compensation=this.evalueCompensation(t,u,o,e),a.deals=null):a.deals=i}if((null==a.deals||0===a.deals.length)&&0===a.compensation){const e=this.maisons.findOthersProperties(i);let t=0;for(var r=0;r<e.length&&t/u.achat<.7;r++){const i=e[r];this.strategie.interetPropriete(i)||(null==a.deals&&(a.deals=[]),a.deals.push(i),t+=i.achat)}}(null!=a.deals&&a.deals.length>0||null!=a.compensation&&a.compensation>0)&&n.push(a)}else e.debug({message:"Le joueur ne demande pas "+u.nom})}this.doPropositionToPlayer(n,t)}doPropositionToPlayer(e,t){if(0===e.length)return t();for(let i in e){let s=e[i],o={terrains:null==s.deals?[]:s.deals,compensation:s.compensation};try{return c.init(this,s.maison.joueurPossede,s.maison,t),void c.propose(o)}catch(e){return console.log(e),t()}}}_canAskTerrain(e){const t=this._getLastProposition(e);if(null!=t){const e=3+Math.round(1e3*Math.random()%3);return t.nbTours+e<We.nbTours}return!0}_getLastProposition(e){return null!=this.rejectedPropositions&&null!=this.rejectedPropositions[e.id]?this.rejectedPropositions[e.id][this.rejectedPropositions[e.id].length-1]:null}traiteRequeteEchange(e,t,i){if(!(void 0!==i.terrains&&0!==i.terrains.length||void 0!==i.compensation&&0!==i.compensation))return c.reject(this);let s=this.maisons.findOthersInterestProprietes(e),o=this._calculatePropositionValue(t,e,i,s);if(o.critere>=3)return c.accept(this);if(o.critere<=0)return c.reject(this);let n={terrains:[],compensation:0},r=0;do{n=this._calculateContreProposition(e,i,n,o.recommandations,t,s),o=this._calculatePropositionValue(t,e,n,s)}while(o.critere<3&&r++<3);return o.critere<3?c.reject(this):c.contrePropose(n,this)}_calculateContreProposition(e,t,i,s,o,n){if(1===s[re]||1===s[ne]){let r=0;for(let e=0;e<n.length&&(n[e].maison.groupe.equals(o.groupe)||(i.terrains.push(n[e].maison),r+=n[e].maison.achat,!(r>o.achat)));e++);if(r<o.achat&&1===s[ne]){let s=!1;for(let o=0;o<t.length&&!s;o++)if(i.terrains.contains(t.terrains[o])||(i.terrains.push(t.terrains[o]),s=!0),!s){let t=e.maisons.findUnterestsProprietes();t.proprietes.length>0&&i.terrains.push(t.proprietes[0])}}}return 1===s[ae]&&(i.compensation+=o.achat/2),i}_calculatePropositionValue(t,i,s,o){let n=[],r=o.some((e=>t.groupe.equals(e.maison.groupe))),a=0,u=0;if(null!=s.terrains&&s.terrains.length>0){let e=!1;for(let i in s.terrains){let n=s.terrains[i],r=null;for(let e=0;e<o.length;e++)o[e].maison.equals(n)&&(r=e);null!=r&&(a+=1+(o.length-r)/o.length,e=!0),a+=n.achat/t.achat}e||(n[ne]=1)}else null!=o&&o.length>0&&(a-=o.length-(r?1:0),n[re]=1);null!=s.compensation?(u=s.compensation/t.achat,this.montant<s.compensation?u+=Math.min(1.5,s.compensation/this.montant-1):n[ae]=1):n.NO_ARGENT=1;let h=(a+u)*this.strategie.acceptSwapTerrain(t,i,o,r);return e.debug({message:"Criteres : "+h+" "+a+" "+u}),{critere:h,recommandations:n,others:o}}traiteContreProposition(e,t,i){if(0===e.terrains.length&&0===e.compensation)return c.reject(this);let s,o=this.maisons.findOthersInterestProprietes(t);if(e.terrains.length>0){let n={terrains:[i],compensation:-1*e.compensation},r=e.terrains[0];s=this._calculatePropositionValue(r,t,n,o)}else s={critere:2};return s.critere>3?c.accept(this):c.reject(this)}evalueCompensation(e,t,i,s){let o=this.comportement.getBudget(this,null!=i&&i>2),n=Math.min(o,t.achat);if(null!=s&&s.proposition.compensation>=n){n=Math.min(this.montant,s.proposition.compensation*this.comportement.getFactorForProposition());let e=(14-Math.log(t.achat))*t.achat;n=Math.min(n,e)}return Math.round(Math.max(0,n))}isDangerous(e){let t=this.argent/e.maisons[0].prixMaison/e.fiches.length,i=e.maisons[0].loyers[t]/this.threasholdMontant,s=this.maisons.findConstructiblesGroupes(),o=!1;for(let t in s)s[t].isVoisin(e)&&(o=!0);return(t+i)*(o?2:1)>=5}chooseMonnaiesEchange(e,t,i,s,o){if(void 0===t||0===t.length)return[];let n=[],r=0;for(let s in t)e.joueurPossede.isDangerous(t[s].groupe)&&i||(0===r||Math.abs(1-e.achat/r)/Math.abs(1-e.achat(r+t[s].achat))>1)&&(n.push(t[s]),r+=t[s].achat);return 0!==n.length||s||!i&&null==o?n:this.chooseMonnaiesEchange(e,t,joueur,!1,s)}initEnchere(e,t){if(this.equals(t.joueurPossede))return;if(null!=this.currentEchange)throw"Impossible de gerer une nouvelle enchere";let i=this.strategie.interetGlobal(t,this,!0),s=this.comportement.getMaxBudgetForStrategie(this,i.interet);this.currentEnchere={transaction:e,terrain:t,budgetMax:s,joueurInteresse:i.joueur}}updateInfoEnchere(e,t){}updateEnchere(e,t,i,s){if(e!==this.currentEnchere.transaction)return;if(this.equals(s))return;let o=Ve*(Math.random()+1);setTimeout((()=>{if(void 0!==this.currentEnchere)if(i>this.currentEnchere.budgetMax||null!=this.currentEnchere.joueurInteresse&&!this.currentEnchere.joueurInteresse.equals(s))u.exitEnchere(this);else try{u.doEnchere(this,i,t)}catch(e){}}),o)}notifyExitEnchere(e){}endEnchere(){this.currentEnchere=null,u.checkEndNotify(this)}doBlocage(){return ce.forEach((function(e){if(!this.equals(this)){let t=e.maisons.findConstructiblesGroupes();if(t.size()>0){let i=0,s=0;for(let e in t){let o=t[e];for(let e in o.proprietes){let t=o.proprietes[e];i+=5-t.nbMaison,s+=(5-t.nbMaison)*t.prixMaison}}if(i>3&&s/i*3<e.montant)return!0}}}),this),!1}_buildSortScore(e){switch(e.type){case"gare":return-1;case"compagnie":return-2;default:return e.isTerrain()?e.groupe.getInfos(this).joueur:0}}propertiesSortByDescImportance(){return this.maisons.maisons.filter((e=>!1===e.statutHypotheque&&!e.isGroupedAndBuild())).sort(((e,t)=>this._buildSortScore(e)-this._buildSortScore(t)))}resolveProblemeArgent(t,i){e.debug({message:"Resoud probleme argent"});let s=this.propertiesSortByDescImportance();e.debug({message:"PHASE 1"});for(let e=0;e<s.length&&this.montant<t;e++)s[e].hypotheque();if(this.montant<t){e.debug({message:"PHASE 2"});let i=this.getGroupsToConstruct("ASC",.1);for(let s in i){let o=i[s].proprietes;o.sort(((e,t)=>e.nbMaison===t.nbMaison?0:e.nbMaison<t.nbMaison?1:-1));let n=0,r=0,a=0,u=0;for(;this.montant<t&&r<o.length&&a++<100;){let e=o[n];0===e.nbMaison?r++:e.sellMaison(this)&&(u++,this.gagner(e.prixMaison/2,!0)),n=(n+1)%o.length}if(this.montant>t){u>0&&e.send("monopoly.vendMaison",{joueur:this,nbMaison:u}),e.refresh();break}}}if(this.montant<t){let e=this.maisons.maisons.filter((e=>!1===e.statutHypotheque));e.sort(((e,t)=>e.achat-t.achat));for(let i=0;i<e.length&&this.montant<t;i++)e[i].hypotheque()}return this.setArgent(this.montant-t),this.bloque=!1,i(),!0}getNbGroupConstructibles(){return this.maisons.maisons.filter((e=>e.isGrouped())).reduce(((e,t)=>(e.add(t.groupe.nom),e)),new Set).size}getGroupsToConstruct(e,t){let i=this.maisons.findConstructiblesGroupes();if(0===i.size())return[];let s=this.comportement.getNextProprietesVisitees(this,t);for(let e in i){let t=i[e];t.proba=0,t.rentabilite=0,t.lessThree=0,t.interetGlobal=0;for(let e in t.proprietes){let i=t.proprietes[e];null!=s[i.id]&&(t.proba+=3*s[i.id].proba),t.rentabilite+=i.getRentabilite(),t.lessThree+=i.nbMaison<=3?.5:0}}let o=[];for(let e in i){let t=i[e];t.interetGlobal=t.proba+t.rentabilite+(t.lessThree>0?.5:0),o.push(t)}let n="ASC"===e?1:-1,r="ASC"===e?-1:1;return o.sort(((e,t)=>e.interetGlobal===t.interetGlobal?0:e.interetGlobal>t.interetGlobal?n:r)),o}hasConstructedGroups(e=0){let t=this.maisons.findConstructiblesGroupes();for(let i in t)if(t[i].group.getAverageConstructions()>e)return!0;return!1}rebuyHypotheque(){let e=this.maisons.findMaisonsHypothequees();if(void 0===e||0===e.length&&this.getNbGroupConstructibles()>0&&!this.hasConstructedGroups(3))return;let t=0;for(;t<e.length&&this.montant>7*e[t].achatHypotheque;)e[t++].leveHypotheque()}minimumPriceHouse(){return 0===this.maisons.maisons.length?0:this.maisons.maisons.reduce(((e,t)=>e.prixMaison<t.prixMaison?e:t),Number.MAX_SAFE_INTEGER).prixMaison}buildConstructions(){if(0===this.maisons.maisons.length)return;let t=this.comportement.getBudget(this);if(t<this.minimumPriceHouse())return;let i=this.getGroupsToConstruct("DESC",.1);if(0===i.length)return;for(let e in i)i[e].proprietes.sort((function(e,t){return e.nbMaison===t.nbMaison?e.achat===t.achat?0:e.achat<t.achat?1:-1:e.nbMaison>t.nbMaison?1:-1}));let s=!1,o=0,n=0,r=3,a={maison:0,hotel:0,terrains:[]};for(;t>=5e3&&!s;){let e=i[n],u=e.proprietes[o];if(u.nbMaison>=r)if(void 0===e.treat?e.treat=1:e.treat++,e.treat===e.proprietes.length){if(n++,o=0,n>=i.length)if(3===r){r=5;for(let e in i)i[e].treat=0;n=0}else s=!0}else o=(o+1)%e.proprietes.length;else try{u.buyMaison(this,!0),t-=u.prixMaison,this.payer(u.prixMaison),4===u.nbMaison?a.hotel++:a.maison++,a.terrains[e.proprietes[o].id]=e.proprietes[o],o=(o+1)%e.proprietes.length}catch(e){s=!0}}e.send("monopoly.acheteConstructions",{joueur:this,achats:a}),e.refresh()}changeStrategie(){if(this.strategie.getStatsProprietes().color.pourcent<40&&this.countInterestProperties()<=2&&!this.isFamilyFree()){e.debug({message:this.nom+" cherche une nouvelle strategie"});for(let t in ie.getAll()){let i=ie.create(t);if(i.name!==this.strategie.name&&i.getStatsProprietes().color.pourcent>50)return e.debug({message:this.nom+" change de stratégie : "+this.strategie.name+" => "+i.name}),void(this.strategie=i)}}}countInterestProperties(){return this.maisons.maisons.filter((e=>this.strategie.groups.contains(e.color))).length}isFamilyFree(){let e=[];for(let t in this.maisons.maisons){let i=this.maisons.maisons[t];if(!e[i.groupe.nom]){e[i.groupe.nom]=!0;let t=!0;for(let e in i.groupe.fiches){let s=i.groupe.fiches[e];0===s.statut||this.equals(s.joueurPossede)||(t=!1)}if(t)return!0}}return!1}actionAvantDesPrison(e){setTimeout((()=>{this.getOutPrison()?null!=e["Utiliser carte"]?e["Utiliser carte"]():e.Payer():e.Attendre()}),Ve)}getOutPrison(){let e=this.comportement.getLoyerMoyen(this),t=this.maisons.getGroupesPossibles();return!(this.maisons.findConstructiblesGroupes().size()>=2)&&(t.length>0&&e.montant<.3*this.montant||!(e.nb>=4&&e.montant>.15*this.montant))}gererAchat(e){e.click()}}class le extends he{constructor(e,t,i,s,o){super(e,t,i,s,o)}moveTo(e){let t=this.pion.deplaceValeursDes(e);X.moveTo(O.buildId(t),this),this.joueSurCase(t)}notifyDices(e,t){X.dices(e,t,this)}notifySelect(){X.notifySelect(this)}notifyAcheteMaison(e,t){X.notifyAcheteMaison(e,t,this)}gagner(e){this.setArgent(this.montant+e),X.gagner(e,this)}notifyPay(e){X.payer(e,this)}}let ce={colorsJoueurs:["#383C89","#A6193E","#C58F01","#086B3D","#B9B29B","#663300"],imgJoueurs:[],joueurs:[],joueurCourant:null,getJoueurCourant(){return this.joueurCourant},setColors(e){null!=e&&(this.colorsJoueurs=e)},setImgJoueurs(e){null!=e&&(this.imgJoueurs=e)},getNbJoueurs(){return this.joueurs.length},getNb(){return this.joueurs.reduce(((e,t)=>e+(t.defaite?0:1)),0)},createAndLoad(e,t,i,s,o){let n=e?de.getRobotPlayer():de.getCurrentPlayer();return this.create(n,t,i,s.defaite,0,o).saver.load(s)},init(){$(".panneau_joueur").empty(),this.joueurs=[],this.joueurCourant=null},lancerDes(){this.joueurCourant.lancerDes()},displayLineByGroups(){let e=O.getGroups(),t=45/e.size(),i=$('<div style="width:100%" class="count-property"></div>');for(let s in e){let o=s.replace(/ /g,"");i.append(`<span style="width:${t}vw;background-color:${e[s]}"></span> : <span class="counter-group ${o}">0</span>`)}return i},create(t,i,s,o,n,r){let a=`joueur${i}`,u=this.colorsJoueurs[i],h=this.imgJoueurs[i],l=new t(i,s,u,n,r);l.enPrison=!1,l.setEnableMouseFunction(de.mouseFunction);let c=$(`<div id="${a}"${o?' class="defaite" ':""}></div>`);return $(c).append(`<div class="joueur-bloc"><span class="joueur-id"><span class="joueur-name">${l.nom}</span> : <span class="compte-banque"></span> ${Qe}</span><span class="info-joueur" title="Info joueur" data-idjoueur="${i}"><img src="img/info-user2.png" style="cursor:pointer;width:24px;float:right"/></span></div>`),$(c).append(this.displayLineByGroups()),$(".panneau_joueur").append('<hr style="border:solid 2px darkgray"/>').append(c),l.setDiv($(`div[id="${a}"]`)),l.setPion(u,h,r),$(`#${a} > div.joueur-bloc`).css("backgroundImage",`linear-gradient(to right,white 50%,${u})`),e.send("monopoly.newPlayer",{joueur:l}),this.joueurs.push(l),l},getByUniqueId(e){return console.log("FIND",e,this.joueurs),this.joueurs.find((t=>null!=t.uniqueID&&t.uniqueID===e))},getById(e){return this.joueurs.find((t=>t.numero===parseInt(e)||t.playerID===e))},change(t){if(null!=this.joueurCourant&&this.joueurCourant.endTurn(),null!=t){let e=this.getById(t);if(null!=e)return e.notifySelect(),this._select(e)}if(c.running)return;let i=null;try{i=this.next(),null==i||null!=ce.getJoueurCourant()&&i.id===ce.getJoueurCourant().id||e.debug({message:`Change player to ${i.nom}`})}catch(e){return this._showVainqueur(e),null}if(null==i)return null;null!=ce.getJoueurCourant()&&i.id===ce.getJoueurCourant().id||(i.notifySelect(),C.resetDouble()),this._select(i)},getAvailableSlots(){return this.joueurs.filter((e=>e.isSlotFree()))},_showVainqueur(t){e.send("monopoly.victoire",{joueur:t});const i=this.joueurs.filter((function(e){return e.defaite}));i.sort(((e,t)=>e.tourDefaite===t.tourDefaite?t.numero-e.numero:t.tourDefaite-e.tourDefaite));let s=`Le joueur ${t.nom} a gagné en ${this._formatTempsJeu(We.heureDebut)}.<br/>`;s+=`1 - ${t.nom}<br/>`,s+=i.map(((e,t)=>`${t+2} - ${e.nom}`)).join("<br/>");let o=this._calculateScore(t);w.create(this.joueurCourant,`Fin de partie : ${o} Points`,"green",s,(()=>{}),null,!0,{Recommencer:()=>{w.close(),et()}})},_calculateScore(e){let t=e.getStats(),i=t.argent/1e4,s=e.maisons.maisons.length*this.joueurs.length/4,o=1+t.hotel/12+t.maison/32,n=(t.tour+1)*this.joueurs.length,r=1;this.joueurs.forEach((t=>{r+=t.equals(e)?0:t.pion.stats.tour}));let a=(n-r)*i*s*o;return Math.round(a)},_formatTempsJeu(e){let t=Math.round(((new Date).getTime()-e)/1e3);if(t<60)return t+" sec";const i=t%60;return t=Math.round(t/60),`${t} min et ${i} sec`},_select(e){e.canPlay?$(".action-joueur").removeAttr("disabled").removeClass("disabled"):$(".action-joueur").attr("disabled","disabled").addClass("disabled"),Ue.echangeApresVente&&O.isFreeFiches()&&$("#idEchangeTerrains").attr("disabled","disabled").addClass("disabled"),e.equals(this.joueurCourant)||($(".joueurCourant").removeClass("joueurCourant"),null!=this.joueurCourant&&null!=this.joueurCourant.pion&&this.joueurCourant.pion.pion.setSelected(!1)),this.joueurCourant=e,this.joueurCourant.pion.pion.setSelected(!0),e.select()},getWinner(){let e,t=0;for(let i in this.joueurs)!0===this.joueurs[i].defaite?t++:e=this.joueurs[i];return t===this.joueurs.length-1?e:null},next(){if(null==this.joueurCourant)return this.joueurs[0];if(this.joueurCourant.bloque)return null;let e=this.getWinner();if(null!=e)throw e;let t=this.joueurCourant;if(!C.continuePlayer()&&!C.isSpecificAction()){let e=0;for(t=this.joueurs[(t.numero+1)%this.joueurs.length];!0===t.defaite&&e++<this.joueurs.length;)t=this.joueurs[(t.numero+1)%this.joueurs.length];t.numero<this.joueurCourant.numero&&We.nbTours++}return C.isSpecificAction()?(C.doSpecificAction(),null):t},forEach(e,t){this.joueurs.forEach(e,t)}};window.gestion=ce;let de={network:!1,master:!0,setMouseFunction(e){this.mouseFunction=e},useNetwork(){this.network=!0},useLocal(){this.network=!1},setMaster(){this.master=!0},setSlave(){this.master=!1},getRobotPlayer(){return this.network?le:he},getCurrentPlayer(){return this.network?this.master?Y:Z:Q},getOtherPlayer(){return this.network?this.master?ee:K:Q}};class pe{constructor(e){this.type=e}action(e){console.error("Not implemented "+e,this.type)}}class me extends pe{constructor(e,t){super("reparation"),this.tarifHotel=e,this.tarifMaison=t}action(e){let t=e.getStats(),i=t.hotel*this.tarifHotel+t.maison*this.tarifMaison;e.payer(i,(()=>ce.change()))}}class ge extends pe{constructor(e){super("birthday"),this.montant=e}action(e){let t=ce.joueurs.filter((t=>!e.equals(t)&&!t.defaite));t.forEach(((i,s)=>{i.payerTo(this.montant,e,(()=>{s===t.length-1&&ce.change()}))}))}}class fe extends pe{constructor(e,t,i,s=!0){super("goto"),this.fiche={axe:e,pos:t},this.direct=i,this.primeDepart=s}action(e){e.joueSurCase(this.fiche,this.direct,this.primeDepart,!0)}}class ye extends pe{constructor(){super("prison"),this.joueurPossede=null}action(e){e.cartesSortiePrison.push(this),this.joueurPossede=e,ce.change()}isLibre(){return null==this.joueurPossede}}class be extends pe{constructor(e,t=!0,i=!0){super("move"),this.nb=e,this.direct=t,this.primeDepart=i}action(e){let t=e.pion.deplaceValeursDes(this.nb);e.joueSurCase(t,this.direct,this.primeDepart)}}class ve extends pe{constructor(e,t){super("taxe"),this.plateauMonopoly=t,this.montant=e}action(e){e.payerParcGratuit(this.plateauMonopoly.parcGratuit,this.montant,(()=>ce.change()))}}class we extends pe{constructor(e){super("prime"),this.montant=e}action(e){e.gagner(this.montant),ce.change()}}let Pe={prefix:"monopoly.",suffix:".save",currentSauvegardeName:null,isSauvegarde:function(){return null!=this.currentSauvegardeName},save:function(t,i){this.currentSauvegardeName=null!=t?this.getSauvegardeName(t):this.currentSauvegardeName||this.getSauvegardeName(),this.saveWithName(this.currentSauvegardeName,i),e.send("monopoly.save",{name:this.currentSauvegardeName})},saveWithName:function(e,t){let i=[];ce.joueurs.filter((e=>e.saver)).forEach((e=>i.push(e.saver.save())));let s=[],o=O.iteratorTerrains();for(;o.hasNext();)s.push(o.next().save());let n={joueurs:i,fiches:s,joueurCourant:null!=ce.getJoueurCourant()?ce.getJoueurCourant().id:"",variantes:Ue,options:t.options,nbTours:We.nbTours,plateau:t.name};this._putStorage(e,n)},load:function(t,i){this.currentSauvegardeName=t;let s=this._getStorage(t);$.extend(Ue,Ue,s.variantes),i.plateau.load(s.plateau||"data-monopoly.json",s.options,(function(){s.joueurs.forEach(((e,t)=>ce.createAndLoad(!e.canPlay,t,e.nom,e,i.plateau.infos.montantDepart))),s.fiches.forEach((e=>O.getById(e.id).load(e))),e.refresh(),We.nbTours=s.nbTours||0,i.afterCreateGame(),ce.change(s.joueurCourant)}))},delete:function(e){localStorage.removeItem(e)},_putStorage:function(e,t){localStorage[e]=JSON.stringify(t)},_getStorage:function(e){if(null==localStorage[e])throw"Aucune sauvegarde";var t=localStorage[e];return JSON.parse(t)},autoSave:function(){},findSauvegardes:function(){let e="^"+this.prefix+"(.*)"+this.suffix+"$",t=[];for(let i in localStorage){let s=new RegExp(e,"g").exec(i);null!=s&&t.push({value:i,label:s[1]})}return t},getSauvegardeName:function(e){return this.prefix+(null==e||""===e?(new Date).getTime():e)+this.suffix}};class xe{constructor(e,t,i,s,o=!0){o&&(this.name=t,this.game=i,this.plateau=e,this.playerUniqueID=s,this.startSource(),this.listenLocalEvents())}startSource(){this.source=new EventSource(`/connect?name=${name}&game=${this.game}${this.playerUniqueID?`&player=${this.playerUniqueID}`:""}`),this.source.onerror=e=>{w.create({},"Connection impossible","red","Impossible de se connecter, le numéro de partie n'existe pas",(()=>tt()),{},!0)},this.queueEvents.detectEndMove(),this.source.addEventListener("event",(e=>{this.queueEvents.add(JSON.parse(e.data))})),this.source.addEventListener("welcome",(e=>{null!=localStorage&&(localStorage.network_game=this.game),this.welcome(JSON.parse(e.data))}))}isMaster(){return!1}welcome(e){if(void 0===this.playerID){this.playerID=e.playerID;const t=`/event?game=${this.game}&playerID=${this.playerID}`;this.eventSender=new Ce(t,this.plateau,this.isMaster()),this.askJoin()}}askJoin(){let e={kind:"join",playerID:this.playerID,name:this.name};null!=this.playerUniqueID&&(e.uniqueID=this.playerUniqueID),this.eventSender.sendEvent(e)}listenLocalEvents(){e.observe("event.network",(e=>{this.debug("Receive local EVENT",e),this.eventSender.sendEvent(e)}))}create(e,t,i,s,o,n){let r={typeGame:s.quickDice?"quick":"classic"};return new Promise((a=>{let u=tt(!1,!1);u.plateau.load(s.plateau,r,(()=>{de.useNetwork(),de.setSlave();for(let r=0;r<e;r++){let e=r===t?de.getCurrentPlayer():de.getOtherPlayer();ce.create(e,r,r===t?i:s.playersName[r],!1,o,n)}this.queueEvents.end(s),u.afterCreateGame(s.playersName),a()}))}))}debug(){ze&&console.log(...arguments)}readEvent(t){let i=ce.getById(t.player);if("disconnected"!==t.kind&&"join"!==t.kind&&"connected"!==t.kind&&"end"!==t.kind&&null==i)throw`No player found for event ${t.kind}`;switch(t.kind){case"disconnected":this.debug("DISCONNECTED",t),this.disconnect(t);break;case"connected":return this.debug("CONNECTED",t),void this.connect(t,i);case"move":this.debug("MOVES",t),i.moveTo(t.nb);break;case"moveTo":this.debug("MOVES",t),i.joueSurCase(O.getById(t.to));break;case"tax":this.debug("TAX",t),i.setArgent(i.montant-t.montant);break;case"earn":this.debug("EARN",t),i.setArgent(i.montant+t.montant);break;case"hypotheque":this.debug("HYPOTHEQUE",t),O.getById(t.terrain).doHypotheque();break;case"leverHypotheque":this.debug("LEVER HYPOTHEQUE",t),O.getById(t.terrain).doLeveHypotheque();break;case"change":this.debug("CHANGE"),ce._select(i);break;case"jail":this.debug("JAIL"),i.goPrison();break;case"buyHouse":this.debug("BUY HOUSE"),O.getById(t.terrain).setNbMaison(t.nb);break;case"loyer":this.debug("LOYER"),e.send("monopoly.payerLoyer",{joueur:i,maison:O.getById(t.maison)});break;case"exit":this.debug("EXIT"),e.send("monopoly.exit",{joueur:i});break;case"message":this.debug("GOT MESSAGE",t),e.send(t.name,{joueur:i,message:t.libelle,maison:null==t.maison?null:O.getById(t.maison)});break;case"buy":this.debug("BUY",t),i.acheteMaison(O.getById(t.terrain),0);break;default:this.readMoreEvent(t,i)}this.queueEvents.end(t)}connect(e,t){Ue.quickMove=e.quickMove,e.playerID===this.playerID?(this.create(e.nb,e.posPlayer,e.name,e,e.argentDepart,e.montantDepart).then((()=>this._updatePlayers(e))),localStorage.uniqueID=e.uniqueID):null!=t&&t.setPlayer(e.name)}_updatePlayers(e){""!==e.joueurCourant&&ce.change(e.joueurCourant),e.detailJoueurs.forEach((e=>{let t=ce.getById(e.id);t.setArgent(e.montant),t.joueSurCaseNoAction(e.position),e.enPrison&&t.showPrison(),t.nbDouble=e.nbDouble,e.maisons.forEach((e=>t.showAcheteMaison(O.get(e))))}))}disconnect(e){e.playerID===this.playerID&&(this.source.close(),w.create({canPlay:!0},"Impossible to connect game","red","You can't access monopoly game, no enough place",(()=>tt())))}readMoreEvent(e,t){switch(e.kind){case"dices":C.gestionDes.setAndShowDices(e,t);break;case"prison":t.goPrison(!1);break;case"exitPrison":t.exitPrison({noTrigger:!1,paye:e.paye,carte:e.carte,notify:!1})}}queueEvents={parent:this,queue:[],add(e){1===this.queue.push(e)&&this.launch()},launch(){if(0===this.queue.length)return;let e=this.queue[0];this.parent.readEvent(e)},end(e,t){0===this.queue.length||e.kind!==this.queue[0].kind||"moveTo"===e.kind&&!0!==t||(this.queue.shift(),this.launch())},detectEndMove(){e.observe("move.end",(()=>this.end({kind:"moveTo"},!0)))}}}class je extends xe{constructor(e,t,i){super(i,e,t)}create(t,i,s,o,n,r){de.useNetwork(),de.setMaster();let a=t-i-1;for(let e=0;e<t;e++){let t,i=`Joueur ${e+1}`;0===e?(t=de.getCurrentPlayer(),""!==s&&(i=s)):(e<o.length&&void 0!==o[e]&&(i=o[e]),e<a+1&&(t=de.getOtherPlayer()),e>a&&(t=de.getRobotPlayer())),o[e]=i,ce.create(t,e,i,!1,n,r)}return a>0&&e.send("monopoly.waitingPlayers",{nb:a,idGame:this.game}),o}readMoreEvent(e,t){switch(e.kind){case"launchDices":S.throw(3).then((e=>{C.gestionDes.setDices(e[0],e[1],e[2]),C.gestionDes._drawCubes(e[0],e[1],e[2]),C.gestionDes.after()}));break;case"join":this.joinGame(e);break;case"end":ce.change();break;default:super.readMoreEvent(e,t)}}askJoin(){}rejoinGame(e){let t=ce.getByUniqueId(e.uniqueID);null==t&&console.log("Error non player"),t.playerID=e.playerID,v.write(t,"is rejoining the game"),console.log("DATA",this.createGameInformations(t,e)),this.eventSender.sendEvent(this.createGameInformations(t,e))}joinGame(t){if(null!=t.uniqueID)return this.rejoinGame(t);let i=ce.getAvailableSlots();if(0===i.length)return console.log("No more free spaces"),this.eventSender.sendEvent({kind:"disconnected",playerID:t.playerID});let s=i[0];s.setPlayer(t.name),s.playerID=t.playerID,s.uniqueID=`id_${btoa(1e8*Math.random())}`,v.write(s,"is joining the game"),this.createGameInformations(s,t),this.eventSender.sendEvent(this.createGameInformations(s,t)),1===i.length&&(ce.change(),e.send("monopoly.start"))}createGameInformations(e,t){return{kind:"connected",player:e.id,name:e.nom,posPlayer:e.numero,playerID:t.playerID,uniqueID:e.uniqueID,playersName:this.plateau.infos.realNames,plateau:this.plateau.name,quickMove:Ue.quickMove,argentDepart:this.plateau.infos.argentJoueurDepart,montantDepart:this.plateau.infos.montantDepart,quickDice:this.plateau.isQuickDice(),nb:ce.getNbJoueurs(),joueurCourant:null!=ce.getJoueurCourant()?ce.getJoueurCourant().id:"",detailJoueurs:this.getPlayersInformations()}}getPlayersInformations(){return ce.joueurs.map((e=>({id:e.id,montant:e.montant,enPrison:e.enPrison,nbDouble:e.nbDouble,defaite:e.defaite,position:e.getPosition(),maisons:e.maisons.maisons.map((e=>({hotel:e.hotel,axe:e.axe,pos:e.pos,nbMaison:e.nbMaison,statutHypotheque:e.statutHypotheque})))})))}isMaster(){return!0}sendDices(e,t){this.eventSender.sendEvent({kind:"dices",player:t,dice1:e[0],dice2:e[1],quickDice:e[2]})}}class Ce{constructor(e,t,i=!1){this.url=e,this.isMaster=i,this.plateau=t}sendEvent(e){!function(e,t){j(e,JSON.stringify(t))}(this.url,e),this.isMaster&&Pe.saveWithName("lastest",this.plateau)}}class Me extends n{constructor(e,t,i,s){super(),this.axe=0,this.pos=0,this.x=0,this.y=0,this.joueur=s,this.color=e,this.isSelected=!1,this.largeur=t,this.currentInterval=null,this.img=null,null!=i&&(this.img=new Image,this.img.src=i,this.largeur+=6),this.init(2,0)}init(e,t){let i=e+"-"+t;this.axe=e,this.pos=t,this.x=O.getById(i).drawing.getCenter().x,this.y=O.getById(i).drawing.getCenter().y}draw(e){this.joueur.defaite||(this.isSelected&&(o.drawCircle(e,this.color,(this.largeur+22)/2,{x:this.x,y:this.y},"#FF0000"),o.drawCircle(e,"#FFFFFF",(this.largeur+18)/2,{x:this.x,y:this.y},"#FF0000")),null!=this.img?o.drawImage(e,this.img,this.x-this.largeur/2,this.y-this.largeur/2,this.largeur,this.largeur,0):o.drawCircle(e,this.color,this.largeur/2,{x:this.x,y:this.y},"#FF0000"),o.drawCircle(e,"#FFFFFF",2,{x:this.x,y:this.y},"#FF0000"))}setSelected(e){this.isSelected=e}goto(e,t,i,s,o=Ue.quickMove){if(o)return this.gotoDirect(e,t,i);if(null!=this.currentInterval)return setTimeout((()=>this.goto(e,t,i,s)),500);if(s){let e=O.getById(this.axe+"-"+this.pos).drawing.getCenter();this.x=e.x,this.y=e.y}if(this.axe===e&&this.pos===t){let e=O.getById(this.axe+"-"+this.pos).drawing._decalagePion();return this.x=e.x,this.y=e.y,void(i&&i())}const n=this._toNextCase();let r="x";this.x===n.x&&(r="y");let a=Math.abs(n[r]-this[r]);const u=n[r]>this[r]?1:-1;this.currentInterval=setInterval((()=>{a>0?(this[r]+=5*u,a-=5):(this.y=n.y,this.x=n.x,clearInterval(this.currentInterval),this.currentInterval=null,this.goto(e,t,i))}),30)}gotoDirect(e,t,i){if(null==e||null==t)return;if(null!=this.currentInterval)return setTimeout((()=>this.gotoDirect(e,t,i)),500);let s=O.getById(this.axe+"-"+this.pos).drawing.getCenter(),o=O.getById(e+"-"+t).drawing.getCenter();if(s.x===o.x){let n=s.y>o.y?-1:1;this.currentInterval=setInterval((()=>{if(n<0&&this.y<=o.y||n>0&&this.y>=o.y)return this._endMove(e,t,i);this.y+=30*(n<0?-1:1)}),30)}else{let n=(s.y-o.y)/(s.x-o.x),r=o.y-n*o.x,a=s.x,u=s.x>o.x?-1:1;this.currentInterval=setInterval((()=>{if(u<0&&a<=o.x||u>0&&a>=o.x)return this.x=o.x,this.y=o.y,this._endMove(e,t,i);this.x=a,this.y=n*a+r,a+=30*(u<0?-1:1)}),30)}}_endMove(e,t,i=(()=>{})){this.axe=e,this.pos=t,clearInterval(this.currentInterval),this.currentInterval=null,i()}_toNextCase(){return this.pos++,this.pos>=r.dimensions.nbCases&&(this.axe=(this.axe+1)%4,this.pos=0),O.getById(this.axe+"-"+this.pos).drawing.getCenter()}}let $e=[{axe:0,color:(e,t,i,s,o,n,r)=>e.fillRect(t,i+r-o,s,o),title:(e,t,i,s,n,a,u)=>o.writeText(s,t+a,i+u-n,Math.PI,e,r.dimensions.textSize),prix:(e,t,i,s,n,a)=>o.writeText(s,t+a,i+n,Math.PI,e,r.dimensions.textSize),image:(e,t,i,s,n,r,a,u,h)=>o.drawImage(e,s,t+r-a,i+u-n,s.width,s.height,h),maison:(e,t,i,s,n,r,a)=>o.drawImage(e,s,t+r-15*n-3,i+a-2,15,15,-Math.PI),hotel:(e,t,i,s,n,r,a)=>o.drawImage(e,s,t+n-r,i+a,18,18,-Math.PI),possede:(e,t,i,s,n,r)=>{o.drawArcCircle(e,s,n,{x:t+r,y:i},Math.PI/2,Math.PI),o.drawArcCircle(e,s,n,{x:t,y:i},0,Math.PI/2)}},{axe:1,color:(e,t,i,s,o,n)=>e.fillRect(t,i,o,n),title:(e,t,i,s,n,a)=>o.writeText(s,t+n,i+a,-Math.PI/2,e,r.dimensions.textSize),prix:(e,t,i,s,n,a,u)=>o.writeText(s,t+u-n,i+a,-Math.PI/2,e,r.dimensions.textSize),image:(e,t,i,s,n,r,a,u,h)=>o.drawImage(e,s,t+n,i+r-a,s.width,s.height,h),maison:(e,t,i,s,n,r)=>o.drawImage(e,s,t+3,i+r-2-15*n,15,15,-Math.PI/2),hotel:(e,t,i,s,n,r)=>o.drawImage(e,s,t,i+n-r,18,18,-Math.PI/2),possede:(e,t,i,s,n,r,a)=>{o.drawArcCircle(e,s,n,{x:t+a,y:i+r},Math.PI,3*Math.PI/2),o.drawArcCircle(e,s,n,{x:t+a,y:i},Math.PI/2,Math.PI)}},{axe:2,color:(e,t,i,s,o)=>e.fillRect(t,i,s,o),title:(e,t,i,s,n)=>o.writeText(s,t,i+n,0,e,r.dimensions.textSize),prix:(e,t,i,s,n,a,u)=>o.writeText(s,t,i+u-n,0,e,r.dimensions.textSize),image:(e,t,i,s,n,r,a,u,h)=>o.drawImage(e,s,t+a,i+n,s.width,s.height,h),maison:(e,t,i,s,n)=>o.drawImage(e,s,t+3+15*n,i+2,15,15,0),hotel:(e,t,i,s,n,r)=>o.drawImage(e,s,t+r,i,18,18,0),possede:(e,t,i,s,n,r,a)=>{o.drawArcCircle(e,s,n,{x:t,y:i+a},3*Math.PI/2,0),o.drawArcCircle(e,s,n,{x:t+r,y:i+a},Math.PI,3*Math.PI/2)}},{axe:3,color:(e,t,i,s,o,n,r)=>e.fillRect(t+r-o,i,o,n),title:(e,t,i,s,n,a,u)=>o.writeText(s,t+u-n,i,Math.PI/2,e,r.dimensions.textSize),prix:(e,t,i,s,n)=>o.writeText(s,t+n,i,Math.PI/2,e,r.dimensions.textSize),image:(e,t,i,s,n,r,a,u,h)=>o.drawImage(e,s,t+u-n,i+a,s.width,s.height,h),maison:(e,t,i,s,n,r,a)=>o.drawImage(e,s,t+a-3,i+2+15*n,15,15,Math.PI/2),hotel:(e,t,i,s,n,r,a)=>o.drawImage(e,s,t+a,i+r,18,18,Math.PI/2),possede:(e,t,i,s,n,r)=>{o.drawArcCircle(e,s,n,{x:t,y:i+r},3*Math.PI/2,0),o.drawArcCircle(e,s,n,{x:t,y:i},0,Math.PI/2)}}];class De extends n{constructor(e,t,i,s,o,n){super(),this.data={},this.axe=t,this.color=i,this.title=s,this.prix=o,this.nbMaison=0,this.imgMaison=new Image,this.imgHotel=new Image,this.colorPossede=null,this.rayon=10,this.init(e,t,n)}setNbMaison(e){this.nbMaison=e}init(e,t,i){this.imgMaison.src="img/maison.png",this.imgHotel.src="img/hotel.png";let s=r.dimensions.plateauSize/2,o=r.dimensions.largeur,n=r.dimensions.hauteur,a=(r.dimensions.nbCases-1)/2,u=o*a;t%2==1?(this.data.height=o,this.data.width=n,1===t?(this.data.x=s+u,this.data.y=s+(e-a-1)*o):(this.data.x=s-u-n,this.data.y=s+(a-e)*o)):(this.data.height=n,this.data.width=o,2===t?(this.data.y=s+u,this.data.x=s+(a-e)*o):(this.data.y=s-u-n,this.data.x=s+(e-a-1)*o)),this._initImage(i)}_initImage(t){if(null!=t){let i=new Image;i.addEventListener("load",(()=>{e.refresh()})),i.src=t.src,i.height=t.height,i.width=t.width,i.margin=t.margin,this.data.image=i}}getCenter(){return{x:this.data.x+this.data.width/2,y:this.data.y+this.data.height/2}}draw(e){const t=r.dimensions.bordure/2,i=r.dimensions.largeur,s=r.dimensions.hauteur;e.strokeStyle="#000000",e.strokeRect(this.data.x,this.data.y,this.data.width,this.data.height);let o=$e[this.axe];if(null!=this.color&&(e.fillStyle=this.color,o.color(e,this.data.x,this.data.y,this.data.width,t,i,s)),null!=this.title){let n=12+(null!=this.color?t:0);o.title(e,this.data.x,this.data.y,this.title,n,i,s)}if(null!=this.prix&&o.prix(e,this.data.x,this.data.y,this.prix,5,i,s),null!=this.data.image){var n=Math.PI/2*((this.axe+2)%4),a=(i-this.data.image.width)/2;let r=10+(null!=this.color?t:10)+(null!=this.title?10:0)+(this.data.image.margin||0);o.image(e,this.data.x,this.data.y,this.data.image,r,i,a,s,n)}if(this.nbMaison<=4){e.fillStyle="#00FF00";for(var u=0;u<this.nbMaison;u++)o.maison(e,this.data.x,this.data.y,this.imgMaison,u,i,s)}else{let t=(i-18)/2;o.hotel(e,this.data.x,this.data.y,this.imgHotel,i,t,s)}null!=this.colorPossede&&o.possede(e,this.data.x,this.data.y,this.colorPossede,this.rayon,i,s)}setJoueur(e){this.colorPossede=null,null!=e&&(this.colorPossede=e.color)}getNbJoueurs(){var e=0;return ce.forEach((function(t){e+=t.pion.axe===this.axe&&t.pion.position===this.pos?1:0}),this),e}_decalagePion(){const e=r.dimensions.bordure/2,t=20+(null!=this.color?e:0)+r.dimensions.largeurPion/2,i=this.getCenter();i.x+=5;let s=r.dimensions.largeurPion,o=(this.data.height-t)/3,n=this.getNbJoueurs();return this.axe%2==0?{x:i.x+(n%3-1)*o,y:n<3?i.y-s:i.y+s}:{x:n<3?i.x-s:i.x+s,y:i.y+(n%3-1)*o}}}class Se extends De{constructor(e,t){super(0,e,null,t,null,null),this.data={},this.init()}init(){let e=r.dimensions.largeur,t=r.dimensions.hauteur,i=r.dimensions.plateauSize/2,s=(r.dimensions.nbCases-1)/2,o=e*s;this.axe%2==1?1===this.axe?(this.data.x=i+o,this.data.y=i+-s*e-t):(this.data.x=i-o-t,this.data.y=i+s*e):2===this.axe?(this.data.y=i+o,this.data.x=i+s*e):(this.data.y=i-o-t,this.data.x=i-s*e-t),this.data.height=this.data.width=t}draw(e){e.strokeStyle="#000000",e.strokeRect(this.data.x,this.data.y,this.data.width,this.data.height),o.writeText(this.title,this.data.x,this.data.y+r.dimensions.hauteur/2,0,e,9,this.data.width)}}function Ie(e){let t=new Image;return t.src=e,t}class Ee{constructor(e,t,i){this.value=0,this.coin=15,this.width=i,this.compute=i-2*this.coin,this.x=e,this.y=t}setValue(e,t="#000000"){this.value=e,this.color=t}draw2or3(e){Ee.drawPoint(e,this.x+.25*this.width,this.y+.75*this.width,this.width/5,this.color),Ee.drawPoint(e,this.x+.75*this.width,this.y+.25*this.width,this.width/5,this.color)}_drawMiddle(e){Ee.drawPoint(e,this.x+this.width/2,this.y+this.width/2,this.width/5,this.color)}draw(e){this._drawCadre(e),void 0!==this.value&&(this.value%2==1&&this._drawMiddle(e),1!==this.value&&this.draw2or3(e),this.value>=4&&this._drawBig(e,{c1:.75,c2:.25}),6===this.value&&this._drawBig(e,{c1:.5,c2:.5}))}_drawBig(e,t){Ee.drawPoint(e,this.x+.75*this.width,this.y+this.width*t.c1,this.width/5,this.color),Ee.drawPoint(e,this.x+.25*this.width,this.y+this.width*t.c2,this.width/5,this.color)}_drawCadre(e){e.strokeStyle="#000000",e.fillStyle="#000000",e.beginPath(),e.moveTo(this.x+this.coin,this.y),e.lineTo(this.x+this.coin+this.compute,this.y),e.bezierCurveTo(this.x+2*this.coin+this.compute,this.y,this.x+2*this.coin+this.compute,this.y+this.coin,this.x+2*this.coin+this.compute,this.y+this.coin),e.lineTo(this.x+2*this.coin+this.compute,this.y+this.coin+this.compute),e.bezierCurveTo(this.x+2*this.coin+this.compute,this.y+2*this.coin+this.compute,this.x+this.compute+this.coin,this.y+2*this.coin+this.compute,this.x+this.compute+this.coin,this.y+2*this.coin+this.compute),e.lineTo(this.x+this.coin,this.y+2*this.coin+this.compute),e.bezierCurveTo(this.x,this.y+2*this.coin+this.compute,this.x,this.y+this.coin+this.compute,this.x,this.y+this.coin+this.compute),e.lineTo(this.x,this.y+this.coin),e.bezierCurveTo(this.x,this.y,this.x+this.coin,this.y,this.x+this.coin,this.y),e.stroke(),e.closePath()}static drawPoint(e,t,i,s,o="#000000"){e.strokeStyle=o,e.fillStyle=o,e.beginPath(),e.arc(t,i,s/2,0,2*Math.PI),e.fill(),e.closePath()}}class Te extends Ee{constructor(e,t,i){super(e,t,i),this.imgBus=Ie("img/bus.png"),this.imgMr=Ie("img/mr_monopoly.png"),this.margin=.1*i}draw(e){if(this._drawCadre(e),void 0!==this.value&&(1!==this.value&&3!==this.value||this._drawMiddle(e),2!==this.value&&3!==this.value||this.draw2or3(e),this.value>=4)){let t=5===this.value?this.imgBus:this.imgMr;o.drawImage(e,t,this.x+this.margin,this.y+this.margin,this.width-this.margin,this.width-this.margin,0)}}}class qe extends n{constructor(e,t,i,s,o){super(),this.canvas=null,this.data={x:e,y:t,width:i,height:s,color:o}}draw(e){this.canvas=e,e.fillStyle=this.data.color,e.fillRect(this.data.x,this.data.y,this.data.width,this.data.height)}enableCaseDetect(e){let t=this;$("canvas").unbind("mousedown").bind("mousedown",(function(i){let s=$(this).offset(),o=t._findFiche(i.clientX-s.left,i.clientY-s.top);null!=o&&(t.disableCaseDetect(),e(o))}))}disableCaseDetect(){$("canvas").unbind("mousedown")}_findFiche(e,t){let i=null;return O.fiches.forEach((function(s){let o=s.drawing.data;e>=o.x&&e<=o.x+o.width&&t>=o.y&&t<=o.y+o.height&&(i=s)})),i}}$((function(){!function(){const e={type:"square",standardCase:De,specialCase:Se,pionJoueur:Me,des:Ee,desRapide:Te,plateau:qe,endPlateau:null};r.addInstance(e),r.type=e.type}()}));let _e=2*Math.PI/40,ke=0;function Ae(e,t){return{y:Math.sin(e)*t,x:Math.cos(e)*t}}function Fe(e,t){return(e+2)%4*10+t}class He extends n{constructor(e,t,i){super(),this.color=e,this.isSelected=!1,this.largeur=t/2,this.img=null,null!=i&&(this.img=new Image,this.img.src=i,this.largeur+=10),this.init(2,0)}init(e,t){let i=r.dimensions.plateauSize/2;this.pos=Fe(e,t),this._rayon=i-(70+ke%3*25),this._angle=.5+.25*(ke%2?1:-1),ke++}draw(e){let t=r.dimensions.plateauSize/2,i=Ae((this.pos+this._angle)*_e,this._rayon);this.isSelected&&o.drawCircle(e,"#FFFFFF",(this.largeur+2)/2,{x:i.x+t,y:i.y+t},"#FF0000"),null!=this.img?o.drawImage(e,this.img,i.x+t-this.largeur/2,i.y+t-this.largeur/2,this.largeur,this.largeur,0):o.drawCircle(e,this.color,this.largeur,{x:i.x+t,y:i.y+t},"#FF0000")}setSelected(e){this.isSelected=e}_moveTo(e,t,i){this.pos!==e?setTimeout((()=>{this.pos=parseFloat((this.pos+i).toFixed(1)),this.pos>=40&&(this.pos=0),this._moveTo(e,t,i)}),30):t()}goto(e,t,i){if(Ue.quickMove)return this.gotoDirect(e,t,i);let s=Fe(e,t);this._moveTo(s,i,.1)}gotoDirect(e,t,i){if(null==e||null==t)return;let s=Fe(e,t);this._moveTo(s,i,1)}}class Je extends n{constructor(e,t,i,s,o,n){super(),this.pos=Fe(t,e),this.color=i,this.title=s,this.prix=o,this.img=n,this.nbMaison=0,this.data={},this.imageMaison=new Image,this.imageHotel=new Image,this.joueurPossede=null,this.init()}setJoueur(e){this.joueurPossede=e}setNbMaison(e){this.nbMaison=e}init(){if(this.imageMaison.src="img/maison.png",this.imageHotel.src="img/hotel.png",null!=this.img){this.img=$.extend(!0,{},r.infos.defaultImage||{},this.img);let t=new Image;t.addEventListener("load",(()=>{e.refresh()})),t.src=this.img.src,t.height=Math.min(this.img.height,30),t.width=Math.min(this.img.width,40),t.margin=this.img.marginTop||0,t.marginLeft=this.img.marginLeft||0,t.rotate=this.img.rotate||0,this.pos>10&&this.pos<30&&(t.rotate=(t.rotate+180)%360,t.marginLeft=t.marginLeft+.5,t.margin=Math.max(0,t.margin-20)),this.data.image=t}}_drawColorGroup(e,t){let i=r.getInfo("backgroundColor");null!=this.color&&(e.beginPath(),e.fillStyle=this.color,e.moveTo(t.centre,t.centre),e.arc(t.centre,t.centre,t.centre,this.pos*_e,(this.pos+1)*_e),e.fill(),e.closePath(),e.beginPath(),e.fillStyle=i,e.moveTo(t.centre,t.centre),e.arc(t.centre,t.centre,t.centre-t.bordure,this.pos*_e,(this.pos+1)*_e),e.fill(),e.closePath())}_drawPossede(e,t){null!=this.joueurPossede&&(e.beginPath(),e.strokeStyle=this.joueurPossede.color,e.lineWidth=10,e.arc(t.centre,t.centre,t.centre-r.dimensions.innerPlateauSize+15,this.pos*_e,(this.pos+1)*_e),e.stroke(),e.closePath())}_writeText(e,t,i,s){o.writeText(t,i.p.x+i.centre,i.p.y+i.centre,s*_e,e,9,i.length,i.align)}_drawTitle(e,t){null!=this.title&&(this.pos>10&&this.pos<30?(t.p=Ae((this.pos+.7)*_e,t.centre-t.bordure-5),t.align="left",this._writeText(e,this.title,t,(this.pos+20)%40+.8)):(t.length=Math.min(t.length,e.measureText(this.title).width+30),t.p=Ae((this.pos+.3)*_e,t.centre-t.length-t.bordure-5),t.align="right",this._writeText(e,this.title,t,this.pos+.2)))}_drawPrice(e,t){null!=this.prix&&(this.pos>10&&this.pos<30?(t.p=Ae((this.pos+.15)*_e,t.centre-t.bordure-5),t.align="left",this._writeText(e,this.prix,t,(this.pos+20)%40+.5)):(t.length=Math.min(t.length,e.measureText(this.prix).width+30),t.p=Ae((this.pos+.9)*_e,t.centre-t.length-t.bordure-5),t.align="right",this._writeText(e,this.prix,t,this.pos+.7)))}_drawHouses(e,t){if(this.nbMaison<=4)for(let i=0;i<this.nbMaison;i++){let s=Ae((this.pos+.25*i)*_e,t.centre-4);o.drawImage(e,this.imageMaison,t.centre+s.x,t.centre+s.y,16,16,this.pos*_e+Math.PI/2)}else{let i=Ae((this.pos+.4)*_e,t.centre-4);o.drawImage(e,this.imageHotel,t.centre+i.x,t.centre+i.y,16,16,this.pos*_e+Math.PI/2)}}_drawImage(e,t){if(null!=this.data.image){let i=Ae((this.pos+this.data.image.marginLeft)*_e,t.centre-t.bordure-5-this.data.image.margin),s=o.fromDegresToRad(this.data.image.rotate)+this.pos*_e+Math.PI/2;o.drawImage(e,this.data.image,t.centre+i.x,t.centre+i.y,this.data.image.width,this.data.image.height,s)}}draw(e){let t=r.dimensions.plateauSize/2,i=r.dimensions.bordure/2,s=Ae(this.pos*_e,t),o=Ae(this.pos*_e,t-r.dimensions.innerPlateauSize);e.fillStyle="#FFFFFF",e.lineWidth=.5,e.moveTo(t-s.x,t-s.y),e.lineTo(t-o.x,t-o.y),e.stroke();let n={centre:t,bordure:i,length:140};this._drawColorGroup(e,n),this._drawTitle(e,n),this._drawPrice(e,n),this._drawImage(e,n),this._drawHouses(e,n),this._drawPossede(e,n)}}class Ge extends n{constructor(e,t){super(),this.pos=Fe(e,0),this.title=t}draw(e){let t=r.dimensions.plateauSize/2,i=Ae(this.pos*_e,t),s=Ae(this.pos*_e,t-r.dimensions.innerPlateauSize),n=r.getInfo("backgroundColor");if(e.fillStyle=n,e.lineWidth=.5,e.moveTo(t-i.x,t-i.y),e.lineTo(t-s.x,t-s.y),e.stroke(),o.drawArcCircle(e,n,t,{x:t,y:t},this.pos*_e,(this.pos+1)*_e),null!=this.title)if(this.pos>10&&this.pos<30){let i=Ae((this.pos+.5)*_e,t-15);o.writeText(this.title,i.x+t,i.y+t,((this.pos+20)%40+.6)*_e,e,9,120,"left")}else{let i=Ae((this.pos+.6)*_e,t-120-15);o.writeText(this.title,i.x+t,i.y+t,(this.pos+.2)*_e,e,9,120,"right")}}}class Re extends Ee{constructor(e,t,i){super(e+195,t+100,i)}}class Le extends Te{constructor(e,t,i){super(e+190,t+100,i)}}class Ne extends n{constructor(e,t,i,s,o){super(),this.data={x:e,y:t,width:i,height:s,color:o}}draw(e){o.drawCircle(e,this.data.color,this.data.width/2,{x:this.data.width/2,y:this.data.width/2})}}class Be extends n{constructor(){super()}draw(e){let t=r.dimensions.plateauSize/2,i=r.dimensions.innerPlateauSize;o.drawCircle(e,"#000000",t-i,{x:t,y:t}),o.drawCircle(e,"#FFFFFF",t-i-2,{x:t,y:t}),o.drawArcCircle(e,"#FF0000",t-i-2,{x:t,y:t},-Math.PI,0),o.drawCircle(e,"#FFFFFF",t-i-50,{x:t,y:t})}}$((function(){!function(){let e={type:"circle",standardCase:Je,specialCase:Ge,pionJoueur:He,des:Re,desRapide:Le,plateau:Ne,endPlateau:Be};r.addInstance(e)}()}));let Oe,ze=!1,Ve=100,Ue={caseDepart:!1,parcGratuit:!1,enchereAchat:!1,echangeApresVente:!1,desRapide:!1,tourAchat:!1,quickMove:!1},We={nbTours:0,heureDebut:new Date,positions:[]},Qe="F.";class Ye{constructor(e,t,i,s,o){this.title=i,this.libelle=e,this.color=s,this.triggerLabel=o,this.actionCarte=t}action(){return w.create(ce.getJoueurCourant(),this.title,this.color,this.libelle,(()=>{let t=`monopoly.${this.triggerLabel}.message`;e.network({kind:"message",player:ce.getJoueurCourant().id,libelle:this.libelle,name:t}),e.send(t,{joueur:ce.getJoueurCourant(),message:this.libelle}),this.actionCarte.action(ce.getJoueurCourant())}),{})}}class Xe extends Ye{constructor(e,t,i){super(e,t,i,"lightblue","chance")}}class Ze extends Ye{constructor(e,t,i){super(e,t,i,"pink","caissecommunaute")}}function Ke(t=ce.getJoueurCourant()){let i=O.getById(t.pion.axe+"-"+t.pion.position);if(null==i)return ce.change();let s=i.action();t.actionApresDes(s,i),e.send("move.end")}function et(){if(null==Oe)return;let e=Oe.options;Oe=new ot(!1),Oe.init(),new st(Oe).restartGame(e)}function tt(e=!1,t=!0){Oe=new ot(e),Oe.init();let i=new st(Oe);return t&&i.show(),Oe}class it{constructor(){this.infos=null,this.titles={},this.name=null,this.parcGratuit=null,this.cartes={caisseCommunaute:[],chance:[]},this.drawing=null}load(e,t,i,s){return t.nomPlateau=e,this.loadFullPath(`data/${e}`,t,i,s)}loadFullPath(e,t,i,s){this._temp_load_data=s,x(e).then((e=>this.managePlateauConfig(e,t,i))).catch((t=>alert(`Le plateau ${e} n'existe pas`)))}managePlateauConfig(e,t,i){if(null==e.plateau)throw"Erreur avec le plateau "+t.nomPlateau;this.name=t.nomPlateau;let s=$.extend(!0,{},e,this._temp_load_data||{});null!=e.extend?this.load(e.extend,t,i,s):this._build(s,t,i)}loadVariantes(){Array.from(document.querySelectorAll("#idVariantes input[type=checkbox][name]")).filter((e=>null==Ue[e.name])).forEach((e=>Ue[e.name]=e.checked))}_build(e,t,i=(()=>{})){this.infos=e.plateau,this.options=t,this.loadVariantes(),r.setNbCases(this.infos.nbCases),r.addInfo("defaultImage",e.images.default||{}),r.addInfo("textColor",this.infos.textColor||"#000000"),r.addInfo("backgroundColor",this.infos.backgroundColor||"#FFFFFF"),this.infos.argentJoueurDepart=this.infos.argent||15e4,this.infos.montantDepart=this.infos.depart||2e4,this.infos.montantPrison=this.infos.prison||5e3,!0===this.infos.hideConstructions?$(".action-normal").hide():$(".action-normal").show(),ce.setColors(this.infos.colors),ce.setImgJoueurs(this.infos.imgJoueurs),"circle"===this.infos.type?this._configureCircle():this.configureSquare(),Qe=e.currency,this.titles=e.titles||{},this.infos.nomsJoueurs=this.infos.nomsJoueurs||[],C.gestionDes=this.isQuickDice()?new E(this.infos.montantPrison,this.parcGratuit):new I(this.infos.montantPrison,this.parcGratuit),C.init(this.infos.rollColor);let s=r.dimensions.plateauSize;this._createPlateauActions(),this.drawing=r.getPlateau(0,0,s,s,this.infos.backgroundColor),a.add(this.drawing,0),this._draw(e),a.add(r.endPlateau(),2),a.init(s,s),u.setPasVente(this.infos.montantDepart/10),i()}_createPlateauActions(){document.querySelector("#idLancerDes").onclick=()=>ce.lancerDes(),document.querySelector("#idOpenPanelHouses").onclick=()=>V.open(),document.querySelector("#idEchangeTerrains").onclick=()=>l.open(ce.getJoueurCourant()),document.querySelector("#idOpenFreeTerrains").onclick=()=>$("#idTerrainsLibres").dialog("open")}isQuickDice(){return"quick"===this.options.typeGame}_configureCircle(){r.setType("circle"),$(".graphic_element,.title").addClass("circle"),$("#idSavePanel").arctext({radius:80,dir:1}),$("#idSubTitle").hide(),$("#idInfoBox").unbind("mousewheel").bind("mousewheel",(function(e,t){let i=$("#idInfoBox").scrollTop()+t*e.deltaFactor*-.7;$("#idInfoBox").scrollTop(i),e.preventDefault()}))}configureSquare(){r.setType("square"),$("#idSavePanel").arctext({radius:-1,dir:1}),$(".graphic_element,.title").removeClass("circle")}_buildCartes(e,t,i){return null!=e?e.cartes.map((e=>new t(e.nom,function(e,t){switch(e.type){case"taxe":return new ve(e.montant,t);case"prime":return new we(e.montant);case"goto":return new fe(e.axe,e.pos,e.direct,e.primeDepart);case"move":return new be(e.nb,e.direct,e.primeDepart);case"prison":return new ye;case"birthday":return new ge(e.montant);case"repair":return new me(e.hotel,e.maison)}throw"Type inconnu"}(e,this),i))):[]}addToGroup(e,t,i,s){return e[t.colors[0]].nom=i,e[t.colors[0]].add(s),s}_createFiche(e,t,i){switch(e.type){case"propriete":return this.addToGroup(t,e,"Terrain",new R(e.axe,e.pos,e.colors,e.nom).setCostsAndDraw(e.prix,e.loyers,e.prixMaison));case"propriete-junior":return this.addToGroup(t,e,"Junior",new L(e.axe,e.pos,e.colors,e.nom).setCostsAndDraw(e.prix,[e.prix]));case"compagnie":return this.addToGroup(t,e,"Compagnie",new B(e.axe,e.pos,e.colors,e.nom).setCostsAndDraw(e.prix,e.loyers,null,i.images[e.img]||i.images.compagnie));case"gare":return this.addToGroup(t,e,"Gare",new N(e.axe,e.pos,e.colors,e.nom).setCostsAndDraw(e.prix,e.loyers,null,i.images.gare));case"chance":return new F(e.axe,e.pos,i.images.chance,this.cartes.chance,this.titles.chance);case"communaute":return new H(e.axe,e.pos,i.images.caisseDeCommunaute,this.cartes.caisseCommunaute,this.titles.communaute);case"taxe":return new A(e.nom,e.prix,e.axe,e.pos,"taxe",i.images.taxe,this);case"prison":return new _(e.nom,(()=>ce.getJoueurCourant().goPrison()),e.axe,e.pos,"prison");case"special":return new _(e.nom,(()=>ce.change()),e.axe,e.pos,"special");case"parc":return this.parcGratuit=new q(e.axe,e.pos),this.parcGratuit;case"depart":return new k(e.nom,e.axe,e.pos,this.infos.montantDepart)}throw"Impossible case"}_draw(e){$("#idSubTitle").text(this.infos.subtitle),this.parcGratuit=null;let t=[],i=[];this.cartes.chance=this._buildCartes(e.chance,Xe,this.titles.chance),this.cartes.caisseCommunaute=this._buildCartes(e.communaute,Ze,this.titles.communaute),$(e.fiches).each(((s,o)=>{null!=o.colors&&o.colors.length>0&&null==i[o.colors[0]]&&(i[o.colors[0]]=new J(o.groupe,o.colors[0]));let n=this._createFiche(o,i,e);null!=n&&(O.add(n),null!=n.color&&null==t[n.color]&&($("style","head").prepend(`.color_${n.color.substring(1)}{color:white;font-weight:bold;background-color:${n.color};}\n`),t[n.color]=1))})),this._calculateVoisins(e.plateau.nbCases)}_calculateVoisins(e=10){let t=null,i=4*e;for(let s=0;s<i+2;s++){let o=Math.floor(s/e)%4,n=s%i-o*e,r=O.get({axe:o,pos:n});null!=r&&null!=r.groupe&&r.isTerrain()&&(null==t&&(t=r.groupe),t.equals(r.groupe)||(r.groupe.groupePrecedent=t,t.groupeSuivant=r.groupe,t=r.groupe))}}enableMouse(e){this.drawing.enableCaseDetect(e)}}class st{constructor(e){this.monopoly=e,this.panelPartie=$("#idPanelCreatePartie")}show(){this.initSlider("sliderJoueur",2,4),this.initSlider("sliderRobot",0,2),this.loadPlateaux(),this.loadSavedGames(),f(this.panelPartie,{title:"Monopoly",closeOnEscape:!1,modal:!0,width:400,position:{my:"center top",at:"center top",of:window},buttons:[{text:"Valider",click:()=>this.createGame()}]})}close(){this.panelPartie.dialog("close")}loadPlateaux(){this.plateaux=$("#idSelectPlateau").empty(),x("data/plateaux.json").then((e=>{null!=e&&null!=e.plateaux&&e.plateaux.forEach((e=>this.plateaux.append(`<option value="${e.url}">${e.name}</option>`)))}))}loadSavedGames(){let e=Pe.findSauvegardes();this.listSauvegarde=$("#idSauvegardes"),$("option:not(:first)",this.listSauvegarde).remove(),e.length>0&&(e.forEach((e=>this.listSauvegarde.append(`<option value="${e.value}">${e.label}</option>`))),$("#idDeleteSauvegarde").unbind("click").bind("click",(()=>{$("option:selected",this.listSauvegarde).length>0&&confirm(`Etes vous sur de vouloir supprimer cette sauvegarde : ${this.listSauvegarde.val()}`)&&(Pe.delete(this.listSauvegarde.val()),$("option:selected",this.listSauvegarde).remove())})),$("#idLoadSauvegarde").unbind("click").bind("click",(()=>{""!==this.listSauvegarde.val()&&(Pe.load(this.listSauvegarde.val(),this.monopoly),this.close())})))}initSlider(e,t,i){$(`#${e}`).slider({min:t,max:6,value:i,create:function(){this.handle=$(".ui-slider-handle",this),this.handle.text($(this).slider("value"))},slide:function(e,t){this.handle.text(t.value)}})}extractOptions(){let e={nbRobots:$("#sliderRobot").slider("value"),nbPlayers:$("#sliderJoueur").slider("value"),waitTimeIA:1};return $("#idPartie",this.panelPartie).find("select[name],:text[name]").each((function(){e[$(this).attr("name")]=$(this).val()})),$("#idPartie",this.panelPartie).find(":checkbox[name]").each((function(){e[$(this).attr("name")]=$(this).is(":checked")})),$("#idGameType",this.panelPartie).find(":radio:checked").each((function(){e[$(this).attr("name")]=$(this).val()})),e.joueur=""!==$("#idNomJoueur").val()?$("#idNomJoueur").val():"",e}isJoinNetwork(){return 1===$("#idCreationGame").tabs("option","active")}isRejoinNetwork(){return 2===$("#idCreationGame").tabs("option","active")}createGame(){return this.isJoinNetwork()?(this.close(),this.monopoly.joinNetworkGame($("#idRemoteNomJoueur").val(),$("#idRemoteGame").val())):this.isRejoinNetwork()?(this.close(),this.monopoly.rejoinNetworkGame()):(Ue={},""!==this.listSauvegarde.val()?Pe.load(this.listSauvegarde.val(),this.monopoly):(this.monopoly.options=this.extractOptions(),this.monopoly.plateau.load($("#idSelectPlateau").val(),this.monopoly.options,(()=>this.monopoly._createGame(this.monopoly.options)))),void this.close())}restartGame(e){this.monopoly.options=e,this.monopoly.plateau.load($("#idSelectPlateau").val(),e,(()=>this.monopoly._createGame(e)))}}class ot{constructor(e){ze=e,w.init("message"),y.init(),this.initPanels(),a.reset(),h.init("idEncherePanel"),b.init("idCommunicationEchange"),ce.init(),V.init({idArgentRestant:"#idArgentRestant",idCout:"#idCoutTotal",idPanel:"#housesPanel",idTerrains:"#idTerrains",idHypotheque:"#toHypotheque",idTerrainsHypotheque:"#idTerrainsHypotheques",idTerrainsConstructibles:"#idTerrainsConstructibles",idCoutAchat:"#coutAchats",idConstructions:"#resteConstructions"}),this.plateau=new it}init(){v.init("idInfoBox"),$(".action-joueur").attr("disabled","disabled").addClass("disabled"),de.setMouseFunction(this.plateau.enableMouse),ze&&this.plateau.load("data-monopoly.json",(()=>this._createGame({})))}joinNetworkGame(e,t){this.remoteManager=new xe(this.plateau,e,t)}rejoinNetworkGame(){this.remoteManager=new xe(this.plateau,"",localStorage.network_game,localStorage.uniqueID)}_createNetworkGame(e){j("/createGame").then((t=>{this.remoteManager=new je(e.joueur,t.game,this.plateau);let i=this.remoteManager.create(e.nbPlayers,e.nbRobots,e.joueur,this.plateau.infos.nomsJoueurs,this.plateau.infos.argentJoueurDepart,this.plateau.infos.montantDepart);return this.afterCreateGame(i)}))}_createGame(e){return"true"===e.networkGame?this._createNetworkGame(e):this._createLocalGame(e)}_createLocalGame(e){let t=new Array(e.nbPlayers);for(let i=0;i<e.nbPlayers;i++){let s=`Joueur ${i+1}`;0===i&&""!==e.joueur?s=e.joueur:this.plateau.infos.nomsJoueurs.length>i&&(s=this.plateau.infos.nomsJoueurs[i]),t[i]=s;let o=i>=e.nbPlayers-e.nbRobots?de.getRobotPlayer():de.getCurrentPlayer();ce.create(o,i,s,!1,this.plateau.infos.argentJoueurDepart,this.plateau.infos.montantDepart)}this.afterCreateGame(t),ce.change(),Ve=Ue.quickMove?10:e.waitTimeIA||Ve}afterCreateGame(e=this.plateau.infos.nomJoueurs){this.plateau.infos.realNames=e,$(".info-joueur").tooltip({show:{},hide:{},content:function(){let e=ce.getById($(this).data("idjoueur")).getStats();return $("span[name]","#infoJoueur").each((function(){$(this).html(e[$(this).attr("name")])})),$("#infoJoueur").html()}}),l.init("idPanelEchange","idSelectJoueurs","idListTerrainsJoueur","idListTerrainsAdversaire")}initPanels(){f($("#message"),{autoOpen:!1,position:{my:"center top",at:"center top",of:window}}),$("#message").prev().css("background","url()"),$("#idSavePanel").click((()=>{let e=Pe.isSauvegarde()?null:prompt("Nom de la sauvegarde (si vide, defini par defaut)");Pe.save(e,this.plateau)})),f($("#achatMaisons"),{autoOpen:!1,position:{my:"center top",at:"center top",of:window},title:"Achat de maisons /hotels",width:500,height:300}),f($("#idTerrainsLibres"),{autoOpen:!1,position:{my:"center top",at:"center top",of:window},title:"Liste des terrains libre",width:350,height:300,buttons:[{text:"Fermer",click:()=>$("#idTerrainsLibres").dialog("close")}],open:()=>this._showFreeTerrains()}),nt||$("#idNetwork").hide()}_showFreeTerrains(){$("#idTerrainsLibres").empty();let e=O.getTerrainsLibres();for(;e.hasNext();){let t=e.next();$("#idTerrainsLibres").append(`<div style="font-weight:bold;color:${t.color}">${t.nom}</div>`)}}}let nt=!1;$((()=>{(async function(){return null!=localStorage&&null!=localStorage.network_game&&null!=localStorage.uniqueID&&"true"===await fetch(`/game/exist?id=${localStorage.network_game}`).then((e=>new Response(e.body).text()))})().then((e=>{$("#existingGame")[e?"show":"hide"]()})),$("#idCreationGame").tabs(),$("#idMontantParc").hide(),tt(!1),$(".mobile").is(":visible")&&r.setSize(950)}))})()})();