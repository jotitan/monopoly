jQuery.fn.extend({ImageRotate:function(t){if(!this.Wilq32||!this.Wilq32.PhotoEffect)return new Wilq32.PhotoEffect(this.get(0),t)._temp},rotate:function(t){if(0!==this.length&&void 0!==t){"number"==typeof t&&(t={angle:t});for(var i=[],e=0,a=this.length;e<a;e++){var s=this.get(e);void 0===s.Wilq32?i.push($($(s).ImageRotate(t))):s.Wilq32.PhotoEffect._rotate(t.angle)}return i}},rotateAnimation:function(t){if(0!==this.length&&void 0!==t){"number"==typeof t&&(t={angle:t});for(var i=[],e=0,a=this.length;e<a;e++){var s=this.get(e);void 0===s.Wilq32?i.push($($(s).ImageRotate(t))):(s.Wilq32.PhotoEffect._parameters.animateAngle=t.angle,s.Wilq32.PhotoEffect._parameters.callback=t.callback||s.Wilq32.PhotoEffect._parameters.callback||function(){},s.Wilq32.PhotoEffect._animateStart())}return i}}}),Wilq32={},Wilq32.PhotoEffect=function(t,i){this._IEfix=t,this._parameters=i,this._parameters.className=t.className,this._parameters.id=t.getAttribute("id"),this._parameters.animateAngle=0,i||(this._parameters={}),this._angle=0,i.angle||(this._parameters.angle=0),this._temp=document.createElement("span"),this._temp.Wilq32={PhotoEffect:this};var e=t.src;t.parentNode.insertBefore(this._temp,t),this._img=new Image,this._img.src=e,this._img._ref=this,jQuery(this._img).bind("load",function(){this._ref._Loader.call(this._ref)}),jQuery.browser.msie&&this._img.complete&&this._Loader()},Wilq32.PhotoEffect.prototype._Loader=jQuery.browser.msie?function(){var t=this._IEfix.src;this._IEfix.parentNode.removeChild(this._IEfix),this._temp.setAttribute("id",this._parameters.id),this._temp.className=this._parameters.className;var i=this._img.width,e=this._img.height;if(this._img._widthMax=this._img._heightMax=Math.sqrt(e*e+i*i),this._img._heightMax=Math.sqrt(e*e+i*i),this._vimage=document.createElement("v:image"),this._vimage._ref=this,this._vimage.style.height=e,this._vimage.style.width=i,this._vimage.style.position="relative",this._temp.style.display="inline-block",this._temp.style.width=this._temp.style.height=this._img._heightMax,this._vimage.src=t,this._temp.appendChild(this._vimage),this._parameters.bind)for(var a in this._parameters.bind)if(this._parameters.bind.hasOwnProperty(a))for(var s in this._parameters.bind[a])this._parameters.bind[a].hasOwnProperty(s)&&jQuery(this._temp).bind(s,this._parameters.bind[a][s]);this._rotate(this._parameters.angle)}:function(){this._IEfix.parentNode.removeChild(this._IEfix),this._temp.setAttribute("id",this._parameters.id),this._temp.className=this._parameters.className;var t=this._img.width,i=this._img.height;if(this._img._widthMax=this._img._heightMax=Math.sqrt(i*i+t*t),this._canvas=document.createElement("canvas"),this._canvas._ref=this,this._canvas.height=i,this._canvas.width=t,this._canvas.setAttribute("width",t),this._temp.appendChild(this._canvas),this._parameters.bind)for(var e in this._parameters.bind)if(this._parameters.bind.hasOwnProperty(e))for(var a in this._parameters.bind[e])this._parameters.bind[e].hasOwnProperty(a)&&jQuery(this._canvas).bind(a,this._parameters.bind[e][a]);this._cnv=this._canvas.getContext("2d"),this._rotate(this._parameters.angle)},Wilq32.PhotoEffect.prototype._animateStart=function(){this._timer&&clearTimeout(this._timer),this._animate()},Wilq32.PhotoEffect.prototype._animate=function(){(this._canvas||this._vimage)&&(this._angle-=.1*(this._angle-this._parameters.animateAngle)),void 0!==this._parameters.minAngle&&this._angle<this._parameters.minAngle&&(this._angle=this._parameters.minAngle),void 0!==this._parameters.maxAngle&&this._angle>this._parameters.maxAngle&&(this._angle=this._parameters.maxAngle);var t=0==!!Math.round(100*this._angle-100*this._parameters.animateAngle)&&!!this._timer;if(this._parameters.callback&&t&&this._parameters.callback(),t&&!this._parameters.animatedGif)clearTimeout(this._timer);else{(this._canvas||this._vimage)&&this._rotate(this._angle);var i=this;this._timer=setTimeout(function(){i._animate.call(i)},10)}},Wilq32.PhotoEffect.prototype._rotate=jQuery.browser.msie?function(t){this._vimage.style.rotation=t,Math.PI,this._vimage.style.top=(this._img._heightMax-this._img.height)/2-(this._vimage.offsetHeight-this._img.height)/2+"px",this._vimage.style.left=(this._img._widthMax-this._img.width)/2-(this._vimage.offsetWidth-this._img.width)/2+"px"}:function(t){if(this._img.width&&"number"==typeof t){t=t%360*Math.PI/180;var i=this._img.width,e=this._img.height,a=this._img._widthMax-i,s=this._img._heightMax-e;this._canvas.width=i+a,this._canvas.height=e+s,this._cnv.save(),this._cnv.translate(a/2,s/2),this._cnv.translate(i/2,e/2),this._cnv.rotate(t),this._cnv.translate(-i/2,-e/2),this._cnv.drawImage(this._img,0,0),this._cnv.restore()}};